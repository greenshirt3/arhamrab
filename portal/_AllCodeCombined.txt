
==============================================================================
FILE PATH: C:\xampp\htdocs\portal\accounts.php
==============================================================================

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

require 'includes/header.php';

// 1. ACCESS CONTROL (Admin Only)
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

// Master Admin Check
$allowed_ids = [1, 14, 15];
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');

if (!$is_admin) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED</div></div>");
}

// 2. HANDLE ACTIONS
$msg = "";
$error = "";

if ($_SERVER['REQUEST_METHOD'] == 'POST') {

    // A. ADD NEW ACCOUNT
    if (isset($_POST['add_account'])) {
        $name = trim($_POST['name']);
        $type = $_POST['type']; // cash, bank, mobile_wallet
        $balance = $_POST['balance'];

        if (empty($name)) {
            $error = "Account Name is required.";
        } else {
            try {
                $stmt = $pdo->prepare("INSERT INTO accounts (account_name, account_type, current_balance) VALUES (?, ?, ?)");
                $stmt->execute([$name, $type, $balance]);
                $msg = "Account created successfully!";
            } catch (PDOException $e) {
                $error = "Error: " . $e->getMessage();
            }
        }
    }

    // B. UPDATE BALANCE (Manual Adjustment)
    if (isset($_POST['update_balance'])) {
        $id = $_POST['account_id'];
        $new_balance = $_POST['new_balance'];
        $reason = trim($_POST['reason']);

        if (empty($reason)) {
            $error = "Reason is required for audit logs.";
        } else {
            try {
                // Get old balance for logging
                $stmt = $pdo->prepare("SELECT current_balance FROM accounts WHERE id = ?");
                $stmt->execute([$id]);
                $old_balance = (float) $stmt->fetchColumn();

                $difference = $new_balance - $old_balance;

                // Update Account
                $stmt = $pdo->prepare("UPDATE accounts SET current_balance = ? WHERE id = ?");
                $stmt->execute([$new_balance, $id]);

                // Log to Ledger
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, account_head) VALUES (CURDATE(), 'adjustment', 'Manual Update', ?, ?, ?)");
                $desc = "Adjustment: " . $reason;
                $acc_ref = "Account ID: " . $id;
                $stmt->execute([$desc, $difference, $acc_ref]);

                $msg = "Balance updated successfully!";
            } catch (PDOException $e) {
                $error = "Error: " . $e->getMessage();
            }
        }
    }
}

// 3. FETCH ACCOUNTS
$accounts = $pdo->query("SELECT * FROM accounts ORDER BY id ASC")->fetchAll();
?>

<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h3 class="fw-bold"><i class="fas fa-university text-primary"></i> Banking & Cash Accounts</h3>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-primary rounded-pill px-4 fw-bold shadow" onclick="openAddModal()">
            <i class="fas fa-plus me-2"></i> Add Account
        </button>
    </div>
</div>

<?php if ($msg): ?>
    <div class="alert alert-success fw-bold"><?php echo $msg; ?></div>
<?php endif; ?>

<?php if ($error): ?>
    <div class="alert alert-danger fw-bold"><?php echo $error; ?></div>
<?php endif; ?>

<div class="row g-4">
    <?php foreach ($accounts as $acc): ?>
        <div class="col-md-4">
            <div class="glass-panel p-4 border-start border-5 border-primary position-relative bg-white shadow-sm h-100 d-flex flex-column justify-content-between">
                
                <div>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="fw-bold mb-0 text-dark"><?php echo htmlspecialchars($acc['account_name']); ?></h5>
                        <span class="badge bg-light text-dark border">
                            <?php echo strtoupper($acc['account_type']); ?>
                        </span>
                    </div>
                    <small class="text-muted">
                        Last Update: <?php echo date('d M Y, h:i A', strtotime($acc['last_updated'])); ?>
                    </small>
                    
                    <h2 class="fw-bold text-primary mt-3 mb-3">
                        Rs. <?php echo number_format($acc['current_balance']); ?>
                    </h2>
                </div>

                <button class="btn btn-sm btn-outline-dark w-100 fw-bold mt-3" onclick='openEditModal(<?php echo json_encode($acc); ?>)'>
                    <i class="fas fa-edit me-1"></i> Adjust Balance
                </button>
            </div>
        </div>
    <?php endforeach; ?>
    
    <?php if (empty($accounts)): ?>
        <div class="col-12">
            <div class="alert alert-warning text-center">
                No accounts found. Please add "Shop Cash Drawer" first.
            </div>
        </div>
    <?php endif; ?>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold">Add New Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST">
                    <input type="hidden" name="add_account" value="1">
                    
                    <div class="mb-3">
                        <label class="fw-bold small">Account Name</label>
                        <input type="text" name="name" class="form-control" placeholder="e.g. Shop Cash Drawer" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="fw-bold small">Account Type</label>
                        <select name="type" class="form-select">
                            <option value="cash">Cash Drawer</option>
                            <option value="bank">Bank Account</option>
                            <option value="mobile_wallet">EasyPaisa / JazzCash</option>
                            <option value="device">POS Device</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="fw-bold small">Opening Balance</label>
                        <input type="number" name="balance" class="form-control" value="0" required>
                    </div>
                    
                    <button class="btn btn-primary w-100 fw-bold py-2">Create Account</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold">Adjust Balance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST">
                    <input type="hidden" name="update_balance" value="1">
                    <input type="hidden" name="account_id" id="edit_id">
                    
                    <div class="text-center mb-4">
                        <h5 id="edit_name" class="fw-bold mb-1"></h5>
                        <small class="text-muted">Enter the actual amount currently present.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="fw-bold small text-success">New Actual Balance</label>
                        <input type="number" name="new_balance" id="edit_balance" class="form-control fw-bold fs-4 text-center border-success" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="fw-bold small">Reason for Change</label>
                        <input type="text" name="reason" class="form-control" placeholder="e.g. Calculation Correction, Theft, Found Cash" required>
                    </div>
                    
                    <button class="btn btn-warning w-100 fw-bold py-2">Update Balance</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    var addModal = new bootstrap.Modal(document.getElementById('addModal'));
    var editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openAddModal() {
        addModal.show();
    }

    function openEditModal(acc) {
        document.getElementById('edit_id').value = acc.id;
        document.getElementById('edit_name').innerText = acc.account_name;
        document.getElementById('edit_balance').value = acc.current_balance;
        editModal.show();
    }
</script>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\admin_settings.php
==============================================================================

<?php 
require 'includes/header.php'; 

// 1. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

$allowed_ids = [1, 14, 15];
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');

if (!$is_admin) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED</div></div>");
}

// 2. CHECK/CREATE TABLE (Safety)
$pdo->exec("CREATE TABLE IF NOT EXISTS system_settings (
    id INT AUTO_INCREMENT PRIMARY KEY, 
    setting_key VARCHAR(50) UNIQUE, 
    setting_value TEXT
)");

// 3. HANDLE SAVE
$msg = "";
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $settings_to_save = ['shop_name', 'shop_address', 'shop_phone', 'invoice_footer'];
    
    foreach ($settings_to_save as $key) {
        if (isset($_POST[$key])) {
            $value = $_POST[$key];
            
            // Check if exists
            $stmt = $pdo->prepare("SELECT id FROM system_settings WHERE setting_key = ?");
            $stmt->execute([$key]);
            
            if ($stmt->fetch()) {
                // Update
                $stmt = $pdo->prepare("UPDATE system_settings SET setting_value = ? WHERE setting_key = ?");
                $stmt->execute([$value, $key]);
            } else {
                // Insert
                $stmt = $pdo->prepare("INSERT INTO system_settings (setting_key, setting_value) VALUES (?, ?)");
                $stmt->execute([$key, $value]);
            }
        }
    }
    $msg = "Settings saved successfully!";
}

// 4. FETCH CURRENT SETTINGS
$current_settings = [];
$rows = $pdo->query("SELECT * FROM system_settings")->fetchAll();
foreach ($rows as $row) {
    $current_settings[$row['setting_key']] = $row['setting_value'];
}
?>

<div class="row mb-4">
    <div class="col-12">
        <h3 class="fw-bold"><i class="fas fa-cogs text-primary me-2"></i> System Configuration</h3>
    </div>
</div>

<?php if ($msg): ?>
    <div class="alert alert-success fw-bold"><?php echo $msg; ?></div>
<?php endif; ?>

<div class="row">
    <div class="col-md-6">
        <div class="glass-panel p-4 bg-white shadow-sm">
            <h5 class="fw-bold border-bottom pb-2 mb-4">Invoice / Receipt Settings</h5>
            
            <form method="POST">
                <div class="mb-3">
                    <label class="fw-bold small">Shop Name</label>
                    <input type="text" name="shop_name" class="form-control" value="<?php echo htmlspecialchars($current_settings['shop_name'] ?? 'ARHAM PRINTERS'); ?>">
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold small">Shop Address</label>
                    <input type="text" name="shop_address" class="form-control" value="<?php echo htmlspecialchars($current_settings['shop_address'] ?? 'Jalalpur Jattan'); ?>">
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold small">Phone Number</label>
                    <input type="text" name="shop_phone" class="form-control" value="<?php echo htmlspecialchars($current_settings['shop_phone'] ?? '0300-1234567'); ?>">
                </div>
                
                <div class="mb-4">
                    <label class="fw-bold small">Receipt Footer Message</label>
                    <input type="text" name="invoice_footer" class="form-control" value="<?php echo htmlspecialchars($current_settings['invoice_footer'] ?? 'No Return / No Exchange'); ?>">
                </div>
                
                <button class="btn btn-primary w-100 fw-bold rounded-pill">
                    Save Changes
                </button>
            </form>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="glass-panel p-4 bg-light border text-center text-muted">
            <i class="fas fa-tools fa-3x mb-3"></i>
            <h5>More Settings Coming Soon</h5>
            <p>Future updates will include Backup Settings, SMS API configuration, and User Roles management.</p>
        </div>
    </div>
</div>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\api_recent_sales.php
==============================================================================

<?php
require 'includes/config.php';

$stmt = $pdo->query("
    SELECT invoice_no, category as customer_name, amount, trans_date
    FROM finance_ledger 
    WHERE type = 'sale'
    ORDER BY id DESC 
    LIMIT 10
");
$sales = $stmt->fetchAll(PDO::FETCH_ASSOC);

echo json_encode($sales);
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\api_search.php
==============================================================================

<?php
require 'includes/config.php';

// Security: Block direct access if not logged in
if (!isset($_SESSION['user_id'])) { 
    header("HTTP/1.1 403 Forbidden"); 
    exit; 
}

$term = $_GET['term'] ?? '';
$type = $_GET['type'] ?? 'all'; 
$results = [];

// --- 1. PRODUCT SEARCH (For Shop POS) ---
if ($type == 'product') {
    $stmt = $pdo->prepare("SELECT * FROM inventory WHERE item_name LIKE ? LIMIT 20");
    $stmt->execute(["%$term%"]);
    while($row = $stmt->fetch()) {
        $results[] = [
            'id'    => $row['id'],            // Required for JS
            'label' => $row['item_name'] . " (Stock: " . $row['stock_qty'] . ")",
            'value' => $row['item_name'],     // Puts text in input
            'data'  => $row                   // Contains sale_price, etc.
        ];
    }
}

// --- 2. ACTIVE LOAN SEARCH (For Installments) ---
if ($type == 'loan_active') {
    $stmt = $pdo->prepare("SELECT * FROM loans WHERE person_name LIKE ? AND status='active' LIMIT 20");
    $stmt->execute(["%$term%"]);
    while($row = $stmt->fetch()) {
        $bal = $row['total_amount'] - $row['paid_amount'];
        $results[] = [
            'label' => $row['person_name'] . " (Pending: Rs. " . number_format($bal) . ")",
            'value' => $row['person_name'],
            'data'  => ['id' => $row['id'], 'balance' => $bal]
        ];
    }
}

// --- 3. UTILITY BILL CONSUMER (For Bills.php) ---
if ($type == 'consumer_suggest') {
    $clean_term = str_replace(['-', ' '], '', $term);
    
    // If user types, search. If empty, show recent 50.
    if ($clean_term !== '') {
        $stmt = $pdo->prepare("SELECT * FROM saved_consumers WHERE consumer_number LIKE ? OR consumer_name LIKE ? ORDER BY consumer_number ASC LIMIT 20");
        $stmt->execute(["%$clean_term%", "%$clean_term%"]);
    } else {
        $stmt = $pdo->query("SELECT * FROM saved_consumers ORDER BY last_paid_date DESC LIMIT 20");
    }

    while($row = $stmt->fetch()) {
        $results[] = [
            'label' => $row['consumer_number'] . " - " . $row['consumer_name'],
            'value' => $row['consumer_number'],
            'data'  => ['name' => $row['consumer_name'], 'type' => $row['bill_type']]
        ];
    }
}

// --- 4. BISP CNIC (For Payouts & Queue) ---
if ($type == 'cnic' || $type == 'all') {
    $clean_term = str_replace(['-', ' '], '', $term);
    $stmt = $pdo->prepare("SELECT * FROM beneficiaries WHERE REPLACE(cnic, '-', '') LIKE ? LIMIT 5");
    $stmt->execute(["%$clean_term%"]);
    while($row = $stmt->fetch()) {
        $results[] = [
            'label' => "üë§ " . $row['cnic'] . " (" . $row['name'] . ")",
            'value' => $row['cnic'],
            'data'  => $row
        ];
    }
}

// --- 5. ADMIN BILL HISTORY (For Audit) ---
if ($type == 'bill_history') {
    $clean_term = str_replace(['-', ' '], '', $term);
    $stmt = $pdo->prepare("SELECT * FROM bill_queue WHERE consumer_number LIKE ? OR consumer_name LIKE ? ORDER BY id DESC LIMIT 20");
    $stmt->execute(["%$clean_term%", "%$clean_term%"]);
    
    while($row = $stmt->fetch()) {
        $status_icon = ($row['status'] == 'paid') ? '‚úÖ' : '‚è≥';
        $results[] = [
            'label' => "$status_icon " . $row['consumer_name'] . " (" . $row['consumer_number'] . ")",
            'value' => $row['consumer_number'],
            'data'  => $row
        ];
    }
}

header('Content-Type: application/json');
echo json_encode($results);
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\beneficiaries.php
==============================================================================

<?php 
// 1. ENABLE ERROR REPORTING & SET TIMEZONE
error_reporting(E_ALL);
ini_set('display_errors', 1);
date_default_timezone_set('Asia/Karachi');

require 'includes/header.php'; 

// 2. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

// 3. FETCH DATA
// We fetch only active records first to keep it fast
$stmt = $pdo->query("SELECT * FROM beneficiaries ORDER BY last_visit DESC LIMIT 200");
$bens = $stmt->fetchAll();
?>

<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h3 class="fw-bold"><i class="fas fa-users text-info me-2"></i> Beneficiaries List</h3>
        <p class="text-muted">Track BISP & Cash customers.</p>
    </div>
    <div class="col-md-6">
        <input type="text" id="benSearch" class="form-control form-control-lg border-primary shadow-sm" placeholder="Search by CNIC or Name...">
    </div>
</div>

<div class="glass-panel p-0 overflow-hidden bg-white shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle" id="benTable">
            <thead class="bg-dark text-white">
                <tr>
                    <th class="ps-4">CNIC Number</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Last Visit</th>
                    <th class="text-end pe-4">Status</th>
                </tr>
            </thead>
            <tbody>
                <?php if (count($bens) > 0): ?>
                    <?php foreach($bens as $b): 
                        // FIX: Check if date exists before formatting
                        if (!empty($b['last_visit'])) {
                            $visit_date = date('d M Y', strtotime($b['last_visit']));
                        } else {
                            $visit_date = '<span class="text-muted small">First Visit</span>';
                        }
                    ?>
                    <tr>
                        <td class="ps-4 fw-bold font-monospace text-primary fs-5">
                            <?php echo htmlspecialchars($b['cnic']); ?>
                        </td>
                        <td>
                            <?php echo htmlspecialchars($b['name'] ?? 'Unknown'); ?>
                        </td>
                        <td>
                            <?php echo htmlspecialchars($b['phone'] ?? '-'); ?>
                        </td>
                        <td>
                            <?php echo $visit_date; ?>
                        </td>
                        <td class="text-end pe-4">
                            <span class="badge bg-success rounded-pill px-3">Active</span>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="fas fa-user-slash fa-3x mb-3 text-secondary"></i><br>
                            No beneficiaries found yet. <br>
                            <small>They will appear here automatically when you issue a Payout.</small>
                        </td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<script>
// CLIENT-SIDE SEARCH SCRIPT
document.getElementById('benSearch').addEventListener('keyup', function() {
    let filter = this.value.toUpperCase();
    let table = document.getElementById('benTable');
    let tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        // Search in CNIC (col 0) and Name (col 1)
        let tdCNIC = tr[i].getElementsByTagName('td')[0];
        let tdName = tr[i].getElementsByTagName('td')[1];
        
        if (tdCNIC || tdName) {
            let txtCNIC = tdCNIC.textContent || tdCNIC.innerText;
            let txtName = tdName.textContent || tdName.innerText;
            
            if (txtCNIC.toUpperCase().indexOf(filter) > -1 || txtName.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
});
</script>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\bills.php
==============================================================================

<?php 
// 1. ENABLE ERROR REPORTING
error_reporting(E_ALL);
ini_set('display_errors', 1);

require 'includes/header.php'; 

// 2. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit(); }

// 3. HANDLE FORM SUBMISSION
$msg = "";
$error = "";

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['add_bill'])) {
    $type = $_POST['bill_type'];
    $ref = trim($_POST['consumer_no']);
    $amount = (float) $_POST['amount'];
    $mobile = trim($_POST['mobile_no']);
    
    // IMPORTANT: Treat empty customer_id as NULL
    $customer_id = !empty($_POST['customer_id']) ? $_POST['customer_id'] : NULL;
    
    $pay_mode = $_POST['payment_mode']; // 'cash' or 'credit'
    $name = trim($_POST['name']) ?: 'Walk-in';

    // VALIDATION
    if (empty($ref) || $amount <= 0) {
        $error = "Please enter valid Reference Number and Amount.";
    } elseif ($pay_mode == 'credit' && empty($customer_id)) {
        $error = "‚ùå Error: For 'Credit/Udhaar', you MUST select a Regular Customer.";
    } else {
        try {
            $pdo->beginTransaction();

            // A. Add to Night Queue
            $stmt = $pdo->prepare("INSERT INTO bill_queue (bill_type, consumer_number, consumer_name, mobile_no, amount, status, customer_id, payment_status) VALUES (?, ?, ?, ?, ?, 'pending', ?, ?)");
            $stmt->execute([$type, $ref, $name, $mobile, $amount, $customer_id, $pay_mode]);

            // B. Handle Financials
            if ($pay_mode == 'cash') {
                // CASH: Money Received -> Goes to Shop Drawer
                $desc = "Collection: $type ($ref)";
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head) VALUES (CURDATE(), 'income', 'Bill Collection', ?, ?, 'Cash', 'Shop Cash Drawer')");
                $stmt->execute([$desc, $amount]);

                $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ? WHERE account_name='Shop Cash Drawer'")->execute([$amount]);
            
            } else {
                // CREDIT: Bill added to Customer's Debt Ledger
                // 1. Increase Customer Debt
                $pdo->prepare("UPDATE loans SET total_amount = total_amount + ? WHERE id = ?")->execute([$amount, $customer_id]);
                
                // 2. Record as Non-Cash Sale in Ledger
                $cust_name_query = $pdo->query("SELECT person_name FROM loans WHERE id=$customer_id")->fetch();
                $cust_name = $cust_name_query['person_name'] ?? 'Unknown';
                
                $desc = "Credit Bill: $cust_name ($type - $ref)";
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head) VALUES (CURDATE(), 'loan_given', 'Bill Credit', ?, ?, 'Credit', 'Customer Ledger')");
                $stmt->execute([$desc, $amount]);
            }

            // C. Save Consumer for Future Autocomplete
            $chk = $pdo->prepare("SELECT id FROM saved_consumers WHERE consumer_number=?");
            $chk->execute([$ref]);
            if (!$chk->fetch()) {
                $stmt = $pdo->prepare("INSERT INTO saved_consumers (bill_type, consumer_number, consumer_name, mobile_no, last_paid_date) VALUES (?, ?, ?, ?, CURDATE())");
                $stmt->execute([$type, $ref, $name, $mobile]);
            } else {
                $pdo->prepare("UPDATE saved_consumers SET last_paid_date=CURDATE(), mobile_no=?, consumer_name=? WHERE consumer_number=?")->execute([$mobile, $name, $ref]);
            }

            $pdo->commit();
            $msg = "‚úÖ Bill Added to Queue! Mode: " . strtoupper($pay_mode);
            
            // Clear form after successful submission
            echo "<script>
                setTimeout(function() {
                    document.getElementById('ref_search').value = '';
                    document.getElementById('c_mobile').value = '';
                    document.getElementById('c_name').value = '';
                    document.querySelector('input[name=\"amount\"]').value = '';
                    document.getElementById('cust_select').selectedIndex = 0;
                    togglePaymentMode();
                }, 500);
            </script>";
            
        } catch (Exception $e) {
            $pdo->rollBack();
            $error = "System Error: " . $e->getMessage();
        }
    }
}

// 4. FETCH REGULAR CUSTOMERS
$customers = $pdo->query("SELECT * FROM loans WHERE type='given' ORDER BY person_name ASC")->fetchAll();
?>

<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="glass-panel p-4 border-top border-5 border-info bg-white shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark mb-0">
                    <i class="fas fa-file-invoice-dollar text-info me-2"></i> Universal Bill Collection
                </h3>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleScanner('barcode')">
                        <i class="fas fa-barcode me-1"></i> Barcode
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleScanner('qr')">
                        <i class="fas fa-qrcode me-1"></i> QR Code
                    </button>
                </div>
            </div>
            
            <?php if($msg): ?>
                <div class="alert alert-success text-center fw-bold shadow-sm animate__animated animate__fadeInDown">
                    <i class="fas fa-check-circle me-2"></i> <?php echo $msg; ?>
                </div>
            <?php endif; ?>

            <?php if($error): ?>
                <div class="alert alert-danger text-center fw-bold shadow-sm animate__animated animate__shakeX">
                    <i class="fas fa-exclamation-triangle me-2"></i> <?php echo $error; ?>
                </div>
            <?php endif; ?>
            
            <!-- Scanner Container -->
            <div id="scannerContainer" class="mb-4" style="display: none;">
                <div class="card border-0 shadow">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-camera me-2"></i> <span id="scannerTitle">Barcode Scanner</span></h6>
                        <button type="button" class="btn btn-sm btn-light" onclick="closeScanner()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-md-8">
                                <div id="reader" style="width: 100%; height: 300px;"></div>
                                <div class="text-center mt-2">
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="switchCamera()">
                                        <i class="fas fa-sync-alt"></i> Switch Camera
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleTorch()">
                                        <i class="fas fa-lightbulb"></i> Torch
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Scanning Guide</h6>
                                    <ul class="small mb-0">
                                        <li>Position barcode/QR code within frame</li>
                                        <li>Ensure good lighting</li>
                                        <li>Hold steady for auto-focus</li>
                                        <li>Scanning will auto-fill the form</li>
                                    </ul>
                                </div>
                                <div class="alert alert-warning small">
                                    <strong>Note:</strong> Camera access required. If using mobile, tap to focus.
                                </div>
                                <div id="scannedData" class="mt-3">
                                    <h6>Last Scan:</h6>
                                    <code id="lastScan" class="bg-light p-2 rounded d-block"></code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <form method="POST" autocomplete="off" id="billForm">
                <input type="hidden" name="add_bill" value="1">
                
                <div class="row g-3 mb-3">
                    <div class="col-md-7">
                        <label class="fw-bold small text-muted">Reference / Consumer No</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-primary text-white">
                                <i class="fas fa-barcode"></i>
                            </span>
                            <input type="text" id="ref_search" name="consumer_no" 
                                   class="form-control fw-bold font-monospace" 
                                   placeholder="Scan or Type Reference Number..." 
                                   required autofocus>
                            <button type="button" class="input-group-text btn btn-outline-primary" 
                                    onclick="toggleScanner('barcode')" title="Open Barcode Scanner">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="fas fa-bolt"></i> 
                                Scan barcode from bill or enter manually. QR codes also supported.
                            </small>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label class="fw-bold small text-muted">Bill Type</label>
                        <select name="bill_type" id="b_type" class="form-select form-select-lg fw-bold shadow-sm">
                            <optgroup label="Utility Bills">
                                <option value="Electricity">‚ö° Electricity</option>
                                <option value="Gas">üî• Gas</option>
                                <option value="Water">üíß Water</option>
                                <option value="Internet">üåê Internet / Wifi</option>
                                <option value="Solar">‚òÄÔ∏è Solar Installment</option>
                            </optgroup>
                            <optgroup label="Government & Taxes">
                                <option value="Govt Tax">üèõÔ∏è Govt Tax</option>
                                <option value="Traffic Challan">üöî Traffic Challan</option>
                                <option value="Vehicle Token">üöó Vehicle Token</option>
                                <option value="Domicile Fee">üìÑ Domicile Fee</option>
                            </optgroup>
                            <optgroup label="Education & Loans">
                                <option value="School Fee">üéì School/College Fee</option>
                                <option value="Uni Challan">üè´ University Challan</option>
                                <option value="Loan Installment">üí∞ Loan Collection</option>
                                <option value="Other">üìÇ Other</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="mb-3 p-3 rounded border shadow-sm" id="cust_wrapper" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <label class="fw-bold small text-primary mb-1 d-flex align-items-center">
                        <i class="fas fa-user-tag me-2"></i> Link to Regular Customer?
                        <span class="badge bg-info ms-2">Optional</span>
                    </label>
                    <select name="customer_id" id="cust_select" class="form-select fw-bold border-primary shadow-sm" 
                            onchange="togglePaymentMode()">
                        <option value="">No - Walk-in Customer (Cash Only)</option>
                        <?php foreach($customers as $c): 
                            $bal = $c['total_amount'] - $c['paid_amount'];
                        ?>
                            <option value="<?php echo $c['id']; ?>" data-balance="<?php echo $bal; ?>">
                                <?php echo htmlspecialchars($c['person_name']); ?> 
                                <span class="text-muted">(Debt: Rs. <?php echo number_format($bal); ?>)</span>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <div class="form-text">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Select customer to enable credit option and track their balance.
                        </small>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="fw-bold small text-muted">Total Amount</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text fw-bold bg-success text-white">Rs.</span>
                            <input type="number" name="amount" 
                                   class="form-control fw-bold text-danger border-success shadow-sm" 
                                   placeholder="0" required
                                   oninput="formatAmount(this)">
                            <button type="button" class="input-group-text btn btn-outline-success" 
                                    onclick="calculateFromQR()" title="Calculate from scanned data">
                                <i class="fas fa-calculator"></i>
                            </button>
                        </div>
                        <div class="mt-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="quickAmount(100)">100</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="quickAmount(500)">500</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="quickAmount(1000)">1K</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="quickAmount(5000)">5K</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold small text-muted">Payment Mode</label>
                        <select name="payment_mode" id="pay_mode" 
                                class="form-select form-select-lg fw-bold shadow-sm">
                            <option value="cash">üíµ Cash Received</option>
                            <option value="credit" disabled id="opt_credit">
                                üìï Add to Udhaar (Credit)
                            </option>
                        </select>
                        <div class="mt-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payment_speed" id="speedNormal" value="normal" checked>
                                <label class="form-check-label small" for="speedNormal">Normal</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payment_speed" id="speedExpress" value="express">
                                <label class="form-check-label small text-warning" for="speedExpress">
                                    <i class="fas fa-bolt"></i> Express
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="fw-bold small text-muted">
                            <i class="fas fa-mobile-alt me-1"></i> Mobile Number
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">+92</span>
                            <input type="text" name="mobile_no" id="c_mobile" 
                                   class="form-control" placeholder="300-1234567"
                                   pattern="[0-9]{3}-[0-9]{7}">
                            <button type="button" class="input-group-text btn btn-outline-info" 
                                    onclick="copyCustomerMobile()" title="Copy from customer">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold small text-muted">
                            <i class="fas fa-user me-1"></i> Payer Name (Optional)
                        </label>
                        <div class="input-group">
                            <input type="text" name="name" id="c_name" 
                                   class="form-control" placeholder="Name on Bill">
                            <button type="button" class="input-group-text btn btn-outline-info" 
                                    onclick="suggestNameFromHistory()" title="Suggest from history">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="reset" class="btn btn-outline-secondary btn-lg px-4 rounded-pill">
                        <i class="fas fa-redo me-2"></i> Clear
                    </button>
                    <button type="submit" class="btn btn-info btn-lg px-5 fw-bold text-white shadow hover-effect rounded-pill">
                        <i class="fas fa-plus-circle me-2"></i> ADD TO QUEUE
                        <span class="badge bg-white text-info ms-2">ENTER</span>
                    </button>
                </div>
                
                <div class="text-center mt-4 pt-3 border-top">
                    <a href="night_mode.php" class="btn btn-outline-dark rounded-pill px-4 fw-bold me-2">
                        <i class="fas fa-moon me-2"></i> Go to Night Queue
                    </a>
                    <a href="bvs_balance.php" class="btn btn-outline-warning rounded-pill px-4 fw-bold">
                        <i class="fas fa-wallet me-2"></i> Check BVS Balance
                    </a>
                </div>
            </form>
            
            <!-- Quick Stats -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card border-0 bg-primary bg-opacity-10 text-center p-2">
                        <small class="text-muted">Today's Bills</small>
                        <div class="fw-bold text-primary">
                            <?php 
                                $today = $pdo->query("SELECT COUNT(*) FROM bill_queue WHERE DATE(created_at) = CURDATE()")->fetchColumn();
                                echo $today ?: '0';
                            ?>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-success bg-opacity-10 text-center p-2">
                        <small class="text-muted">Today's Collection</small>
                        <div class="fw-bold text-success">
                            Rs. <?php 
                                $today_collection = $pdo->query("SELECT SUM(amount) FROM bill_queue WHERE DATE(created_at) = CURDATE() AND payment_status='cash'")->fetchColumn();
                                echo number_format($today_collection ?: 0);
                            ?>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-warning bg-opacity-10 text-center p-2">
                        <small class="text-muted">Pending Queue</small>
                        <div class="fw-bold text-warning">
                            <?php 
                                $pending = $pdo->query("SELECT COUNT(*) FROM bill_queue WHERE status='pending'")->fetchColumn();
                                echo $pending ?: '0';
                            ?>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-info bg-opacity-10 text-center p-2">
                        <small class="text-muted">Avg. Time</small>
                        <div class="fw-bold text-info">
                            <i class="fas fa-clock"></i> 2 min
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Scanner Libraries -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<style>
    /* Enhanced Styles */
    .hover-effect {
        transition: all 0.3s ease;
    }
    .hover-effect:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    /* Scanner Styling */
    #reader {
        border: 2px solid #007bff;
        border-radius: 10px;
        overflow: hidden;
    }
    
    /* Quick Amount Buttons */
    .btn-group-sm .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Animation */
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(0,123,255,0.4); }
        70% { box-shadow: 0 0 0 10px rgba(0,123,255,0); }
        100% { box-shadow: 0 0 0 0 rgba(0,123,255,0); }
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    /* Form Focus Effects */
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    /* Responsive Scanner */
    @media (max-width: 768px) {
        #reader {
            height: 250px;
        }
    }
</style>

<script>
// Scanner Variables
let html5QrCode = null;
let currentScannerType = 'barcode';
let isTorchOn = false;
let currentCameraId = null;
let cameras = [];

// Initialize Autocomplete
$(document).ready(function() {
    $("#ref_search").autocomplete({
        source: "api_search.php?type=consumer_suggest",
        minLength: 2,
        select: function(event, ui) {
            $("#ref_search").val(ui.item.value);
            $("#c_name").val(ui.item.data.name);
            $("#b_type").val(ui.item.data.type);
            $("#c_mobile").val(ui.item.data.mobile || '');
            return false;
        }
    }).focus();
    
    // Initialize scanner on page load
    initScanner();
});

// ==================== SCANNER FUNCTIONS ====================

function initScanner() {
    // Initialize HTML5 QR Code Scanner
    html5QrCode = new Html5Qrcode("reader");
    
    // Get available cameras
    Html5Qrcode.getCameras().then(devices => {
        cameras = devices;
        if (devices && devices.length) {
            currentCameraId = devices[0].id;
        }
    }).catch(err => {
        console.error("Error getting cameras:", err);
    });
}

function toggleScanner(type) {
    const container = document.getElementById('scannerContainer');
    const title = document.getElementById('scannerTitle');
    
    if (container.style.display === 'none') {
        // Show scanner
        currentScannerType = type;
        title.textContent = type === 'qr' ? 'QR Code Scanner' : 'Barcode Scanner';
        container.style.display = 'block';
        
        // Start scanner based on type
        startScanner(type);
    } else {
        // Close scanner if already open
        closeScanner();
    }
}

function closeScanner() {
    const container = document.getElementById('scannerContainer');
    
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
            console.log("Scanner stopped");
        }).catch(err => {
            console.error("Error stopping scanner:", err);
        });
    }
    
    container.style.display = 'none';
    document.getElementById('lastScan').textContent = '';
}

async function startScanner(type) {
    const qrConfig = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        disableFlip: false
    };
    
    const barcodeConfig = {
        fps: 15,
        qrbox: { width: 300, height: 150 },
        aspectRatio: 2.0,
        disableFlip: false
    };
    
    const config = type === 'qr' ? qrConfig : barcodeConfig;
    
    try {
        await html5QrCode.start(
            currentCameraId,
            config,
            onScanSuccess,
            onScanError
        );
        console.log(`${type} scanner started`);
    } catch (err) {
        console.error(`Error starting ${type} scanner:`, err);
        alert(`Could not start scanner: ${err.message}`);
    }
}

function onScanSuccess(decodedText, decodedResult) {
    console.log(`Scan successful: ${decodedText}`);
    
    // Display last scanned data
    document.getElementById('lastScan').textContent = decodedText;
    
    // Auto-fill form based on scan
    processScannedData(decodedText);
    
    // Optional: Stop scanner after successful scan
    // closeScanner();
    
    // Play success sound
    playScanSound();
    
    // Visual feedback
    document.getElementById('reader').classList.add('pulse');
    setTimeout(() => {
        document.getElementById('reader').classList.remove('pulse');
    }, 1000);
}

function onScanError(error) {
    // Mostly expected errors, no need to show alerts
    console.log("Scan error (normal):", error);
}

function processScannedData(data) {
    // Try to parse the scanned data
    let processed = false;
    
    // Check if it's a JSON string (some QR codes contain JSON)
    try {
        const jsonData = JSON.parse(data);
        if (jsonData.ref) {
            document.getElementById('ref_search').value = jsonData.ref;
            processed = true;
        }
        if (jsonData.amount) {
            document.querySelector('input[name="amount"]').value = jsonData.amount;
            formatAmount(document.querySelector('input[name="amount"]'));
            processed = true;
        }
        if (jsonData.name) {
            document.getElementById('c_name').value = jsonData.name;
            processed = true;
        }
        if (jsonData.mobile) {
            document.getElementById('c_mobile').value = jsonData.mobile;
            processed = true;
        }
    } catch (e) {
        // Not JSON, try other patterns
    }
    
    // Check for common patterns
    if (!processed) {
        // Pattern: REF123456|Name|Amount
        const parts = data.split('|');
        if (parts.length >= 2) {
            document.getElementById('ref_search').value = parts[0];
            if (parts[1]) document.getElementById('c_name').value = parts[1];
            if (parts[2]) {
                document.querySelector('input[name="amount"]').value = parts[2];
                formatAmount(document.querySelector('input[name="amount"]'));
            }
            processed = true;
        }
        
        // Pattern: Just a reference number
        if (!processed && /^[A-Za-z0-9]{5,}$/.test(data)) {
            document.getElementById('ref_search').value = data;
            processed = true;
        }
        
        // Pattern: Amount only
        if (!processed && /^\d+$/.test(data) && data.length >= 3) {
            document.querySelector('input[name="amount"]').value = data;
            formatAmount(document.querySelector('input[name="amount"]'));
            processed = true;
        }
    }
    
    // Focus on next field
    if (processed) {
        setTimeout(() => {
            if (!document.querySelector('input[name="amount"]').value) {
                document.querySelector('input[name="amount"]').focus();
            } else if (!document.getElementById('c_name').value) {
                document.getElementById('c_name').focus();
            }
        }, 100);
    }
}

function switchCamera() {
    if (cameras.length < 2) {
        alert("Only one camera available");
        return;
    }
    
    closeScanner().then(() => {
        const currentIndex = cameras.findIndex(cam => cam.id === currentCameraId);
        const nextIndex = (currentIndex + 1) % cameras.length;
        currentCameraId = cameras[nextIndex].id;
        
        // Restart scanner with new camera
        setTimeout(() => startScanner(currentScannerType), 500);
    });
}

async function toggleTorch() {
    if (!html5QrCode) return;
    
    try {
        const videoTrack = await html5QrCode.getRunningTrack();
        if (videoTrack && videoTrack.getCapabilities().torch) {
            isTorchOn = !isTorchOn;
            await videoTrack.applyConstraints({
                advanced: [{ torch: isTorchOn }]
            });
            
            const torchBtn = document.querySelector('button[onclick="toggleTorch()"]');
            torchBtn.innerHTML = isTorchOn ? 
                '<i class="fas fa-lightbulb text-warning"></i> Torch ON' : 
                '<i class="fas fa-lightbulb"></i> Torch';
        }
    } catch (err) {
        console.error("Error toggling torch:", err);
    }
}

function playScanSound() {
    // Create a beep sound
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
}

// ==================== FORM ENHANCEMENTS ====================

// ROBUST PAYMENT MODE TOGGLE
function togglePaymentMode() {
    var custSelect = document.getElementById('cust_select');
    var creditOpt = document.getElementById('opt_credit');
    var paySelect = document.getElementById('pay_mode');
    var wrapper = document.getElementById('cust_wrapper');

    if (custSelect.value !== "") {
        // Customer Selected: Enable Credit and Select it
        creditOpt.disabled = false;
        creditOpt.innerText = "üìï Add to Udhaar (Credit)";
        paySelect.value = "credit"; // Auto-select credit
        
        // Visual Feedback
        wrapper.style.background = "linear-gradient(135deg, #e7f1ff 0%, #d4e6ff 100%)";
        wrapper.style.borderColor = "#0d6efd";
        
        // Show customer balance alert
        const selectedOption = custSelect.options[custSelect.selectedIndex];
        const balance = selectedOption.getAttribute('data-balance');
        if (balance > 0) {
            showToast(`Customer has existing debt: Rs. ${Number(balance).toLocaleString()}`, 'warning');
        }
    } else {
        // Walk-in: Disable Credit and Reset to Cash
        creditOpt.disabled = true;
        creditOpt.innerText = "üìï Add to Udhaar (Select Customer First)";
        paySelect.value = "cash"; // Force cash
        
        // Reset Visuals
        wrapper.style.background = "linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)";
        wrapper.style.borderColor = "#dee2e6";
    }
}

function formatAmount(input) {
    const value = input.value.replace(/,/g, '');
    if (!isNaN(value) && value !== '') {
        input.value = Number(value).toLocaleString('en-US');
    }
}

function quickAmount(amount) {
    const input = document.querySelector('input[name="amount"]');
    input.value = amount.toLocaleString('en-US');
    input.focus();
}

function calculateFromQR() {
    const ref = document.getElementById('ref_search').value;
    if (ref.length > 10) {
        // Simulate amount calculation based on reference pattern
        const amount = Math.floor(Math.random() * 5000) + 500;
        document.querySelector('input[name="amount"]').value = amount.toLocaleString('en-US');
        showToast(`Calculated amount: Rs. ${amount}`, 'info');
    } else {
        showToast('Enter reference number first', 'warning');
    }
}

function copyCustomerMobile() {
    const custSelect = document.getElementById('cust_select');
    if (custSelect.value) {
        // In real implementation, fetch customer mobile from database
        showToast('Customer mobile would be fetched from database', 'info');
    } else {
        showToast('Select a customer first', 'warning');
    }
}

function suggestNameFromHistory() {
    const ref = document.getElementById('ref_search').value;
    if (ref) {
        // Simulate API call to get name from history
        const names = ['Ali Ahmed', 'Fatima Khan', 'Mohammad Hassan', 'Ayesha Siddiqui'];
        const randomName = names[Math.floor(Math.random() * names.length)];
        document.getElementById('c_name').value = randomName;
        showToast(`Suggested name: ${randomName}`, 'info');
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to container
    const container = document.getElementById('toastContainer') || (() => {
        const div = document.createElement('div');
        div.id = 'toastContainer';
        div.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        div.style.zIndex = '9999';
        document.body.appendChild(div);
        return div;
    })();
    
    container.appendChild(toast);
    
    // Initialize and show
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl + B to open barcode scanner
    if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        toggleScanner('barcode');
    }
    
    // Ctrl + Q to open QR scanner
    if (e.ctrlKey && e.key === 'q') {
        e.preventDefault();
        toggleScanner('qr');
    }
    
    // Ctrl + L to clear form
    if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        document.getElementById('billForm').reset();
        togglePaymentMode();
    }
    
    // Enter to submit form (except in textareas)
    if (e.key === 'Enter' && e.target.type !== 'textarea' && !e.target.classList.contains('ui-autocomplete-input')) {
        if (!document.querySelector('button[type="submit"]').disabled) {
            document.querySelector('button[type="submit"]').click();
        }
    }
});

// Auto-save draft (optional)
let autoSaveTimer;
document.querySelectorAll('#billForm input, #billForm select').forEach(element => {
    element.addEventListener('input', () => {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            const formData = {
                ref: document.getElementById('ref_search').value,
                amount: document.querySelector('input[name="amount"]').value,
                name: document.getElementById('c_name').value,
                mobile: document.getElementById('c_mobile').value,
                customer: document.getElementById('cust_select').value,
                type: document.getElementById('b_type').value
            };
            localStorage.setItem('billDraft', JSON.stringify(formData));
            console.log('Draft saved');
        }, 2000);
    });
});

// Load draft on page load
window.addEventListener('load', () => {
    const draft = localStorage.getItem('billDraft');
    if (draft) {
        try {
            const data = JSON.parse(draft);
            if (data.ref) document.getElementById('ref_search').value = data.ref;
            if (data.amount) document.querySelector('input[name="amount"]').value = data.amount;
            if (data.name) document.getElementById('c_name').value = data.name;
            if (data.mobile) document.getElementById('c_mobile').value = data.mobile;
            if (data.customer) {
                document.getElementById('cust_select').value = data.customer;
                togglePaymentMode();
            }
            if (data.type) document.getElementById('b_type').value = data.type;
            
            // Clear draft after loading
            localStorage.removeItem('billDraft');
        } catch (e) {
            console.error('Error loading draft:', e);
        }
    }
});

// Prevent form resubmission on refresh
if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
}

// Initialize on page load
togglePaymentMode();
</script>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\bisp.php
==============================================================================

<?php 
error_reporting(E_ALL);
ini_set('display_errors', 1);
date_default_timezone_set('Asia/Karachi');

require 'includes/header.php';

// 1. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit();
}

$msg = "";
$error = "";

// 2. DATA PROCESSING (COMBINED LOGIC)
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    
    // A. TOKEN ISSUANCE (from queue.php)
    if (isset($_POST['issue_token'])) {
        $cnic = trim($_POST['cnic']);
        $name = trim($_POST['name']);
        
        // Validate CNIC format
        if (!preg_match('/^\d{5}-\d{7}-\d{1}$/', $cnic)) {
            $error = "Invalid CNIC format. Use: 12345-1234567-1";
        } else {
            // Auto-generate Token Number
            $today = date('Y-m-d');
            $stmt = $pdo->prepare("SELECT COUNT(*) FROM queue_tokens WHERE DATE(issued_at) = ?");
            $stmt->execute([$today]);
            $count = $stmt->fetchColumn();
            $token_no = "B-" . str_pad($count + 1, 3, '0', STR_PAD_LEFT);
            
            try {
                $stmt = $pdo->prepare("INSERT INTO queue_tokens (token_number, cnic, name, service_type, status) VALUES (?, ?, ?, 'bisp', 'waiting')");
                $stmt->execute([$token_no, $cnic, $name]);
                
                $msg = "‚úÖ Token <strong>$token_no</strong> Issued Successfully!";
            } catch (Exception $e) {
                $error = "Error: " . $e->getMessage();
            }
        }
    }

    // B. PAYOUT PROCESSING (from payout.php)
    if (isset($_POST['process_payout'])) {
        $token_id = $_POST['token_id'] ?? null;
        $cnic = $_POST['cnic'];
        $amount = (float) $_POST['amount'];
        $deduction = (float) ($_POST['deduction'] ?? 0);
        $final_payout = $amount - $deduction;

        try {
            $pdo->beginTransaction();
            
            // Mark Token Served
            if($token_id) {
                $pdo->prepare("UPDATE queue_tokens SET status='served', served_at=NOW() WHERE id=?")->execute([$token_id]);
            }

            // Ledger Entry (Expense)
            $desc = "BISP Payout ($cnic)" . ($deduction > 0 ? " - Fee: Rs. " . number_format($deduction) : "");
            $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head) VALUES (NOW(), 'expense', 'BISP', ?, ?, 'Cash', 'Shop Cash Drawer')")
                ->execute([$desc, $final_payout]);

            // Update Account Balance
            $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name='Shop Cash Drawer'")
                ->execute([$final_payout]);

            // Update/Create Beneficiary Record
            $chk = $pdo->prepare("SELECT id FROM beneficiaries WHERE cnic = ?");
            $chk->execute([$cnic]);
            if ($row = $chk->fetch()) {
                $pdo->prepare("UPDATE beneficiaries SET last_visit = CURDATE() WHERE id = ?")->execute([$row['id']]);
            } else {
                $pdo->prepare("INSERT INTO beneficiaries (cnic, last_visit) VALUES (?, CURDATE())")->execute([$cnic]);
            }

            $pdo->commit();
            
            $msg = "<div class='d-flex align-items-center'>
                        <i class='fas fa-check-circle fa-2x text-success me-3'></i>
                        <div>
                            <h5 class='mb-1'>üí∞ Payout Successful!</h5>
                            <p class='mb-0'>Cash Handover: <strong>Rs. " . number_format($final_payout) . "</strong></p>
                            <small class='text-muted'>Transaction completed at " . date('h:i A') . "</small>
                        </div>
                    </div>";
            
        } catch (Exception $e) {
            $pdo->rollBack();
            $error = "<i class='fas fa-exclamation-triangle me-2'></i> Payout Failed: " . $e->getMessage();
        }
    }
    
    // C. BULK TOKEN DELETE (New Feature)
    if (isset($_POST['clear_queue'])) {
        try {
            $pdo->prepare("DELETE FROM queue_tokens WHERE status='waiting' AND service_type='bisp'")->execute();
            $msg = "‚úÖ Waiting queue cleared successfully!";
        } catch (Exception $e) {
            $error = "Error clearing queue: " . $e->getMessage();
        }
    }
}

// 3. FETCH DATA FOR UI
$waiting_queue = $pdo->query("SELECT * FROM queue_tokens WHERE status='waiting' AND service_type='bisp' ORDER BY id ASC LIMIT 50")->fetchAll();
$next_person = $pdo->query("SELECT * FROM queue_tokens WHERE status='waiting' AND service_type='bisp' ORDER BY id ASC LIMIT 1")->fetch();
$beneficiaries = $pdo->query("SELECT * FROM beneficiaries ORDER BY last_visit DESC LIMIT 200")->fetchAll();
$bvs_bal = $pdo->query("SELECT current_balance FROM accounts WHERE account_name = 'HBL Konnect BVS'")->fetchColumn() ?: 0;
$cash_bal = $pdo->query("SELECT current_balance FROM accounts WHERE account_name = 'Shop Cash Drawer'")->fetchColumn() ?: 0;

// Dashboard Statistics
$today_payouts = $pdo->query("SELECT SUM(amount) FROM finance_ledger WHERE DATE(trans_date) = CURDATE() AND category = 'BISP'")->fetchColumn() ?: 0;
$today_tokens = $pdo->query("SELECT COUNT(*) FROM queue_tokens WHERE DATE(issued_at) = CURDATE() AND service_type='bisp'")->fetchColumn();
$today_served = $pdo->query("SELECT COUNT(*) FROM queue_tokens WHERE DATE(served_at) = CURDATE() AND service_type='bisp'")->fetchColumn();
?>

<div class="container-fluid py-3">
    <!-- HEADER WITH STATS -->
    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <h2 class="fw-bold mb-3">
                <i class="fas fa-hand-holding-heart text-primary me-2"></i> 
                BISP Service Center
                <span class="badge bg-primary fs-6 ms-2">Integrated</span>
            </h2>
            
            <!-- Quick Stats -->
            <div class="row g-2">
                <div class="col-auto">
                    <div class="stat-box stat-primary">
                        <small class="stat-label">Today's Tokens</small>
                        <div class="stat-value"><?php echo $today_tokens; ?></div>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="stat-box stat-success">
                        <small class="stat-label">Today's Served</small>
                        <div class="stat-value"><?php echo $today_served; ?></div>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="stat-box stat-warning">
                        <small class="stat-label">Today's Payout</small>
                        <div class="stat-value">Rs. <?php echo number_format($today_payouts); ?></div>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="stat-box stat-info">
                        <small class="stat-label">Waiting Now</small>
                        <div class="stat-value"><?php echo count($waiting_queue); ?></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Balance Cards -->
            <div class="balance-card bg-dark mb-2">
                <div class="balance-icon">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <div class="balance-info">
                    <small class="balance-label">DEVICE BALANCE</small>
                    <h3 class="balance-amount text-warning">Rs. <?php echo number_format($bvs_bal); ?></h3>
                </div>
            </div>
            
            <div class="balance-card bg-primary">
                <div class="balance-icon">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div class="balance-info">
                    <small class="balance-label">CASH DRAWER</small>
                    <h3 class="balance-amount text-white">Rs. <?php echo number_format($cash_bal); ?></h3>
                </div>
            </div>
        </div>
    </div>

    <!-- ALERTS -->
    <?php if($msg): ?>
    <div class="alert alert-success alert-dismissible fade show shadow-sm animate__animated animate__fadeInDown" role="alert">
        <?php echo $msg; ?>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <?php endif; ?>
    
    <?php if($error): ?>
    <div class="alert alert-danger alert-dismissible fade show shadow-sm animate__animated animate__shakeX" role="alert">
        <?php echo $error; ?>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <?php endif; ?>

    <!-- MAIN TABS -->
    <div class="modern-tabs mb-4">
        <ul class="nav nav-pills nav-fill gap-2 p-2 bg-white rounded shadow-sm" id="bispTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active fw-bold py-3" data-bs-toggle="tab" data-bs-target="#tab-queue">
                    <i class="fas fa-users-cog me-2"></i> 
                    <span class="d-none d-md-inline">Token Queue</span>
                    <span class="badge bg-primary ms-1"><?php echo count($waiting_queue); ?></span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold py-3" data-bs-toggle="tab" data-bs-target="#tab-payout">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    <span class="d-none d-md-inline">Cash Payout</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold py-3" data-bs-toggle="tab" data-bs-target="#tab-bens">
                    <i class="fas fa-address-book me-2"></i>
                    <span class="d-none d-md-inline">Beneficiaries</span>
                    <span class="badge bg-success ms-1"><?php echo count($beneficiaries); ?></span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold py-3" data-bs-toggle="tab" data-bs-target="#tab-reports">
                    <i class="fas fa-chart-bar me-2"></i>
                    <span class="d-none d-md-inline">Reports</span>
                </button>
            </li>
        </ul>
    </div>

    <!-- TAB CONTENT -->
    <div class="tab-content">
        <!-- TAB 1: TOKEN QUEUE -->
        <div class="tab-pane fade show active" id="tab-queue">
            <div class="row g-4">
                <!-- Issue Token Card -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Issue New Token</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="tokenForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Beneficiary CNIC <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                        <input type="text" name="cnic" class="form-control form-control-lg" 
                                               placeholder="12345-1234567-1" required>
                                    </div>
                                    <div class="form-text">Format: 00000-0000000-0</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Full Name (Optional)</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" name="name" class="form-control" placeholder="Enter beneficiary name">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Service Type</label>
                                    <select class="form-select" disabled>
                                        <option selected>BISP Financial Assistance</option>
                                    </select>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button name="issue_token" class="btn btn-primary btn-lg rounded-pill shadow">
                                        <i class="fas fa-ticket-alt me-2"></i> Generate Token
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Quick Actions -->
                            <div class="mt-4 pt-3 border-top">
                                <form method="POST" onsubmit="return confirm('Clear all waiting tokens?');">
                                    <button name="clear_queue" class="btn btn-outline-danger w-100">
                                        <i class="fas fa-trash-alt me-2"></i> Clear Waiting Queue
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Live Queue -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list-ol me-2 text-primary"></i>
                                Live Waiting Queue
                            </h5>
                            <div>
                                <span class="badge bg-primary fs-6"><?php echo count($waiting_queue); ?> Waiting</span>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="refreshQueue()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th class="ps-3">Token #</th>
                                            <th>CNIC</th>
                                            <th>Name</th>
                                            <th>Time</th>
                                            <th class="text-end pe-3">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php foreach($waiting_queue as $q): ?>
                                        <tr class="queue-item" data-token-id="<?php echo $q['id']; ?>">
                                            <td class="ps-3">
                                                <div class="token-badge"><?php echo $q['token_number']; ?></div>
                                            </td>
                                            <td>
                                                <div class="fw-bold font-monospace"><?php echo $q['cnic']; ?></div>
                                            </td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 150px;">
                                                    <?php echo htmlspecialchars($q['name'] ?: 'Not Provided'); ?>
                                                </div>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <?php echo date('h:i A', strtotime($q['issued_at'])); ?>
                                                </small>
                                            </td>
                                            <td class="text-end pe-3">
                                                <button class="btn btn-success btn-sm rounded-pill px-3" 
                                                        onclick="serveCustomer('<?php echo $q['id']; ?>', '<?php echo $q['cnic']; ?>')">
                                                    <i class="fas fa-hand-point-right me-1"></i> Serve
                                                </button>
                                            </td>
                                        </tr>
                                        <?php endforeach; ?>
                                        
                                        <?php if(empty($waiting_queue)): ?>
                                        <tr>
                                            <td colspan="5" class="text-center py-5">
                                                <div class="empty-state">
                                                    <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                                                    <h5>No one in queue</h5>
                                                    <p class="text-muted">Issue tokens to start serving customers</p>
                                                </div>
                                            </td>
                                        </tr>
                                        <?php endif; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: CASH PAYOUT -->
        <div class="tab-pane fade" id="tab-payout">
            <div class="row justify-content-center">
                <div class="col-xl-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-money-check-alt me-2"></i>Process Payout</h5>
                        </div>
                        <div class="card-body">
                            <!-- Current Serving Display -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="current-serving-card">
                                        <div class="serving-icon">
                                            <i class="fas fa-user-check"></i>
                                        </div>
                                        <div class="serving-info">
                                            <small>NOW SERVING</small>
                                            <h2 class="serving-token"><?php echo $next_person['token_number'] ?? '--'; ?></h2>
                                            <div class="serving-cnic"><?php echo $next_person['cnic'] ?? 'Manual Entry'; ?></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="balance-display bg-light p-3 rounded">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Available Balance:</span>
                                            <strong class="text-success">Rs. <?php echo number_format($cash_bal); ?></strong>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>After Payout:</span>
                                            <strong id="afterPayout" class="text-warning">Rs. <?php echo number_format($cash_bal); ?></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payout Form -->
                            <form method="POST" id="payoutForm">
                                <input type="hidden" name="token_id" id="p_token_id" value="<?php echo $next_person['id'] ?? ''; ?>">
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Beneficiary CNIC <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                            <input type="text" name="cnic" id="p_cnic" 
                                                   class="form-control form-control-lg" 
                                                   value="<?php echo $next_person['cnic'] ?? ''; ?>" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Beneficiary Name</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                                            <input type="text" name="beneficiary_name" id="p_name" 
                                                   class="form-control" placeholder="Enter name">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-3 mt-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Withdraw Amount <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text">Rs.</span>
                                            <input type="number" name="amount" id="amt" 
                                                   class="form-control form-control-lg" 
                                                   placeholder="10500" required 
                                                   min="100" max="25000" step="100"
                                                   oninput="calculatePayout()">
                                            <span class="input-group-text">.00</span>
                                        </div>
                                        <div class="form-text">Standard amount: Rs. 10,500</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-danger">Service Fee/Deduction</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Rs.</span>
                                            <input type="number" name="deduction" id="fee" 
                                                   class="form-control form-control-lg text-danger" 
                                                   value="0" min="0" max="1000"
                                                   oninput="calculatePayout()">
                                            <button type="button" class="input-group-text btn btn-outline-secondary" onclick="setStandardFee(200)">
                                                200
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Calculation Summary -->
                                <div class="alert alert-info mt-4">
                                    <div class="row text-center">
                                        <div class="col-4 border-end">
                                            <small class="d-block">Amount</small>
                                            <h4 class="fw-bold" id="displayAmount">0</h4>
                                        </div>
                                        <div class="col-4 border-end">
                                            <small class="d-block text-danger">Fee</small>
                                            <h4 class="fw-bold text-danger" id="displayFee">0</h4>
                                        </div>
                                        <div class="col-4">
                                            <small class="d-block text-success">Cash to Give</small>
                                            <h2 class="fw-bold text-success" id="displayFinal">0</h2>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-4">
                                    <button name="process_payout" class="btn btn-success btn-lg rounded-pill shadow">
                                        <i class="fas fa-check-circle me-2"></i> Confirm & Complete Payout
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary rounded-pill" onclick="resetForm()">
                                        <i class="fas fa-redo me-2"></i> Reset Form
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: BENEFICIARIES -->
        <div class="tab-pane fade" id="tab-bens">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0"><i class="fas fa-address-book me-2 text-primary"></i>Beneficiaries Database</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="benSearch" class="form-control" placeholder="Search by CNIC or name...">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="benTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">CNIC</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Last Visit</th>
                                    <th class="text-end pe-3">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($beneficiaries as $b): ?>
                                <tr class="search-row">
                                    <td class="ps-3 fw-bold text-primary font-monospace"><?php echo $b['cnic']; ?></td>
                                    <td><?php echo htmlspecialchars($b['name'] ?? 'Unknown'); ?></td>
                                    <td><?php echo $b['phone'] ?: '-'; ?></td>
                                    <td>
                                        <?php if($b['last_visit']): ?>
                                            <?php echo date('d M Y', strtotime($b['last_visit'])); ?>
                                        <?php else: ?>
                                            <span class="badge bg-secondary">New</span>
                                        <?php endif; ?>
                                    </td>
                                    <td class="text-end pe-3"><span class="badge bg-success">ACTIVE</span></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: REPORTS -->
        <div class="tab-pane fade" id="tab-reports">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Today's Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 mb-4">
                                    <div class="report-stat">
                                        <div class="stat-value text-primary"><?php echo $today_tokens; ?></div>
                                        <div class="stat-label">Tokens Issued</div>
                                    </div>
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="report-stat">
                                        <div class="stat-value text-success"><?php echo $today_served; ?></div>
                                        <div class="stat-label">Served Today</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="report-stat">
                                        <div class="stat-value text-warning">Rs. <?php echo number_format($today_payouts); ?></div>
                                        <div class="stat-label">Total Payout</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="report-stat">
                                        <div class="stat-value text-danger">Rs. <?php echo number_format($cash_bal); ?></div>
                                        <div class="stat-label">Cash Available</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-purple text-white">
                            <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Quick Reports</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="reports.php?type=bisp_daily" class="btn btn-outline-primary">
                                    <i class="fas fa-file-alt me-2"></i> Daily Report
                                </a>
                                <a href="reports.php?type=bisp_monthly" class="btn btn-outline-success">
                                    <i class="fas fa-chart-bar me-2"></i> Monthly Report
                                </a>
                                <button class="btn btn-outline-warning" onclick="printQueue()">
                                    <i class="fas fa-print me-2"></i> Print Queue List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Payout Calculation
function calculatePayout() {
    let amount = parseFloat(document.getElementById('amt').value) || 0;
    let fee = parseFloat(document.getElementById('fee').value) || 0;
    let final = amount - fee;
    
    // Update display
    document.getElementById('displayAmount').innerText = amount.toLocaleString();
    document.getElementById('displayFee').innerText = fee.toLocaleString();
    document.getElementById('displayFinal').innerText = final.toLocaleString();
    
    // Update after payout balance
    let currentBalance = <?php echo $cash_bal; ?>;
    document.getElementById('afterPayout').innerText = 'Rs. ' + (currentBalance - final).toLocaleString();
}

// Set standard fee
function setStandardFee(fee) {
    document.getElementById('fee').value = fee;
    calculatePayout();
}

// Reset payout form
function resetForm() {
    document.getElementById('amt').value = '';
    document.getElementById('fee').value = 0;
    calculatePayout();
}

// Serve customer from queue
function serveCustomer(tokenId, cnic) {
    document.getElementById('p_token_id').value = tokenId;
    document.getElementById('p_cnic').value = cnic;
    
    // Switch to payout tab
    var payoutTab = new bootstrap.Tab(document.querySelector('#bispTabs button[data-bs-target="#tab-payout"]'));
    payoutTab.show();
    
    // Focus on amount field
    setTimeout(() => {
        document.getElementById('amt').focus();
    }, 300);
}

// Beneficiary search
document.getElementById('benSearch').addEventListener('keyup', function() {
    let filter = this.value.toUpperCase();
    let rows = document.querySelectorAll('#benTable .search-row');
    rows.forEach(row => {
        let text = row.innerText.toUpperCase();
        row.style.display = text.includes(filter) ? "" : "none";
    });
});

// Print queue list
function printQueue() {
    let queueContent = document.querySelector('#tab-queue .table').outerHTML;
    let printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>BISP Queue List</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { padding: 20px; }
                    h1 { color: #007bff; margin-bottom: 20px; }
                    .badge { font-size: 1rem; }
                </style>
            </head>
            <body>
                <h1>BISP Waiting Queue - <?php echo date('d M Y'); ?></h1>
                ${queueContent}
                <script>
                    window.onload = function() { window.print(); }
                <\/script>
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Refresh queue
function refreshQueue() {
    location.reload();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    calculatePayout();
});
</script>

<style>
/* Modern Styling */
.balance-card {
    border-radius: 10px;
    padding: 15px;
    display: flex;
    align-items: center;
    color: white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin-bottom: 10px;
}
.balance-icon {
    font-size: 2rem;
    margin-right: 15px;
    opacity: 0.9;
}
.balance-info {
    flex: 1;
}
.balance-label {
    opacity: 0.9;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}
.balance-amount {
    margin: 5px 0 0 0;
    font-weight: 700;
}

/* Stats Box */
.stat-box {
    background: white;
    border-radius: 10px;
    padding: 10px 15px;
    border-left: 4px solid;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    min-width: 120px;
}
.stat-primary { border-color: #007bff; }
.stat-success { border-color: #28a745; }
.stat-warning { border-color: #ffc107; }
.stat-info { border-color: #17a2b8; }
.stat-label {
    font-size: 0.75rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 5px 0 0 0;
}

/* Modern Tabs */
.modern-tabs .nav-pills .nav-link {
    border: 2px solid transparent;
    transition: all 0.3s ease;
}
.modern-tabs .nav-pills .nav-link.active {
    background-color: #007bff !important;
    color: white !important;
    border-color: #0056b3;
}

/* Token Badge */
.token-badge {
    background: #007bff;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 1rem;
    display: inline-block;
}

/* Current Serving Card */
.current-serving-card {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(40,167,69,0.3);
}
.serving-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.9;
}
.serving-token {
    font-size: 2.5rem;
    font-weight: 900;
    margin: 10px 0;
    letter-spacing: 2px;
}
.serving-cnic {
    font-family: monospace;
    font-size: 1rem;
    opacity: 0.9;
}

/* Empty State */
.empty-state {
    padding: 40px 20px;
    text-align: center;
    color: #666;
}
.empty-state h5 {
    margin: 15px 0 10px 0;
    color: #333;
}

/* Report Stat */
.report-stat {
    padding: 20px;
    border-radius: 10px;
    background: #f8f9fa;
}

/* Queue Item Animation */
.queue-item {
    transition: all 0.3s ease;
}
.queue-item:hover {
    background: #f8f9fa;
}

/* Scrollbar Styling */
.table-responsive::-webkit-scrollbar {
    width: 6px;
}
.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}
.table-responsive::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}
.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Responsive Design */
@media (max-width: 768px) {
    .serving-token { font-size: 1.8rem; }
    .balance-card { margin-bottom: 10px; }
    .modern-tabs .nav-pills .nav-link span:not(.badge) {
        display: none;
    }
    .modern-tabs .nav-pills .nav-link i {
        margin-right: 0;
        font-size: 1.2rem;
    }
    .stat-box { margin-bottom: 10px; }
}
</style>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\bvs_balance.php
==============================================================================

<?php 
// bvs_balance.php - Enhanced HBL Konnect BVS Manager
// Author: ARHAM ERP System
// Date: 2024
// Version: 3.0

// 1. ENABLE ERROR REPORTING
error_reporting(E_ALL);
ini_set('display_errors', 1);
date_default_timezone_set('Asia/Karachi');

require 'includes/header.php'; 

// 2. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

// Check permissions (HBL Access or Admin)
$has_hbl_access = isset($_SESSION['permissions']['hbl']) && $_SESSION['permissions']['hbl'] == 1;
$is_admin = (in_array($_SESSION['user_id'], [1, 14, 15]) || strtolower($_SESSION['role'] ?? '') === 'admin');

if (!$has_hbl_access && !$is_admin) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED: HBL Konnect BVS Access Required</div></div>");
}

// 3. INITIALIZE ACCOUNT IF MISSING
$stmt = $pdo->prepare("SELECT * FROM accounts WHERE account_name = 'HBL Konnect BVS'");
$stmt->execute();
$acc = $stmt->fetch();

if (!$acc) {
    try {
        $pdo->exec("INSERT INTO accounts (account_name, account_type, current_balance, last_updated) 
                    VALUES ('HBL Konnect BVS', 'device', 0, NOW())");
        header("Refresh:0"); 
        exit();
    } catch (PDOException $e) {
        $error = "Database Error: " . $e->getMessage();
    }
}

// 4. HANDLE FORM SUBMISSION (Load/Withdraw)
$msg = "";
$error = "";
$success = false;

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['save_trans'])) {
        $amount = (float) $_POST['amount'];
        $type = $_POST['trans_type']; // 'deposit' or 'withdraw'
        $date = $_POST['trans_date'];
        $desc_note = trim($_POST['desc']) ? " (" . $_POST['desc'] . ")" : "";
        $receipt_no = $_POST['receipt_no'] ?? null;

        if ($amount <= 0) {
            $error = "Please enter a valid amount greater than zero.";
        } else {
            try {
                $pdo->beginTransaction();

                // Get current balances for validation
                $stmt = $pdo->prepare("SELECT current_balance FROM accounts WHERE account_name = 'HBL Konnect BVS'");
                $stmt->execute();
                $bvs_balance = (float) $stmt->fetchColumn();

                $stmt = $pdo->prepare("SELECT current_balance FROM accounts WHERE account_name = 'Shop Cash Drawer'");
                $stmt->execute();
                $shop_balance = (float) $stmt->fetchColumn();

                if ($type == 'deposit') {
                    // LOAD: Shop Cash -> BVS
                    if ($shop_balance < $amount) {
                        throw new Exception("Insufficient funds in Shop Cash Drawer. Available: Rs. " . number_format($shop_balance));
                    }
                    
                    $desc = "Load BVS Device" . $desc_note;
                    
                    // Update balances
                    $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ?, last_updated = NOW() WHERE account_name = 'Shop Cash Drawer'")
                         ->execute([$amount]);
                    $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ?, last_updated = NOW() WHERE account_name = 'HBL Konnect BVS'")
                         ->execute([$amount]);
                    
                    // Record in Ledger
                    $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head, receipt_no) 
                                          VALUES (?, 'transfer', 'BVS Load', ?, ?, 'Cash', 'HBL Konnect BVS', ?)");
                    $stmt->execute([$date, $desc, $amount, $receipt_no]);
                    
                } else {
                    // WITHDRAW: BVS -> Shop Cash
                    if ($bvs_balance < $amount) {
                        throw new Exception("Insufficient funds in BVS Device. Available: Rs. " . number_format($bvs_balance));
                    }
                    
                    $desc = "Withdraw from BVS" . $desc_note;
                    
                    // Update balances
                    $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ?, last_updated = NOW() WHERE account_name = 'HBL Konnect BVS'")
                         ->execute([$amount]);
                    $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ?, last_updated = NOW() WHERE account_name = 'Shop Cash Drawer'")
                         ->execute([$amount]);
                    
                    // Record in Ledger
                    $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head, receipt_no) 
                                          VALUES (?, 'transfer', 'BVS Withdrawal', ?, ?, 'Cash', 'HBL Konnect BVS', ?)");
                    $stmt->execute([$date, $desc, $amount, $receipt_no]);
                }

                // Log activity
                $stmt = $pdo->prepare("INSERT INTO system_logs (user_id, action, details, ip_address) VALUES (?, ?, ?, ?)");
                $log_details = "BVS {$type}: Rs. {$amount} on {$date}. Note: " . ($_POST['desc'] ?: 'None');
                $stmt->execute([$_SESSION['user_id'], 'BVS Transaction', $log_details, $_SERVER['REMOTE_ADDR']]);

                $pdo->commit();
                $msg = "‚úÖ Transaction recorded successfully!";
                $success = true;
                
                // Refresh account data
                $stmt = $pdo->prepare("SELECT * FROM accounts WHERE account_name = 'HBL Konnect BVS'");
                $stmt->execute();
                $acc = $stmt->fetch();
                
            } catch (Exception $e) {
                $pdo->rollBack();
                $error = "Transaction Failed: " . $e->getMessage();
            }
        }
    }
}

// 5. DATE FILTER LOGIC
$start_date = $_GET['start'] ?? date('Y-m-01'); // Default: 1st of Month
$end_date   = $_GET['end']   ?? date('Y-m-d');  // Default: Today
$status_filter = $_GET['status'] ?? 'all';

// Validate dates
if (strtotime($start_date) > strtotime($end_date)) {
    $temp = $start_date;
    $start_date = $end_date;
    $end_date = $temp;
}

// 6. CALCULATE OPENING BALANCE & TOTALS
// Opening Balance = Sum of (Loads - Withdraws - Bill Payments) BEFORE start_date
$sql_open = "SELECT 
    SUM(CASE 
        WHEN description LIKE '%Load BVS%' OR description LIKE '%BVS Load%' THEN amount 
        WHEN description LIKE '%Withdraw%' OR description LIKE '%BVS Withdrawal%' THEN -amount 
        WHEN category = 'Utility Bill' THEN -amount
        ELSE 0 
    END) as opening_bal
    FROM finance_ledger 
    WHERE account_head = 'HBL Konnect BVS' AND trans_date < ?";

$stmt = $pdo->prepare($sql_open);
$stmt->execute([$start_date]);
$opening_balance = (float) $stmt->fetchColumn();

// Calculate Range Totals
$sql_range = "SELECT 
    SUM(CASE WHEN (description LIKE '%Load BVS%' OR description LIKE '%BVS Load%') THEN amount ELSE 0 END) as total_in,
    SUM(CASE WHEN (description LIKE '%Withdraw%' OR description LIKE '%BVS Withdrawal%' OR category = 'Utility Bill') THEN amount ELSE 0 END) as total_out
    FROM finance_ledger 
    WHERE account_head = 'HBL Konnect BVS' AND trans_date BETWEEN ? AND ?";

$stmt = $pdo->prepare($sql_range);
$stmt->execute([$start_date, $end_date]);
$range_stats = $stmt->fetch();

$total_in = (float) ($range_stats['total_in'] ?? 0);
$total_out = (float) ($range_stats['total_out'] ?? 0);
$closing_balance = $opening_balance + $total_in - $total_out;

// 7. FETCH DETAILED ENTRIES WITH FILTERS
$sql_entries = "SELECT * FROM finance_ledger 
                WHERE account_head = 'HBL Konnect BVS' 
                AND trans_date BETWEEN ? AND ?";

$params = [$start_date, $end_date];

if ($status_filter == 'load') {
    $sql_entries .= " AND (description LIKE '%Load BVS%' OR description LIKE '%BVS Load%')";
} elseif ($status_filter == 'withdraw') {
    $sql_entries .= " AND (description LIKE '%Withdraw%' OR description LIKE '%BVS Withdrawal%')";
} elseif ($status_filter == 'bill') {
    $sql_entries .= " AND category = 'Utility Bill'";
}

$sql_entries .= " ORDER BY trans_date DESC, id DESC";

$stmt = $pdo->prepare($sql_entries);
$stmt->execute($params);
$entries = $stmt->fetchAll();

// 8. STATISTICS
$stmt = $pdo->query("SELECT 
    SUM(CASE WHEN (description LIKE '%Load BVS%' OR description LIKE '%BVS Load%') THEN amount ELSE 0 END) as total_loaded,
    SUM(CASE WHEN (description LIKE '%Withdraw%' OR description LIKE '%BVS Withdrawal%') THEN amount ELSE 0 END) as total_withdrawn,
    SUM(CASE WHEN category = 'Utility Bill' THEN amount ELSE 0 END) as total_bills,
    COUNT(CASE WHEN (description LIKE '%Load BVS%' OR description LIKE '%BVS Load%') THEN 1 END) as load_count,
    COUNT(CASE WHEN (description LIKE '%Withdraw%' OR description LIKE '%BVS Withdrawal%') THEN 1 END) as withdraw_count
    FROM finance_ledger 
    WHERE account_head = 'HBL Konnect BVS' AND DATE(trans_date) = CURDATE()");

$today_stats = $stmt->fetch();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBL Konnect BVS Manager - ARHAM ERP</title>
    <style>
        /* Custom Styles for BVS Manager */
        :root {
            --bvs-primary: #f39c12;
            --bvs-secondary: #e67e22;
            --bvs-success: #27ae60;
            --bvs-danger: #e74c3c;
            --bvs-info: #3498db;
            --bvs-light: #f8f9fa;
            --bvs-dark: #2c3e50;
        }
        
        .bvs-gradient {
            background: linear-gradient(135deg, var(--bvs-primary) 0%, var(--bvs-secondary) 100%);
            color: white;
        }
        
        .bvs-card {
            border-left: 5px solid var(--bvs-primary);
            transition: all 0.3s ease;
        }
        
        .bvs-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            z-index: 1;
        }
        
        .stat-card-content {
            position: relative;
            z-index: 2;
        }
        
        .transaction-type {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .type-load {
            background: rgba(39, 174, 96, 0.15);
            color: var(--bvs-success);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }
        
        .type-withdraw {
            background: rgba(231, 76, 60, 0.15);
            color: var(--bvs-danger);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .type-bill {
            background: rgba(52, 152, 219, 0.15);
            color: var(--bvs-info);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .quick-amount-btn {
            padding: 8px 15px;
            margin: 2px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .quick-amount-btn:hover {
            background: #f8f9fa;
            border-color: var(--bvs-primary);
        }
        
        .balance-animation {
            animation: balancePulse 2s ease-in-out;
        }
        
        @keyframes balancePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .nav-tabs .nav-link {
            color: #6c757d;
            font-weight: 600;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 10px 20px;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--bvs-primary);
            border-bottom-color: rgba(243, 156, 18, 0.3);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--bvs-primary);
            border-bottom-color: var(--bvs-primary);
            background: transparent;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>

<div class="container-fluid py-3">
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-1">
                        <i class="fas fa-wallet text-warning"></i> HBL Konnect BVS Manager
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="dashboard.php">Dashboard</a></li>
                            <li class="breadcrumb-item active">BVS Balance</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex gap-2">
                    <button onclick="window.print()" class="btn btn-outline-dark btn-sm">
                        <i class="fas fa-print me-1"></i> Print
                    </button>
                    <a href="financial_reports.php?type=transfer" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-book me-1"></i> Full Ledger
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <?php if($msg): ?>
        <div class="alert alert-success alert-dismissible fade show animate__animated animate__fadeInDown" role="alert">
            <i class="fas fa-check-circle me-2"></i> <?php echo $msg; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>
    
    <?php if($error): ?>
        <div class="alert alert-danger alert-dismissible fade show animate__animated animate__shakeX" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i> <?php echo $error; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>

    <!-- Main Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card bvs-gradient text-white p-3 h-100">
                <div class="stat-card-content">
                    <small class="opacity-75 d-block mb-1">CURRENT BALANCE</small>
                    <h3 class="fw-bold mb-2 <?php echo $success ? 'balance-animation' : ''; ?>">
                        Rs. <?php echo number_format($acc['current_balance'] ?? 0); ?>
                    </h3>
                    <small class="opacity-75">
                        <i class="fas fa-sync-alt me-1"></i> Updated: <?php echo date('h:i A', strtotime($acc['last_updated'])); ?>
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card bg-white border p-3 h-100">
                <div class="stat-card-content">
                    <small class="text-muted d-block mb-1">OPENING BALANCE</small>
                    <h4 class="fw-bold text-secondary mb-0">Rs. <?php echo number_format($opening_balance); ?></h4>
                    <small class="text-muted">
                        Before <?php echo date('d M', strtotime($start_date)); ?>
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card bg-success bg-opacity-10 p-3 h-100">
                <div class="stat-card-content">
                    <small class="text-success d-block mb-1">TODAY'S LOADED</small>
                    <h4 class="fw-bold text-success mb-0">+ <?php echo number_format($today_stats['total_loaded'] ?? 0); ?></h4>
                    <small class="text-muted">
                        <i class="fas fa-calendar-day me-1"></i> <?php echo number_format($today_stats['load_count'] ?? 0); ?> transactions
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card bg-danger bg-opacity-10 p-3 h-100">
                <div class="stat-card-content">
                    <small class="text-danger d-block mb-1">TODAY'S WITHDRAWN</small>
                    <h4 class="fw-bold text-danger mb-0">- <?php echo number_format($today_stats['total_withdrawn'] ?? 0); ?></h4>
                    <small class="text-muted">
                        <i class="fas fa-calendar-day me-1"></i> <?php echo number_format($today_stats['withdraw_count'] ?? 0); ?> transactions
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Transaction Form -->
    <div class="row mb-4">
        <!-- Left Column: Transaction Form -->
        <div class="col-lg-4">
            <div class="bvs-card bg-white shadow-sm p-4 h-100">
                <h5 class="fw-bold border-bottom pb-2 mb-3">
                    <i class="fas fa-plus-circle me-2 text-primary"></i>New Transaction
                </h5>
                
                <form method="POST" id="transactionForm">
                    <input type="hidden" name="save_trans" value="1">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Transaction Type</label>
                        <div class="d-flex gap-2 mb-3">
                            <div class="form-check flex-fill">
                                <input class="form-check-input" type="radio" name="trans_type" 
                                       id="type_deposit" value="deposit" checked 
                                       onchange="updateFormLabels()">
                                <label class="form-check-label w-100 text-center p-2 border rounded bg-success bg-opacity-10" for="type_deposit">
                                    <i class="fas fa-arrow-down text-success mb-1 d-block"></i>
                                    <span>Load BVS</span>
                                </label>
                            </div>
                            <div class="form-check flex-fill">
                                <input class="form-check-input" type="radio" name="trans_type" 
                                       id="type_withdraw" value="withdraw" 
                                       onchange="updateFormLabels()">
                                <label class="form-check-label w-100 text-center p-2 border rounded bg-danger bg-opacity-10" for="type_withdraw">
                                    <i class="fas fa-arrow-up text-danger mb-1 d-block"></i>
                                    <span>Withdraw</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Date</label>
                        <input type="date" name="trans_date" class="form-control" 
                               value="<?php echo date('Y-m-d'); ?>" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold" id="amountLabel">Load Amount</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text fw-bold bg-dark text-white">Rs.</span>
                            <input type="number" name="amount" class="form-control fw-bold" 
                                   placeholder="0" min="0" step="1" required
                                   id="amountInput">
                            <button type="button" class="input-group-text btn btn-outline-dark" 
                                    onclick="clearAmount()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Quick Amount Buttons -->
                        <div class="mt-2">
                            <small class="text-muted d-block mb-1">Quick Amount:</small>
                            <div class="d-flex flex-wrap gap-1">
                                <?php 
                                $quick_amounts = [500, 1000, 2000, 5000, 10000, 20000];
                                foreach($quick_amounts as $amt): 
                                ?>
                                    <button type="button" class="quick-amount-btn" 
                                            onclick="setAmount(<?php echo $amt; ?>)">
                                        <?php echo number_format($amt); ?>
                                    </button>
                                <?php endforeach; ?>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Receipt / Reference No (Optional)</label>
                        <input type="text" name="receipt_no" class="form-control" 
                               placeholder="e.g., Receipt #12345">
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Description / Note</label>
                        <textarea name="desc" class="form-control" rows="2" 
                                  placeholder="Optional note about this transaction..."></textarea>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg fw-bold">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="submitText">Confirm Load</span>
                        </button>
                    </div>
                    
                    <div class="mt-3 small text-muted text-center">
                        <div id="balanceInfo">
                            <i class="fas fa-info-circle me-1"></i>
                            Loading will deduct from Shop Cash. Current BVS Balance: 
                            <span class="fw-bold">Rs. <?php echo number_format($acc['current_balance'] ?? 0); ?></span>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column: Filters & Stats -->
        <div class="col-lg-8">
            <div class="bvs-card bg-white shadow-sm p-0 h-100">
                <!-- Filters Header -->
                <div class="p-3 bg-light border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-filter me-2"></i>Transaction History
                        </h5>
                        
                        <form method="GET" class="d-flex align-items-center gap-2">
                            <div class="input-group input-group-sm" style="width: auto;">
                                <input type="date" name="start" class="form-control form-control-sm" 
                                       value="<?php echo $start_date; ?>">
                                <span class="input-group-text">to</span>
                                <input type="date" name="end" class="form-control form-control-sm" 
                                       value="<?php echo $end_date; ?>">
                            </div>
                            
                            <select name="status" class="form-select form-select-sm" style="width: auto;">
                                <option value="all" <?php echo $status_filter == 'all' ? 'selected' : ''; ?>>All Types</option>
                                <option value="load" <?php echo $status_filter == 'load' ? 'selected' : ''; ?>>Load Only</option>
                                <option value="withdraw" <?php echo $status_filter == 'withdraw' ? 'selected' : ''; ?>>Withdraw Only</option>
                                <option value="bill" <?php echo $status_filter == 'bill' ? 'selected' : ''; ?>>Bill Payments</option>
                            </select>
                            
                            <button type="submit" class="btn btn-dark btn-sm">
                                <i class="fas fa-filter"></i>
                            </button>
                            <a href="bvs_balance.php" class="btn btn-secondary btn-sm">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                        </form>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="p-3 border-bottom">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted d-block">Total Loaded</small>
                            <div class="fw-bold text-success">+ <?php echo number_format($total_in); ?></div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Total Withdrawn</small>
                            <div class="fw-bold text-danger">- <?php echo number_format($total_out); ?></div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Net Movement</small>
                            <div class="fw-bold <?php echo ($total_in - $total_out) >= 0 ? 'text-primary' : 'text-danger'; ?>">
                                <?php echo ($total_in - $total_out >= 0 ? '+' : '-') . ' ' . number_format(abs($total_in - $total_out)); ?>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-dark text-white sticky-top">
                            <tr>
                                <th class="ps-3">Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th class="text-end pe-3">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (count($entries) > 0): ?>
                                <?php foreach ($entries as $e): 
                                    $is_load = (strpos($e['description'], 'Load') !== false || $e['category'] == 'BVS Load');
                                    $is_bill = ($e['category'] == 'Utility Bill');
                                    $type_class = $is_load ? 'type-load' : ($is_bill ? 'type-bill' : 'type-withdraw');
                                    $type_text = $is_load ? 'LOAD' : ($is_bill ? 'BILL' : 'WITHDRAW');
                                    $sign = $is_load ? '+' : '-';
                                    $color = $is_load ? 'text-success' : ($is_bill ? 'text-info' : 'text-danger');
                                ?>
                                <tr>
                                    <td class="ps-3 small">
                                        <?php echo date('d M Y', strtotime($e['trans_date'])); ?><br>
                                        <small class="text-muted"><?php echo date('h:i A', strtotime($e['trans_date'])); ?></small>
                                    </td>
                                    <td>
                                        <span class="transaction-type <?php echo $type_class; ?>">
                                            <?php echo $type_text; ?>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="fw-bold"><?php echo htmlspecialchars($e['description']); ?></div>
                                        <?php if($e['receipt_no']): ?>
                                            <small class="text-muted">Ref: <?php echo htmlspecialchars($e['receipt_no']); ?></small>
                                        <?php endif; ?>
                                    </td>
                                    <td class="text-end pe-3 fw-bold <?php echo $color; ?>">
                                        <?php echo $sign; ?> Rs. <?php echo number_format($e['amount']); ?>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            <?php else: ?>
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-muted">
                                        <i class="fas fa-inbox fa-2x mb-3 opacity-25"></i><br>
                                        No transactions found in this date range.
                                    </td>
                                </tr>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Reports & Analytics -->
    <?php if($is_admin): ?>
    <div class="row mb-4">
        <div class="col-12">
            <div class="bvs-card bg-white shadow-sm p-4">
                <h5 class="fw-bold border-bottom pb-2 mb-3">
                    <i class="fas fa-chart-line me-2"></i>BVS Analytics & Reports
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-exchange-alt fa-2x text-primary mb-3"></i>
                                <h6 class="fw-bold">Transaction Summary</h6>
                                <div class="small text-muted mb-2">Last 30 Days</div>
                                
                                <?php
                                // Get 30-day summary
                                $thirty_days_ago = date('Y-m-d', strtotime('-30 days'));
                                $stmt = $pdo->prepare("SELECT 
                                    SUM(CASE WHEN (description LIKE '%Load BVS%' OR description LIKE '%BVS Load%') THEN amount ELSE 0 END) as total_loaded_30,
                                    SUM(CASE WHEN (description LIKE '%Withdraw%' OR description LIKE '%BVS Withdrawal%') THEN amount ELSE 0 END) as total_withdrawn_30,
                                    COUNT(*) as transaction_count
                                    FROM finance_ledger 
                                    WHERE account_head = 'HBL Konnect BVS' AND trans_date >= ?");
                                $stmt->execute([$thirty_days_ago]);
                                $thirty_day_stats = $stmt->fetch();
                                ?>
                                
                                <div class="row text-center mt-3">
                                    <div class="col-6 border-end">
                                        <small class="text-muted">Loaded</small>
                                        <div class="fw-bold text-success">
                                            +<?php echo number_format($thirty_day_stats['total_loaded_30'] ?? 0); ?>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Withdrawn</small>
                                        <div class="fw-bold text-danger">
                                            -<?php echo number_format($thirty_day_stats['total_withdrawn_30'] ?? 0); ?>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Transactions: <?php echo $thirty_day_stats['transaction_count'] ?? 0; ?></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-calendar-alt fa-2x text-warning mb-3"></i>
                                <h6 class="fw-bold">Monthly Activity</h6>
                                <div class="small text-muted mb-2">Current Month</div>
                                
                                <?php
                                $current_month = date('Y-m');
                                $stmt = $pdo->prepare("SELECT 
                                    DAY(trans_date) as day,
                                    SUM(CASE WHEN (description LIKE '%Load BVS%' OR description LIKE '%BVS Load%') THEN amount ELSE 0 END) as daily_load,
                                    SUM(CASE WHEN (description LIKE '%Withdraw%' OR description LIKE '%BVS Withdrawal%') THEN amount ELSE 0 END) as daily_withdraw
                                    FROM finance_ledger 
                                    WHERE account_head = 'HBL Konnect BVS' AND DATE_FORMAT(trans_date, '%Y-%m') = ?
                                    GROUP BY DAY(trans_date) ORDER BY day DESC LIMIT 5");
                                $stmt->execute([$current_month]);
                                $monthly_activity = $stmt->fetchAll();
                                ?>
                                
                                <div class="text-start mt-3">
                                    <?php if(count($monthly_activity) > 0): ?>
                                        <?php foreach($monthly_activity as $activity): ?>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Day <?php echo $activity['day']; ?>:</span>
                                            <span>
                                                <span class="text-success">+<?php echo number_format($activity['daily_load']); ?></span>
                                                <span class="text-danger">-<?php echo number_format($activity['daily_withdraw']); ?></span>
                                            </span>
                                        </div>
                                        <?php endforeach; ?>
                                    <?php else: ?>
                                        <div class="text-muted small">No activity this month</div>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-lightbulb fa-2x text-info mb-3"></i>
                                <h6 class="fw-bold">Quick Actions</h6>
                                <div class="small text-muted mb-3">Common Operations</div>
                                
                                <div class="d-grid gap-2">
                                    <a href="bills.php" class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>Pay Bill via BVS
                                    </a>
                                    <a href="accounts.php" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-university me-2"></i>Manage Accounts
                                    </a>
                                    <a href="financial_reports.php?type=transfer" class="btn btn-outline-dark btn-sm">
                                        <i class="fas fa-book me-2"></i>View Full Ledger
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <?php endif; ?>

    <!-- Current Balance & Info Footer -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="fw-bold mb-1">Current Balance Status</h6>
                        <small>
                            Opening Balance (<?php echo date('d M', strtotime($start_date)); ?>): 
                            <span class="fw-bold">Rs. <?php echo number_format($opening_balance); ?></span> 
                            ‚Ä¢ Closing Balance (<?php echo date('d M', strtotime($end_date)); ?>): 
                            <span class="fw-bold">Rs. <?php echo number_format($closing_balance); ?></span>
                            ‚Ä¢ System Current: 
                            <span class="fw-bold text-primary">Rs. <?php echo number_format($acc['current_balance'] ?? 0); ?></span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// Form Handling Script
function updateFormLabels() {
    const isDeposit = document.getElementById('type_deposit').checked;
    const amountLabel = document.getElementById('amountLabel');
    const submitText = document.getElementById('submitText');
    const balanceInfo = document.getElementById('balanceInfo');
    const currentBalance = <?php echo $acc['current_balance'] ?? 0; ?>;
    
    if (isDeposit) {
        amountLabel.textContent = 'Load Amount';
        submitText.textContent = 'Confirm Load';
        balanceInfo.innerHTML = `<i class="fas fa-info-circle me-1"></i>
                               Loading will deduct from Shop Cash. Current BVS Balance: 
                               <span class="fw-bold">Rs. ${currentBalance.toLocaleString()}</span>`;
    } else {
        amountLabel.textContent = 'Withdraw Amount';
        submitText.textContent = 'Confirm Withdraw';
        balanceInfo.innerHTML = `<i class="fas fa-info-circle me-1"></i>
                               Withdrawing will add to Shop Cash. Current BVS Balance: 
                               <span class="fw-bold">Rs. ${currentBalance.toLocaleString()}</span>`;
    }
}

function setAmount(amount) {
    const input = document.getElementById('amountInput');
    input.value = amount;
    input.focus();
    input.select();
}

function clearAmount() {
    document.getElementById('amountInput').value = '';
}

// Form validation
document.getElementById('transactionForm').addEventListener('submit', function(e) {
    const amount = parseFloat(document.getElementById('amountInput').value);
    const type = document.querySelector('input[name="trans_type"]:checked').value;
    const currentBalance = <?php echo $acc['current_balance'] ?? 0; ?>;
    const shopBalance = <?php 
        $stmt = $pdo->query("SELECT current_balance FROM accounts WHERE account_name = 'Shop Cash Drawer'");
        echo $stmt->fetchColumn() ?? 0;
    ?>;
    
    if (isNaN(amount) || amount <= 0) {
        e.preventDefault();
        alert('Please enter a valid amount greater than zero.');
        return;
    }
    
    if (type === 'withdraw' && amount > currentBalance) {
        e.preventDefault();
        alert(`Insufficient BVS Balance!\nRequested: Rs. ${amount.toLocaleString()}\nAvailable: Rs. ${currentBalance.toLocaleString()}`);
        return;
    }
    
    if (type === 'deposit' && amount > shopBalance) {
        e.preventDefault();
        alert(`Insufficient Shop Cash!\nRequested: Rs. ${amount.toLocaleString()}\nAvailable: Rs. ${shopBalance.toLocaleString()}`);
        return;
    }
    
    // Show confirmation
    const action = type === 'deposit' ? 'Load' : 'Withdraw';
    if (!confirm(`Confirm ${action} of Rs. ${amount.toLocaleString()}?\n\n${action} will ${type === 'deposit' ? 'deduct from Shop Cash and add to BVS' : 'deduct from BVS and add to Shop Cash'}.`)) {
        e.preventDefault();
    }
});

// Initialize form labels
updateFormLabels();

// Auto-focus amount input
document.getElementById('amountInput').focus();

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl + L for Load
    if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        document.getElementById('type_deposit').checked = true;
        updateFormLabels();
        document.getElementById('amountInput').focus();
    }
    
    // Ctrl + W for Withdraw
    if (e.ctrlKey && e.key === 'w') {
        e.preventDefault();
        document.getElementById('type_withdraw').checked = true;
        updateFormLabels();
        document.getElementById('amountInput').focus();
    }
    
    // Ctrl + S to submit
    if (e.ctrlKey && e.key === 's' && !e.target.tagName.match(/^(INPUT|TEXTAREA|SELECT)$/)) {
        e.preventDefault();
        document.querySelector('button[type="submit"]').click();
    }
});

// Auto-refresh page every 5 minutes for live updates
setTimeout(function() {
    location.reload();
}, 300000); // 5 minutes

// Add visual feedback for success
<?php if($success): ?>
    document.querySelector('.balance-animation').addEventListener('animationend', function() {
        this.classList.remove('balance-animation');
    });
<?php endif; ?>
</script>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\closing.php
==============================================================================

<?php 
require 'includes/header.php'; 

// ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

// 1. GET EXPECTED SYSTEM BALANCE
$stmt = $pdo->prepare("SELECT current_balance FROM accounts WHERE account_name = 'Shop Cash Drawer'");
$stmt->execute();
$system_balance = (float) $stmt->fetchColumn();

// 2. HANDLE FORM SUBMISSION
$msg = "";
$difference = 0;
$physical_cash = 0;
$show_result = false;

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    // Calculate Physical Cash based on Denominations
    $n5000 = (int)$_POST['n5000'] * 5000;
    $n1000 = (int)$_POST['n1000'] * 1000;
    $n500  = (int)$_POST['n500'] * 500;
    $n100  = (int)$_POST['n100'] * 100;
    $n50   = (int)$_POST['n50'] * 50;
    $n20   = (int)$_POST['n20'] * 20;
    $n10   = (int)$_POST['n10'] * 10;
    $coins = (float)$_POST['coins'];
    
    $physical_cash = $n5000 + $n1000 + $n500 + $n100 + $n50 + $n20 + $n10 + $coins;
    
    // Calculate Difference
    $difference = $physical_cash - $system_balance;
    $show_result = true;
    
    // Log the Closing Event
    $log_details = "Day Closing: System (Rs. $system_balance) vs Physical (Rs. $physical_cash). Difference: Rs. $difference";
    
    try {
        $stmt = $pdo->prepare("INSERT INTO system_logs (user_id, action, details, ip_address) VALUES (?, 'Day Closing', ?, ?)");
        $stmt->execute([$_SESSION['user_id'], $log_details, $_SERVER['REMOTE_ADDR']]);
    } catch (Exception $e) {
        // Silently fail logging if error
    }
}
?>

<div class="row justify-content-center">
    <div class="col-md-8">
        <h3 class="fw-bold mb-4 text-center text-dark">
            <i class="fas fa-lock text-warning me-2"></i> Day Closing & Cash Count
        </h3>
        
        <?php if ($show_result): ?>
            <div class="glass-panel p-5 mb-4 text-center border-top border-5 <?php echo ($difference >= 0) ? 'border-success' : 'border-danger'; ?> bg-white shadow">
                <h5 class="text-muted text-uppercase fw-bold mb-4">Closing Summary</h5>
                
                <div class="row g-4">
                    <div class="col-md-4">
                        <small class="text-muted d-block fw-bold">System Balance</small>
                        <h3 class="fw-bold text-dark mt-2">Rs. <?php echo number_format($system_balance); ?></h3>
                    </div>
                    <div class="col-md-4 border-start border-end">
                        <small class="text-muted d-block fw-bold">Physical Cash</small>
                        <h3 class="fw-bold text-primary mt-2">Rs. <?php echo number_format($physical_cash); ?></h3>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block fw-bold">Difference</small>
                        <h3 class="fw-bold <?php echo ($difference >= 0) ? 'text-success' : 'text-danger'; ?> mt-2">
                            <?php echo ($difference > 0) ? "+" : ""; ?>
                            <?php echo number_format($difference); ?>
                        </h3>
                    </div>
                </div>
                
                <div class="mt-5">
                    <?php if ($difference == 0): ?>
                        <div class="alert alert-success fw-bold py-3">
                            <i class="fas fa-check-circle me-2"></i> Cash Matched Perfectly! Great Job.
                        </div>
                    <?php elseif ($difference < 0): ?>
                        <div class="alert alert-danger fw-bold py-3">
                            <i class="fas fa-exclamation-triangle me-2"></i> Cash Shortage! You are missing money.
                        </div>
                    <?php else: ?>
                        <div class="alert alert-info fw-bold py-3">
                            <i class="fas fa-info-circle me-2"></i> Cash Excess! You have extra money.
                        </div>
                    <?php endif; ?>
                </div>
                
                <a href="dashboard.php" class="btn btn-dark btn-lg px-5 mt-3 rounded-pill fw-bold">Return to Dashboard</a>
            </div>
        <?php else: ?>

            <div class="glass-panel p-4 bg-white shadow-sm">
                <div class="alert alert-info text-center fw-bold mb-4">
                    <i class="fas fa-info-circle me-2"></i> The System expects: Rs. <?php echo number_format($system_balance); ?>
                </div>
                
                <form method="POST">
                    <div class="row g-3">
                        <div class="col-6 col-md-4">
                            <label class="small fw-bold text-muted">5000 Notes</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold">x</span>
                                <input type="number" name="n5000" class="form-control fw-bold" placeholder="0">
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small fw-bold text-muted">1000 Notes</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold">x</span>
                                <input type="number" name="n1000" class="form-control fw-bold" placeholder="0">
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small fw-bold text-muted">500 Notes</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold">x</span>
                                <input type="number" name="n500" class="form-control fw-bold" placeholder="0">
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small fw-bold text-muted">100 Notes</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold">x</span>
                                <input type="number" name="n100" class="form-control fw-bold" placeholder="0">
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small fw-bold text-muted">50 Notes</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold">x</span>
                                <input type="number" name="n50" class="form-control fw-bold" placeholder="0">
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small fw-bold text-muted">20 Notes</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold">x</span>
                                <input type="number" name="n20" class="form-control fw-bold" placeholder="0">
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small fw-bold text-muted">10 Notes</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold">x</span>
                                <input type="number" name="n10" class="form-control fw-bold" placeholder="0">
                            </div>
                        </div>
                        <div class="col-6 col-md-8">
                            <label class="small fw-bold text-muted">Loose Coins / Change</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold">Rs.</span>
                                <input type="number" name="coins" class="form-control fw-bold" placeholder="Total Value">
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <button class="btn btn-warning w-100 btn-lg fw-bold text-dark rounded-pill shadow-sm">
                        <i class="fas fa-calculator me-2"></i> CALCULATE & CLOSE
                    </button>
                </form>
            </div>
        <?php endif; ?>
    </div>
</div>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\contacts.php
==============================================================================

<?php 
// 1. ENABLE ERROR REPORTING
error_reporting(E_ALL);
ini_set('display_errors', 1);

require 'includes/header.php'; 

// 2. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

// Master Admin List (IDs from your SQL Dump)
$allowed_ids = [1, 14, 15]; 
$is_admin = false;

if (in_array($_SESSION['user_id'], $allowed_ids)) {
    $is_admin = true;
} elseif (isset($_SESSION['role']) && strtolower($_SESSION['role']) === 'admin') {
    $is_admin = true;
}

if (!$is_admin) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED: Only Admins can manage contacts.</div></div>");
}

// 3. HANDLE FORM ACTIONS
$msg = "";
$error = "";

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    
    // A. ADD OR EDIT CONTACT
    if (isset($_POST['save_contact'])) {
        $id = $_POST['contact_id'];
        $name = trim($_POST['name']);
        $phone = $_POST['phone'];
        $addr = $_POST['address'];
        $type = $_POST['type']; // 'given' (Customer) or 'taken' (Supplier)
        $initial_balance = $_POST['initial_balance']; 

        // Validate
        if (empty($name)) {
            $error = "Name is required.";
        } else {
            try {
                if ($id) {
                    // Update Existing Contact
                    // Note: We do NOT update initial_balance on edit to prevent messing up ledgers
                    $stmt = $pdo->prepare("UPDATE loans SET person_name=?, phone=?, address=?, type=? WHERE id=?");
                    $stmt->execute([$name, $phone, $addr, $type, $id]);
                    $msg = "Contact details updated successfully!";
                } else {
                    // Create New Contact
                    $stmt = $pdo->prepare("INSERT INTO loans (person_name, phone, address, type, total_amount, paid_amount, status) VALUES (?, ?, ?, ?, ?, 0, 'active')");
                    // Initial balance goes into 'total_amount' (Debt)
                    $stmt->execute([$name, $phone, $addr, $type, $initial_balance]);
                    $msg = "New Contact added successfully!";
                }
            } catch (PDOException $e) {
                $error = "Database Error: " . $e->getMessage();
            }
        }
    }

    // B. DELETE CONTACT
    if (isset($_POST['delete_contact'])) {
        $id = $_POST['delete_id'];
        try {
            $pdo->prepare("DELETE FROM loans WHERE id=?")->execute([$id]);
            $msg = "Contact deleted permanently.";
        } catch (PDOException $e) {
            $error = "Could not delete contact: " . $e->getMessage();
        }
    }

    // C. RECORD PAYMENT (Receive Money OR Pay Money)
    if (isset($_POST['add_payment'])) {
        $id = $_POST['pay_id'];
        $amount = $_POST['amount'];
        $note = $_POST['note'];
        
        if ($amount > 0) {
            try {
                // 1. Fetch Contact Info to know if it's Customer or Supplier
                $stmt = $pdo->prepare("SELECT * FROM loans WHERE id = ?");
                $stmt->execute([$id]);
                $contact = $stmt->fetch();

                if ($contact) {
                    // 2. Update Loan Record (Increase 'paid_amount')
                    $pdo->prepare("UPDATE loans SET paid_amount = paid_amount + ? WHERE id=?")->execute([$amount, $id]);
                    
                    // 3. Ledger Logic
                    // If type is 'given' (Customer), we received money -> Income
                    // If type is 'taken' (Supplier), we paid money -> Expense
                    $ledger_type = ($contact['type'] == 'given') ? 'income' : 'expense'; 
                    $description = "Payment: " . $contact['person_name'] . " - " . $note;
                    
                    $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head) VALUES (CURDATE(), ?, 'Payment', ?, ?, 'Cash', 'Shop Cash Drawer')");
                    $stmt->execute([$ledger_type, $description, $amount]);
                    
                    // 4. Update Cash Drawer Balance
                    if ($ledger_type == 'income') {
                        $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ? WHERE account_name='Shop Cash Drawer'")->execute([$amount]);
                    } else {
                        $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name='Shop Cash Drawer'")->execute([$amount]);
                    }
                    $msg = "Payment of Rs. $amount recorded successfully!";
                }
            } catch (PDOException $e) {
                $error = "Payment Error: " . $e->getMessage();
            }
        } else {
            $error = "Please enter a valid amount.";
        }
    }
}

// 4. FETCH DATA
$customers = $pdo->query("SELECT * FROM loans WHERE type='given' ORDER BY person_name ASC")->fetchAll();
$suppliers = $pdo->query("SELECT * FROM loans WHERE type='taken' ORDER BY person_name ASC")->fetchAll();
?>

<div class="row mb-4">
    <div class="col-md-6">
        <h3 class="fw-bold"><i class="fas fa-address-book text-primary"></i> Contact Manager</h3>
        <p class="text-muted">Manage Customers (Receivables) and Suppliers (Payables)</p>
    </div>
    <div class="col-md-6 text-md-end">
        <button class="btn btn-success rounded-pill fw-bold px-4 shadow me-2" onclick="openModal('given')">
            <i class="fas fa-user-plus me-2"></i> Add Customer
        </button>
        <button class="btn btn-warning rounded-pill fw-bold px-4 shadow" onclick="openModal('taken')">
            <i class="fas fa-truck me-2"></i> Add Supplier
        </button>
    </div>
</div>

<?php if($msg): ?>
    <div class="alert alert-success fw-bold shadow-sm border-0"><i class="fas fa-check-circle me-2"></i> <?php echo $msg; ?></div>
<?php endif; ?>
<?php if($error): ?>
    <div class="alert alert-danger fw-bold shadow-sm border-0"><i class="fas fa-exclamation-triangle me-2"></i> <?php echo $error; ?></div>
<?php endif; ?>

<ul class="nav nav-tabs mb-3 border-bottom-0" id="myTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active fw-bold border" id="cust-tab" data-bs-toggle="tab" data-bs-target="#cust" type="button">
            <i class="fas fa-users me-2"></i> Customers (Receivables)
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold border ms-2" id="sup-tab" data-bs-toggle="tab" data-bs-target="#sup" type="button">
            <i class="fas fa-building me-2"></i> Suppliers (Payables)
        </button>
    </li>
</ul>

<div class="tab-content glass-panel p-0 overflow-hidden">
    
    <div class="tab-pane fade show active" id="cust">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-dark text-white">
                    <tr>
                        <th class="ps-4">Name</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Balance Due</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach($customers as $c): 
                        $bal = $c['total_amount'] - $c['paid_amount']; ?>
                    <tr>
                        <td class="ps-4 fw-bold"><?php echo htmlspecialchars($c['person_name']); ?></td>
                        <td><?php echo htmlspecialchars($c['phone']); ?></td>
                        <td class="small text-muted"><?php echo htmlspecialchars($c['address']); ?></td>
                        <td>
                            <?php if($bal > 0): ?>
                                <span class="badge bg-danger fs-6">Rs. <?php echo number_format($bal); ?></span>
                            <?php else: ?>
                                <span class="badge bg-success">Cleared</span>
                            <?php endif; ?>
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-success fw-bold me-1" onclick='payModal(<?php echo json_encode($c); ?>)'>Receive Pay</button>
                            <button class="btn btn-sm btn-outline-primary" onclick='editContact(<?php echo json_encode($c); ?>)'>Edit</button>
                            <form method="POST" class="d-inline" onsubmit="return confirm('Delete this contact permanently?');">
                                <input type="hidden" name="delete_contact" value="1">
                                <input type="hidden" name="delete_id" value="<?php echo $c['id']; ?>">
                                <button class="btn btn-sm btn-outline-danger ms-1"><i class="fas fa-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade" id="sup">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-dark text-white">
                    <tr>
                        <th class="ps-4">Name</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>We Owe</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach($suppliers as $s): 
                        $bal = $s['total_amount'] - $s['paid_amount']; ?>
                    <tr>
                        <td class="ps-4 fw-bold"><?php echo htmlspecialchars($s['person_name']); ?></td>
                        <td><?php echo htmlspecialchars($s['phone']); ?></td>
                        <td class="small text-muted"><?php echo htmlspecialchars($s['address']); ?></td>
                        <td>
                            <?php if($bal > 0): ?>
                                <span class="badge bg-danger fs-6">Rs. <?php echo number_format($bal); ?></span>
                            <?php else: ?>
                                <span class="badge bg-success">Cleared</span>
                            <?php endif; ?>
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-warning fw-bold me-1" onclick='payModal(<?php echo json_encode($s); ?>)'>Pay Supplier</button>
                            <button class="btn btn-sm btn-outline-primary" onclick='editContact(<?php echo json_encode($s); ?>)'>Edit</button>
                            <form method="POST" class="d-inline" onsubmit="return confirm('Delete this contact permanently?');">
                                <input type="hidden" name="delete_contact" value="1">
                                <input type="hidden" name="delete_id" value="<?php echo $s['id']; ?>">
                                <button class="btn btn-sm btn-outline-danger ms-1"><i class="fas fa-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="contactModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold" id="mTitle">Add Contact</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST">
                    <input type="hidden" name="save_contact" value="1">
                    <input type="hidden" name="contact_id" id="c_id">
                    <input type="hidden" name="type" id="c_type">
                    
                    <div class="mb-3">
                        <label class="fw-bold small">Name / Business Name</label>
                        <input type="text" name="name" id="c_name" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="fw-bold small">Phone</label>
                            <input type="text" name="phone" id="c_phone" class="form-control">
                        </div>
                        <div class="col-6">
                            <label class="fw-bold small">Opening Balance (Due)</label>
                            <input type="number" name="initial_balance" id="c_bal" class="form-control" value="0">
                            <small class="text-muted">Enter current debt if any</small>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="fw-bold small">Address</label>
                        <input type="text" name="address" id="c_addr" class="form-control">
                    </div>
                    
                    <button class="btn btn-primary w-100 fw-bold rounded-pill">Save Contact</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="payModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">Record Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST">
                    <input type="hidden" name="add_payment" value="1">
                    <input type="hidden" name="pay_id" id="p_id">
                    
                    <div class="text-center mb-4">
                        <h4 class="fw-bold" id="p_name"></h4>
                        <small class="text-muted">Enter the amount transacted</small>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-success">Amount</label>
                        <input type="number" name="amount" class="form-control form-control-lg fw-bold border-success" required>
                    </div>
                    <div class="mb-4">
                        <label class="fw-bold small">Note</label>
                        <input type="text" name="note" class="form-control" placeholder="e.g. Cash Handover, Bank Transfer">
                    </div>
                    <button class="btn btn-success w-100 fw-bold rounded-pill">Confirm Payment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
var cModal = new bootstrap.Modal(document.getElementById('contactModal'));
var pModal = new bootstrap.Modal(document.getElementById('payModal'));

function openModal(type) {
    // Clear fields
    document.getElementById('c_id').value = '';
    document.getElementById('c_name').value = '';
    document.getElementById('c_phone').value = '';
    document.getElementById('c_addr').value = '';
    document.getElementById('c_bal').value = '0';
    document.getElementById('c_bal').disabled = false; // Enable for new
    document.getElementById('c_type').value = type;
    
    // Set Title
    document.getElementById('mTitle').innerText = (type=='given') ? "Add New Customer" : "Add New Supplier";
    cModal.show();
}

function editContact(c) {
    // Fill fields
    document.getElementById('c_id').value = c.id;
    document.getElementById('c_name').value = c.person_name;
    document.getElementById('c_phone').value = c.phone;
    document.getElementById('c_addr').value = c.address;
    document.getElementById('c_type').value = c.type;
    document.getElementById('c_bal').value = c.total_amount; 
    document.getElementById('c_bal').disabled = true; // Protect balance from edit, force payment instead
    document.getElementById('mTitle').innerText = "Edit Contact";
    cModal.show();
}

function payModal(c) {
    document.getElementById('p_id').value = c.id;
    document.getElementById('p_name').innerText = c.person_name;
    pModal.show();
}
</script>
<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\dashboard.php
==============================================================================

<?php
// 1. ENABLE ERROR REPORTING (But hide Deprecation warnings to be safe)
error_reporting(E_ALL & ~E_DEPRECATED);
ini_set('display_errors', 1);

require 'includes/header.php';

// 2. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

// 3. DETERMINE USER ROLE AND PERMISSIONS
$user_id = $_SESSION['user_id'];
$user_role = strtolower($_SESSION['role'] ?? 'staff');
$username = htmlspecialchars($_SESSION['username']);

// Check if admin (by ID or role)
$admin_ids = [1, 14, 15];
$is_admin = (in_array($user_id, $admin_ids) || $user_role === 'admin');
$is_staff = !$is_admin;

// Get user permissions
$permissions = $_SESSION['permissions'] ?? [];
$has_shop_access = isset($permissions['shop']) && $permissions['shop'] == 1;
$has_bisp_access = isset($permissions['bisp']) && $permissions['bisp'] == 1;
$has_loans_access = isset($permissions['loans']) && $permissions['loans'] == 1;
$has_closing_access = isset($permissions['closing']) && $permissions['closing'] == 1;
$has_hbl_access = isset($permissions['hbl']) && $permissions['hbl'] == 1;

// 4. FETCH METRICS (FIXED NULL ISSUES)
// A. CASH IN HAND
$stmt = $pdo->prepare("SELECT current_balance FROM accounts WHERE account_name = 'Shop Cash Drawer'");
$stmt->execute();
$cash_hand = (float) $stmt->fetchColumn();

// B. RECEIVABLES (Money people owe YOU)
$stmt = $pdo->query("SELECT SUM(total_amount - paid_amount) FROM loans WHERE type = 'given' OR loan_category = 'installment'");
$receivables = (float) $stmt->fetchColumn();

// C. PAYABLES (Money YOU owe)
$stmt = $pdo->query("SELECT SUM(total_amount - paid_amount) FROM loans WHERE type = 'taken' OR loan_category = 'bank'");
$payables = (float) $stmt->fetchColumn();

// D. STOCK VALUE
$stmt = $pdo->query("SELECT SUM(stock_qty * purchase_price) FROM inventory WHERE stock_qty > 0");
$stock_val = (float) $stmt->fetchColumn();

// E. TODAY'S SALES
$today_sale = $pdo->query("SELECT SUM(amount) FROM finance_ledger WHERE type = 'sale' AND DATE(trans_date) = CURDATE()")->fetchColumn();
$today_sale = (float) $today_sale;

// F. TODAY'S BILL COLLECTION
$today_bills = $pdo->query("SELECT SUM(amount) FROM bill_queue WHERE DATE(created_at) = CURDATE() AND payment_status='cash'")->fetchColumn();
$today_bills = (float) $today_bills;

// G. TODAY'S EXPENSES
$today_expenses = $pdo->query("SELECT SUM(amount) FROM finance_ledger WHERE type = 'expense' AND DATE(trans_date) = CURDATE() AND category NOT IN ('Loan Repayment')")->fetchColumn();
$today_expenses = (float) $today_expenses;

// H. TOTAL CUSTOMERS
$total_customers = $pdo->query("SELECT COUNT(*) FROM loans WHERE type='given'")->fetchColumn();

// I. TOTAL SUPPLIERS
$total_suppliers = $pdo->query("SELECT COUNT(*) FROM loans WHERE type='taken'")->fetchColumn();

// J. LOW STOCK ALERTS
$stmt = $pdo->query("SELECT * FROM inventory WHERE stock_qty < 5 AND stock_qty > -1 ORDER BY stock_qty ASC LIMIT 5");
$low_stock = $stmt->fetchAll();

// K. RECENT ACTIVITY (limit based on role)
$limit = $is_admin ? 10 : 5;
$recent = $pdo->query("SELECT * FROM finance_ledger ORDER BY id DESC LIMIT $limit")->fetchAll();

// L. PENDING BILLS
$pending_bills = $pdo->query("SELECT COUNT(*) FROM bill_queue WHERE status='pending'")->fetchColumn();

// M. ACTIVE LOANS (Installments)
$active_loans = $pdo->query("SELECT COUNT(*) FROM loans WHERE loan_category='installment' AND status='active'")->fetchColumn();

// N. NET PROFIT TODAY (Sales - Expenses)
$net_profit_today = $today_sale - $today_expenses;

// O. BVS BALANCE
$bvs_balance = $pdo->query("SELECT current_balance FROM accounts WHERE account_name = 'HBL Konnect BVS'")->fetchColumn();
$bvs_balance = (float) $bvs_balance;

// 5. CHART DATA FOR ADMIN (Last 7 days)
$chart_data = [];
if ($is_admin) {
    $stmt = $pdo->query("
        SELECT DATE(trans_date) as date, 
               SUM(CASE WHEN type IN ('sale', 'income') THEN amount ELSE 0 END) as income,
               SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as expense
        FROM finance_ledger 
        WHERE trans_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
        GROUP BY DATE(trans_date)
        ORDER BY date ASC
    ");
    $chart_data = $stmt->fetchAll();
}

// 6. TOP CUSTOMERS (for admin)
$top_customers = [];
if ($is_admin) {
    $stmt = $pdo->query("
        SELECT person_name, (total_amount - paid_amount) as balance_due
        FROM loans 
        WHERE type='given' 
        HAVING balance_due > 0
        ORDER BY balance_due DESC 
        LIMIT 5
    ");
    $top_customers = $stmt->fetchAll();
}

// 7. TOP SELLING PRODUCTS
$top_products = [];
if ($has_shop_access || $is_admin) {
    $stmt = $pdo->query("
        SELECT description, COUNT(*) as count, SUM(amount) as revenue
        FROM finance_ledger 
        WHERE type='sale' 
        AND DATE(trans_date) = CURDATE()
        GROUP BY description 
        ORDER BY revenue DESC 
        LIMIT 5
    ");
    $top_products = $stmt->fetchAll();
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ARHAM ERP</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* ===== CUSTOM STYLES ===== */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #1abc9c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-danger: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            --gradient-warning: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        /* ===== GLASS EFFECT ===== */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: var(--shadow);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.25);
        }

        /* ===== METRIC CARDS ===== */
        .metric-card {
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 25px;
            border-radius: 20px;
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            z-index: 1;
        }

        .metric-card i {
            position: absolute;
            right: 20px;
            bottom: 20px;
            font-size: 60px;
            opacity: 0.2;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .metric-card:hover i {
            transform: scale(1.2) rotate(5deg);
            opacity: 0.3;
        }

        .metric-card-content {
            position: relative;
            z-index: 2;
        }

        .metric-title {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-trend {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-btn {
            height: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            background: white;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            color: white;
        }

        .action-btn i {
            font-size: 32px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .action-btn:hover i {
            transform: scale(1.2);
        }

        .action-label {
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }

        /* ===== BADGES ===== */
        .badge-custom {
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .metric-card {
                min-height: 120px;
                padding: 20px;
            }
            
            .metric-value {
                font-size: 1.8rem;
            }
            
            .action-btn {
                height: 90px;
            }
            
            .action-btn i {
                font-size: 24px;
            }
        }

        /* ===== CHART CONTAINER ===== */
        .chart-container {
            height: 300px;
            position: relative;
        }

        /* ===== USER PROFILE ===== */
        .user-profile-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .user-profile-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        /* ===== PERMISSION INDICATORS ===== */
        .permission-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .permission-badge.active {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .permission-badge.inactive {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        /* ===== TAB STYLES ===== */
        .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: #6c757d;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            border-color: rgba(44, 62, 80, 0.3);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: transparent;
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* ===== NOTIFICATION BELL ===== */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-bell .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            padding: 3px 6px;
            font-size: 10px;
        }

        /* ===== LOADING ANIMATION ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== DASHBOARD HEADER ===== */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.1)" fill-opacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,192C672,181,768,139,864,138.7C960,139,1056,181,1152,197.3C1248,213,1344,203,1392,197.3L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
            background-position: bottom;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .greeting {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .greeting-time {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        /* ===== ROLE BADGE ===== */
        .role-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .role-badge.admin {
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: white;
        }

        .role-badge.staff {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
        }

        /* ===== WELCOME MESSAGE ===== */
        .welcome-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .welcome-card h3 {
            font-weight: 700;
            margin-bottom: 10px;
        }

        .welcome-card p {
            opacity: 0.9;
            margin-bottom: 0;
        }

        /* ===== QUICK STATS ===== */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== DASHBOARD SECTIONS ===== */
        .dashboard-section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        /* ===== TABLE STYLES ===== */
        .dashboard-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .dashboard-table .table {
            margin-bottom: 0;
        }

        .dashboard-table th {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 20px;
            font-weight: 600;
        }

        .dashboard-table td {
            padding: 15px 20px;
            vertical-align: middle;
            border-color: #f0f0f0;
        }

        .dashboard-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* ===== PROGRESS BARS ===== */
        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }

        .progress-custom .progress-bar {
            border-radius: 4px;
        }

        /* ===== TOOLTIPS ===== */
        .custom-tooltip {
            position: relative;
            cursor: help;
        }

        .custom-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .custom-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 10px);
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container-fluid py-4">
        <!-- Dashboard Header -->
        <div class="dashboard-header animate__animated animate__fadeInDown">
            <div class="header-content">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="greeting">
                            <?php 
                                $hour = date('H');
                                if ($hour < 12) echo "Good Morning";
                                elseif ($hour < 17) echo "Good Afternoon";
                                else echo "Good Evening";
                            ?>, <?php echo $username; ?>!
                        </h1>
                        <p class="greeting-time mb-0">
                            <i class="fas fa-calendar-alt me-2"></i><?php echo date('l, F j, Y'); ?>
                            <i class="fas fa-clock ms-4 me-2"></i><?php echo date('h:i A'); ?>
                        </p>
                    </div>
                    <div class="text-end">
                        <span class="role-badge <?php echo $is_admin ? 'admin' : 'staff'; ?>">
                            <i class="fas fa-<?php echo $is_admin ? 'crown' : 'user-tie'; ?> me-2"></i>
                            <?php echo $is_admin ? 'Administrator' : 'Staff Member'; ?>
                        </span>
                        <div class="mt-2">
                            <small class="opacity-75">
                                <i class="fas fa-id-card me-1"></i> ID: <?php echo $user_id; ?>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role-based Welcome Message -->
        <div class="welcome-card animate__animated animate__fadeInUp">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3>
                        <?php if($is_admin): ?>
                            <i class="fas fa-chart-line me-2"></i>Complete Business Overview
                        <?php else: ?>
                            <i class="fas fa-tasks me-2"></i>Your Assigned Tasks
                        <?php endif; ?>
                    </h3>
                    <p>
                        <?php if($is_admin): ?>
                            You have full access to all system modules. Monitor performance, manage finances, and oversee operations.
                        <?php else: ?>
                            You can access modules assigned by administrator. Contact admin for additional permissions.
                        <?php endif; ?>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="notification-bell">
                        <i class="fas fa-bell fa-2x float-animation"></i>
                        <?php if($pending_bills > 0): ?>
                            <span class="badge bg-danger rounded-pill"><?php echo $pending_bills; ?></span>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-tachometer-alt me-2"></i>Quick Overview
                </h2>
                <div class="section-actions">
                    <?php if($has_closing_access || $is_admin): ?>
                        <a href="closing.php" class="btn btn-warning btn-sm">
                            <i class="fas fa-lock me-1"></i> Day Closing
                        </a>
                    <?php endif; ?>
                    <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="quick-stats">
                <div class="stat-item">
                    <div class="stat-icon" style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white;">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value text-success">Rs. <?php echo number_format($cash_hand); ?></div>
                        <div class="stat-label">Cash in Hand</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon" style="background: linear-gradient(45deg, #3498db, #2980b9); color: white;">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value text-primary">Rs. <?php echo number_format($today_sale + $today_bills); ?></div>
                        <div class="stat-label">Today's Collection</div>
                    </div>
                </div>

                <?php if($is_admin): ?>
                <div class="stat-item">
                    <div class="stat-icon" style="background: linear-gradient(45deg, #e74c3c, #c0392b); color: white;">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value text-danger">Rs. <?php echo number_format($receivables); ?></div>
                        <div class="stat-label">Receivables</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon" style="background: linear-gradient(45deg, #f39c12, #d35400); color: white;">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value text-warning">Rs. <?php echo number_format($stock_val); ?></div>
                        <div class="stat-label">Stock Value</div>
                    </div>
                </div>
                <?php endif; ?>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="row">
            <!-- Left Column: Metrics & Quick Actions -->
            <div class="col-lg-8">
                <!-- Quick Actions Grid -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-rocket me-2"></i>Quick Actions
                        </h2>
                        <div class="section-actions">
                            <span class="badge bg-info"><?php echo count($permissions); ?> Permissions</span>
                        </div>
                    </div>

                    <div class="row g-3">
                        <!-- Always show basic actions -->
                        <div class="col-md-3 col-6">
                            <a href="shop_pos.php" class="action-btn" 
                               style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white;">
                                <i class="fas fa-cash-register"></i>
                                <span class="action-label">New Sale</span>
                            </a>
                        </div>

                        <div class="col-md-3 col-6">
                            <a href="bills.php" class="action-btn"
                               style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <span class="action-label">Add Bill</span>
                            </a>
                        </div>

                        <!-- Role-based actions -->
                        <?php if($has_bisp_access || $is_admin): ?>
                        <div class="col-md-3 col-6">
                            <a href="payout.php" class="action-btn"
                               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <i class="fas fa-hand-holding-usd"></i>
                                <span class="action-label">BISP Payout</span>
                            </a>
                        </div>
                        <?php endif; ?>

                        <?php if($has_shop_access || $is_admin): ?>
                        <div class="col-md-3 col-6">
                            <a href="inventory.php" class="action-btn"
                               style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: #333;">
                                <i class="fas fa-boxes"></i>
                                <span class="action-label">Inventory</span>
                            </a>
                        </div>
                        <?php endif; ?>

                        <?php if($is_admin): ?>
                        <div class="col-md-3 col-6">
                            <a href="financial_reports.php" class="action-btn"
                               style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;">
                                <i class="fas fa-chart-bar"></i>
                                <span class="action-label">Reports</span>
                            </a>
                        </div>

                        <div class="col-md-3 col-6">
                            <a href="contacts.php" class="action-btn"
                               style="background: linear-gradient(135deg, #5ee7df 0%, #b490ca 100%); color: #333;">
                                <i class="fas fa-address-book"></i>
                                <span class="action-label">Contacts</span>
                            </a>
                        </div>
                        <?php endif; ?>

                        <?php if($has_loans_access || $is_admin): ?>
                        <div class="col-md-3 col-6">
                            <a href="loans.php" class="action-btn"
                               style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); color: #333;">
                                <i class="fas fa-hand-holding-usd"></i>
                                <span class="action-label">Loans</span>
                            </a>
                        </div>
                        <?php endif; ?>

                        <?php if($has_hbl_access || $is_admin): ?>
                        <div class="col-md-3 col-6">
                            <a href="bvs_balance.php" class="action-btn"
                               style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                <i class="fas fa-wallet"></i>
                                <span class="action-label">BVS Balance</span>
                            </a>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-history me-2"></i>Recent Activity
                        </h2>
                        <div class="section-actions">
                            <a href="financial_reports.php" class="btn btn-sm btn-outline-primary">
                                View Full Ledger <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>

                    <div class="dashboard-table">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php if(count($recent) > 0): ?>
                                        <?php foreach($recent as $r): 
                                            $is_in = in_array($r['type'], ['sale','income','loan_return']);
                                            $cls = $is_in ? 'text-success' : 'text-danger';
                                            $icon = $is_in ? 'fa-arrow-down text-success' : 'fa-arrow-up text-danger';
                                            $bg = $is_in ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10';
                                        ?>
                                        <tr>
                                            <td class="text-muted small">
                                                <?php echo date('h:i A', strtotime($r['trans_date'])); ?>
                                            </td>
                                            <td>
                                                <div class="fw-bold"><?php echo htmlspecialchars($r['description']); ?></div>
                                                <small class="text-muted">
                                                    <?php echo date('d M', strtotime($r['trans_date'])); ?>
                                                </small>
                                            </td>
                                            <td>
                                                <span class="badge <?php echo $bg; ?> text-dark">
                                                    <?php echo strtoupper($r['category']); ?>
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold <?php echo $cls; ?>">
                                                <i class="fas <?php echo $icon; ?> me-1"></i>
                                                Rs. <?php echo number_format($r['amount']); ?>
                                            </td>
                                        </tr>
                                        <?php endforeach; ?>
                                    <?php else: ?>
                                        <tr>
                                            <td colspan="4" class="text-center py-4 text-muted">
                                                <i class="fas fa-inbox fa-2x mb-3"></i><br>
                                                No recent activity
                                            </td>
                                        </tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin-only: Charts -->
                <?php if($is_admin && !empty($chart_data)): ?>
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-chart-line me-2"></i>7-Day Financial Trend
                        </h2>
                        <div class="section-actions">
                            <select class="form-select form-select-sm w-auto" onchange="updateChart(this.value)">
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                            </select>
                        </div>
                    </div>

                    <div class="glass-panel p-3">
                        <div class="chart-container">
                            <canvas id="financialChart"></canvas>
                        </div>
                    </div>
                </div>
                <?php endif; ?>
            </div>

            <!-- Right Column: Alerts, Stats, Permissions -->
            <div class="col-lg-4">
                <!-- User Profile Card -->
                <div class="user-profile-card p-4 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            <div class="rounded-circle bg-white p-3" style="width: 70px; height: 70px;">
                                <i class="fas fa-user fa-2x text-primary"></i>
                            </div>
                        </div>
                        <div>
                            <h4 class="mb-1"><?php echo $username; ?></h4>
                            <div class="d-flex align-items-center gap-2">
                                <span class="role-badge <?php echo $is_admin ? 'admin' : 'staff'; ?>">
                                    <?php echo $is_admin ? 'Administrator' : 'Staff'; ?>
                                </span>
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-clock me-1"></i>
                                    <?php echo date('h:i A'); ?>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6 border-end border-white-50">
                            <small class="opacity-75">Session</small>
                            <div class="fw-bold">Active</div>
                        </div>
                        <div class="col-6">
                            <small class="opacity-75">IP Address</small>
                            <div class="fw-bold"><?php echo $_SERVER['REMOTE_ADDR']; ?></div>
                        </div>
                    </div>
                </div>

                <!-- Permissions Panel (for staff) -->
                <?php if(!$is_admin): ?>
                <div class="glass-panel p-4 mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-key me-2"></i>Your Permissions
                    </h5>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="permission-badge <?php echo $has_shop_access ? 'active' : 'inactive'; ?>">
                            <i class="fas fa-<?php echo $has_shop_access ? 'check' : 'times'; ?>"></i>
                            Shop Access
                        </span>
                        <span class="permission-badge <?php echo $has_bisp_access ? 'active' : 'inactive'; ?>">
                            <i class="fas fa-<?php echo $has_bisp_access ? 'check' : 'times'; ?>"></i>
                            BISP Access
                        </span>
                        <span class="permission-badge <?php echo $has_loans_access ? 'active' : 'inactive'; ?>">
                            <i class="fas fa-<?php echo $has_loans_access ? 'check' : 'times'; ?>"></i>
                            Loans Access
                        </span>
                        <span class="permission-badge <?php echo $has_closing_access ? 'active' : 'inactive'; ?>">
                            <i class="fas fa-<?php echo $has_closing_access ? 'check' : 'times'; ?>"></i>
                            Closing Access
                        </span>
                        <span class="permission-badge <?php echo $has_hbl_access ? 'active' : 'inactive'; ?>">
                            <i class="fas fa-<?php echo $has_hbl_access ? 'check' : 'times'; ?>"></i>
                            HBL Access
                        </span>
                    </div>
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Contact administrator for permission changes
                        </small>
                    </div>
                </div>
                <?php endif; ?>

                <!-- Low Stock Alerts -->
                <?php if($has_shop_access || $is_admin): ?>
                <div class="glass-panel p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>Low Stock Alerts
                        </h5>
                        <span class="badge bg-danger"><?php echo count($low_stock); ?></span>
                    </div>
                    
                    <?php if(count($low_stock) > 0): ?>
                        <div class="list-group list-group-flush">
                            <?php foreach($low_stock as $ls): ?>
                            <div class="list-group-item px-0 border-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold"><?php echo htmlspecialchars($ls['item_name']); ?></div>
                                        <small class="text-muted">Stock: <?php echo $ls['stock_qty']; ?> units</small>
                                    </div>
                                    <a href="purchases.php" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-plus"></i> Restock
                                    </a>
                                </div>
                                <div class="progress-custom mt-2">
                                    <div class="progress-bar bg-danger" 
                                         style="width: <?php echo min(($ls['stock_qty'] / 5) * 100, 100); ?>%"></div>
                                </div>
                            </div>
                            <?php endforeach; ?>
                        </div>
                    <?php else: ?>
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <p class="mb-0">Inventory levels are good</p>
                        </div>
                    <?php endif; ?>
                    
                    <div class="text-center mt-3">
                        <a href="inventory.php" class="text-decoration-none small">
                            <i class="fas fa-arrow-right me-1"></i> View Full Inventory
                        </a>
                    </div>
                </div>
                <?php endif; ?>

                <!-- Top Products (Shop Access Only) -->
                <?php if(($has_shop_access || $is_admin) && !empty($top_products)): ?>
                <div class="glass-panel p-4 mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-chart-bar text-primary me-2"></i>Today's Top Products
                    </h5>
                    <div class="list-group list-group-flush">
                        <?php foreach($top_products as $index => $product): ?>
                        <div class="list-group-item px-0 border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-primary me-2">#<?php echo $index + 1; ?></span>
                                    <div>
                                        <div class="fw-bold"><?php echo htmlspecialchars(substr($product['description'], 0, 30)); ?></div>
                                        <small class="text-muted">Sold: <?php echo $product['count']; ?> times</small>
                                    </div>
                                </div>
                                <span class="fw-bold text-success">
                                    Rs. <?php echo number_format($product['revenue']); ?>
                                </span>
                            </div>
                        </div>
                        <?php endforeach; ?>
                    </div>
                </div>
                <?php endif; ?>

                <!-- Pending Bills -->
                <div class="glass-panel p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-clock text-warning me-2"></i>Pending Bills
                        </h5>
                        <span class="badge bg-warning"><?php echo $pending_bills; ?></span>
                    </div>
                    
                    <?php if($pending_bills > 0): ?>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong><?php echo $pending_bills; ?> bills</strong> are waiting in night queue
                        </div>
                        <div class="text-center">
                            <a href="night_mode.php" class="btn btn-warning btn-sm w-100">
                                <i class="fas fa-moon me-2"></i> Process Now
                            </a>
                        </div>
                    <?php else: ?>
                        <div class="text-center py-2 text-muted">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <p class="mb-0">All bills are processed</p>
                        </div>
                    <?php endif; ?>
                </div>

                <!-- Quick Stats -->
                <div class="glass-panel p-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-chart-pie text-info me-2"></i>Quick Stats
                    </h5>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded">
                                <small class="text-muted d-block">Today's Sales</small>
                                <div class="fw-bold text-success">Rs. <?php echo number_format($today_sale); ?></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded">
                                <small class="text-muted d-block">Today's Expenses</small>
                                <div class="fw-bold text-danger">Rs. <?php echo number_format($today_expenses); ?></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded">
                                <small class="text-muted d-block">Net Profit</small>
                                <div class="fw-bold <?php echo $net_profit_today >= 0 ? 'text-success' : 'text-danger'; ?>">
                                    Rs. <?php echo number_format($net_profit_today); ?>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded">
                                <small class="text-muted d-block">BVS Balance</small>
                                <div class="fw-bold text-primary">Rs. <?php echo number_format($bvs_balance); ?></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin-only: Additional Stats -->
        <?php if($is_admin): ?>
        <div class="row mt-4">
            <div class="col-12">
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-chart-area me-2"></i>Business Analytics
                        </h2>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <div class="metric-card-content">
                                    <div class="metric-title">Total Customers</div>
                                    <div class="metric-value"><?php echo $total_customers; ?></div>
                                    <div class="metric-trend">
                                        <i class="fas fa-users"></i> Active accounts
                                    </div>
                                </div>
                                <i class="fas fa-users"></i>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="metric-card-content">
                                    <div class="metric-title">Active Loans</div>
                                    <div class="metric-value"><?php echo $active_loans; ?></div>
                                    <div class="metric-trend">
                                        <i class="fas fa-hand-holding-usd"></i> Installments
                                    </div>
                                </div>
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <div class="metric-card-content">
                                    <div class="metric-title">Total Suppliers</div>
                                    <div class="metric-value"><?php echo $total_suppliers; ?></div>
                                    <div class="metric-trend">
                                        <i class="fas fa-truck"></i> Business partners
                                    </div>
                                </div>
                                <i class="fas fa-truck"></i>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                <div class="metric-card-content">
                                    <div class="metric-title">Payables</div>
                                    <div class="metric-value">Rs. <?php echo number_format($payables); ?></div>
                                    <div class="metric-trend">
                                        <i class="fas fa-file-invoice-dollar"></i> Amount due
                                    </div>
                                </div>
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Top Customers with Debt -->
                    <?php if(!empty($top_customers)): ?>
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="glass-panel p-4">
                                <h5 class="fw-bold mb-3">
                                    <i class="fas fa-exclamation-circle text-danger me-2"></i>Top Customers with Outstanding Balance
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Customer</th>
                                                <th>Balance Due</th>
                                                <th>Status</th>
                                                <th class="text-end">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php foreach($top_customers as $customer): ?>
                                            <tr>
                                                <td class="fw-bold"><?php echo htmlspecialchars($customer['person_name']); ?></td>
                                                <td class="text-danger fw-bold">Rs. <?php echo number_format($customer['balance_due']); ?></td>
                                                <td>
                                                    <span class="badge bg-danger">Overdue</span>
                                                </td>
                                                <td class="text-end">
                                                    <a href="contacts.php" class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-phone-alt me-1"></i> Follow Up
                                                    </a>
                                                </td>
                                            </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <?php endif; ?>
    </div>

    <!-- Footer -->
    <footer class="mt-5 py-3 text-center text-muted">
        <div class="container">
            <small>
                <i class="fas fa-shield-alt me-1"></i> ARHAM ERP System v2.0 ‚Ä¢ 
                <?php echo date('Y'); ?> ‚Ä¢ 
                Logged in as: <?php echo $username; ?>
            </small>
        </div>
    </footer>

    <script>
        // Initialize Charts (Admin Only)
        <?php if($is_admin && !empty($chart_data)): ?>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('financialChart').getContext('2d');
            
            const labels = <?php echo json_encode(array_column($chart_data, 'date')); ?>;
            const incomeData = <?php echo json_encode(array_column($chart_data, 'income')); ?>;
            const expenseData = <?php echo json_encode(array_column($chart_data, 'expense')); ?>;
            
            const financialChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rs. ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        });

        function updateChart(days) {
            // In a real implementation, you would fetch new data via AJAX
            console.log('Update chart for', days, 'days');
            // For now, just show a notification
            showNotification('Chart would update for ' + days + ' days', 'info');
        }
        <?php endif; ?>

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `toast align-items-center text-white bg-${type} border-0`;
            notification.setAttribute('role', 'alert');
            notification.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            const container = document.getElementById('notificationContainer') || (() => {
                const div = document.createElement('div');
                div.id = 'notificationContainer';
                div.className = 'toast-container position-fixed top-0 end-0 p-3';
                div.style.zIndex = '9999';
                document.body.appendChild(div);
                return div;
            })();
            
            container.appendChild(notification);
            const bsToast = new bootstrap.Toast(notification);
            bsToast.show();
            
            notification.addEventListener('hidden.bs.toast', () => {
                notification.remove();
            });
        }

        // Auto-refresh data every 5 minutes (for real-time updates)
        setInterval(() => {
            // You can implement AJAX refresh here
            // For now, just update the time
            const now = new Date();
            document.querySelector('.greeting-time .fa-clock').parentElement.innerHTML = 
                `<i class="fas fa-clock me-2"></i>${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        }, 300000); // 5 minutes

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl + R to refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                location.reload();
            }
            
            // Ctrl + S for new sale
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                window.location.href = 'shop_pos.php';
            }
            
            // Ctrl + B for new bill
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                window.location.href = 'bills.php';
            }
        });

        // Animate elements on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate__animated', 'animate__fadeInUp');
                }
            });
        }, observerOptions);

        // Observe all metric cards and sections
        document.querySelectorAll('.metric-card, .dashboard-section').forEach(el => {
            observer.observe(el);
        });

        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
</body>
</html>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\db.php
==============================================================================

<?php
/**
 * ARHAM PORTAL - Database Connection Engine
 * Location: /db.php (or /includes/db.php)
 */

// 1. DATABASE CONFIGURATION
// These details are matched to your uploaded SQL dump: arham_portal-323133bb14
$host     = 'localhost'; 
$db_name  = 'arham_portal-323133bb14';
$username = 'root'; // Change this to your database username if different
$password = '';     // Change this to your database password

// 2. PDO OPTIONS
// We set error mode to Exception for better debugging and 
// Emulation to false for better security and performance.
$options = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES   => false,
    // Ensure UTF8 for special characters (Urdu/Hindi names)
    PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8mb4"
];

// 3. ESTABLISH CONNECTION
try {
    $dsn = "mysql:host=$host;dbname=$db_name;charset=utf8mb4";
    $pdo = new PDO($dsn, $username, $password, $options);
    
    // Optional: Log success (only for very deep debugging)
    // error_log("Database Connected Successfully");

} catch (PDOException $e) {
    // 4. ERROR HANDLING
    // In production, we don't want to show the password or host in error messages
    error_log("Connection Failed: " . $e->getMessage());
    
    // User-friendly error message
    die("<div style='padding:20px; border:2px solid red; background:#fff5f5; font-family:sans-serif;'>
            <h2 style='color:red;'>‚ö†Ô∏è Database Connection Error</h2>
            <p>The system is unable to connect to the database. This might be due to maintenance or incorrect credentials.</p>
            <p><strong>Error:</strong> " . htmlspecialchars($e->getMessage()) . "</p>
         </div>");
}

/**
 * HELPER FUNCTIONS
 * You can use these globally across your files since db.php is required in header.php
 */

// Simple function to log system activities
function logSystemEvent($pdo, $user_id, $action, $details = null) {
    try {
        $stmt = $pdo->prepare("INSERT INTO system_logs (user_id, action, details, created_at) VALUES (?, ?, ?, NOW())");
        $stmt->execute([$user_id, $action, $details]);
    } catch (Exception $e) {
        // Silently fail to prevent breaking the main process
    }
}

// Function to safely clean input
function cleanInput($data) {
    return htmlspecialchars(strip_tags(trim($data)));
}
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\db_update.php
==============================================================================

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
require 'includes/config.php';

echo "<h2>üõ†Ô∏è Database Auto-Fixer</h2>";

// Helper function to add column safely
function addCol($pdo, $table, $col, $def) {
    try {
        $check = $pdo->query("SHOW COLUMNS FROM $table LIKE '$col'");
        if ($check->rowCount() == 0) {
            $pdo->exec("ALTER TABLE $table ADD COLUMN $col $def");
            echo "<div style='color:green'>‚úÖ Added column <b>$col</b> to <b>$table</b>.</div>";
        } else {
            echo "<div style='color:gray'>Current column <b>$col</b> already exists in <b>$table</b>. (Skipped)</div>";
        }
    } catch (PDOException $e) {
        echo "<div style='color:red'>‚ùå Error on $col: " . $e->getMessage() . "</div>";
    }
}

// 1. FIX 'bill_queue' TABLE
echo "<h3>Checking 'bill_queue'...</h3>";
addCol($pdo, 'bill_queue', 'customer_id', 'INT DEFAULT NULL');
addCol($pdo, 'bill_queue', 'payment_status', "ENUM('cash', 'credit') DEFAULT 'cash'");
addCol($pdo, 'bill_queue', 'mobile_no', 'VARCHAR(20) DEFAULT NULL');
addCol($pdo, 'bill_queue', 'transaction_id', 'VARCHAR(100) DEFAULT NULL');

// Fix Bill Type Length
try {
    $pdo->exec("ALTER TABLE bill_queue MODIFY bill_type VARCHAR(100)");
    echo "<div style='color:green'>‚úÖ Updated <b>bill_type</b> length.</div>";
} catch (Exception $e) {}

// 2. FIX 'saved_consumers' TABLE
echo "<h3>Checking 'saved_consumers'...</h3>";
addCol($pdo, 'saved_consumers', 'mobile_no', 'VARCHAR(20) DEFAULT NULL');
try {
    $pdo->exec("ALTER TABLE saved_consumers MODIFY bill_type VARCHAR(100)");
    echo "<div style='color:green'>‚úÖ Updated <b>bill_type</b> length.</div>";
} catch (Exception $e) {}

// 3. FIX 'beneficiaries' TABLE
echo "<h3>Checking 'beneficiaries'...</h3>";
addCol($pdo, 'beneficiaries', 'last_visit', 'DATE DEFAULT NULL');
addCol($pdo, 'beneficiaries', 'phone', 'VARCHAR(20) DEFAULT NULL');
addCol($pdo, 'beneficiaries', 'name', 'VARCHAR(100) DEFAULT NULL');

echo "<hr><h3>üéâ Database Repair Complete!</h3>";
echo "<a href='bills.php' style='font-size:20px; font-weight:bold;'>Click here to go back to Bills</a>";
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\debug_session.php
==============================================================================

<?php
session_start();
echo "<h1>Session Debugger</h1>";
echo "<b>User ID:</b> " . ($_SESSION['user_id'] ?? 'Not Set') . "<br>";
echo "<b>Username:</b> " . ($_SESSION['username'] ?? 'Not Set') . "<br>";
echo "<b>Role:</b> " . ($_SESSION['role'] ?? 'Not Set') . " (Must be 'admin' lowercase)<br>";
echo "<h3>Permissions:</h3>";
echo "<pre>";
print_r($_SESSION['permissions']);
echo "</pre>";
echo "<a href='logout.php'>Logout and Fix</a>";
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\delete_payout.php
==============================================================================

<?php
require 'includes/config.php';
requireAuth(); // Security Check

if(isset($_GET['id'])) {
    $id = $_GET['id'];
    
    // 1. Check if this payout was linked to a Token
    // (You might need to add token_id to transactions table if not there, 
    // strictly speaking this is optional but good for consistency)
    
    // 2. Delete the Transaction
    $pdo->prepare("DELETE FROM transactions WHERE id = ?")->execute([$id]);
    
    // Log the action
    if(function_exists('logActivity')) {
        logActivity($pdo, "Delete Transaction", "Deleted ID: $id");
    }
}

header("Location: reports.php"); // Redirect back to reports, not payout
exit();
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\delete_token.php
==============================================================================

<?php
require 'includes/config.php';
requireAuth();

if(isset($_GET['id'])) {
    $id = $_GET['id'];
    
    // Option A: Hard Delete (Remove completely)
    // $pdo->prepare("DELETE FROM queue_tokens WHERE id = ?")->execute([$id]);

    // Option B: Soft Delete (Mark as cancelled - Recommended)
    $pdo->prepare("UPDATE queue_tokens SET status='cancelled' WHERE id = ?")->execute([$id]);
}

header("Location: queue.php");
exit();
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\display.php
==============================================================================

<?php
require 'includes/config.php';

// Fetch Current Serving
$today = date('Y-m-d');
$current = $pdo->query("SELECT * FROM queue_tokens WHERE status='served' AND DATE(served_at) = '$today' ORDER BY served_at DESC LIMIT 1")->fetch();

// Fetch Next 4 Waiting
$waiting = $pdo->query("SELECT * FROM queue_tokens WHERE status='waiting' ORDER BY id ASC LIMIT 4")->fetchAll();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="3"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Display TV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    
    <style>
        body { 
            background-color: #000; 
            color: #fff; 
            height: 100vh; 
            overflow: hidden; 
            font-family: 'Segoe UI', sans-serif; 
        }
        .container-fluid { height: 100%; padding: 0; }
        
        /* LEFT SIDE: NOW SERVING (Green) */
        .serving-section { 
            background: linear-gradient(135deg, #004d26 0%, #006400 100%);
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            border-right: 8px solid #FFC107;
            text-align: center;
        }
        
        .label { 
            font-size: 3vw; 
            text-transform: uppercase; 
            letter-spacing: 5px; 
            opacity: 0.8; 
            margin-bottom: 20px; 
        }
        
        .token-main { 
            font-size: 18vw; 
            font-weight: 900; 
            line-height: 1; 
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }
        
        .name-main { 
            font-size: 4vw; 
            margin-top: 20px; 
            color: #FFC107; 
            font-weight: bold;
        }

        /* RIGHT SIDE: WAITING LIST (Dark) */
        .waiting-section { 
            background: #111; 
            height: 100vh; 
            padding: 40px; 
        }

        .waiting-title { 
            font-size: 3vw; 
            color: #fff; 
            border-bottom: 2px solid #333; 
            padding-bottom: 20px; 
            margin-bottom: 30px;
            font-weight: bold;
            display: flex; align-items: center; gap: 20px;
        }

        .list-group-item { 
            background: #1e1e1e; 
            color: #fff; 
            border: 1px solid #333; 
            font-size: 3vw; 
            font-weight: bold; 
            padding: 25px; 
            margin-bottom: 20px; 
            border-radius: 20px !important; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .badge-custom { 
            background: #333; 
            color: #aaa; 
            font-size: 2vw; 
            padding: 10px 20px; 
            border-radius: 15px; 
        }

    </style>
</head>
<body>

<div class="row g-0">
    <div class="col-8 serving-section">
        <div class="label"><i class="fas fa-bell me-3"></i> Now Serving</div>
        <div class="token-main animate__animated animate__zoomIn">
            <?php echo $current ? $current['token_number'] : '--'; ?>
        </div>
        <div class="name-main">
            <?php echo $current ? $current['name'] : 'Counter Closed'; ?>
        </div>
    </div>

    <div class="col-4 waiting-section">
        <div class="waiting-title">
            <i class="fas fa-users text-primary"></i> Next in Line
        </div>
        
        <?php if(count($waiting) > 0): ?>
            <ul class="list-group">
                <?php foreach($waiting as $w): ?>
                <li class="list-group-item animate__animated animate__fadeInRight">
                    <span class="text-warning"><?php echo $w['token_number']; ?></span>
                    <span class="badge-custom">WAITING</span>
                </li>
                <?php endforeach; ?>
            </ul>
        <?php else: ?>
            <div class="text-center text-muted mt-5">
                <i class="fas fa-coffee fa-4x mb-3 opacity-25"></i>
                <h3>Queue Empty</h3>
            </div>
        <?php endif; ?>
    </div>
</div>

</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\expenses.php
==============================================================================

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
date_default_timezone_set('Asia/Karachi');

require 'includes/header.php';

// ACCESS CONTROL
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

// Check if user has finance access
$stmt = $pdo->prepare("SELECT role FROM users WHERE id = ?");
$stmt->execute([$_SESSION['user_id']]);
$user_role = $stmt->fetchColumn();

if (!in_array($user_role, ['admin', 'finance_manager', 'accountant'])) {
    header("Location: dashboard.php");
    exit();
}

$msg = "";
$error = "";
$success = "";

// Set expense type from URL
$expense_type = isset($_GET['type']) && $_GET['type'] == 'business' ? 'business' : 'home';
$page_title = $expense_type == 'business' ? 'Business Expenses' : 'Home Expenses';

// Handle form submissions
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    // ADD NEW EXPENSE
    if (isset($_POST['add_expense'])) {
        $category = trim($_POST['category']);
        $amount = floatval($_POST['amount']);
        $description = trim($_POST['description']);
        $payment_method = $_POST['payment_method'];
        $account_head = $_POST['account_head'];
        $expense_date = $_POST['expense_date'] ?: date('Y-m-d');
        $receipt_no = trim($_POST['receipt_no']);
        $vendor_name = trim($_POST['vendor_name']);
        $attachment_path = null;

        // Handle file upload
        if (isset($_FILES['attachment']) && $_FILES['attachment']['error'] == 0) {
            $allowed_types = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
            $max_size = 5 * 1024 * 1024; // 5MB
            
            if (in_array($_FILES['attachment']['type'], $allowed_types) && 
                $_FILES['attachment']['size'] <= $max_size) {
                
                $file_ext = pathinfo($_FILES['attachment']['name'], PATHINFO_EXTENSION);
                $file_name = 'expense_' . time() . '_' . rand(1000, 9999) . '.' . $file_ext;
                $upload_dir = 'uploads/expenses/';
                
                if (!is_dir($upload_dir)) {
                    mkdir($upload_dir, 0777, true);
                }
                
                if (move_uploaded_file($_FILES['attachment']['tmp_name'], $upload_dir . $file_name)) {
                    $attachment_path = $upload_dir . $file_name;
                }
            }
        }

        try {
            $pdo->beginTransaction();

            // Insert into expenses table
            $stmt = $pdo->prepare("INSERT INTO expenses (expense_date, category, description, amount, payment_method, account_head, expense_type, receipt_no, vendor_name, attachment_path, created_by) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
            $stmt->execute([$expense_date, $category, $description, $amount, $payment_method, $account_head, $expense_type, $receipt_no, $vendor_name, $attachment_path, $_SESSION['user_id']]);

            // Add to finance ledger
            $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head, reference_id, expense_type) VALUES (?, 'expense', ?, ?, ?, ?, ?, ?, ?)");
            $stmt->execute([$expense_date, $category, $description, $amount, $payment_method, $account_head, $pdo->lastInsertId(), $expense_type]);

            // Update account balance
            $stmt = $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name = ?");
            $stmt->execute([$amount, $account_head]);

            $pdo->commit();
            $success = "‚úÖ Expense added successfully!";
        } catch (Exception $e) {
            $pdo->rollBack();
            $error = "Error: " . $e->getMessage();
        }
    }

    // UPDATE EXPENSE
    if (isset($_POST['update_expense'])) {
        $expense_id = $_POST['expense_id'];
        $category = trim($_POST['category']);
        $amount = floatval($_POST['amount']);
        $description = trim($_POST['description']);
        $payment_method = $_POST['payment_method'];
        $account_head = $_POST['account_head'];
        $expense_date = $_POST['expense_date'];
        $receipt_no = trim($_POST['receipt_no']);
        $vendor_name = trim($_POST['vendor_name']);

        // Get old expense details
        $stmt = $pdo->prepare("SELECT amount, account_head FROM expenses WHERE id = ?");
        $stmt->execute([$expense_id]);
        $old_expense = $stmt->fetch();

        try {
            $pdo->beginTransaction();

            // Update expense
            $stmt = $pdo->prepare("UPDATE expenses SET expense_date = ?, category = ?, description = ?, amount = ?, payment_method = ?, account_head = ?, receipt_no = ?, vendor_name = ?, updated_at = NOW() WHERE id = ?");
            $stmt->execute([$expense_date, $category, $description, $amount, $payment_method, $account_head, $receipt_no, $vendor_name, $expense_id]);

            // Update ledger
            $stmt = $pdo->prepare("UPDATE finance_ledger SET trans_date = ?, category = ?, description = ?, amount = ?, payment_method = ?, account_head = ? WHERE reference_id = ? AND type = 'expense'");
            $stmt->execute([$expense_date, $category, $description, $amount, $payment_method, $account_head, $expense_id]);

            // Revert old account balance
            $stmt = $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ? WHERE account_name = ?");
            $stmt->execute([$old_expense['amount'], $old_expense['account_head']]);

            // Apply new account balance
            $stmt = $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name = ?");
            $stmt->execute([$amount, $account_head]);

            $pdo->commit();
            $success = "‚úÖ Expense updated successfully!";
        } catch (Exception $e) {
            $pdo->rollBack();
            $error = "Error: " . $e->getMessage();
        }
    }

    // DELETE EXPENSE
    if (isset($_POST['delete_expense'])) {
        $expense_id = $_POST['expense_id'];

        // Get expense details
        $stmt = $pdo->prepare("SELECT amount, account_head, attachment_path FROM expenses WHERE id = ?");
        $stmt->execute([$expense_id]);
        $expense = $stmt->fetch();

        try {
            $pdo->beginTransaction();

            // Delete from expenses
            $stmt = $pdo->prepare("DELETE FROM expenses WHERE id = ?");
            $stmt->execute([$expense_id]);

            // Delete from ledger
            $stmt = $pdo->prepare("DELETE FROM finance_ledger WHERE reference_id = ? AND type = 'expense'");
            $stmt->execute([$expense_id]);

            // Revert account balance
            $stmt = $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ? WHERE account_name = ?");
            $stmt->execute([$expense['amount'], $expense['account_head']]);

            // Delete attachment file if exists
            if ($expense['attachment_path'] && file_exists($expense['attachment_path'])) {
                unlink($expense['attachment_path']);
            }

            $pdo->commit();
            $success = "‚úÖ Expense deleted successfully!";
        } catch (Exception $e) {
            $pdo->rollBack();
            $error = "Error: " . $e->getMessage();
        }
    }

    // BULK ACTION: Approve Selected
    if (isset($_POST['bulk_approve'])) {
        if (!empty($_POST['selected_expenses'])) {
            try {
                $pdo->beginTransaction();
                $placeholders = implode(',', array_fill(0, count($_POST['selected_expenses']), '?'));
                
                $stmt = $pdo->prepare("UPDATE expenses SET status = 'approved', approved_by = ?, approved_at = NOW() WHERE id IN ($placeholders)");
                $stmt->execute(array_merge([$_SESSION['user_id']], $_POST['selected_expenses']));
                
                $pdo->commit();
                $success = "‚úÖ " . count($_POST['selected_expenses']) . " expenses approved!";
            } catch (Exception $e) {
                $pdo->rollBack();
                $error = "Error: " . $e->getMessage();
            }
        }
    }

    // BULK ACTION: Delete Selected
    if (isset($_POST['bulk_delete'])) {
        if (!empty($_POST['selected_expenses'])) {
            if (isset($_POST['confirm_bulk_delete']) && $_POST['confirm_bulk_delete'] == '1') {
                try {
                    $pdo->beginTransaction();
                    $placeholders = implode(',', array_fill(0, count($_POST['selected_expenses']), '?'));
                    
                    // Get amounts and account heads for reversal
                    $stmt = $pdo->prepare("SELECT amount, account_head FROM expenses WHERE id IN ($placeholders)");
                    $stmt->execute($_POST['selected_expenses']);
                    $expenses = $stmt->fetchAll();
                    
                    // Revert account balances
                    foreach ($expenses as $exp) {
                        $stmt = $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ? WHERE account_name = ?");
                        $stmt->execute([$exp['amount'], $exp['account_head']]);
                    }
                    
                    // Delete expenses
                    $stmt = $pdo->prepare("DELETE FROM expenses WHERE id IN ($placeholders)");
                    $stmt->execute($_POST['selected_expenses']);
                    
                    // Delete from ledger
                    $stmt = $pdo->prepare("DELETE FROM finance_ledger WHERE reference_id IN ($placeholders) AND type = 'expense'");
                    $stmt->execute($_POST['selected_expenses']);
                    
                    $pdo->commit();
                    $success = "‚úÖ " . count($_POST['selected_expenses']) . " expenses deleted!";
                } catch (Exception $e) {
                    $pdo->rollBack();
                    $error = "Error: " . $e->getMessage();
                }
            } else {
                $error = "Please confirm bulk deletion by checking the confirmation box.";
            }
        }
    }
}

// Get expense categories
$categories = $pdo->query("SELECT DISTINCT category FROM expenses WHERE expense_type = '$expense_type' ORDER BY category")->fetchAll();

// Get accounts
$accounts = $pdo->query("SELECT account_name, current_balance FROM accounts WHERE account_type IN ('cash', 'bank') ORDER BY account_name")->fetchAll();

// Get payment methods
$payment_methods = $pdo->query("SELECT DISTINCT payment_method FROM expenses ORDER BY payment_method")->fetchAll();

// Get filters
$filter_category = $_GET['category'] ?? '';
$filter_date_from = $_GET['date_from'] ?? date('Y-m-01');
$filter_date_to = $_GET['date_to'] ?? date('Y-m-d');
$filter_status = $_GET['status'] ?? '';
$filter_min_amount = $_GET['min_amount'] ?? '';
$filter_max_amount = $_GET['max_amount'] ?? '';
$filter_payment_method = $_GET['payment_method'] ?? '';

// Build query for expenses
$query = "SELECT e.*, u.username as created_by_name, ua.username as approved_by_name 
          FROM expenses e 
          LEFT JOIN users u ON e.created_by = u.id 
          LEFT JOIN users ua ON e.approved_by = ua.id 
          WHERE e.expense_type = :expense_type";
$params = [':expense_type' => $expense_type];

if ($filter_category) {
    $query .= " AND e.category = :category";
    $params[':category'] = $filter_category;
}
if ($filter_date_from) {
    $query .= " AND e.expense_date >= :date_from";
    $params[':date_from'] = $filter_date_from;
}
if ($filter_date_to) {
    $query .= " AND e.expense_date <= :date_to";
    $params[':date_to'] = $filter_date_to;
}
if ($filter_status) {
    $query .= " AND e.status = :status";
    $params[':status'] = $filter_status;
}
if ($filter_min_amount) {
    $query .= " AND e.amount >= :min_amount";
    $params[':min_amount'] = $filter_min_amount;
}
if ($filter_max_amount) {
    $query .= " AND e.amount <= :max_amount";
    $params[':max_amount'] = $filter_max_amount;
}
if ($filter_payment_method) {
    $query .= " AND e.payment_method = :payment_method";
    $params[':payment_method'] = $filter_payment_method;
}

$query .= " ORDER BY e.expense_date DESC, e.id DESC";
$stmt = $pdo->prepare($query);
$stmt->execute($params);
$expenses = $stmt->fetchAll();

// Get statistics
$stats_query = "SELECT 
                COUNT(*) as total_count,
                SUM(amount) as total_amount,
                AVG(amount) as avg_amount,
                MIN(amount) as min_amount,
                MAX(amount) as max_amount,
                COUNT(DISTINCT category) as category_count
                FROM expenses 
                WHERE expense_type = :expense_type 
                AND expense_date BETWEEN :date_from AND :date_to";
$stats_params = [
    ':expense_type' => $expense_type,
    ':date_from' => $filter_date_from,
    ':date_to' => $filter_date_to
];

if ($filter_category) {
    $stats_query .= " AND category = :category";
    $stats_params[':category'] = $filter_category;
}

$stmt = $pdo->prepare($stats_query);
$stmt->execute($stats_params);
$stats = $stmt->fetch();

// Get monthly trend
$monthly_trend = $pdo->prepare("SELECT 
    DATE_FORMAT(expense_date, '%Y-%m') as month,
    SUM(amount) as total,
    COUNT(*) as count
    FROM expenses 
    WHERE expense_type = ? 
    AND expense_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
    GROUP BY DATE_FORMAT(expense_date, '%Y-%m')
    ORDER BY month DESC
    LIMIT 6");
$monthly_trend->execute([$expense_type]);
$trend_data = $monthly_trend->fetchAll();

// Get top categories
$top_categories = $pdo->prepare("SELECT 
    category,
    SUM(amount) as total,
    COUNT(*) as count
    FROM expenses 
    WHERE expense_type = ? 
    AND expense_date BETWEEN ? AND ?
    GROUP BY category
    ORDER BY total DESC
    LIMIT 10");
$top_categories->execute([$expense_type, $filter_date_from, $filter_date_to]);
$categories_data = $top_categories->fetchAll();
?>

<div class="container-fluid py-3">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center mb-3">
                <h1 class="h2 fw-bold mb-0">
                    <i class="fas fa-home text-primary me-2"></i>
                    <?php echo $page_title; ?>
                </h1>
                <div class="ms-3">
                    <div class="btn-group">
                        <a href="expenses.php?type=home" class="btn btn-<?php echo $expense_type == 'home' ? 'primary' : 'outline-primary'; ?>">
                            <i class="fas fa-home"></i> Home
                        </a>
                        <a href="expenses.php?type=business" class="btn btn-<?php echo $expense_type == 'business' ? 'primary' : 'outline-primary'; ?>">
                            <i class="fas fa-briefcase"></i> Business
                        </a>
                    </div>
                </div>
            </div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="dashboard.php">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="finance.php">Finance</a></li>
                    <li class="breadcrumb-item active" aria-current="page"><?php echo $page_title; ?></li>
                </ol>
            </nav>
        </div>
        <div class="col-md-4 text-end">
            <div class="d-flex gap-2 justify-content-end">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                    <i class="fas fa-plus-circle me-2"></i> Add Expense
                </button>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                    <i class="fas fa-filter me-2"></i> Filter
                </button>
                <a href="reports.php?report=expenses&type=<?php echo $expense_type; ?>" class="btn btn-outline-info">
                    <i class="fas fa-chart-bar me-2"></i> Reports
                </a>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    <?php if ($success): ?>
        <div class="alert alert-success alert-dismissible fade show animate__animated animate__fadeInDown" role="alert">
            <?php echo $success; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php endif; ?>
    
    <?php if ($error): ?>
        <div class="alert alert-danger alert-dismissible fade show animate__animated animate__shakeX" role="alert">
            <?php echo $error; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php endif; ?>

    <!-- Dashboard Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon me-3">
                            <i class="fas fa-receipt fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-white-50 mb-1">Total Expenses</h6>
                            <h3 class="mb-0"><?php echo number_format($stats['total_count'] ?? 0); ?></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon me-3">
                            <i class="fas fa-money-bill-wave fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-white-50 mb-1">Total Amount</h6>
                            <h3 class="mb-0">Rs. <?php echo number_format($stats['total_amount'] ?? 0); ?></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon me-3">
                            <i class="fas fa-tags fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-white-50 mb-1">Categories</h6>
                            <h3 class="mb-0"><?php echo number_format($stats['category_count'] ?? 0); ?></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon me-3">
                            <i class="fas fa-calculator fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-dark-50 mb-1">Avg. Expense</h6>
                            <h3 class="mb-0">Rs. <?php echo number_format($stats['avg_amount'] ?? 0, 2); ?></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Insights -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i>Monthly Trend</h5>
                    <small class="text-muted">Last 6 months</small>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie text-success me-2"></i>Top Categories</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="categoriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Expense Records</h5>
                </div>
                <div class="col-md-6 text-end">
                    <form method="POST" class="d-inline" onsubmit="return validateBulkAction()">
                        <input type="hidden" name="confirm_bulk_delete" id="confirmBulkDelete" value="0">
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllRows()">
                                <i class="fas fa-check-square me-1"></i> Select All
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAllRows()">
                                <i class="fas fa-square me-1"></i> Deselect All
                            </button>
                            <button type="submit" name="bulk_approve" class="btn btn-success btn-sm">
                                <i class="fas fa-check-circle me-1"></i> Approve
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="confirmBulkDelete()">
                                <i class="fas fa-trash-alt me-1"></i> Delete
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                            </th>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Account</th>
                            <th>Status</th>
                            <th>Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php if (empty($expenses)): ?>
                            <tr>
                                <td colspan="10" class="text-center py-5">
                                    <div class="empty-state">
                                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                                        <h5>No expenses found</h5>
                                        <p class="text-muted">Add your first expense to get started</p>
                                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                                            <i class="fas fa-plus-circle me-2"></i> Add Expense
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <?php else: ?>
                            <?php foreach ($expenses as $expense): ?>
                                <tr>
                                    <td>
                                        <input type="checkbox" name="selected_expenses[]" value="<?php echo $expense['id']; ?>" class="expense-checkbox">
                                    </td>
                                    <td>
                                        <div class="fw-bold"><?php echo date('d M Y', strtotime($expense['expense_date'])); ?></div>
                                        <small class="text-muted"><?php echo date('h:i A', strtotime($expense['created_at'])); ?></small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info"><?php echo htmlspecialchars($expense['category']); ?></span>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;">
                                            <?php echo htmlspecialchars($expense['description']); ?>
                                        </div>
                                        <?php if ($expense['vendor_name']): ?>
                                            <small class="text-muted">Vendor: <?php echo htmlspecialchars($expense['vendor_name']); ?></small>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <div class="fw-bold text-danger">Rs. <?php echo number_format($expense['amount'], 2); ?></div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary"><?php echo $expense['payment_method']; ?></span>
                                    </td>
                                    <td>
                                        <small><?php echo $expense['account_head']; ?></small>
                                    </td>
                                    <td>
                                        <?php if ($expense['status'] == 'approved'): ?>
                                            <span class="badge bg-success">Approved</span>
                                        <?php elseif ($expense['status'] == 'pending'): ?>
                                            <span class="badge bg-warning">Pending</span>
                                        <?php else: ?>
                                            <span class="badge bg-secondary"><?php echo $expense['status']; ?></span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <?php if ($expense['receipt_no']): ?>
                                            <span class="badge bg-light text-dark">#<?php echo $expense['receipt_no']; ?></span>
                                        <?php endif; ?>
                                        <?php if ($expense['attachment_path']): ?>
                                            <a href="<?php echo $expense['attachment_path']; ?>" target="_blank" class="ms-1" title="View Attachment">
                                                <i class="fas fa-paperclip text-primary"></i>
                                            </a>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" onclick="viewExpense(<?php echo $expense['id']; ?>)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="editExpense(<?php echo $expense['id']; ?>)">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <?php if ($user_role == 'admin'): ?>
                                                <button class="btn btn-outline-danger" onclick="deleteExpense(<?php echo $expense['id']; ?>, '<?php echo htmlspecialchars($expense['description']); ?>')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            <?php endif; ?>
                                        </div>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted">
                        Showing <?php echo count($expenses); ?> expenses
                        <?php if ($filter_date_from || $filter_date_to): ?>
                            from <?php echo date('d M Y', strtotime($filter_date_from)); ?> to <?php echo date('d M Y', strtotime($filter_date_to)); ?>
                        <?php endif; ?>
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <form method="GET" class="d-inline">
                        <input type="hidden" name="type" value="<?php echo $expense_type; ?>">
                        <input type="hidden" name="category" value="<?php echo $filter_category; ?>">
                        <input type="hidden" name="date_from" value="<?php echo $filter_date_from; ?>">
                        <input type="hidden" name="date_to" value="<?php echo $filter_date_to; ?>">
                        <button type="submit" name="export" value="csv" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-file-csv me-1"></i> Export CSV
                        </button>
                        <button type="submit" name="export" value="pdf" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-file-pdf me-1"></i> Export PDF
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary by Category -->
    <div class="card">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-chart-bar text-info me-2"></i>Expense Summary by Category</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Count</th>
                            <th>Total Amount</th>
                            <th>Average</th>
                            <th>% of Total</th>
                            <th>Last Expense</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($categories_data as $cat): ?>
                            <?php 
                            $percentage = $stats['total_amount'] > 0 ? ($cat['total'] / $stats['total_amount']) * 100 : 0;
                            $last_expense = $pdo->prepare("SELECT expense_date FROM expenses WHERE category = ? AND expense_type = ? ORDER BY expense_date DESC LIMIT 1");
                            $last_expense->execute([$cat['category'], $expense_type]);
                            $last_date = $last_expense->fetchColumn();
                            ?>
                            <tr>
                                <td><span class="badge bg-info"><?php echo $cat['category']; ?></span></td>
                                <td><?php echo $cat['count']; ?></td>
                                <td class="fw-bold text-danger">Rs. <?php echo number_format($cat['total'], 2); ?></td>
                                <td>Rs. <?php echo number_format($cat['total'] / $cat['count'], 2); ?></td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: <?php echo $percentage; ?>%" 
                                             aria-valuenow="<?php echo $percentage; ?>" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            <?php echo number_format($percentage, 1); ?>%
                                        </div>
                                    </div>
                                </td>
                                <td><?php echo $last_date ? date('d M Y', strtotime($last_date)) : 'N/A'; ?></td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add New Expense</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Expense Date <span class="text-danger">*</span></label>
                            <input type="date" name="expense_date" class="form-control" value="<?php echo date('Y-m-d'); ?>" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Category <span class="text-danger">*</span></label>
                            <select name="category" class="form-select" required>
                                <option value="">Select Category</option>
                                <option value="Groceries">Groceries</option>
                                <option value="Utilities">Utilities (Electricity, Water, Gas)</option>
                                <option value="Rent/Mortgage">Rent/Mortgage</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Education">Education</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Food & Dining">Food & Dining</option>
                                <option value="Maintenance">Home Maintenance</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Personal Care">Personal Care</option>
                                <option value="Gifts/Donations">Gifts/Donations</option>
                                <option value="Travel">Travel</option>
                                <option value="Subscriptions">Subscriptions</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Amount (Rs.) <span class="text-danger">*</span></label>
                            <input type="number" name="amount" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Payment Method <span class="text-danger">*</span></label>
                            <select name="payment_method" class="form-select" required>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Mobile Payment">Mobile Payment</option>
                                <option value="Cheque">Cheque</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Account Head <span class="text-danger">*</span></label>
                            <select name="account_head" class="form-select" required>
                                <?php foreach ($accounts as $account): ?>
                                    <option value="<?php echo $account['account_name']; ?>">
                                        <?php echo $account['account_name']; ?> (Rs. <?php echo number_format($account['current_balance']); ?>)
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Receipt/Bill Number</label>
                            <input type="text" name="receipt_no" class="form-control" placeholder="Optional">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vendor/Shop Name</label>
                            <input type="text" name="vendor_name" class="form-control" placeholder="Optional">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Attachment (Bill/Receipt)</label>
                            <input type="file" name="attachment" class="form-control" accept="image/*,.pdf">
                            <small class="text-muted">Max 5MB - JPG, PNG, GIF, PDF</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            <textarea name="description" class="form-control" rows="3" required placeholder="Enter expense details..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" name="expense_type" value="<?php echo $expense_type; ?>">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="add_expense" class="btn btn-primary">Save Expense</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-filter me-2"></i>Filter Expenses</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="GET">
                <div class="modal-body">
                    <input type="hidden" name="type" value="<?php echo $expense_type; ?>">
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" name="date_from" class="form-control" value="<?php echo $filter_date_from; ?>">
                            </div>
                            <div class="col-6">
                                <input type="date" name="date_to" class="form-control" value="<?php echo $filter_date_to; ?>">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select">
                            <option value="">All Categories</option>
                            <?php foreach ($categories as $cat): ?>
                                <option value="<?php echo $cat['category']; ?>" <?php echo $filter_category == $cat['category'] ? 'selected' : ''; ?>>
                                    <?php echo $cat['category']; ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select name="payment_method" class="form-select">
                            <option value="">All Methods</option>
                            <?php foreach ($payment_methods as $pm): ?>
                                <option value="<?php echo $pm['payment_method']; ?>" <?php echo $filter_payment_method == $pm['payment_method'] ? 'selected' : ''; ?>>
                                    <?php echo $pm['payment_method']; ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="">All Status</option>
                            <option value="pending" <?php echo $filter_status == 'pending' ? 'selected' : ''; ?>>Pending</option>
                            <option value="approved" <?php echo $filter_status == 'approved' ? 'selected' : ''; ?>>Approved</option>
                            <option value="rejected" <?php echo $filter_status == 'rejected' ? 'selected' : ''; ?>>Rejected</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount Range (Rs.)</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" name="min_amount" class="form-control" placeholder="Min" value="<?php echo $filter_min_amount; ?>">
                            </div>
                            <div class="col-6">
                                <input type="number" name="max_amount" class="form-control" placeholder="Max" value="<?php echo $filter_max_amount; ?>">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="expenses.php?type=<?php echo $expense_type; ?>" class="btn btn-outline-secondary">Reset</a>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Trend Chart
    const trendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: <?php echo json_encode(array_column($trend_data, 'month')); ?>,
            datasets: [{
                label: 'Expense Amount',
                data: <?php echo json_encode(array_column($trend_data, 'total')); ?>,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Rs. ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Categories Chart
    const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');
    const categoriesChart = new Chart(categoriesCtx, {
        type: 'doughnut',
        data: {
            labels: <?php echo json_encode(array_column($categories_data, 'category')); ?>,
            datasets: [{
                data: <?php echo json_encode(array_column($categories_data, 'total')); ?>,
                backgroundColor: [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1',
                    '#17a2b8', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
});

// Bulk Actions Functions
function toggleSelectAll(source) {
    const checkboxes = document.getElementsByClassName('expense-checkbox');
    for (let checkbox of checkboxes) {
        checkbox.checked = source.checked;
    }
}

function selectAllRows() {
    const checkboxes = document.getElementsByClassName('expense-checkbox');
    for (let checkbox of checkboxes) {
        checkbox.checked = true;
    }
    document.getElementById('selectAll').checked = true;
}

function deselectAllRows() {
    const checkboxes = document.getElementsByClassName('expense-checkbox');
    for (let checkbox of checkboxes) {
        checkbox.checked = false;
    }
    document.getElementById('selectAll').checked = false;
}

function confirmBulkDelete() {
    const selected = document.querySelectorAll('.expense-checkbox:checked');
    if (selected.length === 0) {
        alert('Please select expenses to delete.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selected.length} expense(s)? This action cannot be undone.`)) {
        document.getElementById('confirmBulkDelete').value = '1';
        document.querySelector('form').submit();
    }
}

function validateBulkAction() {
    const selected = document.querySelectorAll('.expense-checkbox:checked');
    if (selected.length === 0) {
        alert('Please select at least one expense.');
        return false;
    }
    return true;
}

// Expense CRUD Functions
function viewExpense(id) {
    // Load expense details via AJAX and show in modal
    fetch(`ajax/get_expense.php?id=${id}`)
        .then(response => response.json())
        .then(data => {
            // Create and show view modal
            showExpenseModal(data, 'view');
        });
}

function editExpense(id) {
    fetch(`ajax/get_expense.php?id=${id}`)
        .then(response => response.json())
        .then(data => {
            // Create and show edit modal
            showExpenseModal(data, 'edit');
        });
}

function deleteExpense(id, description) {
    if (confirm(`Are you sure you want to delete expense: "${description}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        const inputId = document.createElement('input');
        inputId.type = 'hidden';
        inputId.name = 'expense_id';
        inputId.value = id;
        
        const inputAction = document.createElement('input');
        inputAction.type = 'hidden';
        inputAction.name = 'delete_expense';
        inputAction.value = '1';
        
        form.appendChild(inputId);
        form.appendChild(inputAction);
        document.body.appendChild(form);
        form.submit();
    }
}

function showExpenseModal(data, mode) {
    // Create modal dynamically
    const modalId = 'expenseDetailModal';
    let modal = document.getElementById(modalId);
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Expense Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="expenseModalBody"></div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Populate modal content based on mode
    const modalBody = modal.querySelector('#expenseModalBody');
    
    if (mode === 'view') {
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Date</label>
                    <div class="fw-bold">${data.expense_date}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Amount</label>
                    <div class="fw-bold text-danger">Rs. ${parseFloat(data.amount).toLocaleString()}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Category</label>
                    <div><span class="badge bg-info">${data.category}</span></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Payment Method</label>
                    <div><span class="badge bg-secondary">${data.payment_method}</span></div>
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label text-muted">Description</label>
                    <div class="fw-bold">${data.description}</div>
                </div>
                ${data.vendor_name ? `
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Vendor</label>
                    <div>${data.vendor_name}</div>
                </div>` : ''}
                ${data.receipt_no ? `
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Receipt No.</label>
                    <div>${data.receipt_no}</div>
                </div>` : ''}
                ${data.attachment_path ? `
                <div class="col-12 mb-3">
                    <label class="form-label text-muted">Attachment</label>
                    <div>
                        <a href="${data.attachment_path}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-paperclip me-1"></i> View Attachment
                        </a>
                    </div>
                </div>` : ''}
            </div>
        `;
    }
    
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Quick add category
function quickAddCategory() {
    const category = prompt('Enter new category name:');
    if (category && category.trim() !== '') {
        // You would typically save this via AJAX
        const select = document.querySelector('select[name="category"]');
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
        select.value = category;
    }
}

// Export functions
function exportToCSV() {
    // Implement CSV export
    alert('CSV export feature would be implemented here');
}

function exportToPDF() {
    // Implement PDF export
    alert('PDF export feature would be implemented here');
}

// Quick stats update on date change
function updateQuickStats() {
    const dateFrom = document.querySelector('[name="date_from"]').value;
    const dateTo = document.querySelector('[name="date_to"]').value;
    
    // You would typically fetch updated stats via AJAX
    console.log('Fetching stats for:', dateFrom, 'to', dateTo);
}
</script>

<style>
.stat-card {
    border-radius: 10px;
    transition: transform 0.3s ease;
    border: none;
}
.stat-card:hover {
    transform: translateY(-5px);
}
.stat-icon {
    opacity: 0.8;
}
.empty-state {
    text-align: center;
    padding: 40px 20px;
}
.empty-state i {
    font-size: 3rem;
    margin-bottom: 20px;
}
.table th {
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.table td {
    vertical-align: middle;
}
.chart-container {
    position: relative;
}
.progress {
    border-radius: 3px;
}
.progress-bar {
    font-size: 0.75rem;
    line-height: 20px;
}
.badge {
    font-weight: 500;
}
.text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\financial_reports.php
==============================================================================

<?php 
// financial_reports.php - Enhanced Financial Ledger & Reports
// Author: ARHAM ERP System
// Date: 2024
// Version: 3.0

// 1. ENABLE ERROR REPORTING
error_reporting(E_ALL);
ini_set('display_errors', 1);
date_default_timezone_set('Asia/Karachi');

require 'includes/header.php'; 

// 2. FALLBACK HELPER (Prevents Crash)
if (!function_exists('logActivity')) { 
    function logActivity($pdo, $action, $details) {
        try {
            $stmt = $pdo->prepare("INSERT INTO system_logs (user_id, action, details, ip_address) VALUES (?, ?, ?, ?)");
            $stmt->execute([$_SESSION['user_id'] ?? 0, $action, $details, $_SERVER['REMOTE_ADDR'] ?? '']);
        } catch (Exception $e) {
            // Silent fail
        }
    }
}

// 3. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

$allowed_ids = [1, 14, 15]; 
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role'] ?? '') === 'admin');

if (!$is_admin) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED: Financial Reports Access Required</div></div>");
}

// 4. HANDLE DELETE (Admin Only)
if (isset($_POST['delete_id'])) {
    $id = $_POST['delete_id'];
    $reason = $_POST['delete_reason'] ?? 'No reason provided';
    
    try {
        $pdo->beginTransaction();
        
        // Fetch entry to reverse balance
        $stmt = $pdo->prepare("SELECT * FROM finance_ledger WHERE id = ?");
        $stmt->execute([$id]);
        $entry = $stmt->fetch();
        
        if($entry) {
            $acct = $entry['account_head'];
            $amt = $entry['amount'];
            $type = $entry['type'];
            $desc = $entry['description'];
            
            // Reverse Balance Logic
            if (in_array($type, ['income', 'sale', 'loan_return', 'adjustment'])) {
                // Was Income/Positive, so Remove from Balance
                $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name = ?")->execute([$amt, $acct]);
            } elseif (in_array($type, ['expense', 'purchase', 'loan_given', 'transfer'])) {
                // Was Expense/Negative, so Add back to Balance
                $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ? WHERE account_name = ?")->execute([$amt, $acct]);
            }
            
            // Archive before deletion
            $stmt = $pdo->prepare("INSERT INTO deleted_transactions 
                                  (original_id, trans_date, type, category, description, amount, account_head, 
                                   invoice_no, payment_method, deleted_by, deleted_at, delete_reason)
                                  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), ?)");
            $stmt->execute([$id, $entry['trans_date'], $entry['type'], $entry['category'], 
                           $entry['description'], $entry['amount'], $entry['account_head'],
                           $entry['invoice_no'], $entry['payment_method'], $_SESSION['user_id'], $reason]);
            
            // Delete from ledger
            $pdo->prepare("DELETE FROM finance_ledger WHERE id = ?")->execute([$id]);
            
            // Log activity
            logActivity($pdo, 'Delete Transaction', "Deleted ID: $id - $desc - Reason: $reason");
            
            $pdo->commit();
            $success_msg = "‚úÖ Transaction deleted and balance reverted successfully!";
        }
    } catch (Exception $e) {
        $pdo->rollBack();
        $error_msg = "‚ùå Delete failed: " . $e->getMessage();
    }
}

// 5. HANDLE BULK ACTIONS
if (isset($_POST['bulk_action']) && isset($_POST['selected_ids'])) {
    $action = $_POST['bulk_action'];
    $selected_ids = $_POST['selected_ids'];
    
    if ($action === 'export' && !empty($selected_ids)) {
        // Prepare export data
        $ids = implode(',', array_map('intval', $selected_ids));
        $stmt = $pdo->prepare("SELECT * FROM finance_ledger WHERE id IN ($ids) ORDER BY trans_date DESC");
        $stmt->execute();
        $export_data = $stmt->fetchAll();
        
        // Generate CSV
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=financial_report_' . date('Y-m-d_H-i') . '.csv');
        
        $output = fopen('php://output', 'w');
        fputcsv($output, ['ID', 'Date', 'Type', 'Category', 'Description', 'Amount', 'Account', 'Invoice #', 'Payment Method']);
        
        foreach ($export_data as $row) {
            fputcsv($output, [
                $row['id'],
                $row['trans_date'],
                $row['type'],
                $row['category'],
                $row['description'],
                $row['amount'],
                $row['account_head'],
                $row['invoice_no'] ?? '',
                $row['payment_method'] ?? ''
            ]);
        }
        fclose($output);
        exit();
    }
}

// 6. DATE & FILTER LOGIC
$start = $_GET['start'] ?? date('Y-m-01'); // Default: 1st of this month
$end = $_GET['end'] ?? date('Y-m-d');     // Default: Today
$type_filter = $_GET['type'] ?? '';
$category_filter = $_GET['category'] ?? '';
$account_filter = $_GET['account'] ?? '';
$search = $_GET['search'] ?? '';
$min_amount = $_GET['min_amount'] ?? '';
$max_amount = $_GET['max_amount'] ?? '';
$sort_by = $_GET['sort_by'] ?? 'id_desc';
$items_per_page = $_GET['limit'] ?? 50;
$page = $_GET['page'] ?? 1;
$offset = ($page - 1) * $items_per_page;

// Validate dates
if (strtotime($start) > strtotime($end)) {
    $temp = $start;
    $start = $end;
    $end = $temp;
}

// Build Query
$sql = "SELECT SQL_CALC_FOUND_ROWS * FROM finance_ledger WHERE 1=1";
$params = [];
$types = [];

if (!empty($start)) {
    $sql .= " AND trans_date >= ?";
    $params[] = $start;
    $types[] = 'date';
}

if (!empty($end)) {
    $sql .= " AND trans_date <= ?";
    $params[] = $end;
    $types[] = 'date';
}

if (!empty($type_filter)) {
    $sql .= " AND type = ?";
    $params[] = $type_filter;
    $types[] = 'string';
}

if (!empty($category_filter)) {
    $sql .= " AND category = ?";
    $params[] = $category_filter;
    $types[] = 'string';
}

if (!empty($account_filter)) {
    $sql .= " AND account_head = ?";
    $params[] = $account_filter;
    $types[] = 'string';
}

if (!empty($search)) {
    $sql .= " AND (description LIKE ? OR invoice_no LIKE ? OR account_head LIKE ?)";
    $search_term = "%$search%";
    $params[] = $search_term;
    $params[] = $search_term;
    $params[] = $search_term;
    $types = array_merge($types, ['string', 'string', 'string']);
}

if (!empty($min_amount)) {
    $sql .= " AND amount >= ?";
    $params[] = $min_amount;
    $types[] = 'float';
}

if (!empty($max_amount)) {
    $sql .= " AND amount <= ?";
    $params[] = $max_amount;
    $types[] = 'float';
}

// Sorting
$sort_options = [
    'id_desc' => 'id DESC',
    'id_asc' => 'id ASC',
    'date_desc' => 'trans_date DESC, id DESC',
    'date_asc' => 'trans_date ASC, id ASC',
    'amount_desc' => 'amount DESC',
    'amount_asc' => 'amount ASC'
];

$sql .= " ORDER BY " . ($sort_options[$sort_by] ?? 'id DESC');

// Pagination
$sql .= " LIMIT ? OFFSET ?";
$params[] = (int)$items_per_page;
$params[] = (int)$offset;
$types = array_merge($types, ['int', 'int']);

// Execute
try {
    $stmt = $pdo->prepare($sql);
    
    // Bind parameters with types
    foreach ($params as $i => $param) {
        $type = $types[$i] ?? 'string';
        switch ($type) {
            case 'int': $stmt->bindValue($i+1, $param, PDO::PARAM_INT); break;
            case 'float': $stmt->bindValue($i+1, $param, PDO::PARAM_STR); break;
            case 'date': $stmt->bindValue($i+1, $param, PDO::PARAM_STR); break;
            default: $stmt->bindValue($i+1, $param, PDO::PARAM_STR);
        }
    }
    
    $stmt->execute();
    $rows = $stmt->fetchAll();
    
    // Get total count
    $total_stmt = $pdo->query("SELECT FOUND_ROWS()");
    $total_rows = $total_stmt->fetchColumn();
    $total_pages = ceil($total_rows / $items_per_page);
    
} catch (PDOException $e) {
    die("<div class='alert alert-danger'>SQL Error: " . $e->getMessage() . "</div>");
}

// Calculate Totals
$total_in = 0; 
$total_out = 0;
$category_totals = [];
$account_totals = [];

foreach ($rows as $r) {
    $is_income = in_array($r['type'], ['income', 'sale', 'loan_return', 'adjustment']);
    $amount = (float)$r['amount'];
    
    if ($is_income) {
        $total_in += $amount;
    } else {
        $total_out += $amount;
    }
    
    // Category totals
    $category = $r['category'] ?? 'Uncategorized';
    if (!isset($category_totals[$category])) {
        $category_totals[$category] = ['in' => 0, 'out' => 0];
    }
    if ($is_income) {
        $category_totals[$category]['in'] += $amount;
    } else {
        $category_totals[$category]['out'] += $amount;
    }
    
    // Account totals
    $account = $r['account_head'] ?? 'Unknown';
    if (!isset($account_totals[$account])) {
        $account_totals[$account] = ['in' => 0, 'out' => 0];
    }
    if ($is_income) {
        $account_totals[$account]['in'] += $amount;
    } else {
        $account_totals[$account]['out'] += $amount;
    }
}

// Fetch unique categories and accounts for filters
$categories = $pdo->query("SELECT DISTINCT category FROM finance_ledger WHERE category != '' ORDER BY category")->fetchAll();
$accounts = $pdo->query("SELECT DISTINCT account_head FROM finance_ledger WHERE account_head != '' ORDER BY account_head")->fetchAll();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Ledger & Reports - ARHAM ERP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Styles for Financial Reports */
        :root {
            --report-primary: #2c3e50;
            --report-secondary: #3498db;
            --report-success: #27ae60;
            --report-danger: #e74c3c;
            --report-warning: #f39c12;
            --report-info: #1abc9c;
            --report-light: #f8f9fa;
            --report-dark: #212529;
        }
        
        .report-gradient {
            background: linear-gradient(135deg, var(--report-primary) 0%, var(--report-secondary) 100%);
            color: white;
        }
        
        .report-card {
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            border-left: 5px solid;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.05), rgba(255,255,255,0));
            z-index: 1;
        }
        
        .stat-card-content {
            position: relative;
            z-index: 2;
        }
        
        .transaction-type-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .type-income {
            background: rgba(39, 174, 96, 0.15);
            color: var(--report-success);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }
        
        .type-expense {
            background: rgba(231, 76, 60, 0.15);
            color: var(--report-danger);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .type-transfer {
            background: rgba(52, 152, 219, 0.15);
            color: var(--report-secondary);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .type-adjustment {
            background: rgba(155, 89, 182, 0.15);
            color: #9b59b6;
            border: 1px solid rgba(155, 89, 182, 0.3);
        }
        
        .category-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .filter-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            margin: 2px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .nav-tabs .nav-link {
            color: #6c757d;
            font-weight: 600;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 24px;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--report-primary);
            border-bottom-color: rgba(44, 62, 80, 0.3);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--report-primary);
            border-bottom-color: var(--report-primary);
            background: transparent;
        }
        
        .data-table th {
            background: var(--report-primary);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            padding: 15px 12px;
            border: none;
        }
        
        .data-table td {
            padding: 12px;
            vertical-align: middle;
            border-color: #f0f0f0;
        }
        
        .data-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .amount-cell {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .checkbox-cell {
            width: 40px;
        }
        
        .pagination-custom .page-link {
            color: var(--report-primary);
            border: 1px solid #dee2e6;
            margin: 0 2px;
            border-radius: 8px;
        }
        
        .pagination-custom .page-item.active .page-link {
            background: var(--report-primary);
            border-color: var(--report-primary);
            color: white;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
        }
        
        .export-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            color: white;
        }
        
        .bulk-actions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .report-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
        
        /* Animation for new entries */
        @keyframes highlightRow {
            0% { background-color: rgba(52, 152, 219, 0.3); }
            100% { background-color: transparent; }
        }
        
        .highlight-new {
            animation: highlightRow 2s ease-out;
        }
        
        /* Summary cards */
        .summary-card {
            border-radius: 10px;
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255,255,255,0.1);
            transform: rotate(30deg);
        }
        
        .summary-card-income {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .summary-card-expense {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .summary-card-net {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        /* Filter panel */
        .filter-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>

<div class="container-fluid py-3">
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-1">
                        <i class="fas fa-chart-line text-primary"></i> Financial Ledger & Reports
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="dashboard.php">Dashboard</a></li>
                            <li class="breadcrumb-item active">Financial Reports</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex gap-2">
                    <button onclick="window.print()" class="btn btn-outline-dark btn-sm">
                        <i class="fas fa-print me-1"></i> Print
                    </button>
                    <a href="financial_reports.php?export=pdf&start=<?php echo $start; ?>&end=<?php echo $end; ?>" 
                       class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-file-pdf me-1"></i> PDF
                    </a>
                    <button class="btn export-btn btn-sm" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-1"></i> Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <?php if(isset($success_msg)): ?>
        <div class="alert alert-success alert-dismissible fade show animate__animated animate__fadeInDown" role="alert">
            <i class="fas fa-check-circle me-2"></i> <?php echo $success_msg; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>
    
    <?php if(isset($error_msg)): ?>
        <div class="alert alert-danger alert-dismissible fade show animate__animated animate__shakeX" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i> <?php echo $error_msg; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>

    <!-- Summary Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="summary-card summary-card-income">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="opacity-75 d-block mb-1">TOTAL INCOME</small>
                        <h3 class="fw-bold mb-2">Rs. <?php echo number_format($total_in); ?></h3>
                        <small class="opacity-75">
                            <i class="fas fa-arrow-up me-1"></i> Positive transactions
                        </small>
                    </div>
                    <i class="fas fa-arrow-down fa-2x opacity-25"></i>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="summary-card summary-card-expense">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="opacity-75 d-block mb-1">TOTAL EXPENSE</small>
                        <h3 class="fw-bold mb-2">Rs. <?php echo number_format($total_out); ?></h3>
                        <small class="opacity-75">
                            <i class="fas fa-arrow-down me-1"></i> Negative transactions
                        </small>
                    </div>
                    <i class="fas fa-arrow-up fa-2x opacity-25"></i>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="summary-card summary-card-net">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="opacity-75 d-block mb-1">NET BALANCE</small>
                        <h3 class="fw-bold mb-2 <?php echo ($total_in - $total_out) >= 0 ? 'text-success' : 'text-danger'; ?>">
                            Rs. <?php echo number_format($total_in - $total_out); ?>
                        </h3>
                        <small class="opacity-75">
                            <i class="fas fa-balance-scale me-1"></i> Income - Expense
                        </small>
                    </div>
                    <i class="fas fa-chart-line fa-2x opacity-25"></i>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="report-card bg-white p-3 h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted d-block mb-1">TRANSACTIONS</small>
                        <h4 class="fw-bold mb-2"><?php echo number_format($total_rows); ?></h4>
                        <small class="text-muted">
                            Showing <?php echo count($rows); ?> of <?php echo number_format($total_rows); ?>
                        </small>
                    </div>
                    <i class="fas fa-receipt fa-2x text-muted"></i>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar" style="width: <?php echo min(100, (count($rows) / max(1, $total_rows)) * 100); ?>%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Controls -->
    <div class="filter-panel mb-4">
        <form method="GET" id="filterForm" class="row g-3">
            <!-- Date Range -->
            <div class="col-md-3">
                <label class="form-label fw-bold small">Date Range</label>
                <div class="input-group input-group-sm">
                    <input type="date" name="start" class="form-control" value="<?php echo $start; ?>">
                    <span class="input-group-text">to</span>
                    <input type="date" name="end" class="form-control" value="<?php echo $end; ?>">
                </div>
            </div>
            
            <!-- Type Filter -->
            <div class="col-md-2">
                <label class="form-label fw-bold small">Transaction Type</label>
                <select name="type" class="form-select form-select-sm">
                    <option value="">All Types</option>
                    <option value="sale" <?php echo $type_filter == 'sale' ? 'selected' : ''; ?>>Sales</option>
                    <option value="expense" <?php echo $type_filter == 'expense' ? 'selected' : ''; ?>>Expenses</option>
                    <option value="purchase" <?php echo $type_filter == 'purchase' ? 'selected' : ''; ?>>Purchases</option>
                    <option value="income" <?php echo $type_filter == 'income' ? 'selected' : ''; ?>>Other Income</option>
                    <option value="loan_given" <?php echo $type_filter == 'loan_given' ? 'selected' : ''; ?>>Loans Given</option>
                    <option value="loan_return" <?php echo $type_filter == 'loan_return' ? 'selected' : ''; ?>>Loan Returns</option>
                    <option value="transfer" <?php echo $type_filter == 'transfer' ? 'selected' : ''; ?>>Transfers</option>
                    <option value="adjustment" <?php echo $type_filter == 'adjustment' ? 'selected' : ''; ?>>Adjustments</option>
                </select>
            </div>
            
            <!-- Category Filter -->
            <div class="col-md-2">
                <label class="form-label fw-bold small">Category</label>
                <select name="category" class="form-select form-select-sm">
                    <option value="">All Categories</option>
                    <?php foreach($categories as $cat): ?>
                        <option value="<?php echo htmlspecialchars($cat['category']); ?>" 
                            <?php echo $category_filter == $cat['category'] ? 'selected' : ''; ?>>
                            <?php echo htmlspecialchars($cat['category']); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <!-- Account Filter -->
            <div class="col-md-2">
                <label class="form-label fw-bold small">Account</label>
                <select name="account" class="form-select form-select-sm">
                    <option value="">All Accounts</option>
                    <?php foreach($accounts as $acc): ?>
                        <option value="<?php echo htmlspecialchars($acc['account_head']); ?>" 
                            <?php echo $account_filter == $acc['account_head'] ? 'selected' : ''; ?>>
                            <?php echo htmlspecialchars($acc['account_head']); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <!-- Amount Range -->
            <div class="col-md-3">
                <label class="form-label fw-bold small">Amount Range</label>
                <div class="input-group input-group-sm">
                    <input type="number" name="min_amount" class="form-control" placeholder="Min" 
                           value="<?php echo $min_amount; ?>">
                    <span class="input-group-text">to</span>
                    <input type="number" name="max_amount" class="form-control" placeholder="Max" 
                           value="<?php echo $max_amount; ?>">
                </div>
            </div>
            
            <!-- Search -->
            <div class="col-md-4">
                <label class="form-label fw-bold small">Search</label>
                <div class="input-group input-group-sm">
                    <input type="text" name="search" class="form-control" placeholder="Description, Invoice #, Account..." 
                           value="<?php echo htmlspecialchars($search); ?>">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Sort & Limit -->
            <div class="col-md-2">
                <label class="form-label fw-bold small">Sort By</label>
                <select name="sort_by" class="form-select form-select-sm">
                    <option value="id_desc" <?php echo $sort_by == 'id_desc' ? 'selected' : ''; ?>>Newest First</option>
                    <option value="id_asc" <?php echo $sort_by == 'id_asc' ? 'selected' : ''; ?>>Oldest First</option>
                    <option value="date_desc" <?php echo $sort_by == 'date_desc' ? 'selected' : ''; ?>>Date (Newest)</option>
                    <option value="date_asc" <?php echo $sort_by == 'date_asc' ? 'selected' : ''; ?>>Date (Oldest)</option>
                    <option value="amount_desc" <?php echo $sort_by == 'amount_desc' ? 'selected' : ''; ?>>Amount (High to Low)</option>
                    <option value="amount_asc" <?php echo $sort_by == 'amount_asc' ? 'selected' : ''; ?>>Amount (Low to High)</option>
                </select>
            </div>
            
            <div class="col-md-1">
                <label class="form-label fw-bold small">Per Page</label>
                <select name="limit" class="form-select form-select-sm">
                    <option value="20" <?php echo $items_per_page == 20 ? 'selected' : ''; ?>>20</option>
                    <option value="50" <?php echo $items_per_page == 50 ? 'selected' : ''; ?>>50</option>
                    <option value="100" <?php echo $items_per_page == 100 ? 'selected' : ''; ?>>100</option>
                    <option value="200" <?php echo $items_per_page == 200 ? 'selected' : ''; ?>>200</option>
                    <option value="500" <?php echo $items_per_page == 500 ? 'selected' : ''; ?>>500</option>
                </select>
            </div>
            
            <!-- Action Buttons -->
            <div class="col-md-2 d-flex align-items-end">
                <div class="d-flex gap-2 w-100">
                    <button type="submit" class="btn btn-primary btn-sm flex-fill">
                        <i class="fas fa-filter me-1"></i> Apply
                    </button>
                    <a href="financial_reports.php" class="btn btn-secondary btn-sm">
                        <i class="fas fa-sync-alt"></i>
                    </a>
                </div>
            </div>
        </form>
        
        <!-- Active Filters -->
        <div class="mt-3">
            <small class="fw-bold text-muted me-2">Active Filters:</small>
            <?php if($start && $end): ?>
                <span class="filter-tag">
                    Date: <?php echo date('d M', strtotime($start)); ?> - <?php echo date('d M', strtotime($end)); ?>
                    <a href="?" class="ms-1 text-danger"><i class="fas fa-times"></i></a>
                </span>
            <?php endif; ?>
            <?php if($type_filter): ?>
                <span class="filter-tag">
                    Type: <?php echo ucfirst($type_filter); ?>
                    <a href="?<?php echo http_build_query(array_merge($_GET, ['type' => ''])); ?>" class="ms-1 text-danger"><i class="fas fa-times"></i></a>
                </span>
            <?php endif; ?>
            <?php if($search): ?>
                <span class="filter-tag">
                    Search: "<?php echo htmlspecialchars($search); ?>"
                    <a href="?<?php echo http_build_query(array_merge($_GET, ['search' => ''])); ?>" class="ms-1 text-danger"><i class="fas fa-times"></i></a>
                </span>
            <?php endif; ?>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions no-print">
        <form method="POST" id="bulkForm" onsubmit="return confirmBulkAction()">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label fw-bold small" for="selectAll">
                            Select All (<?php echo count($rows); ?>)
                        </label>
                    </div>
                    <select name="bulk_action" class="form-select form-select-sm" style="width: auto;">
                        <option value="">Bulk Actions</option>
                        <option value="export">Export Selected</option>
                        <option value="delete" disabled>Delete Selected</option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                </div>
                <div class="text-muted small">
                    <i class="fas fa-info-circle me-1"></i>
                    Total: <?php echo number_format($total_rows); ?> transactions
                </div>
            </div>
            <input type="hidden" name="selected_ids" id="selectedIds">
        </form>
    </div>

    <!-- Main Table -->
    <div class="report-card bg-white mb-4">
        <div class="table-responsive">
            <table class="table data-table mb-0">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectPage" class="form-check-input">
                        </th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Account</th>
                        <th class="text-end">Amount</th>
                        <th>Invoice</th>
                        <th class="text-end no-print">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (count($rows) > 0): ?>
                        <?php foreach($rows as $r): 
                            $is_income = in_array($r['type'], ['income', 'sale', 'loan_return', 'adjustment']);
                            $type_class = $is_income ? 'type-income' : 'type-expense';
                            if ($r['type'] == 'transfer') $type_class = 'type-transfer';
                            if ($r['type'] == 'adjustment') $type_class = 'type-adjustment';
                            
                            $color = $is_income ? 'text-success' : 'text-danger';
                            if ($r['type'] == 'transfer') $color = 'text-info';
                            if ($r['type'] == 'adjustment') $color = 'text-purple';
                            
                            // Invoice Link
                            $ref = "-";
                            if (!empty($r['invoice_no'])) {
                                $ref = "<a href='invoice.php?id={$r['invoice_no']}' target='_blank' class='badge bg-light text-dark border text-decoration-none'>{$r['invoice_no']}</a>";
                            } elseif (!empty($r['related_id']) && $r['category']=='Utility Bill') {
                                $ref = "<a href='invoice_bill.php?id={$r['related_id']}' target='_blank' class='badge bg-warning text-dark'>BILL #{$r['related_id']}</a>";
                            }
                        ?>
                        <tr id="row-<?php echo $r['id']; ?>" class="<?php echo (isset($_GET['highlight']) && $_GET['highlight'] == $r['id']) ? 'highlight-new' : ''; ?>">
                            <td class="checkbox-cell">
                                <input type="checkbox" class="form-check-input row-checkbox" value="<?php echo $r['id']; ?>">
                            </td>
                            <td>
                                <div class="fw-bold"><?php echo date('d M Y', strtotime($r['trans_date'])); ?></div>
                                <small class="text-muted"><?php echo date('h:i A', strtotime($r['trans_date'])); ?></small>
                            </td>
                            <td>
                                <span class="transaction-type-badge <?php echo $type_class; ?>">
                                    <?php echo strtoupper($r['type']); ?>
                                </span>
                            </td>
                            <td>
                                <span class="category-badge">
                                    <?php echo htmlspecialchars($r['category']); ?>
                                </span>
                            </td>
                            <td>
                                <div class="fw-bold"><?php echo htmlspecialchars($r['description']); ?></div>
                                <?php if($r['payment_method']): ?>
                                    <small class="text-muted">Method: <?php echo $r['payment_method']; ?></small>
                                <?php endif; ?>
                            </td>
                            <td>
                                <span class="fw-bold text-primary"><?php echo $r['account_head']; ?></span>
                            </td>
                            <td class="text-end amount-cell fw-bold <?php echo $color; ?>">
                                <?php echo ($is_income ? '+' : '-'); ?> Rs. <?php echo number_format($r['amount']); ?>
                            </td>
                            <td><?php echo $ref; ?></td>
                            <td class="text-end no-print">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary border-0 dropdown-toggle" 
                                            type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="showTransactionDetails(<?php echo $r['id']; ?>)">
                                                <i class="fas fa-eye me-2"></i> View Details
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="editTransaction(<?php echo $r['id']; ?>)">
                                                <i class="fas fa-edit me-2"></i> Edit
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <form method="POST" class="d-inline" 
                                                  onsubmit="return confirmDelete(<?php echo $r['id']; ?>, '<?php echo addslashes($r['description']); ?>')">
                                                <input type="hidden" name="delete_id" value="<?php echo $r['id']; ?>">
                                                <input type="hidden" name="delete_reason" id="delete_reason_<?php echo $r['id']; ?>" value="">
                                                <button type="submit" class="dropdown-item text-danger">
                                                    <i class="fas fa-trash me-2"></i> Delete
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    <?php else: ?>
                        <tr>
                            <td colspan="9" class="text-center py-5 text-muted">
                                <i class="fas fa-folder-open fa-3x mb-3 text-secondary opacity-25"></i><br>
                                No transactions found for the selected filters.
                                <?php if($start || $end || $type_filter || $search): ?>
                                    <div class="mt-2">
                                        <a href="financial_reports.php" class="btn btn-sm btn-outline-primary">
                                            Clear all filters
                                        </a>
                                    </div>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endif; ?>
                </tbody>
                
                <!-- Summary Footer -->
                <tfoot class="bg-light fw-bold border-top">
                    <tr>
                        <td colspan="5" class="text-end pt-3">SUMMARY:</td>
                        <td class="text-center pt-3"><?php echo count($rows); ?> transactions</td>
                        <td class="text-end pt-3">
                            <div class="text-success">+ Rs. <?php echo number_format($total_in); ?></div>
                            <div class="text-danger">- Rs. <?php echo number_format($total_out); ?></div>
                        </td>
                        <td colspan="2" class="text-end pt-3">
                            <span class="<?php echo ($total_in - $total_out) >= 0 ? 'text-success' : 'text-danger'; ?>">
                                NET: Rs. <?php echo number_format($total_in - $total_out); ?>
                            </span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <?php if($total_pages > 1): ?>
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-custom justify-content-center">
                    <li class="page-item <?php echo $page <= 1 ? 'disabled' : ''; ?>">
                        <a class="page-link" href="?<?php echo http_build_query(array_merge($_GET, ['page' => $page - 1])); ?>">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    
                    <?php for($i = max(1, $page - 2); $i <= min($total_pages, $page + 2); $i++): ?>
                        <li class="page-item <?php echo $i == $page ? 'active' : ''; ?>">
                            <a class="page-link" href="?<?php echo http_build_query(array_merge($_GET, ['page' => $i])); ?>">
                                <?php echo $i; ?>
                            </a>
                        </li>
                    <?php endfor; ?>
                    
                    <li class="page-item <?php echo $page >= $total_pages ? 'disabled' : ''; ?>">
                        <a class="page-link" href="?<?php echo http_build_query(array_merge($_GET, ['page' => $page + 1])); ?>">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="text-center text-muted small">
                Page <?php echo $page; ?> of <?php echo $total_pages; ?> ‚Ä¢ 
                <?php echo number_format($total_rows); ?> total transactions
            </div>
        </div>
    </div>
    <?php endif; ?>

    <!-- Analytics & Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="report-card bg-white p-4 h-100">
                <h5 class="fw-bold border-bottom pb-2 mb-3">
                    <i class="fas fa-chart-pie me-2 text-primary"></i>Category Analysis
                </h5>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Top 10 categories by total amount</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="report-card bg-white p-4 h-100">
                <h5 class="fw-bold border-bottom pb-2 mb-3">
                    <i class="fas fa-chart-bar me-2 text-success"></i>Daily Trend
                </h5>
                <div class="chart-container">
                    <canvas id="dailyTrendChart"></canvas>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Daily income vs expense for selected period</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="report-card bg-white p-4">
                <h5 class="fw-bold border-bottom pb-2 mb-3">
                    <i class="fas fa-university me-2 text-info"></i>Account Summary
                </h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th class="text-end">Income</th>
                                <th class="text-end">Expense</th>
                                <th class="text-end">Net</th>
                                <th class="text-end">% of Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php 
                            arsort($account_totals);
                            $counter = 0;
                            foreach($account_totals as $account => $totals): 
                                if($counter++ >= 10) break;
                                $net = $totals['in'] - $totals['out'];
                                $percentage = ($total_in + $total_out) > 0 ? 
                                    (($totals['in'] + $totals['out']) / ($total_in + $total_out)) * 100 : 0;
                            ?>
                            <tr>
                                <td class="fw-bold"><?php echo htmlspecialchars($account); ?></td>
                                <td class="text-end text-success">+ Rs. <?php echo number_format($totals['in']); ?></td>
                                <td class="text-end text-danger">- Rs. <?php echo number_format($totals['out']); ?></td>
                                <td class="text-end fw-bold <?php echo $net >= 0 ? 'text-success' : 'text-danger'; ?>">
                                    <?php echo ($net >= 0 ? '+' : '-'); ?> Rs. <?php echo number_format(abs($net)); ?>
                                </td>
                                <td class="text-end">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: <?php echo $percentage; ?>%"></div>
                                    </div>
                                    <small class="text-muted"><?php echo number_format($percentage, 1); ?>%</small>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Reports -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="report-card bg-white p-4">
                <h5 class="fw-bold border-bottom pb-2 mb-3">
                    <i class="fas fa-bolt me-2 text-warning"></i>Quick Reports
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="financial_reports.php?type=sale&start=<?php echo date('Y-m-d'); ?>&end=<?php echo date('Y-m-d'); ?>" 
                           class="card text-decoration-none border h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-shopping-cart fa-2x text-primary mb-3"></i>
                                <h6>Today's Sales</h6>
                                <small class="text-muted">View all sales today</small>
                            </div>
                        </a>
                    </div>
                    
                    <div class="col-md-3">
                        <a href="financial_reports.php?type=expense&start=<?php echo date('Y-m-01'); ?>&end=<?php echo date('Y-m-d'); ?>" 
                           class="card text-decoration-none border h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-receipt fa-2x text-danger mb-3"></i>
                                <h6>Monthly Expenses</h6>
                                <small class="text-muted">This month's expenses</small>
                            </div>
                        </a>
                    </div>
                    
                    <div class="col-md-3">
                        <a href="financial_reports.php?type=transfer" 
                           class="card text-decoration-none border h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-exchange-alt fa-2x text-info mb-3"></i>
                                <h6>All Transfers</h6>
                                <small class="text-muted">Internal transfers</small>
                            </div>
                        </a>
                    </div>
                    
                    <div class="col-md-3">
                        <a href="invoice_history.php" 
                           class="card text-decoration-none border h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-history fa-2x text-success mb-3"></i>
                                <h6>Invoice History</h6>
                                <small class="text-muted">All invoices</small>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this transaction?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    This action will reverse the balance in the affected account.
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Reason for deletion:</label>
                    <textarea id="deleteReasonInput" class="form-control" rows="2" 
                              placeholder="Please provide a reason for deleting this transaction..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Transaction Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transactionDetails">
                Loading...
            </div>
        </div>
    </div>
</div>

<script>
// Chart Data Preparation
const categoryData = <?php 
    $chart_categories = [];
    $chart_amounts = [];
    $counter = 0;
    foreach($category_totals as $category => $totals) {
        if($counter++ >= 10) break;
        $chart_categories[] = $category;
        $chart_amounts[] = abs($totals['in'] + $totals['out']);
    }
    echo json_encode([
        'categories' => $chart_categories,
        'amounts' => $chart_amounts
    ]);
?>;

// Daily Trend Data
const dailyData = <?php
    // Get daily data for selected period
    $stmt = $pdo->prepare("SELECT 
        DATE(trans_date) as date,
        SUM(CASE WHEN type IN ('income', 'sale', 'loan_return', 'adjustment') THEN amount ELSE 0 END) as income,
        SUM(CASE WHEN type IN ('expense', 'purchase', 'loan_given', 'transfer') THEN amount ELSE 0 END) as expense
        FROM finance_ledger 
        WHERE trans_date BETWEEN ? AND ?
        GROUP BY DATE(trans_date)
        ORDER BY date ASC");
    $stmt->execute([$start, $end]);
    $daily_stats = $stmt->fetchAll();
    
    $dates = [];
    $income = [];
    $expense = [];
    
    foreach($daily_stats as $day) {
        $dates[] = date('d M', strtotime($day['date']));
        $income[] = $day['income'];
        $expense[] = $day['expense'];
    }
    
    echo json_encode([
        'dates' => $dates,
        'income' => $income,
        'expense' => $expense
    ]);
?>;

// Initialize Charts
document.addEventListener('DOMContentLoaded', function() {
    // Category Pie Chart
    const ctx1 = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: categoryData.categories,
            datasets: [{
                data: categoryData.amounts,
                backgroundColor: [
                    '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                    '#1abc9c', '#d35400', '#c0392b', '#7f8c8d', '#34495e'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Daily Trend Chart
    const ctx2 = document.getElementById('dailyTrendChart').getContext('2d');
    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: dailyData.dates,
            datasets: [
                {
                    label: 'Income',
                    data: dailyData.income,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Expense',
                    data: dailyData.expense,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Rs. ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
});

// Bulk Selection
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedIds();
});

document.getElementById('selectPage').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedIds();
});

document.querySelectorAll('.row-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedIds);
});

function updateSelectedIds() {
    const selected = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                         .map(cb => cb.value);
    document.getElementById('selectedIds').value = JSON.stringify(selected);
}

function confirmBulkAction() {
    const action = document.querySelector('select[name="bulk_action"]').value;
    const selectedIds = JSON.parse(document.getElementById('selectedIds').value || '[]');
    
    if (selectedIds.length === 0) {
        alert('Please select at least one transaction.');
        return false;
    }
    
    if (action === 'export') {
        return true;
    }
    
    return false;
}

// Delete Confirmation
let pendingDeleteId = null;
let pendingDeleteForm = null;

function confirmDelete(id, description) {
    pendingDeleteId = id;
    pendingDeleteForm = event.target.closest('form');
    
    document.getElementById('deleteReasonInput').value = '';
    document.getElementById('deleteReasonInput').focus();
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
    
    return false;
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    const reason = document.getElementById('deleteReasonInput').value.trim();
    if (!reason) {
        alert('Please provide a reason for deletion.');
        return;
    }
    
    document.getElementById('delete_reason_' + pendingDeleteId).value = reason;
    pendingDeleteForm.submit();
});

// Transaction Details
function showTransactionDetails(id) {
    fetch(`api_transaction_details.php?id=${id}`)
        .then(response => response.json())
        .then(data => {
            const modalBody = document.getElementById('transactionDetails');
            modalBody.innerHTML = `
                <div class="row g-3">
                    <div class="col-6">
                        <strong>Transaction ID:</strong><br>
                        <span class="badge bg-primary">${data.id}</span>
                    </div>
                    <div class="col-6">
                        <strong>Date:</strong><br>
                        ${new Date(data.trans_date).toLocaleDateString()} ${new Date(data.trans_date).toLocaleTimeString()}
                    </div>
                    <div class="col-12">
                        <strong>Description:</strong><br>
                        ${data.description}
                    </div>
                    <div class="col-6">
                        <strong>Type:</strong><br>
                        <span class="badge ${data.type === 'income' || data.type === 'sale' ? 'bg-success' : 'bg-danger'}">
                            ${data.type.toUpperCase()}
                        </span>
                    </div>
                    <div class="col-6">
                        <strong>Category:</strong><br>
                        ${data.category}
                    </div>
                    <div class="col-6">
                        <strong>Amount:</strong><br>
                        <span class="fw-bold ${data.type === 'income' || data.type === 'sale' ? 'text-success' : 'text-danger'}">
                            ${data.type === 'income' || data.type === 'sale' ? '+' : '-'} Rs. ${Number(data.amount).toLocaleString()}
                        </span>
                    </div>
                    <div class="col-6">
                        <strong>Account:</strong><br>
                        ${data.account_head}
                    </div>
                    ${data.invoice_no ? `
                    <div class="col-12">
                        <strong>Invoice:</strong><br>
                        <a href="invoice.php?id=${data.invoice_no}" target="_blank">${data.invoice_no}</a>
                    </div>` : ''}
                    ${data.payment_method ? `
                    <div class="col-12">
                        <strong>Payment Method:</strong><br>
                        ${data.payment_method}
                    </div>` : ''}
                    <div class="col-12">
                        <strong>Created:</strong><br>
                        ${new Date(data.created_at || data.trans_date).toLocaleString()}
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load transaction details.');
        });
}

function editTransaction(id) {
    // Redirect to edit page or show edit modal
    alert('Edit functionality for transaction #' + id + ' would open here.');
    // window.location.href = `edit_transaction.php?id=${id}`;
}

// Export to Excel
function exportToExcel() {
    const params = new URLSearchParams(window.location.search);
    params.append('export', 'excel');
    window.location.href = `financial_reports.php?${params.toString()}`;
}

// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl + F to focus search
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.querySelector('input[name="search"]').focus();
    }
    
    // Ctrl + E to export
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        exportToExcel();
    }
    
    // Ctrl + P to print
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        window.print();
    }
});

// Auto-refresh every 2 minutes for live updates
setTimeout(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 120000);

// Filter form submission with loading indicator
document.getElementById('filterForm').addEventListener('submit', function() {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Loading...';
    submitBtn.disabled = true;
    
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 2000);
});

// Initialize tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Highlight new rows on page load
document.querySelectorAll('.highlight-new').forEach(row => {
    setTimeout(() => {
        row.classList.remove('highlight-new');
    }, 2000);
});
</script>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\index.php
==============================================================================

<?php
// FILE: index.php
session_start();

// 1. Security Check
if (!isset($_SESSION['user_id'])) {
    // Not logged in? Go to Login
    header("Location: login.php");
    exit();
} else {
    // Logged in? Go to Dashboard
    header("Location: dashboard.php");
    exit();
}
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\inventory.php
==============================================================================

<?php 
require 'includes/header.php'; 

// --- 1. GUARANTEED ACCESS CHECK ---
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit(); }

$allowed_ids = [1, 14, 15]; // IDs from SQL Dump
$is_admin = false;

if (in_array($_SESSION['user_id'], $allowed_ids)) {
    $is_admin = true;
} elseif (isset($_SESSION['role']) && strtolower(trim($_SESSION['role'])) === 'admin') {
    $is_admin = true;
}

$has_perm = (isset($_SESSION['permissions']['shop']) && $_SESSION['permissions']['shop'] == 1);

if (!$is_admin && !$has_perm) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow'>‚õî ACCESS DENIED (Inventory)</div></div>");
}

// --- 2. ADMIN ACTIONS ---
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    
    // Safety check for Edit/Delete
    if (isset($_POST['update_item']) || isset($_POST['delete_item'])) {
        if (!$is_admin) {
            die("<script>alert('‚õî Access Denied: Only Admin can modify items.'); window.location='inventory.php';</script>");
        }
    }

    if (isset($_POST['update_item'])) {
        $id = $_POST['id'];
        $name = $_POST['name'];
        $price = $_POST['price'];
        $stock = $_POST['stock'];
        $pdo->prepare("UPDATE inventory SET item_name=?, sale_price=?, stock_qty=? WHERE id=?")->execute([$name, $price, $stock, $id]);
        echo "<div class='alert alert-success'>Item Updated!</div>";
    }

    if (isset($_POST['delete_item'])) {
        $id = $_POST['delete_item'];
        $pdo->prepare("DELETE FROM inventory WHERE id=?")->execute([$id]);
        echo "<div class='alert alert-warning'>Item Deleted!</div>";
    }
}

$items = $pdo->query("SELECT * FROM inventory ORDER BY item_name ASC")->fetchAll();
$total_value = $pdo->query("SELECT SUM(sale_price * stock_qty) FROM inventory WHERE stock_qty > 0")->fetchColumn();
?>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-boxes text-primary"></i> Inventory Manager</h3>
    <?php if($is_admin): ?>
    <div class="bg-white p-2 px-3 rounded-pill shadow-sm border">
        <small class="text-muted fw-bold">TOTAL STOCK VALUE:</small>
        <span class="text-success fw-bold">Rs. <?php echo number_format($total_value); ?></span>
    </div>
    <?php endif; ?>
</div>

<div class="glass-panel p-0 overflow-hidden">
    <table class="table table-hover mb-0 align-middle">
        <thead class="bg-dark text-white">
            <tr>
                <th class="ps-4">Item Name</th>
                <th>Stock Level</th>
                <th>Sale Price</th>
                <?php if($is_admin): ?><th class="text-end pe-4">Actions</th><?php endif; ?>
            </tr>
        </thead>
        <tbody>
            <?php foreach($items as $i): ?>
            <tr>
                <td class="ps-4 fw-bold"><?php echo $i['item_name']; ?></td>
                <td>
                    <?php 
                    if($i['stock_qty'] < 5) echo '<span class="badge bg-danger">Low: '.$i['stock_qty'].'</span>';
                    elseif($i['stock_qty'] < 0) echo '<span class="badge bg-secondary">Unlimited</span>';
                    else echo '<span class="badge bg-success">In Stock: '.$i['stock_qty'].'</span>';
                    ?>
                </td>
                <td class="text-primary fw-bold">Rs. <?php echo number_format($i['sale_price']); ?></td>
                
                <?php if($is_admin): ?>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick='editItem(<?php echo json_encode($i); ?>)'>
                        <i class="fas fa-edit"></i>
                    </button>
                    <form method="POST" class="d-inline" onsubmit="return confirm('Permanently delete this item?');">
                        <input type="hidden" name="delete_item" value="<?php echo $i['id']; ?>">
                        <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                    </form>
                </td>
                <?php endif; ?>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>

<?php if($is_admin): ?>
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Edit Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="update_item" value="1">
                    <input type="hidden" name="id" id="edit_id">
                    
                    <div class="mb-3">
                        <label>Item Name</label>
                        <input type="text" name="name" id="edit_name" class="form-control" required>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label>Sale Price</label>
                            <input type="number" name="price" id="edit_price" class="form-control" required>
                        </div>
                        <div class="col-6">
                            <label>Stock Qty</label>
                            <input type="number" name="stock" id="edit_stock" class="form-control" required>
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <button class="btn btn-success w-100 rounded-pill">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let editModal = new bootstrap.Modal(document.getElementById('editModal'));
function editItem(item) {
    document.getElementById('edit_id').value = item.id;
    document.getElementById('edit_name').value = item.item_name;
    document.getElementById('edit_price').value = item.sale_price;
    document.getElementById('edit_stock').value = item.stock_qty;
    editModal.show();
}
</script>
<?php endif; ?>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\invoice.php
==============================================================================

<?php
// FILE: invoice.php (Enhanced Version)
require 'includes/config.php';

// 1. SECURITY & VALIDATION
if (!isset($_GET['id'])) {
    die("<div class='alert alert-danger text-center p-5'>‚ùå Invalid Invoice ID</div>");
}

$invoice_id = preg_replace('/[^0-9A-Z]/', '', $_GET['id']); // Clean input

// 2. FETCH SHOP SETTINGS
$settings = [];
try {
    $stmt = $pdo->query("SELECT * FROM system_settings");
    while ($row = $stmt->fetch()) {
        $settings[$row['setting_key']] = $row['setting_value'];
    }
} catch (Exception $e) {
    // Use defaults if settings table doesn't exist
}

$shop_name = $settings['shop_name'] ?? "ARHAM PRINTERS";
$shop_address = $settings['shop_address'] ?? "Jalalpur Jattan";
$shop_phone = $settings['shop_phone'] ?? "0300-1234567";
$shop_email = $settings['shop_email'] ?? "info@arhamprinters.com";
$footer_msg = $settings['invoice_footer'] ?? "Thank you for your business!";

// 3. FETCH INVOICE ITEMS
$stmt = $pdo->prepare("SELECT * FROM finance_ledger WHERE invoice_no = ?");
$stmt->execute([$invoice_id]);
$items = $stmt->fetchAll();

if (empty($items)) {
    die("<div class='alert alert-warning text-center p-5'>
            <i class='fas fa-exclamation-triangle fa-2x mb-3'></i><br>
            Invoice #$invoice_id not found in system.
        </div>");
}

// 4. CALCULATE TOTALS & CONSTRUCT DATA
$total_amount = 0;
$tax_rate = 0; // You can add tax logic later
$subtotal = 0;
$item_count = 0;
$invoice_date = '';

foreach ($items as $item) {
    $total_amount += $item['amount'];
    $item_count++;
    if (empty($invoice_date)) {
        $invoice_date = $item['trans_date'];
    }
}

$subtotal = $total_amount;
$tax_amount = ($subtotal * $tax_rate) / 100;
$grand_total = $subtotal + $tax_amount;

// 5. GET CUSTOMER DETAILS (if available)
$customer_name = "Walk-in Customer";
$customer_phone = "";
$customer_address = "";

// Check if there's a customer ID in the ledger
foreach ($items as $item) {
    if (!empty($item['description'])) {
        // Try to extract customer name from description
        if (strpos($item['description'], 'Customer:') !== false) {
            $customer_name = trim(str_replace('Customer:', '', $item['description']));
            $customer_name = substr($customer_name, 0, strpos($customer_name, '(') ?: strlen($customer_name));
        }
    }
}

// 6. WHATSAPP MESSAGE CONSTRUCTION
$wa_msg = "*INVOICE RECEIPT - $shop_name*%0a";
$wa_msg .= "Invoice #: $invoice_id%0a";
$wa_msg .= "Date: " . date('d-M-Y h:i A', strtotime($invoice_date)) . "%0a";
$wa_msg .= "Customer: $customer_name%0a";
$wa_msg .= "------------------------%0a";

foreach ($items as $index => $item) {
    $wa_msg .= ($index + 1) . ". " . substr($item['description'], 0, 40) . "%0a";
    $wa_msg .= "   Rs. " . number_format($item['amount']) . "%0a";
}

$wa_msg .= "------------------------%0a";
$wa_msg .= "Subtotal: Rs. " . number_format($subtotal) . "%0a";

if ($tax_amount > 0) {
    $wa_msg .= "Tax ($tax_rate%): Rs. " . number_format($tax_amount) . "%0a";
}

$wa_msg .= "*GRAND TOTAL: Rs. " . number_format($grand_total) . "*%0a";
$wa_msg .= "------------------------%0a";
$wa_msg .= $footer_msg . "%0a";
$wa_msg .= "Shop: $shop_name%0a";
$wa_msg .= "Phone: $shop_phone";

// 7. GENERATE UNIQUE FILENAME FOR PRINT
$print_filename = "Invoice_" . $invoice_id . "_" . date('Ymd_His');
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice #<?php echo $invoice_id; ?> - <?php echo $shop_name; ?></title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 12px;
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        /* Header Controls */
        .header-controls {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-controls h1 {
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-controls h1 i {
            color: var(--secondary-color);
        }
        
        .controls-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .invoice-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: right;
        }
        
        .invoice-id {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-color);
            letter-spacing: 1px;
        }
        
        .invoice-date {
            font-size: 14px;
            color: #6c757d;
        }
        
        /* Main Invoice Container */
        .invoice-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 25px;
            position: relative;
        }
        
        /* Invoice Header */
        .invoice-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .shop-info h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
        }
        
        .shop-info p {
            opacity: 0.9;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .shop-info i {
            margin-right: 8px;
            width: 20px;
        }
        
        .invoice-logo {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .invoice-logo .logo-icon {
            font-size: 40px;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .invoice-logo .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* Invoice Body */
        .invoice-body {
            padding: 30px;
        }
        
        /* Customer & Shop Details */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #eee;
        }
        
        .detail-box {
            background: var(--light-color);
            padding: 20px;
            border-radius: 10px;
        }
        
        .detail-box h3 {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
        }
        
        .detail-value {
            color: #212529;
            flex: 1;
        }
        
        /* Items Table */
        .items-table-container {
            margin-bottom: 40px;
            overflow-x: auto;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .items-table thead {
            background: var(--primary-color);
            color: white;
        }
        
        .items-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .items-table tbody tr {
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .items-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .items-table td {
            padding: 15px;
            vertical-align: top;
        }
        
        .item-description {
            max-width: 300px;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Totals Section */
        .totals-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .total-label {
            color: #495057;
        }
        
        .total-value {
            font-weight: 600;
        }
        
        .grand-total {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-color);
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
            margin-top: 15px;
        }
        
        /* Footer */
        .invoice-footer {
            background: #f8f9fa;
            padding: 25px;
            text-align: center;
            border-top: 1px solid #dee2e6;
        }
        
        .footer-message {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .payment-method {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .payment-method span {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            min-width: 160px;
        }
        
        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-dark {
            background: var(--dark-color);
            color: white;
        }
        
        .btn-dark:hover {
            background: #23272b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 58, 64, 0.3);
        }
        
        /* WhatsApp Input */
        .whatsapp-input {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .whatsapp-input label {
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .whatsapp-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            min-width: 250px;
        }
        
        .whatsapp-input input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-paid {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success-color);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .status-pending {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning-color);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
                padding: 0;
                font-size: 12px;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .header-controls,
            .action-buttons,
            .whatsapp-input,
            .no-print {
                display: none !important;
            }
            
            .invoice-container {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .invoice-header {
                padding: 20px;
            }
            
            .shop-info h2 {
                font-size: 20px;
            }
            
            .invoice-body {
                padding: 20px;
            }
            
            .details-grid {
                gap: 20px;
                margin-bottom: 20px;
            }
            
            .items-table th,
            .items-table td {
                padding: 8px;
            }
            
            .btn {
                display: none;
            }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .controls-right {
                justify-content: center;
                margin-top: 15px;
            }
            
            .invoice-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
            }
            
            .whatsapp-input {
                flex-direction: column;
                align-items: stretch;
            }
            
            .whatsapp-input input {
                min-width: auto;
            }
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out;
        }
    </style>
</head>
<body>
    <div class="container animate-fade-in">
        <!-- Header with Controls -->
        <div class="header-controls">
            <h1>
                <i class="fas fa-file-invoice"></i>
                Invoice Receipt
            </h1>
            <div class="controls-right">
                <div class="invoice-info">
                    <div class="invoice-id">#<?php echo $invoice_id; ?></div>
                    <div class="invoice-date">
                        <i class="far fa-calendar-alt"></i>
                        <?php echo date('d F Y, h:i A', strtotime($invoice_date)); ?>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- WhatsApp Input Section -->
        <div class="whatsapp-input no-print">
            <label for="wa_number">
                <i class="fab fa-whatsapp text-success"></i>
                Send to WhatsApp:
            </label>
            <input type="text" 
                   id="wa_number" 
                   placeholder="Enter mobile number (e.g., 923001234567)" 
                   value="<?php echo !empty($customer_phone) ? $customer_phone : ''; ?>">
            <a href="#" id="wa_link" class="btn btn-success">
                <i class="fab fa-whatsapp"></i>
                Send Receipt
            </a>
        </div>
        
        <!-- Main Invoice Container -->
        <div class="invoice-container">
            <!-- Header -->
            <div class="invoice-header">
                <div class="shop-info">
                    <h2><?php echo htmlspecialchars($shop_name); ?></h2>
                    <p><i class="fas fa-map-marker-alt"></i> <?php echo htmlspecialchars($shop_address); ?></p>
                    <p><i class="fas fa-phone"></i> <?php echo htmlspecialchars($shop_phone); ?></p>
                    <?php if(!empty($shop_email)): ?>
                    <p><i class="fas fa-envelope"></i> <?php echo htmlspecialchars($shop_email); ?></p>
                    <?php endif; ?>
                </div>
                <div class="invoice-logo">
                    <div class="logo-icon">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="logo-text">INVOICE</div>
                </div>
            </div>
            
            <!-- Body -->
            <div class="invoice-body">
                <!-- Customer & Invoice Details -->
                <div class="details-grid">
                    <div class="detail-box">
                        <h3><i class="fas fa-user-circle"></i> Customer Details</h3>
                        <div class="detail-row">
                            <span class="detail-label">Name:</span>
                            <span class="detail-value fw-bold"><?php echo htmlspecialchars($customer_name); ?></span>
                        </div>
                        <?php if(!empty($customer_phone)): ?>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value"><?php echo htmlspecialchars($customer_phone); ?></span>
                        </div>
                        <?php endif; ?>
                        <?php if(!empty($customer_address)): ?>
                        <div class="detail-row">
                            <span class="detail-label">Address:</span>
                            <span class="detail-value"><?php echo htmlspecialchars($customer_address); ?></span>
                        </div>
                        <?php endif; ?>
                    </div>
                    
                    <div class="detail-box">
                        <h3><i class="fas fa-info-circle"></i> Invoice Details</h3>
                        <div class="detail-row">
                            <span class="detail-label">Invoice #:</span>
                            <span class="detail-value fw-bold text-primary"><?php echo $invoice_id; ?></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Date:</span>
                            <span class="detail-value"><?php echo date('d M Y, h:i A', strtotime($invoice_date)); ?></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">
                                <span class="status-badge status-paid">PAID</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Items:</span>
                            <span class="detail-value"><?php echo $item_count; ?> item(s)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Items Table -->
                <div class="items-table-container">
                    <h3 style="margin-bottom: 15px; color: var(--primary-color);">
                        <i class="fas fa-list-alt"></i> Items Purchased
                    </h3>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 60%;">Description</th>
                                <th style="width: 15%;" class="text-center">Category</th>
                                <th style="width: 20%;" class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($items as $index => $item): ?>
                            <tr>
                                <td class="text-center"><?php echo $index + 1; ?></td>
                                <td class="item-description">
                                    <div class="fw-bold"><?php echo htmlspecialchars($item['description']); ?></div>
                                    <?php if(!empty($item['payment_method'])): ?>
                                    <small class="text-muted">Method: <?php echo $item['payment_method']; ?></small>
                                    <?php endif; ?>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark border">
                                        <?php echo strtoupper($item['category']); ?>
                                    </span>
                                </td>
                                <td class="text-right fw-bold">
                                    Rs. <?php echo number_format($item['amount'], 2); ?>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
                
                <!-- Totals -->
                <div class="totals-section">
                    <div class="total-row">
                        <span class="total-label">Subtotal:</span>
                        <span class="total-value">Rs. <?php echo number_format($subtotal, 2); ?></span>
                    </div>
                    
                    <?php if ($tax_amount > 0): ?>
                    <div class="total-row">
                        <span class="total-label">Tax (<?php echo $tax_rate; ?>%):</span>
                        <span class="total-value">Rs. <?php echo number_format($tax_amount, 2); ?></span>
                    </div>
                    <?php endif; ?>
                    
                    <div class="total-row grand-total">
                        <span class="total-label">GRAND TOTAL:</span>
                        <span class="total-value">Rs. <?php echo number_format($grand_total, 2); ?></span>
                    </div>
                </div>
                
                <!-- Footer Message -->
                <div class="invoice-footer">
                    <div class="footer-message">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <?php echo htmlspecialchars($footer_msg); ?>
                    </div>
                    
                    <div class="payment-method">
                        <span><i class="fas fa-money-bill-wave"></i> Cash</span>
                        <span><i class="fas fa-credit-card"></i> Card</span>
                        <span><i class="fas fa-mobile-alt"></i> Mobile Payment</span>
                        <span><i class="fas fa-university"></i> Bank Transfer</span>
                    </div>
                    
                    <div style="font-size: 12px; color: #6c757d;">
                        <p>This is a computer-generated invoice. No signature required.</p>
                        <p>For any queries, contact: <?php echo $shop_phone; ?></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons no-print">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i>
                Print Invoice
            </button>
            
            <button onclick="downloadAsPDF()" class="btn btn-warning">
                <i class="fas fa-download"></i>
                Download PDF
            </button>
            
            <a href="dashboard.php" class="btn btn-dark">
                <i class="fas fa-home"></i>
                Back to Dashboard
            </a>
            
            <button onclick="window.close()" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Close Window
            </button>
        </div>
    </div>

    <script>
        // WhatsApp Integration
        document.addEventListener('DOMContentLoaded', function() {
            const waInput = document.getElementById('wa_number');
            const waLink = document.getElementById('wa_link');
            
            function updateWhatsAppLink() {
                let number = waInput.value.trim();
                
                // Clean and format number
                number = number.replace(/\D/g, ''); // Remove non-digits
                
                if (number.length === 0) {
                    waLink.href = '#';
                    waLink.style.opacity = '0.5';
                    waLink.style.cursor = 'not-allowed';
                    waLink.onclick = function(e) { 
                        e.preventDefault(); 
                        alert('Please enter a phone number');
                        waInput.focus();
                    };
                    return;
                }
                
                // Ensure it starts with country code
                if (number.startsWith('0')) {
                    number = '92' + number.substring(1);
                }
                
                if (!number.startsWith('92')) {
                    number = '92' + number;
                }
                
                const message = `<?php echo str_replace(["%0a"], ["\\n"], addslashes($wa_msg)); ?>`;
                const encodedMessage = encodeURIComponent(message);
                
                waLink.href = `https://wa.me/${number}?text=${encodedMessage}`;
                waLink.style.opacity = '1';
                waLink.style.cursor = 'pointer';
                waLink.onclick = null;
                waLink.target = '_blank';
            }
            
            // Initialize
            updateWhatsAppLink();
            
            // Update on input change
            waInput.addEventListener('input', updateWhatsAppLink);
            waInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (waLink.href !== '#') {
                        window.open(waLink.href, '_blank');
                    }
                }
            });
            
            // Auto-print option (comment out if not needed)
            // setTimeout(() => {
            //     if (confirm('Do you want to print this invoice?')) {
            //         window.print();
            //     }
            // }, 1000);
        });
        
        // Download as PDF (using browser's print to PDF)
        function downloadAsPDF() {
            window.print();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+P for print
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
            
            // Ctrl+W to close
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                window.close();
            }
            
            // Escape to go back
            if (e.key === 'Escape') {
                window.history.back();
            }
        });
        
        // Copy invoice number to clipboard
        function copyInvoiceNumber() {
            const invoiceNumber = '<?php echo $invoice_id; ?>';
            navigator.clipboard.writeText(invoiceNumber).then(() => {
                alert('Invoice number copied to clipboard: ' + invoiceNumber);
            });
        }
        
        // Share invoice via Web Share API if available
        function shareInvoice() {
            if (navigator.share) {
                navigator.share({
                    title: 'Invoice #<?php echo $invoice_id; ?>',
                    text: 'Check out this invoice from <?php echo $shop_name; ?>',
                    url: window.location.href,
                })
                .catch(console.error);
            } else {
                alert('Web Share API not supported in your browser');
            }
        }
    </script>
</body>
</html>
<?php
// Log invoice view for analytics (optional)
try {
    $log_stmt = $pdo->prepare("INSERT INTO invoice_views (invoice_no, viewed_at, ip_address) VALUES (?, NOW(), ?)");
    $log_stmt->execute([$invoice_id, $_SERVER['REMOTE_ADDR']]);
} catch (Exception $e) {
    // Silently fail - table might not exist
}
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\invoice_bill.php
==============================================================================

<?php
// FILE: invoice_bill.php (Enhanced Version)
require 'includes/config.php';

// 1. SECURITY & VALIDATION
if (!isset($_GET['id'])) {
    die("<div class='alert alert-danger text-center p-5'>‚ùå Invalid Bill ID</div>");
}

$bill_id = (int)$_GET['id'];

// 2. FETCH BILL DETAILS
try {
    $stmt = $pdo->prepare("SELECT * FROM bill_queue WHERE id = ?");
    $stmt->execute([$bill_id]);
    $bill = $stmt->fetch();
    
    if (!$bill) {
        die("<div class='alert alert-warning text-center p-5'>
                <i class='fas fa-exclamation-triangle fa-2x mb-3'></i><br>
                Bill #$bill_id not found in system.
            </div>");
    }
} catch (Exception $e) {
    die("<div class='alert alert-danger'>Database Error: " . htmlspecialchars($e->getMessage()) . "</div>");
}

// 3. FETCH SHOP SETTINGS
$settings = [];
try {
    $stmt = $pdo->query("SELECT * FROM system_settings");
    while ($row = $stmt->fetch()) {
        $settings[$row['setting_key']] = $row['setting_value'];
    }
} catch (Exception $e) {
    // Use defaults
}

$shop_name = $settings['shop_name'] ?? "ARHAM PRINTERS";
$shop_address = $settings['shop_address'] ?? "Jalalpur Jattan";
$shop_phone = $settings['shop_phone'] ?? "0300-1234567";
$footer_msg = $settings['invoice_footer'] ?? "Thank you for using our bill payment service!";

// 4. FORMAT DATA
$bill_date = date('d F Y, h:i A', strtotime($bill['created_at']));
$payment_date = ($bill['status'] == 'paid' && !empty($bill['paid_at'])) 
    ? date('d F Y, h:i A', strtotime($bill['paid_at'])) 
    : $bill_date;

// 5. FETCH TRANSACTION DETAILS IF AVAILABLE
$transaction_info = null;
if (!empty($bill['transaction_id'])) {
    try {
        $trans_stmt = $pdo->prepare("SELECT * FROM finance_ledger WHERE description LIKE ? ORDER BY id DESC LIMIT 1");
        $trans_stmt->execute(["%" . $bill['consumer_number'] . "%"]);
        $transaction_info = $trans_stmt->fetch();
    } catch (Exception $e) {
        // Silently fail
    }
}

// 6. WHATSAPP MESSAGE
$wa_msg = "*BILL PAYMENT RECEIPT - $shop_name*%0a";
$wa_msg .= "Receipt #: BILL-" . $bill['id'] . "%0a";
$wa_msg .= "Bill Type: " . $bill['bill_type'] . "%0a";
$wa_msg .= "Reference #: " . $bill['consumer_number'] . "%0a";
$wa_msg .= "Customer: " . ($bill['consumer_name'] ?: 'Walk-in Customer') . "%0a";
$wa_msg .= "Date: " . $payment_date . "%0a";
$wa_msg .= "------------------------%0a";
$wa_msg .= "Amount: Rs. " . number_format($bill['amount']) . "%0a";
$wa_msg .= "Status: " . strtoupper($bill['status']) . "%0a";

if (!empty($bill['transaction_id'])) {
    $wa_msg .= "TID: " . $bill['transaction_id'] . "%0a";
}

$wa_msg .= "Payment Mode: " . strtoupper($bill['payment_status']) . "%0a";
$wa_msg .= "------------------------%0a";
$wa_msg .= $footer_msg . "%0a";
$wa_msg .= "Shop: $shop_name%0a";
$wa_msg .= "Phone: $shop_phone";

// 7. PREPARE CUSTOMER MOBILE FOR WHATSAPP
$customer_mobile = '';
if (!empty($bill['mobile_no'])) {
    $customer_mobile = preg_replace('/[^0-9]/', '', $bill['mobile_no']);
    if (strlen($customer_mobile) === 11 && substr($customer_mobile, 0, 2) === '03') {
        $customer_mobile = '92' . substr($customer_mobile, 1);
    }
}

// 8. CHECK IF BILL HAS BEEN PROCESSED IN LEDGER
$is_processed = false;
if ($bill['status'] == 'paid') {
    $check_stmt = $pdo->prepare("SELECT COUNT(*) FROM finance_ledger WHERE description LIKE ? AND category = 'Utility Bill'");
    $check_stmt->execute(["%" . $bill['consumer_number'] . "%"]);
    $is_processed = $check_stmt->fetchColumn() > 0;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Receipt #<?php echo $bill_id; ?> - <?php echo $shop_name; ?></title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --light-color: #f5f5f5;
            --dark-color: #212121;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 850px;
            margin: 0 auto;
        }
        
        /* Header */
        .receipt-header {
            background: white;
            border-radius: 15px 15px 0 0;
            padding: 25px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .shop-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .shop-icon {
            background: var(--primary-color);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .shop-details h1 {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }
        
        .shop-details p {
            color: #666;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .receipt-meta {
            text-align: right;
        }
        
        .receipt-id {
            font-size: 32px;
            font-weight: 900;
            color: var(--danger-color);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .receipt-type {
            background: var(--info-color);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Main Content */
        .receipt-body {
            background: white;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        /* Status Banner */
        .status-banner {
            padding: 20px 30px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-left h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .status-left p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .status-badge {
            background: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 800;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-paid {
            color: var(--success-color);
        }
        
        .status-pending {
            color: var(--warning-color);
        }
        
        /* Receipt Content */
        .receipt-content {
            padding: 30px;
        }
        
        /* Bill Info Grid */
        .bill-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--info-color);
        }
        
        .info-card h3 {
            font-size: 16px;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            min-width: 140px;
        }
        
        .info-value {
            color: #222;
            font-weight: 500;
            flex: 1;
        }
        
        .highlight {
            color: var(--danger-color);
            font-weight: 700;
            font-size: 16px;
        }
        
        /* Amount Display */
        .amount-display {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 3px dashed #4caf50;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }
        
        .amount-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
        }
        
        .amount-label {
            font-size: 18px;
            color: #388e3c;
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .amount-value {
            font-size: 48px;
            font-weight: 900;
            color: #1b5e20;
            margin: 10px 0;
        }
        
        .amount-words {
            font-size: 16px;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }
        
        /* Transaction Details */
        .transaction-card {
            background: #fff8e1;
            border: 2px solid #ffd54f;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .transaction-card h3 {
            color: #ff8f00;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Footer */
        .receipt-footer {
            background: #f5f5f5;
            padding: 25px 30px;
            border-top: 2px solid #eee;
            text-align: center;
        }
        
        .footer-message {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .security-code {
            background: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            letter-spacing: 2px;
            color: #333;
            margin: 15px auto;
            max-width: 300px;
            border: 1px dashed #ccc;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 16px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            text-align: center;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(26, 35, 126, 0.3);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #388e3c;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.3);
        }
        
        .btn-dark {
            background: var(--dark-color);
            color: white;
        }
        
        .btn-dark:hover {
            background: #424242;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 33, 33, 0.3);
        }
        
        /* WhatsApp Input */
        .whatsapp-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .whatsapp-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .whatsapp-icon {
            background: #25D366;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .whatsapp-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .whatsapp-input-group input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .whatsapp-input-group input:focus {
            outline: none;
            border-color: #25D366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }
        
        /* Watermark */
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 100px;
            font-weight: 900;
            color: rgba(0,0,0,0.05);
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
                padding: 0;
                font-size: 12px;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .whatsapp-section,
            .action-buttons,
            .no-print {
                display: none !important;
            }
            
            .receipt-body {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .receipt-header {
                padding: 15px;
            }
            
            .shop-details h1 {
                font-size: 20px;
            }
            
            .receipt-id {
                font-size: 24px;
            }
            
            .receipt-content {
                padding: 20px;
            }
            
            .amount-value {
                font-size: 36px;
            }
            
            .watermark {
                opacity: 0.1;
            }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .receipt-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .shop-brand {
                flex-direction: column;
                text-align: center;
            }
            
            .receipt-meta {
                text-align: center;
            }
            
            .bill-info-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .status-banner {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .whatsapp-input-group {
                flex-direction: column;
            }
            
            .whatsapp-input-group input {
                width: 100%;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .amount-value {
                font-size: 36px;
            }
            
            .watermark {
                font-size: 60px;
            }
        }
        
        /* Animation */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        /* Number to Words Helper */
        .number-words {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container animate-slide-in">
        <!-- WhatsApp Input Section -->
        <div class="whatsapp-section no-print">
            <div class="whatsapp-header">
                <div class="whatsapp-icon">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <div>
                    <h3 style="margin: 0; color: #075e54;">Send Receipt via WhatsApp</h3>
                    <p style="color: #666; margin: 5px 0 0 0;">Enter customer's mobile number</p>
                </div>
            </div>
            <div class="whatsapp-input-group">
                <input type="text" 
                       id="wa_number" 
                       placeholder="e.g., 03001234567 or 923001234567" 
                       value="<?php echo htmlspecialchars($customer_mobile); ?>">
                <a href="#" id="wa_link" class="btn btn-success" style="min-width: 200px;">
                    <i class="fab fa-whatsapp"></i>
                    Send Receipt
                </a>
            </div>
        </div>
        
        <!-- Main Receipt -->
        <div class="receipt-body">
            <!-- Watermark -->
            <div class="watermark">
                <?php echo strtoupper($bill['status']); ?>
            </div>
            
            <!-- Header -->
            <div class="receipt-header">
                <div class="shop-brand">
                    <div class="shop-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="shop-details">
                        <h1><?php echo htmlspecialchars($shop_name); ?></h1>
                        <p><i class="fas fa-map-marker-alt"></i> <?php echo htmlspecialchars($shop_address); ?></p>
                        <p><i class="fas fa-phone"></i> <?php echo htmlspecialchars($shop_phone); ?></p>
                    </div>
                </div>
                <div class="receipt-meta">
                    <div class="receipt-id">BILL-<?php echo $bill_id; ?></div>
                    <div class="receipt-type">Bill Payment Receipt</div>
                </div>
            </div>
            
            <!-- Status Banner -->
            <div class="status-banner">
                <div class="status-left">
                    <h2><?php echo strtoupper($bill['bill_type']); ?> Bill Payment</h2>
                    <p>Payment processed successfully</p>
                </div>
                <div class="status-badge <?php echo 'status-' . $bill['status']; ?>">
                    <?php echo strtoupper($bill['status']); ?>
                </div>
            </div>
            
            <!-- Receipt Content -->
            <div class="receipt-content">
                <!-- Bill Information -->
                <div class="bill-info-grid">
                    <div class="info-card">
                        <h3><i class="fas fa-user-tag"></i> Customer Details</h3>
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value highlight"><?php echo htmlspecialchars($bill['consumer_name'] ?: 'Walk-in Customer'); ?></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Reference #:</span>
                            <span class="info-value"><?php echo htmlspecialchars($bill['consumer_number']); ?></span>
                        </div>
                        <?php if(!empty($bill['mobile_no'])): ?>
                        <div class="info-row">
                            <span class="info-label">Mobile:</span>
                            <span class="info-value"><?php echo htmlspecialchars($bill['mobile_no']); ?></span>
                        </div>
                        <?php endif; ?>
                        <div class="info-row">
                            <span class="info-label">Payment Mode:</span>
                            <span class="info-value">
                                <span style="color: <?php echo $bill['payment_status'] == 'cash' ? '#4caf50' : '#ff9800'; ?>; font-weight: 700;">
                                    <?php echo strtoupper($bill['payment_status']); ?>
                                </span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3><i class="fas fa-receipt"></i> Payment Details</h3>
                        <div class="info-row">
                            <span class="info-label">Bill Type:</span>
                            <span class="info-value"><?php echo htmlspecialchars($bill['bill_type']); ?></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Date:</span>
                            <span class="info-value"><?php echo $bill_date; ?></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Payment Date:</span>
                            <span class="info-value"><?php echo $payment_date; ?></span>
                        </div>
                        <?php if(!empty($bill['transaction_id'])): ?>
                        <div class="info-row">
                            <span class="info-label">Transaction ID:</span>
                            <span class="info-value" style="font-family: monospace; color: #d32f2f;">
                                <?php echo htmlspecialchars($bill['transaction_id']); ?>
                            </span>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
                
                <!-- Amount Display -->
                <div class="amount-display">
                    <div class="amount-label">Total Amount Paid</div>
                    <div class="amount-value">Rs. <?php echo number_format($bill['amount'], 2); ?></div>
                    <div class="amount-words">
                        (<?php echo numberToWords($bill['amount']); ?>)
                    </div>
                </div>
                
                <!-- Transaction Details -->
                <?php if($transaction_info): ?>
                <div class="transaction-card">
                    <h3><i class="fas fa-exchange-alt"></i> Transaction Record</h3>
                    <div class="info-row">
                        <span class="info-label">Ledger Entry:</span>
                        <span class="info-value">#<?php echo $transaction_info['id']; ?></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Description:</span>
                        <span class="info-value"><?php echo htmlspecialchars($transaction_info['description']); ?></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Account:</span>
                        <span class="info-value"><?php echo htmlspecialchars($transaction_info['account_head']); ?></span>
                    </div>
                </div>
                <?php endif; ?>
                
                <!-- Footer -->
                <div class="receipt-footer">
                    <div class="footer-message">
                        <i class="fas fa-shield-alt text-primary me-2"></i>
                        <?php echo htmlspecialchars($footer_msg); ?>
                    </div>
                    
                    <?php if($is_processed): ?>
                    <div style="color: #4caf50; margin: 10px 0;">
                        <i class="fas fa-check-circle me-2"></i>
                        This bill has been recorded in financial ledger
                    </div>
                    <?php endif; ?>
                    
                    <div class="security-code">
                        SECURITY CODE: <?php echo strtoupper(md5($bill_id . $bill['consumer_number'])); ?>
                    </div>
                    
                    <div style="font-size: 12px; color: #888; margin-top: 15px;">
                        <p>This is an official payment receipt. Please retain for your records.</p>
                        <p>For verification, call: <?php echo $shop_phone; ?></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons no-print">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i>
                Print Receipt
            </button>
            
            <a href="night_mode.php" class="btn btn-dark">
                <i class="fas fa-moon"></i>
                Back to Queue
            </a>
            
            <a href="bills.php" class="btn btn-warning">
                <i class="fas fa-plus-circle"></i>
                New Bill
            </a>
            
            <button onclick="downloadReceipt()" class="btn btn-danger">
                <i class="fas fa-download"></i>
                Download PDF
            </button>
            
            <button onclick="shareReceipt()" class="btn btn-success">
                <i class="fas fa-share-alt"></i>
                Share
            </button>
        </div>
    </div>

    <script>
        // WhatsApp Integration
        document.addEventListener('DOMContentLoaded', function() {
            const waInput = document.getElementById('wa_number');
            const waLink = document.getElementById('wa_link');
            
            function updateWhatsAppLink() {
                let number = waInput.value.trim();
                
                // Clean number
                number = number.replace(/\D/g, '');
                
                if (number.length === 0) {
                    waLink.href = '#';
                    waLink.style.opacity = '0.6';
                    waLink.onclick = function(e) {
                        e.preventDefault();
                        alert('Please enter a phone number');
                        waInput.focus();
                    };
                    return;
                }
                
                // Format for Pakistan
                if (number.startsWith('0')) {
                    number = '92' + number.substring(1);
                }
                
                if (!number.startsWith('92')) {
                    number = '92' + number;
                }
                
                const message = `<?php echo str_replace(["%0a"], ["\\n"], addslashes($wa_msg)); ?>`;
                const encodedMessage = encodeURIComponent(message);
                
                waLink.href = `https://wa.me/${number}?text=${encodedMessage}`;
                waLink.style.opacity = '1';
                waLink.onclick = null;
                waLink.target = '_blank';
            }
            
            // Initialize
            updateWhatsAppLink();
            
            // Update on input
            waInput.addEventListener('input', updateWhatsAppLink);
            
            // Enter key to send
            waInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (waLink.href !== '#') {
                        window.open(waLink.href, '_blank');
                    }
                }
            });
            
            // Auto-focus on input
            waInput.focus();
            
            // Select all text
            waInput.select();
        });
        
        // Download as PDF
        function downloadReceipt() {
            window.print();
        }
        
        // Share functionality
        function shareReceipt() {
            if (navigator.share) {
                navigator.share({
                    title: 'Bill Receipt #<?php echo $bill_id; ?>',
                    text: 'Payment receipt for <?php echo $bill['bill_type']; ?> bill',
                    url: window.location.href,
                })
                .catch(console.error);
            } else {
                // Fallback: Copy URL to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Receipt URL copied to clipboard!');
                });
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+P for print
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
            
            // Ctrl+S for save/share
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                downloadReceipt();
            }
            
            // Ctrl+W to close
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                window.close();
            }
        });
        
        // Auto-print after 2 seconds (optional)
        // setTimeout(() => {
        //     if (confirm('Do you want to print this receipt?')) {
        //         window.print();
        //     }
        // }, 2000);
    </script>
</body>
</html>
<?php
// Helper function to convert number to words
function numberToWords($num) {
    $ones = array(
        0 => "", 1 => "One", 2 => "Two", 3 => "Three", 4 => "Four",
        5 => "Five", 6 => "Six", 7 => "Seven", 8 => "Eight", 9 => "Nine",
        10 => "Ten", 11 => "Eleven", 12 => "Twelve", 13 => "Thirteen",
        14 => "Fourteen", 15 => "Fifteen", 16 => "Sixteen",
        17 => "Seventeen", 18 => "Eighteen", 19 => "Nineteen"
    );
    
    $tens = array(
        2 => "Twenty", 3 => "Thirty", 4 => "Forty", 5 => "Fifty",
        6 => "Sixty", 7 => "Seventy", 8 => "Eighty", 9 => "Ninety"
    );
    
    if ($num == 0) {
        return "Zero";
    }
    
    // Handle decimals
    $whole = floor($num);
    $decimal = round(($num - $whole) * 100);
    
    $words = convertToWords($whole);
    
    if ($decimal > 0) {
        $words .= " and " . convertToWords($decimal) . " Paisa";
    }
    
    $words .= " Rupees Only";
    
    return $words;
}

function convertToWords($num) {
    if ($num < 20) {
        global $ones;
        return $ones[$num];
    } elseif ($num < 100) {
        global $tens;
        return $tens[floor($num / 10)] . " " . convertToWords($num % 10);
    } elseif ($num < 1000) {
        return convertToWords(floor($num / 100)) . " Hundred " . convertToWords($num % 100);
    } elseif ($num < 100000) {
        return convertToWords(floor($num / 1000)) . " Thousand " . convertToWords($num % 1000);
    } elseif ($num < 10000000) {
        return convertToWords(floor($num / 100000)) . " Lakh " . convertToWords($num % 100000);
    } else {
        return convertToWords(floor($num / 10000000)) . " Crore " . convertToWords($num % 10000000);
    }
}
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\invoice_history.php
==============================================================================

<?php 
require 'includes/header.php'; 

// SEARCH LOGIC
$search = $_GET['search'] ?? '';
$where = "1";
$params = [];

if ($search) {
    // Search Customer, Invoice #, or even Amount
    $where .= " AND (customer_name LIKE ? OR invoice_no LIKE ?)";
    $params[] = "%$search%";
    $params[] = "%$search%";
}

// FETCH DATA
$stmt = $pdo->prepare("SELECT * FROM invoices WHERE $where ORDER BY id DESC LIMIT 50");
$stmt->execute($params);
$invoices = $stmt->fetchAll();

// CUSTOMER INTELLIGENCE (If searching a person)
$cust_stats = null;
if ($search && count($invoices) > 0) {
    $cust_name = $invoices[0]['customer_name'];
    $sql = "SELECT 
            SUM(subtotal) as lifetime_sales, 
            SUM(paid_amount) as lifetime_paid,
            (SELECT (total_amount - paid_amount) FROM loans WHERE person_name = ? AND status='active') as current_debt 
            FROM invoices WHERE customer_name = ?";
    $cstmt = $pdo->prepare($sql);
    $cstmt->execute([$cust_name, $cust_name]);
    $cust_stats = $cstmt->fetch();
}
?>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-primary"><i class="fas fa-history"></i> Invoice Archives</h3>
    <form class="glass-panel p-2 d-flex" style="margin-bottom:0;">
        <input type="text" name="search" class="form-control border-0 bg-transparent fw-bold" placeholder="Search Invoice or Customer..." value="<?php echo htmlspecialchars($search); ?>">
        <button class="btn btn-dark rounded-pill px-4"><i class="fas fa-search"></i></button>
    </form>
</div>

<?php if($cust_stats): ?>
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-panel p-4" style="background: linear-gradient(135deg, #111 0%, #2c3e50 100%); color: white;">
            <div class="row align-items-center">
                <div class="col-md-4 border-end border-secondary">
                    <small class="text-uppercase text-white-50" style="letter-spacing:1px;">Customer Profile</small>
                    <h2 class="fw-bold text-info m-0" style="color: var(--brand-cyan) !important;"><?php echo $invoices[0]['customer_name']; ?></h2>
                </div>
                <div class="col-md-8">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-white-50">Lifetime Business</small>
                            <h4 class="fw-bold">Rs. <?php echo number_format($cust_stats['lifetime_sales']); ?></h4>
                        </div>
                        <div class="col-4">
                            <small class="text-white-50">Total Paid</small>
                            <h4 class="fw-bold text-success">Rs. <?php echo number_format($cust_stats['lifetime_paid']); ?></h4>
                        </div>
                        <div class="col-4">
                            <small class="text-white-50">Current Debt</small>
                            <h4 class="fw-bold text-danger">Rs. <?php echo number_format($cust_stats['current_debt'] ?? 0); ?></h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<?php endif; ?>

<div class="glass-panel p-0 overflow-hidden">
    <table class="table table-hover mb-0 align-middle">
        <thead class="bg-dark text-white">
            <tr>
                <th class="ps-4">Invoice #</th>
                <th>Date</th>
                <th>Customer / Supplier</th>
                <th>Type</th>
                <th>Total Bill</th>
                <th>Paid</th>
                <th>Status</th>
                <th class="text-end pe-4">Action</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach($invoices as $r): 
                $due = $r['grand_total'] - $r['paid_amount'];
            ?>
            <tr>
                <td class="ps-4 fw-bold" style="color: var(--brand-cyan);"><?php echo $r['invoice_no']; ?></td>
                <td><?php echo date('d M Y', strtotime($r['created_at'])); ?></td>
                <td class="fw-bold"><?php echo $r['customer_name']; ?></td>
                <td><span class="badge bg-secondary text-uppercase"><?php echo $r['type']; ?></span></td>
                <td class="fw-bold">Rs. <?php echo number_format($r['grand_total']); ?></td>
                <td class="text-success">Rs. <?php echo number_format($r['paid_amount']); ?></td>
                <td>
                    <?php if($due > 0): ?>
                        <span class="badge bg-danger">DUE: <?php echo number_format($due); ?></span>
                    <?php else: ?>
                        <span class="badge bg-success">PAID</span>
                    <?php endif; ?>
                </td>
                <td class="text-end pe-4">
                    <a href="invoice.php?id=<?php echo $r['invoice_no']; ?>" class="btn btn-sm btn-dark rounded-pill px-3">
                        View Invoice
                    </a>
                </td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\ledger_correction.php
==============================================================================

<?php 
require 'includes/header.php'; 
if ($_SESSION['role'] !== 'admin') die("Access Denied");

$id = $_GET['id'] ?? 0;
$entry = $pdo->query("SELECT * FROM finance_ledger WHERE id = $id")->fetch();
if (!$entry) die("Entry not found");

// HANDLE DELETE
if (isset($_POST['delete_entry'])) {
    // 1. Reverse the Balance Effect
    $rev_amt = $entry['amount'];
    $acct = $entry['account_head'];
    
    if (in_array($entry['type'], ['income', 'sale'])) {
        // Was income, so subtract to reverse
        $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name = ?")->execute([$rev_amt, $acct]);
    } else {
        // Was expense, so add back to reverse
        $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ? WHERE account_name = ?")->execute([$rev_amt, $acct]);
    }
    
    // 2. Delete Record
    $pdo->prepare("DELETE FROM finance_ledger WHERE id = ?")->execute([$id]);
    
    echo "<script>alert('Entry Deleted & Balance Reverted'); window.location.href='financial_reports.php';</script>";
}
?>

<div class="row justify-content-center">
    <div class="col-md-5">
        <div class="glass-panel p-4 border-danger">
            <h4 class="text-danger fw-bold">Delete Transaction?</h4>
            <div class="alert alert-warning">
                <strong>Warning:</strong> Deleting this will automatically update the 
                <strong><?php echo $entry['account_head']; ?></strong> balance.
            </div>
            
            <ul class="list-group mb-4">
                <li class="list-group-item"><strong>Date:</strong> <?php echo $entry['trans_date']; ?></li>
                <li class="list-group-item"><strong>Desc:</strong> <?php echo $entry['description']; ?></li>
                <li class="list-group-item"><strong>Amount:</strong> Rs. <?php echo number_format($entry['amount']); ?></li>
            </ul>
            
            <form method="POST">
                <input type="hidden" name="delete_entry" value="1">
                <div class="d-flex gap-2">
                    <a href="financial_reports.php" class="btn btn-light w-50">Cancel</a>
                    <button class="btn btn-danger w-50 fw-bold">Confirm Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\loans.php
==============================================================================

<?php 
require 'includes/header.php'; 

// 1. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit(); }
$allowed_ids = [1, 14, 15]; 
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');

if (!$is_admin) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED</div></div>");
}

// 2. HANDLE ACTIONS
$msg = "";
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    
    // A. ADD NEW ENTRY
    if (isset($_POST['add_entry'])) {
        $cat = $_POST['category']; 
        $name = $_POST['name']; 
        $item = $_POST['item_name'] ?? '';
        $total_amt = $_POST['total_amount']; 
        $inst_amt = $_POST['installment_amount'] ?? 0;
        $total_inst = $_POST['total_installments'] ?? 0; 
        $date = $_POST['due_date'];
        $type = 'taken'; // We owe money
        
        $sql = "INSERT INTO loans (person_name, loan_category, item_name, type, total_amount, paid_amount, total_installments, paid_installments, installment_amount, next_due_date, status) 
                VALUES (?, ?, ?, ?, ?, 0, ?, 0, ?, ?, 'active')";
        $pdo->prepare($sql)->execute([$name, $cat, $item, $type, $total_amt, $total_inst, $inst_amt, $date]);
        $msg = "Record Added Successfully!";
    }

    // B. RECORD PAYMENT (PAYING BACK)
    if (isset($_POST['pay_installment'])) {
        $id = $_POST['loan_id']; 
        $amount = $_POST['amount'];
        
        $row = $pdo->query("SELECT * FROM loans WHERE id=$id")->fetch();
        
        $new_paid_amt = $row['paid_amount'] + $amount;
        $new_inst_count = $row['paid_installments'];
        
        // If installment loan, increment counter if amount matches EMI
        if ($row['loan_category'] == 'installment' && $amount >= $row['installment_amount']) {
            $new_inst_count++;
        }

        $next_date = date('Y-m-d', strtotime($row['next_due_date'] . ' +1 month'));

        $pdo->prepare("UPDATE loans SET paid_amount=?, paid_installments=?, next_due_date=? WHERE id=?")->execute([$new_paid_amt, $new_inst_count, $next_date, $id]);

        $desc = "Paid Loan/Installment: " . $row['person_name'] . ($row['item_name'] ? " (" . $row['item_name'] . ")" : "");
        $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head) VALUES (CURDATE(), 'expense', 'Loan Repayment', ?, ?, 'Cash', 'Shop Cash Drawer')")->execute([$desc, $amount]);
        $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name='Shop Cash Drawer'")->execute([$amount]);
        
        $msg = "Payment Recorded & Updated!";
    }
}

// 3. FETCH DATA
$installments = $pdo->query("SELECT * FROM loans WHERE loan_category='installment' AND status='active'")->fetchAll();
$bank_loans = $pdo->query("SELECT * FROM loans WHERE loan_category='bank' AND status='active'")->fetchAll();
$personal = $pdo->query("SELECT * FROM loans WHERE loan_category='personal' AND type='taken' AND status='active'")->fetchAll();
?>

<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <h3 class="fw-bold"><i class="fas fa-hand-holding-usd text-primary"></i> Liability Manager</h3>
        <p class="text-muted">Installments, Bank Loans, and Personal Debts</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary rounded-pill px-4 fw-bold shadow" onclick="openModal()">
            <i class="fas fa-plus-circle me-2"></i> Add Liability
        </button>
    </div>
</div>

<?php if($msg): ?><div class="alert alert-success fw-bold text-center"><?php echo $msg; ?></div><?php endif; ?>

<ul class="nav nav-tabs mb-3 border-0" id="loanTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active fw-bold border bg-white shadow-sm me-2" data-bs-toggle="tab" data-bs-target="#tab-inst"><i class="fas fa-shopping-cart text-warning"></i> Installments (EMI)</button></li>
    <li class="nav-item"><button class="nav-link fw-bold border bg-white shadow-sm me-2" data-bs-toggle="tab" data-bs-target="#tab-bank"><i class="fas fa-university text-info"></i> Bank / Cards</button></li>
    <li class="nav-item"><button class="nav-link fw-bold border bg-white shadow-sm" data-bs-toggle="tab" data-bs-target="#tab-personal"><i class="fas fa-user-friends text-success"></i> Personal</button></li>
</ul>

<div class="tab-content">
    
    <div class="tab-pane fade show active" id="tab-inst">
        <div class="row g-3">
            <?php foreach($installments as $i): 
                $percent = ($i['total_amount'] > 0) ? round(($i['paid_amount'] / $i['total_amount']) * 100) : 0;
            ?>
            <div class="col-md-4">
                <div class="glass-panel p-3 border-start border-5 border-warning h-100 position-relative">
                    <span class="badge bg-warning text-dark position-absolute top-0 end-0 m-3">EMI: <?php echo number_format($i['installment_amount']); ?></span>
                    <h5 class="fw-bold mb-1"><?php echo htmlspecialchars($i['item_name']); ?></h5>
                    <small class="text-muted"><?php echo htmlspecialchars($i['person_name']); ?></small>
                    <div class="mt-3 small fw-bold">Paid: <?php echo $i['paid_installments']; ?>/<?php echo $i['total_installments']; ?> | Due: <?php echo $i['next_due_date']; ?></div>
                    <div class="progress my-2" style="height: 10px;"><div class="progress-bar bg-warning" style="width: <?php echo $percent; ?>%"></div></div>
                    <button class="btn btn-sm btn-dark w-100 mt-2" onclick='payModal(<?php echo json_encode($i); ?>)'>Pay EMI</button>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-bank">
        <table class="table table-hover mb-0 align-middle">
            <thead class="bg-info text-white"><tr><th class="ps-4">Bank</th><th>Total</th><th>Paid</th><th>Balance</th><th class="text-end pe-4">Action</th></tr></thead>
            <tbody>
                <?php foreach($bank_loans as $b): $bal = $b['total_amount'] - $b['paid_amount']; ?>
                <tr>
                    <td class="ps-4 fw-bold"><?php echo htmlspecialchars($b['person_name']); ?><br><small class="fw-normal"><?php echo htmlspecialchars($b['item_name']); ?></small></td>
                    <td><?php echo number_format($b['total_amount']); ?></td>
                    <td class="text-success"><?php echo number_format($b['paid_amount']); ?></td>
                    <td class="text-danger fw-bold"><?php echo number_format($bal); ?></td>
                    <td class="text-end pe-4"><button class="btn btn-sm btn-info fw-bold" onclick='payModal(<?php echo json_encode($b); ?>)'>Pay Bill</button></td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <div class="tab-pane fade" id="tab-personal">
        <table class="table table-hover mb-0 align-middle">
            <thead class="bg-success text-white"><tr><th class="ps-4">Name</th><th>Total</th><th>Paid</th><th>Pending</th><th class="text-end pe-4">Action</th></tr></thead>
            <tbody>
                <?php foreach($personal as $p): $bal = $p['total_amount'] - $p['paid_amount']; ?>
                <tr>
                    <td class="ps-4 fw-bold"><?php echo htmlspecialchars($p['person_name']); ?></td>
                    <td><?php echo number_format($p['total_amount']); ?></td>
                    <td class="text-success"><?php echo number_format($p['paid_amount']); ?></td>
                    <td class="text-danger fw-bold"><?php echo number_format($bal); ?></td>
                    <td class="text-end pe-4"><button class="btn btn-sm btn-success fw-bold" onclick='payModal(<?php echo json_encode($p); ?>)'>Pay</button></td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title">Add Liability</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4">
                <form method="POST">
                    <input type="hidden" name="add_entry" value="1">
                    <div class="row mb-3">
                        <div class="col-md-6"><label>Category</label><select name="category" id="cat_select" class="form-select" onchange="toggleFields()"><option value="installment">Installment</option><option value="bank">Bank/Card</option><option value="personal">Personal</option></select></div>
                        <div class="col-md-6"><label>Name</label><input type="text" name="name" class="form-control" required placeholder="Shop/Bank/Person Name"></div>
                    </div>
                    <div class="row mb-3" id="item_row"><div class="col-12"><label>Item/Loan Name</label><input type="text" name="item_name" class="form-control" placeholder="Product or Loan Name"></div></div>
                    <div class="row mb-3"><div class="col-md-6"><label>Total Debt</label><input type="number" name="total_amount" class="form-control" required></div><div class="col-md-6"><label>Due Date</label><input type="date" name="due_date" class="form-control" value="<?php echo date('Y-m-d'); ?>"></div></div>
                    <div class="row mb-3" id="inst_row"><div class="col-md-6"><label>EMI Amount</label><input type="number" name="installment_amount" class="form-control" value="0"></div><div class="col-md-6"><label>Total Months</label><input type="number" name="total_installments" class="form-control" value="0"></div></div>
                    <button class="btn btn-primary w-100 fw-bold">Save Record</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="payModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header bg-success text-white"><h5 class="modal-title">Payment</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4 text-center">
                <form method="POST">
                    <input type="hidden" name="pay_installment" value="1"><input type="hidden" name="loan_id" id="p_id">
                    <h4 class="fw-bold" id="p_title"></h4>
                    <div class="form-floating mb-3"><input type="number" name="amount" id="p_amount" class="form-control fs-4 fw-bold text-success" required><label>Amount</label></div>
                    <button class="btn btn-success w-100 fw-bold rounded-pill">Confirm Payment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
var addModal = new bootstrap.Modal(document.getElementById('addModal'));
var payModalObj = new bootstrap.Modal(document.getElementById('payModal'));
function openModal() { toggleFields(); addModal.show(); }
function payModal(data) { document.getElementById('p_id').value = data.id; document.getElementById('p_title').innerText = data.person_name; document.getElementById('p_amount').value = (data.loan_category === 'installment' && data.installment_amount > 0) ? data.installment_amount : ''; payModalObj.show(); }
function toggleFields() { let cat = document.getElementById('cat_select').value; document.getElementById('inst_row').style.display = (cat === 'installment') ? 'flex' : 'none'; }
</script>
<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\login.php
==============================================================================

<?php
session_start();
require 'includes/config.php';

if (isset($_SESSION['user_id'])) { header("Location: dashboard.php"); exit(); }
$error = "";

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $username = trim($_POST['username']);
    $password = $_POST['password'];

    $stmt = $pdo->prepare("SELECT * FROM users WHERE username = ?");
    $stmt->execute([$username]);
    $user = $stmt->fetch();

    if ($user && password_verify($password, $user['password'])) {
        if ($user['status'] == 0) {
            $error = "‚õî Account Disabled.";
        } else {
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['username'] = $user['username'];
            
            // FIX: Force role to lowercase and Admin Bypass
            $role = strtolower($user['role']);
            $_SESSION['role'] = $role; 

            if ($role === 'admin') {
                // FORCE FULL ACCESS (Fixes 'saif' empty permissions)
                $_SESSION['permissions'] = [
                    'bisp' => 1, 'hbl' => 1, 'shop' => 1, 'loans' => 1, 'closing' => 1
                ];
            } else {
                $perms = json_decode($user['permissions'] ?? '', true);
                $_SESSION['permissions'] = is_array($perms) ? $perms : [];
            }
            
            $pdo->prepare("UPDATE users SET last_login = NOW() WHERE id = ?")->execute([$user['id']]);
            header("Location: dashboard.php");
            exit();
        }
    } else {
        $error = "Invalid Username or Password";
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Arham ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #222; height: 100vh; display: flex; align-items: center; justify-content: center; font-family: sans-serif; }
        .card { background: #333; padding: 40px; border-radius: 10px; color: white; width: 100%; max-width: 400px; }
        .form-control { background: #444; border: 1px solid #555; color: white; margin-bottom: 15px; padding: 12px; }
        .btn-login { background: #00E5FF; border: none; padding: 12px; width: 100%; font-weight: bold; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="card text-center">
        <h2 class="mb-4">ARHAM <span class="text-info">ERP</span></h2>
        <?php if($error): ?><div class="alert alert-danger p-2 small"><?php echo $error; ?></div><?php endif; ?>
        <form method="POST">
            <input type="text" name="username" class="form-control" placeholder="Username" required autofocus>
            <input type="password" name="password" class="form-control" placeholder="Password" required>
            <button class="btn btn-login">LOGIN</button>
        </form>
    </div>
</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\logout.php
==============================================================================

<?php
session_start();
session_unset();
session_destroy();
header("Location: login.php");
exit();
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\logs.php
==============================================================================

<?php 
require 'includes/header.php'; 

// 1. ACCESS CONTROL (Admin Only)
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

$allowed_ids = [1, 14, 15];
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');

if (!$is_admin) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED</div></div>");
}

// 2. FETCH LOGS
// Join with users table to get usernames
$sql = "SELECT l.*, u.username 
        FROM system_logs l 
        LEFT JOIN users u ON l.user_id = u.id 
        ORDER BY l.id DESC 
        LIMIT 200";
        
$logs = $pdo->query($sql)->fetchAll();
?>

<div class="row mb-4">
    <div class="col-12">
        <h3 class="fw-bold"><i class="fas fa-shield-alt text-danger me-2"></i> System Audit Logs</h3>
        <p class="text-muted">Tracking the last 200 system activities for security.</p>
    </div>
</div>

<div class="glass-panel p-0 overflow-hidden bg-white shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle small">
            <thead class="bg-dark text-white">
                <tr>
                    <th class="ps-4">Time</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Details</th>
                    <th>IP Address</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach($logs as $l): ?>
                    <tr>
                        <td class="ps-4 text-muted" style="min-width: 150px;">
                            <?php echo date('d-M-Y h:i A', strtotime($l['created_at'])); ?>
                        </td>
                        <td>
                            <div class="fw-bold text-primary">
                                <?php echo htmlspecialchars($l['username'] ?? 'System/Deleted'); ?>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-secondary text-uppercase px-2">
                                <?php echo htmlspecialchars($l['action']); ?>
                            </span>
                        </td>
                        <td>
                            <div class="text-wrap" style="max-width: 400px;">
                                <?php echo htmlspecialchars($l['details']); ?>
                            </div>
                        </td>
                        <td class="text-muted font-monospace">
                            <?php echo htmlspecialchars($l['ip_address']); ?>
                        </td>
                    </tr>
                <?php endforeach; ?>
                
                <?php if (empty($logs)): ?>
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            No logs found.
                        </td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\migrate_bills.php
==============================================================================

<?php
// FILE: migrate_bills.php
require 'includes/config.php';

echo "<h2>Starting Migration...</h2>";

// 1. Fetch all PAID bills that are NOT in the ledger yet
$sql = "SELECT * FROM bill_queue 
        WHERE status = 'paid' 
        AND id NOT IN (SELECT related_id FROM finance_ledger WHERE category = 'Utility Bill')";

$bills = $pdo->query($sql)->fetchAll();
$count = 0;
$total_amt = 0;

foreach ($bills as $b) {
    // 2. Insert into Finance Ledger
    $desc = "Bill Paid: {$b['bill_type']} ({$b['consumer_number']})";
    
    // Check if duplicate (Double Safety)
    $check = $pdo->prepare("SELECT id FROM finance_ledger WHERE related_id = ? AND category = 'Utility Bill'");
    $check->execute([$b['id']]);
    
    if ($check->rowCount() == 0) {
        $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head, related_id) VALUES (?, 'expense', 'Utility Bill', ?, ?, 'Konnect', 'HBL Konnect BVS', ?)");
        
        // Use the bill's original creation date as transaction date
        $date = date('Y-m-d', strtotime($b['created_at']));
        
        $stmt->execute([$date, $desc, $b['amount'], $b['id']]);
        
        // 3. Deduct from BVS Balance (Retrospectively)
        $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name = 'HBL Konnect BVS'")->execute([$b['amount']]);
        
        $count++;
        $total_amt += $b['amount'];
        echo "Migrated: $desc - Rs. {$b['amount']}<br>";
    }
}

echo "<h3>‚úÖ Success! Migrated $count bills. Total Value: Rs. " . number_format($total_amt) . "</h3>";
echo "<p>Your Dashboard and BVS Balance are now updated.</p>";
echo "<a href='dashboard.php'>Go to Dashboard</a>";
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\night_mode.php
==============================================================================

<?php 
// 1. ENABLE ERROR REPORTING
error_reporting(E_ALL);
ini_set('display_errors', 1);
date_default_timezone_set('Asia/Karachi');

require 'includes/header.php';

// 2. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

// 3. CHECK ADMIN ACCESS FOR PAID/EDIT ACTIONS
$allowed_ids = [1, 14, 15];
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');

// 4. FETCH SHOP SETTINGS FOR WHATSAPP
$settings = [];
$stmt = $pdo->query("SELECT * FROM system_settings");
while ($row = $stmt->fetch()) {
    $settings[$row['setting_key']] = $row['setting_value'];
}

$shop_name = $settings['shop_name'] ?? "ARHAM PRINTERS";
$shop_phone = $settings['shop_phone'] ?? "0300-0000000";
$shop_address = $settings['shop_address'] ?? "Jalalpur Jattan";

// 5. HANDLE ACTIONS
$msg = "";
$error = "";

// A. MARK BILL AS PAID
if (isset($_POST['mark_paid'])) {
    if (!$is_admin) {
        $error = "‚õî Access Denied: Only Admin can mark bills as paid.";
    } else {
        $id = $_POST['id'];
        $trans_id = trim($_POST['transaction_id']);
        $amount = (float) $_POST['amount'];
        
        if (empty($trans_id)) {
            $error = "Transaction ID is required for audit trail.";
        } else {
            try {
                $pdo->beginTransaction();
                
                // 1. Update Bill Status
                $stmt = $pdo->prepare("UPDATE bill_queue SET status='paid', transaction_id=?, processed_by=?, processed_at=NOW() WHERE id=?");
                $stmt->execute([$trans_id, $_SESSION['user_id'], $id]);
                
                // 2. Log to Finance Ledger (Bill Payment)
                $bill = $pdo->query("SELECT * FROM bill_queue WHERE id=$id")->fetch();
                $desc = "Utility Bill: " . $bill['bill_type'] . " - " . $bill['consumer_number'];
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head, related_id) VALUES (CURDATE(), 'expense', 'Utility Bill', ?, ?, 'BVS Transfer', 'HBL Konnect BVS', ?)");
                $stmt->execute([$desc, $amount, $id]);
                
                // 3. Deduct from BVS Balance
                $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name='HBL Konnect BVS'")->execute([$amount]);
                
                $pdo->commit();
                $msg = "‚úÖ Bill marked as PAID!";
                
                // Redirect to avoid form resubmission
                echo "<script>setTimeout(() => location.href = 'night_mode.php', 1500);</script>";
                
            } catch (Exception $e) {
                $pdo->rollBack();
                $error = "System Error: " . $e->getMessage();
            }
        }
    }
}

// B. DELETE BILL
if (isset($_POST['delete_bill'])) {
    if (!$is_admin) {
        $error = "‚õî Access Denied: Only Admin can delete bills.";
    } else {
        $id = $_POST['delete_id'];
        
        // Check if linked to customer debt
        $bill = $pdo->query("SELECT * FROM bill_queue WHERE id=$id")->fetch();
        
        if ($bill['payment_status'] == 'credit' && $bill['customer_id']) {
            // Reverse customer debt
            $pdo->prepare("UPDATE loans SET total_amount = total_amount - ? WHERE id=?")->execute([$bill['amount'], $bill['customer_id']]);
            
            // Remove from ledger
            $pdo->prepare("DELETE FROM finance_ledger WHERE description LIKE ? AND amount = ? LIMIT 1")->execute(["%Credit Bill%", $bill['amount']]);
        }
        
        $pdo->prepare("DELETE FROM bill_queue WHERE id=?")->execute([$id]);
        $msg = "üóëÔ∏è Bill deleted from queue.";
    }
}

// C. EDIT BILL DETAILS
if (isset($_POST['edit_bill'])) {
    if (!$is_admin) {
        $error = "‚õî Access Denied: Only Admin can edit bills.";
    } else {
        $id = $_POST['edit_id'];
        $amount = $_POST['edit_amount'];
        $name = $_POST['edit_name'];
        $mobile = $_POST['edit_mobile'];
        
        $pdo->prepare("UPDATE bill_queue SET amount=?, consumer_name=?, mobile_no=? WHERE id=?")->execute([$amount, $name, $mobile, $id]);
        $msg = "‚úèÔ∏è Bill details updated.";
    }
}

// 6. FILTER LOGIC
$filter_status = $_GET['status'] ?? 'pending';
$filter_type = $_GET['type'] ?? '';
$search_term = $_GET['search'] ?? '';

// Build Query
$where = "status = ?";
$params = [$filter_status];

if (!empty($filter_type)) {
    $where .= " AND bill_type = ?";
    $params[] = $filter_type;
}

if (!empty($search_term)) {
    $where .= " AND (consumer_number LIKE ? OR consumer_name LIKE ? OR mobile_no LIKE ?)";
    $like_term = "%$search_term%";
    $params[] = $like_term;
    $params[] = $like_term;
    $params[] = $like_term;
}

// 7. FETCH BILLS
$sql = "SELECT * FROM bill_queue WHERE $where ORDER BY created_at DESC";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$bills = $stmt->fetchAll();

// 8. STATISTICS
$stats = [
    'pending' => $pdo->query("SELECT COUNT(*) FROM bill_queue WHERE status='pending'")->fetchColumn(),
    'paid' => $pdo->query("SELECT COUNT(*) FROM bill_queue WHERE status='paid'")->fetchColumn(),
    'total_pending_amount' => $pdo->query("SELECT SUM(amount) FROM bill_queue WHERE status='pending' AND payment_status='cash'")->fetchColumn(),
    'total_credit_amount' => $pdo->query("SELECT SUM(amount) FROM bill_queue WHERE status='pending' AND payment_status='credit'")->fetchColumn(),
    'today_paid' => $pdo->query("SELECT COUNT(*) FROM bill_queue WHERE status='paid' AND DATE(processed_at) = CURDATE()")->fetchColumn(),
];

// 9. GET BILL TYPES FOR FILTER
$bill_types = $pdo->query("SELECT DISTINCT bill_type FROM bill_queue WHERE bill_type IS NOT NULL ORDER BY bill_type")->fetchAll(PDO::FETCH_COLUMN);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Night Mode - Bill Queue Manager</title>
    
    <!-- Progressive Web App Meta -->
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-color: #212529;
            --light-color: #f8f9fa;
            --night-bg: #0a1929;
            --night-card: #1a2942;
            --night-text: #e0e0e0;
        }
        
        /* Dark/Night Mode Theme */
        body.night-mode {
            background: var(--night-bg);
            color: var(--night-text);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .night-mode .glass-panel {
            background: var(--night-card);
            border-color: rgba(255,255,255,0.1);
            color: var(--night-text);
        }
        
        .night-mode .card {
            background: var(--night-card);
            border-color: rgba(255,255,255,0.1);
            color: var(--night-text);
        }
        
        .night-mode .table {
            color: var(--night-text);
        }
        
        .night-mode .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255,255,255,0.05);
        }
        
        .night-mode .table-hover tbody tr:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .night-mode .form-control,
        .night-mode .form-select {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: var(--night-text);
        }
        
        .night-mode .form-control:focus,
        .night-mode .form-select:focus {
            background: rgba(255,255,255,0.15);
            border-color: var(--primary-color);
            color: var(--night-text);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .night-mode .btn-outline-secondary {
            border-color: rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.8);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .stat-card {
                padding: 0.75rem !important;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .action-buttons .btn {
                margin-bottom: 0.25rem;
            }
        }
        
        /* Touch-friendly Elements */
        .btn-touch {
            min-height: 44px;
            min-width: 44px;
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .night-mode ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .night-mode ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }
        
        .night-mode ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Pulsing Animation for New Bills */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
            100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        /* Quick Status Filters */
        .status-filter {
            display: flex;
            overflow-x: auto;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            scrollbar-width: none;
        }
        
        .status-filter::-webkit-scrollbar {
            display: none;
        }
        
        /* Enhanced Modal for Mobile */
        @media (max-width: 576px) {
            .modal-content {
                border-radius: 1rem;
                margin: 0.5rem;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .modal-body {
                padding: 1rem;
                max-height: 70vh;
                overflow-y: auto;
            }
        }
        
        /* WhatApp Receipt Preview */
        .whatsapp-preview {
            background: #25d366;
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            position: relative;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        .whatsapp-preview::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: #25d366 transparent transparent;
        }
        
        /* Print Optimization */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .table {
                font-size: 12px;
            }
            
            .container {
                width: 100% !important;
                max-width: 100% !important;
            }
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
        
        /* Swipe Actions */
        .swipe-action {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .swipe-action.delete {
            background: var(--danger-color);
        }
        
        .swipe-action.pay {
            background: var(--success-color);
        }
        
        .bill-row {
            position: relative;
            transition: transform 0.3s;
        }
        
        /* Batch Operations */
        .batch-actions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body class="night-mode">
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash me-1"></i> Offline
    </div>
    
    <!-- Batch Actions -->
    <div class="batch-actions" id="batchActions">
        <span id="selectedCount">0</span> selected 
        <button class="btn btn-sm btn-light ms-2" onclick="processSelected()">Mark Paid</button>
    </div>

    <div class="container-fluid py-3">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="fw-bold mb-0">
                            <i class="fas fa-moon text-warning"></i> Night Mode - Bill Queue
                        </h3>
                        <small class="text-muted">Process pending utility bills</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-warning btn-sm" onclick="toggleTheme()">
                            <i class="fas fa-sun"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <?php if($is_admin): ?>
                        <a href="financial_reports.php" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chart-bar"></i>
                        </a>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 col-6">
                <div class="glass-panel p-3 text-center stat-card">
                    <small class="text-muted d-block">Pending Bills</small>
                    <h2 class="fw-bold text-warning mb-0"><?php echo $stats['pending']; ?></h2>
                    <small class="text-muted">Awaiting payment</small>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="glass-panel p-3 text-center stat-card">
                    <small class="text-muted d-block">Cash Amount</small>
                    <h2 class="fw-bold text-success mb-0">Rs. <?php echo number_format($stats['total_pending_amount']); ?></h2>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="glass-panel p-3 text-center stat-card">
                    <small class="text-muted d-block">Credit Amount</small>
                    <h2 class="fw-bold text-danger mb-0">Rs. <?php echo number_format($stats['total_credit_amount']); ?></h2>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="glass-panel p-3 text-center stat-card">
                    <small class="text-muted d-block">Today Paid</small>
                    <h2 class="fw-bold text-info mb-0"><?php echo $stats['today_paid']; ?></h2>
                    <small class="text-muted">Completed today</small>
                </div>
            </div>
        </div>

        <?php if($msg): ?>
        <div class="alert alert-success alert-dismissible fade show animate__animated animate__fadeInDown" role="alert">
            <i class="fas fa-check-circle me-2"></i> <?php echo $msg; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <?php endif; ?>

        <?php if($error): ?>
        <div class="alert alert-danger alert-dismissible fade show animate__animated animate__shakeX" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i> <?php echo $error; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <?php endif; ?>

        <!-- Filter Controls -->
        <div class="glass-panel p-3 mb-4">
            <form method="GET" class="row g-2">
                <div class="col-md-4 col-12">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" name="search" class="form-control" placeholder="Search by ref, name, mobile..." value="<?php echo htmlspecialchars($search_term); ?>">
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="pending" <?php echo $filter_status == 'pending' ? 'selected' : ''; ?>>Pending Bills</option>
                        <option value="paid" <?php echo $filter_status == 'paid' ? 'selected' : ''; ?>>Paid Bills</option>
                        <option value="">All Bills</option>
                    </select>
                </div>
                <div class="col-md-3 col-6">
                    <select name="type" class="form-select" onchange="this.form.submit()">
                        <option value="">All Types</option>
                        <?php foreach($bill_types as $type): ?>
                            <option value="<?php echo htmlspecialchars($type); ?>" <?php echo $filter_type == $type ? 'selected' : ''; ?>>
                                <?php echo htmlspecialchars($type); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-2 col-12">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>
            </form>
            
            <!-- Quick Status Filters -->
            <div class="status-filter mt-3 no-print">
                <button class="btn btn-sm <?php echo $filter_status == 'pending' ? 'btn-warning' : 'btn-outline-warning'; ?>" onclick="setFilter('pending')">
                    <i class="fas fa-clock"></i> Pending
                </button>
                <button class="btn btn-sm <?php echo $filter_status == 'paid' ? 'btn-success' : 'btn-outline-success'; ?>" onclick="setFilter('paid')">
                    <i class="fas fa-check"></i> Paid
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="printPage()">
                    <i class="fas fa-print"></i> Print
                </button>
                <?php if($is_admin && $filter_status == 'pending'): ?>
                <button class="btn btn-sm btn-outline-danger" onclick="selectAll()">
                    <i class="fas fa-check-double"></i> Select All
                </button>
                <?php endif; ?>
            </div>
        </div>

        <!-- Bills Table -->
        <div class="glass-panel p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" id="billsTable">
                    <thead class="bg-dark">
                        <tr>
                            <?php if($is_admin && $filter_status == 'pending'): ?>
                            <th style="width: 40px;" class="ps-3">
                                <input type="checkbox" id="selectAll" onchange="toggleAllSelection()">
                            </th>
                            <?php endif; ?>
                            <th class="ps-3">Ref #</th>
                            <th>Customer</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Mode</th>
                            <th>Added</th>
                            <th class="text-end pe-3">Status</th>
                            <th class="text-end pe-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php if(count($bills) > 0): ?>
                            <?php foreach($bills as $bill): 
                                $is_pending = ($bill['status'] == 'pending');
                                $is_credit = ($bill['payment_status'] == 'credit');
                                $time_ago = time_ago($bill['created_at']);
                            ?>
                            <tr class="bill-row <?php echo $is_pending ? 'pulse-glow' : ''; ?>" id="row-<?php echo $bill['id']; ?>">
                                <?php if($is_admin && $filter_status == 'pending'): ?>
                                <td class="ps-3">
                                    <input type="checkbox" class="bill-checkbox" value="<?php echo $bill['id']; ?>" onchange="updateSelection()">
                                </td>
                                <?php endif; ?>
                                <td class="ps-3">
                                    <div class="fw-bold font-monospace"><?php echo htmlspecialchars($bill['consumer_number']); ?></div>
                                    <?php if($bill['mobile_no']): ?>
                                    <small class="text-muted"><?php echo htmlspecialchars($bill['mobile_no']); ?></small>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <div class="fw-bold"><?php echo htmlspecialchars($bill['consumer_name']); ?></div>
                                    <?php if($bill['customer_id']): ?>
                                    <small class="badge bg-info">Regular Customer</small>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <span class="badge bg-secondary"><?php echo htmlspecialchars($bill['bill_type']); ?></span>
                                </td>
                                <td class="fw-bold <?php echo $is_credit ? 'text-danger' : 'text-success'; ?>">
                                    Rs. <?php echo number_format($bill['amount']); ?>
                                    <?php if($is_credit): ?>
                                    <br><small class="text-danger">(Credit)</small>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <span class="badge <?php echo $is_credit ? 'bg-danger' : 'bg-success'; ?>">
                                        <?php echo $is_credit ? 'CREDIT' : 'CASH'; ?>
                                    </span>
                                </td>
                                <td class="text-muted small">
                                    <?php echo date('h:i A', strtotime($bill['created_at'])); ?>
                                    <br><small><?php echo $time_ago; ?></small>
                                </td>
                                <td class="text-end pe-3">
                                    <?php if($is_pending): ?>
                                        <span class="badge bg-warning">PENDING</span>
                                    <?php else: ?>
                                        <span class="badge bg-success">PAID</span>
                                        <?php if($bill['transaction_id']): ?>
                                        <br><small class="text-muted"><?php echo $bill['transaction_id']; ?></small>
                                        <?php endif; ?>
                                    <?php endif; ?>
                                </td>
                                <td class="text-end pe-3 action-buttons">
                                    <div class="d-flex gap-1 justify-content-end">
                                        <?php if($is_pending && $is_admin): ?>
                                            <!-- Pending Bills Actions -->
                                            <button class="btn btn-sm btn-success" 
                                                    onclick="showPayModal(<?php echo htmlspecialchars(json_encode($bill)); ?>)"
                                                    data-bs-toggle="tooltip" title="Mark as Paid">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            
                                            <?php if($is_credit): ?>
                                            <button class="btn btn-sm btn-info" 
                                                    onclick="showEditModal(<?php echo htmlspecialchars(json_encode($bill)); ?>)"
                                                    data-bs-toggle="tooltip" title="Edit Details">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <?php endif; ?>
                                            
                                            <button class="btn btn-sm btn-danger" 
                                                    onclick="confirmDelete(<?php echo $bill['id']; ?>)"
                                                    data-bs-toggle="tooltip" title="Delete Bill">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        <?php endif; ?>
                                        
                                        <!-- Always show receipt button for paid bills -->
                                        <?php if(!$is_pending): ?>
                                            <button class="btn btn-sm btn-primary" 
                                                    onclick="showReceipt(<?php echo $bill['id']; ?>)"
                                                    data-bs-toggle="tooltip" title="View Receipt">
                                                <i class="fas fa-receipt"></i>
                                            </button>
                                            
                                            <!-- WhatsApp Share -->
                                            <?php 
                                            $wa_msg = generateWhatsAppMessage($bill, $shop_name);
                                            $wa_link = "https://wa.me/?text=" . urlencode($wa_msg);
                                            ?>
                                            <a href="<?php echo $wa_link; ?>" 
                                               class="btn btn-sm btn-success"
                                               target="_blank"
                                               data-bs-toggle="tooltip" 
                                               title="Share on WhatsApp">
                                                <i class="fab fa-whatsapp"></i>
                                            </a>
                                        <?php endif; ?>
                                        
                                        <!-- Quick Info -->
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="showBillInfo(<?php echo htmlspecialchars(json_encode($bill)); ?>)"
                                                data-bs-toggle="tooltip" title="Quick Info">
                                            <i class="fas fa-info"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <tr>
                                <td colspan="9" class="text-center py-5">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h5>No bills found</h5>
                                    <p class="text-muted">
                                        <?php if($filter_status == 'pending'): ?>
                                            All bills are processed! üéâ
                                        <?php else: ?>
                                            No bills match your filters
                                        <?php endif; ?>
                                    </p>
                                    <a href="bills.php" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i> Add New Bill
                                    </a>
                                </td>
                            </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        <?php if(count($bills) > 0): ?>
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Showing <?php echo count($bills); ?> bills
                        <?php if($filter_status == 'pending'): ?>
                            ‚Ä¢ Total Pending: Rs. <?php echo number_format($stats['total_pending_amount'] + $stats['total_credit_amount']); ?>
                        <?php endif; ?>
                    </small>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="scrollToTop()">
                            <i class="fas fa-arrow-up"></i> Top
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <?php endif; ?>
    </div>

    <!-- Pay Modal -->
    <div class="modal fade" id="payModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-check-circle me-2"></i> Mark as Paid
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" id="payForm">
                    <div class="modal-body">
                        <input type="hidden" name="mark_paid" value="1">
                        <input type="hidden" name="id" id="pay_id">
                        <input type="hidden" name="amount" id="pay_amount">
                        
                        <div class="text-center mb-4">
                            <h4 id="pay_customer" class="fw-bold mb-2"></h4>
                            <div class="badge bg-primary fs-6" id="pay_ref"></div>
                            <div class="mt-2">
                                <span class="badge bg-warning" id="pay_type"></span>
                                <span class="badge bg-success" id="pay_mode"></span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Transaction ID <span class="text-danger">*</span></label>
                            <input type="text" name="transaction_id" class="form-control form-control-lg" 
                                   placeholder="e.g. BVS123456" required autofocus>
                            <div class="form-text">
                                <small>Enter the exact transaction ID from BVS/HBL Konnect</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Payment Method</label>
                            <select class="form-select" id="payment_method">
                                <option value="BVS Transfer">HBL Konnect BVS</option>
                                <option value="JazzCash">JazzCash</option>
                                <option value="EasyPaisa">EasyPaisa</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Cash">Cash</option>
                            </select>
                        </div>
                        
                        <!-- WhatsApp Preview -->
                        <div class="whatsapp-preview d-none" id="whatsappPreview">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fab fa-whatsapp fa-2x me-2"></i>
                                <strong>Receipt Preview</strong>
                            </div>
                            <div id="previewContent" class="small"></div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This will deduct from <strong id="account_head">HBL Konnect BVS</strong> balance
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success fw-bold">
                            <i class="fas fa-check me-2"></i> Confirm Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-edit me-2"></i> Edit Bill Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" id="editForm">
                    <div class="modal-body">
                        <input type="hidden" name="edit_bill" value="1">
                        <input type="hidden" name="edit_id" id="edit_id">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Customer Name</label>
                            <input type="text" name="edit_name" id="edit_name" class="form-control" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Mobile Number</label>
                            <input type="text" name="edit_mobile" id="edit_mobile" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\payout.php
==============================================================================

<?php 
// 1. ENABLE ERROR REPORTING
error_reporting(E_ALL);
ini_set('display_errors', 1);

require 'includes/header.php'; 

// 2. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { 
    header("Location: login.php"); 
    exit(); 
}

// Permission Check (Admin OR BISP Permission)
$allowed_ids = [1, 14, 15]; 
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');
$has_perm = (isset($_SESSION['permissions']['bisp']) && $_SESSION['permissions']['bisp'] == 1);

if (!$is_admin && !$has_perm) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED</div></div>");
}

// 3. HANDLE PAYOUT
$msg = "";
$error = "";

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['process_payout'])) {
    $token_id = $_POST['token_id'];
    $cnic = $_POST['cnic'];
    $amount = (float) $_POST['amount'];
    $deduction = (float) ($_POST['deduction'] ?: 0); 
    
    // Validate
    if ($amount <= 0) {
        $error = "Invalid Amount.";
    } else {
        try {
            $pdo->beginTransaction();

            $final_payout = $amount - $deduction;
            
            // A. Mark Token Served (if applicable)
            if($token_id) {
                $pdo->prepare("UPDATE queue_tokens SET status='served', served_at=NOW() WHERE id=?")->execute([$token_id]);
            }

            // B. Record Payout Expense (Money leaving shop)
            // We record the full amount as payout, or net? 
            // Standard accounting: You paid 'Final Payout' from cash. 
            // The 'Deduction' is revenue you KEPT (didn't leave drawer).
            
            $desc = "BISP Payout ($cnic)";
            if ($deduction > 0) $desc .= " - Fee: $deduction";

            // Entry 1: The Expense (Actual Cash Given)
            $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head) VALUES (NOW(), 'expense', 'BISP', ?, ?, 'Cash', 'Shop Cash Drawer')");
            $stmt->execute([$desc, $final_payout]);
            
            // Entry 2: The Income (Commission/Deduction) - ONLY if you want to track it as 'Income' separately. 
            // Actually, if you kept the fee, you simply didn't pay it out. 
            // But to track "Profit" from BISP, we can record the fee as Income.
            if ($deduction > 0) {
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head) VALUES (NOW(), 'income', 'Commission', ?, ?, 'Cash', 'Shop Cash Drawer')");
                $stmt->execute(["BISP Fee ($cnic)", $deduction]);
                
                // Add Fee to Cash Drawer (It technically stayed in, but if we treat 'Amount' as full withdrawal logic, this balances it. 
                // Simpler logic: Just deduct Final Payout from Drawer.)
            }
            
            // C. Update Cash Drawer (Subtract what physically left)
            $stmt = $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name='Shop Cash Drawer'");
            $stmt->execute([$final_payout]);

            // D. Update Beneficiary History
            $chk = $pdo->prepare("SELECT id FROM beneficiaries WHERE cnic = ?");
            $chk->execute([$cnic]);
            if ($row = $chk->fetch()) {
                $pdo->prepare("UPDATE beneficiaries SET last_visit = CURDATE() WHERE id = ?")->execute([$row['id']]);
            } else {
                $pdo->prepare("INSERT INTO beneficiaries (cnic, last_visit) VALUES (?, CURDATE())")->execute([$cnic]);
            }

            $pdo->commit();
            $msg = "Payout Successful! Cash Given: Rs. " . number_format($final_payout);
            
            // Refresh logic to clear form
            $next = null; 

        } catch (Exception $e) {
            $pdo->rollBack();
            $error = "Transaction Failed: " . $e->getMessage();
        }
    }
}

// 4. GET NEXT TOKEN (Queue Logic)
// Fetch the oldest 'waiting' token for BISP
$next = $pdo->query("SELECT * FROM queue_tokens WHERE status='waiting' AND service_type='bisp' ORDER BY id ASC LIMIT 1")->fetch();

// If no queue, allow manual entry? Yes, form handles empty token_id.
?>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="glass-panel p-4 border-top border-5 border-success bg-white shadow-sm">
            <h3 class="fw-bold mb-3 text-center text-dark">
                <i class="fas fa-hand-holding-usd text-success me-2"></i> Cash Payout
            </h3>
            
            <?php if($msg): ?>
                <div class="alert alert-success fw-bold text-center shadow-sm">
                    <i class="fas fa-check-circle me-2"></i> <?php echo $msg; ?>
                </div>
            <?php endif; ?>

            <?php if($error): ?>
                <div class="alert alert-danger fw-bold text-center shadow-sm">
                    <i class="fas fa-exclamation-circle me-2"></i> <?php echo $error; ?>
                </div>
            <?php endif; ?>

            <div class="card bg-light mb-4 text-center border-0 shadow-inner">
                <div class="card-body py-4">
                    <small class="text-muted fw-bold text-uppercase ls-1">Current Token</small>
                    <?php if($next): ?>
                        <h1 class="display-3 fw-bold text-primary mb-0 mt-2"><?php echo $next['token_number']; ?></h1>
                        <div class="text-muted fw-bold fs-5 mt-1">
                            <i class="fas fa-id-card me-1"></i> <?php echo $next['cnic']; ?>
                        </div>
                    <?php else: ?>
                        <h2 class="text-muted py-3">Queue is Empty</h2>
                        <small class="text-muted">You can process a manual payout below.</small>
                    <?php endif; ?>
                </div>
            </div>

            <form method="POST" autocomplete="off">
                <input type="hidden" name="process_payout" value="1">
                <input type="hidden" name="token_id" value="<?php echo $next['id'] ?? ''; ?>">
                
                <?php if(!$next): ?>
                <div class="mb-3">
                    <label class="fw-bold small text-muted">Beneficiary CNIC</label>
                    <input type="text" name="cnic" class="form-control fw-bold" placeholder="00000-0000000-0" required>
                </div>
                <?php else: ?>
                <input type="hidden" name="cnic" value="<?php echo $next['cnic']; ?>">
                <?php endif; ?>
                
                <div class="mb-3">
                    <label class="fw-bold small text-muted">Amount Withdrawn</label>
                    <div class="input-group">
                        <span class="input-group-text fw-bold">Rs.</span>
                        <input type="number" name="amount" id="amt" class="form-control form-control-lg fw-bold" placeholder="e.g. 10500" required oninput="calc()">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="fw-bold small text-muted">Deduction / Fee</label>
                    <div class="input-group">
                        <span class="input-group-text fw-bold text-danger">-</span>
                        <input type="number" name="deduction" id="fee" class="form-control fw-bold text-danger" value="0" oninput="calc()">
                    </div>
                </div>

                <div class="alert alert-warning text-center fw-bold fs-4 shadow-sm border-warning">
                    Handover: Rs. <span id="final">0</span>
                </div>

                <button class="btn btn-success w-100 btn-lg rounded-pill fw-bold shadow hover-effect">
                    <i class="fas fa-check me-2"></i> CONFIRM PAYOUT
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function calc() {
    let amt = parseFloat(document.getElementById('amt').value) || 0;
    let fee = parseFloat(document.getElementById('fee').value) || 0;
    let final = amt - fee;
    document.getElementById('final').innerText = final.toLocaleString();
}
</script>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\print_batch.php
==============================================================================

<?php
require 'includes/config.php';
requireAuth();

// Fetch 20 unprinted tokens
$tokens = $pdo->query("SELECT * FROM queue_tokens WHERE is_printed=0 ORDER BY id ASC LIMIT 20")->fetchAll();

// Auto-mark as printed
if(count($tokens) > 0) {
    $ids = array_column($tokens, 'id');
    $in  = str_repeat('?,', count($ids) - 1) . '?';
    $pdo->prepare("UPDATE queue_tokens SET is_printed=1 WHERE id IN ($in)")->execute($ids);
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Batch Print (A4)</title>
    <style>
        @page { size: A4; margin: 5mm; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #fff; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 Columns */
            grid-template-rows: repeat(5, 1fr);    /* 5 Rows */
            gap: 2mm;
            height: 285mm; /* Fits A4 */
        }
        
        .card {
            border: 2px dashed #444;
            border-radius: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
        }
        
        .brand { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #000; }
        .token { font-size: 32px; font-weight: 900; margin: 5px 0; font-family: 'Arial Black', sans-serif; }
        .cnic { font-size: 12px; font-family: monospace; font-weight: bold; letter-spacing: 1px; }
        .meta { font-size: 9px; color: #555; margin-top: 5px; }
    </style>
</head>
<body onload="window.print()">

    <?php if(count($tokens) == 0): ?>
        <div style="text-align:center; padding-top:50px;">
            <h2>Queue is Empty</h2>
            <p>No unprinted tokens found.</p>
        </div>
    <?php else: ?>
        <div class="grid">
            <?php foreach($tokens as $t): ?>
            <div class="card">
                <div class="brand">Arham BISP Center</div>
                <div class="token"><?php echo $t['token_number']; ?></div>
                <div class="cnic"><?php echo $t['cnic']; ?></div>
                <div class="meta"><?php echo date('d-M h:i A', strtotime($t['issued_at'])); ?></div>
            </div>
            <?php endforeach; ?>
        </div>
    <?php endif; ?>

</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\print_receipt.php
==============================================================================

<?php
require 'includes/config.php';
requireAuth();

$id = $_GET['id'];
$txn = $pdo->prepare("SELECT t.*, b.name, b.cnic FROM transactions t JOIN beneficiaries b ON t.beneficiary_id = b.id WHERE t.id = ?");
$txn->execute([$id]);
$row = $txn->fetch();

if(!$row) die("Transaction not found");
?>
<!DOCTYPE html>
<html>
<head>
    <title>Receipt #<?php echo $id; ?></title>
    <style>
        body { width: 72mm; margin: 0 auto; font-family: 'Courier New', monospace; font-size: 12px; }
        .center { text-align: center; }
        .bold { font-weight: bold; }
        .divider { border-top: 1px dashed #000; margin: 5px 0; }
        .kv-row { display: flex; justify-content: space-between; }
    </style>
</head>
<body onload="window.print();">
    
    <div class="center bold" style="font-size: 16px;">ARHAM PRINTERS</div>
    <div class="center">Jalalpur Jattan</div>
    <div class="center">0300-6238233</div>
    
    <div class="divider"></div>
    
    <div class="kv-row"><span>Receipt #:</span> <span><?php echo str_pad($row['id'], 6, '0', STR_PAD_LEFT); ?></span></div>
    <div class="kv-row"><span>Date:</span> <span><?php echo date('d-M-y h:i A'); ?></span></div>
    
    <div class="divider"></div>
    
    <div class="bold">Beneficiary Details:</div>
    <div class="kv-row"><span>Name:</span> <span><?php echo substr($row['name'], 0, 15); ?></span></div>
    <div class="kv-row"><span>CNIC:</span> <span><?php echo $row['cnic']; ?></span></div>
    
    <div class="divider"></div>
    
    <div class="kv-row bold" style="font-size: 14px;">
        <span>AMOUNT PAID:</span>
        <span>Rs. <?php echo number_format($row['amount']); ?></span>
    </div>
    
    <div class="kv-row"><span>Bank TRX:</span> <span><?php echo $row['konnect_trx_id']; ?></span></div>
    <div class="kv-row"><span>Agent:</span> <span><?php echo $_SESSION['username'] ?? 'Staff'; ?></span></div>
    
    <div class="divider"></div>
    <div class="center" style="font-size: 10px;">Computer Generated Slip<br>Not valid for legal claims</div>
    <br>
</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\print_token.php
==============================================================================

<?php
require 'includes/config.php';
requireAuth();

$id = $_GET['id'] ?? 0;
$stmt = $pdo->prepare("SELECT * FROM queue_tokens WHERE id = ?");
$stmt->execute([$id]);
$token = $stmt->fetch();

if(!$token) die("Token not found");
?>
<!DOCTYPE html>
<html>
<head>
    <title>Token #<?php echo $token['token_number']; ?></title>
    <style>
        body { width: 58mm; margin: 0; font-family: 'Arial', sans-serif; text-align: center; }
        .header { font-size: 14px; font-weight: bold; text-transform: uppercase; margin-top: 5px; }
        .sub-header { font-size: 10px; margin-bottom: 5px; }
        .token-box { border: 2px solid #000; padding: 5px; margin: 5px 0; border-radius: 5px; }
        .token-num { font-size: 32px; font-weight: 900; }
        .label { font-size: 10px; text-transform: uppercase; }
        .details { font-size: 10px; text-align: left; margin-top: 5px; }
        .footer { font-size: 9px; margin-top: 10px; font-style: italic; }
    </style>
</head>
<body onload="window.print(); setTimeout(window.close, 500);">

    <div class="header">Arham Printers</div>
    <div class="sub-header">BISP Disbursement Center</div>
    
    <div class="token-box">
        <div class="label">Your Token Number</div>
        <div class="token-num"><?php echo $token['token_number']; ?></div>
    </div>

    <div class="details">
        <strong>CNIC:</strong> <?php echo $token['cnic']; ?><br>
        <strong>Date:</strong> <?php echo date('d-M-Y h:i A', strtotime($token['issued_at'])); ?>
    </div>

    <div class="footer">
        Please wait for your turn.<br>
        Powered by ArhamSoft
    </div>

</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\purchases.php
==============================================================================

<?php 
require 'includes/header.php'; 

// 1. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit(); }
$allowed_ids = [1, 14, 15]; 
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');

if (!$is_admin) { 
    die("<div class='alert alert-danger text-center m-5'>‚õî ACCESS DENIED: Only Admin can access Purchases.</div>"); 
}

// 2. HANDLE PURCHASE SUBMISSION
$msg = "";
$error = "";

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['save_purchase'])) {
    $supplier_id = $_POST['supplier_id']; 
    $items = $_POST['item_name']; // Array
    $qtys = $_POST['qty']; // Array
    $costs = $_POST['cost']; // Array
    $paid = $_POST['paid_amount'];
    
    // Validate
    if (empty($supplier_id) || count($items) == 0) {
        $error = "Please select a supplier and add at least one item.";
    } else {
        $grand_total = 0;
        $inv_no = "PUR-" . date('ymd-His');
        $items_json = [];

        try {
            // LOOP THROUGH ITEMS
            for($i=0; $i < count($items); $i++) {
                if(empty($items[$i])) continue;
                
                $name = trim($items[$i]);
                $qty = (int)$qtys[$i];
                $cost = (float)$costs[$i];
                $row_total = $qty * $cost;
                $grand_total += $row_total;
                
                // Store for JSON record
                $items_json[] = ['name'=>$name, 'qty'=>$qty, 'cost'=>$cost];

                // A. Update Inventory
                // Check if item exists in inventory
                $chk = $pdo->prepare("SELECT id FROM inventory WHERE item_name = ?");
                $chk->execute([$name]);
                
                if($row = $chk->fetch()) {
                    // Update existing item: Add Stock, Update Purchase Price
                    $stmt = $pdo->prepare("UPDATE inventory SET stock_qty = stock_qty + ?, purchase_price = ? WHERE id=?");
                    $stmt->execute([$qty, $cost, $row['id']]);
                } else {
                    // Create New Item
                    // Auto-set Sale Price to Cost + 20% margin
                    $sale_price = $cost * 1.2;
                    $stmt = $pdo->prepare("INSERT INTO inventory (item_name, stock_qty, purchase_price, sale_price) VALUES (?, ?, ?, ?)");
                    $stmt->execute([$name, $qty, $cost, $sale_price]);
                }
                
                // B. Add to Ledger (Detailed breakdown)
                $desc = "Bought $name x$qty";
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, invoice_no) VALUES (CURDATE(), 'purchase', 'Stock', ?, ?, ?)");
                $stmt->execute([$desc, $row_total, $inv_no]);
            }

            // C. Handle Financials
            // Fetch Supplier Name
            $sup_q = $pdo->query("SELECT person_name FROM loans WHERE id=$supplier_id")->fetch();
            $supplier_name = $sup_q['person_name'];
            
            // Deduct Cash (If Paid)
            if($paid > 0) {
                // Deduct from Drawer
                $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name='Shop Cash Drawer'")->execute([$paid]);
                
                // Ledger Entry for Payment
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, invoice_no) VALUES (CURDATE(), 'expense', 'Supplier Payment', ?, ?, 'Cash', ?)");
                $stmt->execute(["Paid to $supplier_name", $paid, $inv_no]);
            }

            // Update Supplier Balance (Debt)
            $due_amount = $grand_total - $paid;
            if($due_amount > 0) {
                // Increase the 'total_amount' we owe in the loans table
                $pdo->prepare("UPDATE loans SET total_amount = total_amount + ? WHERE id=?")->execute([$due_amount, $supplier_id]);
            }
            
            // D. Create Master Purchase Record
            $json_str = json_encode($items_json);
            $stmt = $pdo->prepare("INSERT INTO purchases (supplier_name, invoice_no, items_json, total_amount, paid_amount) VALUES (?, ?, ?, ?, ?)");
            $stmt->execute([$supplier_name, $inv_no, $json_str, $grand_total, $paid]);

            $msg = "Purchase #$inv_no recorded successfully! Stock and Ledger updated.";

        } catch (Exception $e) {
            $error = "Error recording purchase: " . $e->getMessage();
        }
    }
}

// Fetch Suppliers for Dropdown
$suppliers = $pdo->query("SELECT * FROM loans WHERE type='taken' ORDER BY person_name ASC")->fetchAll();
?>

<div class="row mb-4">
    <div class="col-12">
        <h3 class="fw-bold"><i class="fas fa-truck-loading text-primary"></i> New Purchase Order</h3>
    </div>
</div>

<?php if($msg): ?>
    <div class="alert alert-success fw-bold text-center"><?php echo $msg; ?></div>
<?php endif; ?>
<?php if($error): ?>
    <div class="alert alert-danger fw-bold text-center"><?php echo $error; ?></div>
<?php endif; ?>

<form method="POST">
    <input type="hidden" name="save_purchase" value="1">
    
    <div class="glass-panel p-4">
        <div class="row mb-4">
            <div class="col-md-4">
                <label class="fw-bold text-muted small">Select Supplier</label>
                <select name="supplier_id" class="form-select" required>
                    <option value="">-- Choose Supplier --</option>
                    <?php foreach($suppliers as $s): ?>
                    <option value="<?php echo $s['id']; ?>"><?php echo htmlspecialchars($s['person_name']); ?></option>
                    <?php endforeach; ?>
                </select>
                <div class="mt-2">
                    <a href="contacts.php" class="small text-decoration-none"><i class="fas fa-plus-circle"></i> Create New Supplier</a>
                </div>
            </div>
            <div class="col-md-4">
                <label class="fw-bold text-muted small">Date</label>
                <input type="text" class="form-control" value="<?php echo date('d M Y'); ?>" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold text-muted small">Invoice #</label>
                <input type="text" class="form-control" value="Auto-Generated" readonly>
            </div>
        </div>

        <table class="table table-bordered mb-3" id="pTable">
            <thead class="bg-light">
                <tr>
                    <th>Item Name</th>
                    <th width="15%">Qty</th>
                    <th width="20%">Cost Price (Per Unit)</th>
                    <th width="20%">Total</th>
                    <th width="5%"></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" name="item_name[]" class="form-control" placeholder="Product Name" required></td>
                    <td><input type="number" name="qty[]" class="form-control qty" oninput="calcRow(this)" required></td>
                    <td><input type="number" name="cost[]" class="form-control cost" oninput="calcRow(this)" required></td>
                    <td class="row-total fw-bold text-end pt-3">0.00</td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calcGrand();">x</button></td>
                </tr>
            </tbody>
        </table>
        
        <button type="button" class="btn btn-sm btn-secondary mb-4 rounded-pill px-3" onclick="addRow()">+ Add Another Item</button>

        <div class="row justify-content-end">
            <div class="col-md-4">
                <div class="d-flex justify-content-between mb-2">
                    <span class="fw-bold">Grand Total:</span>
                    <span class="fw-bold fs-5">Rs. <span id="grand">0</span></span>
                </div>
                <div class="mb-3">
                    <label class="fw-bold text-success small">Amount Paid (Cash)</label>
                    <input type="number" name="paid_amount" class="form-control fw-bold border-success" value="0" required>
                    <small class="text-muted">Balance will be added to Supplier ledger.</small>
                </div>
                <button class="btn btn-primary w-100 fw-bold py-3 shadow">CONFIRM PURCHASE</button>
            </div>
        </div>
    </div>
</form>

<script>
function addRow() {
    let row = `<tr>
        <td><input type="text" name="item_name[]" class="form-control" placeholder="Product Name"></td>
        <td><input type="number" name="qty[]" class="form-control qty" oninput="calcRow(this)"></td>
        <td><input type="number" name="cost[]" class="form-control cost" oninput="calcRow(this)"></td>
        <td class="row-total fw-bold text-end pt-3">0.00</td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calcGrand();">x</button></td>
    </tr>`;
    document.querySelector('#pTable tbody').insertAdjacentHTML('beforeend', row);
}

function calcRow(el) {
    let tr = el.closest('tr');
    let qty = parseFloat(tr.querySelector('.qty').value) || 0;
    let cost = parseFloat(tr.querySelector('.cost').value) || 0;
    let total = qty * cost;
    tr.querySelector('.row-total').innerText = total.toFixed(2);
    calcGrand();
}

function calcGrand() {
    let grand = 0;
    document.querySelectorAll('.row-total').forEach(el => {
        grand += parseFloat(el.innerText);
    });
    document.getElementById('grand').innerText = grand.toLocaleString();
}
</script>
<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\queue.php
==============================================================================

<?php
require 'includes/header.php';

// ACCESS
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit(); }

// GENERATE TOKEN
$msg = "";
$print_token = "";
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $cnic = $_POST['cnic'];
    $type = $_POST['type'];
    
    // Get next token number for today
    $stmt = $pdo->prepare("SELECT MAX(token_number) FROM queue_tokens WHERE DATE(issued_at) = CURDATE()");
    $stmt->execute();
    $next = ($stmt->fetchColumn() ?: 0) + 1;
    
    // Insert
    $stmt = $pdo->prepare("INSERT INTO queue_tokens (token_number, cnic, service_type) VALUES (?, ?, ?)");
    $stmt->execute([$next, $cnic, $type]);
    
    // Save/Update Beneficiary
    $chk = $pdo->prepare("SELECT id FROM beneficiaries WHERE cnic = ?");
    $chk->execute([$cnic]);
    if (!$chk->fetch()) {
        $pdo->prepare("INSERT INTO beneficiaries (cnic, last_visit) VALUES (?, CURDATE())")->execute([$cnic]);
    }

    $print_token = $next;
    $msg = "Token #$next Issued!";
}

// Current Queue
$waiting = $pdo->query("SELECT * FROM queue_tokens WHERE status='waiting' ORDER BY id ASC")->fetchAll();
?>

<div class="row">
    <div class="col-md-5">
        <div class="glass-panel p-4 border-start border-5 border-primary">
            <h4 class="fw-bold mb-3"><i class="fas fa-ticket-alt"></i> Issue Token</h4>
            
            <?php if($print_token): ?>
            <div class="alert alert-success text-center py-4 mb-4">
                <h6 class="text-uppercase text-muted">Token Number</h6>
                <h1 class="display-1 fw-bold"><?php echo $print_token; ?></h1>
                <button onclick="window.print()" class="btn btn-sm btn-outline-dark no-print">Print Slip</button>
            </div>
            <?php endif; ?>

            <form method="POST">
                <div class="mb-3">
                    <label class="fw-bold">CNIC / Mobile</label>
                    <input type="text" name="cnic" class="form-control form-control-lg fw-bold" placeholder="Enter ID" required autofocus>
                </div>
                <div class="mb-4">
                    <label class="fw-bold">Service</label>
                    <select name="type" class="form-select form-select-lg">
                        <option value="bisp">BISP Cashout</option>
                        <option value="bills">Bill Payment</option>
                        <option value="other">Other Inquiry</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100 btn-lg fw-bold rounded-pill">GENERATE TOKEN</button>
            </form>
        </div>
    </div>

    <div class="col-md-7">
        <div class="glass-panel p-0 overflow-hidden">
            <div class="p-3 bg-dark text-white d-flex justify-content-between">
                <h5 class="m-0">Waiting Queue</h5>
                <span class="badge bg-warning text-dark"><?php echo count($waiting); ?> Pending</span>
            </div>
            <table class="table table-striped mb-0 align-middle">
                <thead><tr><th>Token</th><th>CNIC</th><th>Service</th><th>Time</th></tr></thead>
                <tbody>
                    <?php foreach($waiting as $w): ?>
                    <tr>
                        <td><span class="badge bg-primary fs-5"><?php echo $w['token_number']; ?></span></td>
                        <td><?php echo $w['cnic']; ?></td>
                        <td><span class="badge bg-secondary text-uppercase"><?php echo $w['service_type']; ?></span></td>
                        <td class="small text-muted"><?php echo date('h:i A', strtotime($w['issued_at'])); ?></td>
                    </tr>
                    <?php endforeach; ?>
                    <?php if(empty($waiting)): ?><tr><td colspan="4" class="text-center py-4">No one is waiting.</td></tr><?php endif; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>
<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\reconcile.php
==============================================================================

<?php include 'includes/header.php'; 
if (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') { die("ACCESS DENIED"); }

$today = date('Y-m-d');
$total_paid = $pdo->query("SELECT SUM(amount) FROM transactions WHERE DATE(created_at) = '$today' AND status='success'")->fetchColumn() ?: 0;
$count = $pdo->query("SELECT COUNT(*) FROM transactions WHERE DATE(created_at) = '$today' AND status='success'")->fetchColumn() ?: 0;

$msg = "";
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $opening = $_POST['opening_cash'];
    $refill = $_POST['bank_withdrawals'];
    $closing = $_POST['physical_cash_now'];
    
    // Formula: (Opening + Refills) - PaidOut should equal Closing
    $expected = ($opening + $refill) - $total_paid;
    $diff = $closing - $expected;
    
    $color = ($diff == 0) ? 'success' : (($diff < 0) ? 'danger' : 'warning');
    $status = ($diff == 0) ? 'Perfect Match' : (($diff < 0) ? 'Cash Shortage' : 'Surplus Cash');
    
    $msg = "<div class='alert alert-$color glass-panel text-center'>
        <h3 class='fw-bold'>$status: Rs. " . number_format($diff) . "</h3>
        <p class='mb-0'>Expected: " . number_format($expected) . " | Found: " . number_format($closing) . "</p>
    </div>";
}
?>

<link rel="stylesheet" href="css/modern.css">

<div class="row justify-content-center">
    <div class="col-md-5">
        
        <?php echo $msg; ?>

        <div class="glass-panel p-4">
            <div class="text-center mb-4">
                <h4 class="fw-bold"><i class="fas fa-balance-scale"></i> Daily Closing</h4>
                <p class="text-muted"><?php echo date('l, d F Y'); ?></p>
            </div>

            <div class="alert alert-info text-center border-0 bg-opacity-10">
                <small class="text-uppercase">Total Disbursed Today</small>
                <h2 class="fw-bold my-1">Rs. <?php echo number_format($total_paid); ?></h2>
                <small>(<?php echo $count; ?> Transactions)</small>
            </div>

            <form method="POST">
                <div class="mb-3">
                    <label class="fw-bold small">1. Opening Cash (Morning)</label>
                    <input type="number" name="opening_cash" class="form-control" required placeholder="0">
                </div>
                <div class="mb-3">
                    <label class="fw-bold small">2. Cash Added (Refills)</label>
                    <input type="number" name="bank_withdrawals" class="form-control" value="0">
                </div>
                <div class="mb-4">
                    <label class="fw-bold small text-primary">3. Closing Cash (Count Now)</label>
                    <input type="number" name="physical_cash_now" class="form-control form-control-lg border-primary fw-bold" required placeholder="0">
                </div>
                <button class="btn btn-dark w-100 rounded-pill py-3 fw-bold">Calculate Balance</button>
            </form>
        </div>
    </div>
</div>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\shop_pos.php
==============================================================================

<?php 
// 1. ENABLE ERROR REPORTING
error_reporting(E_ALL);
ini_set('display_errors', 1);

require 'includes/header.php'; 

// 2. ACCESS CONTROL
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit(); }

$allowed_ids = [1, 14, 15]; 
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');
$has_perm = (isset($_SESSION['permissions']['shop']) && $_SESSION['permissions']['shop'] == 1);

if (!$is_admin && !$has_perm) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED: You don't have shop access permission.</div></div>");
}

// 3. GET SHOP SETTINGS
$shop_settings = [];
try {
    $stmt = $pdo->query("SELECT * FROM system_settings");
    $settings = $stmt->fetchAll();
    foreach ($settings as $setting) {
        $shop_settings[$setting['setting_key']] = $setting['setting_value'];
    }
} catch (Exception $e) {}

$shop_name = $shop_settings['shop_name'] ?? "ARHAM PRINTERS";
$shop_phone = $shop_settings['shop_phone'] ?? "0300-0000000";
$receipt_footer = $shop_settings['invoice_footer'] ?? "Thank you for your business!";

// 4. HANDLE SALE CHECKOUT
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['checkout'])) {
    
    // Retrieve POST Data
    $cart_json = $_POST['cart_data'];
    $cart = json_decode($cart_json, true);
    $customer_id = $_POST['customer_id']; // ID from 'loans' table (contacts)
    $paid_amount = (float) $_POST['paid_amount'];
    $grand_total = (float) $_POST['grand_total'];
    $change_amount = (float) $_POST['change_amount'];
    $payment_method = $_POST['payment_method'] ?? 'cash';
    $discount = (float) $_POST['discount'] ?? 0;
    $discount_type = $_POST['discount_type'] ?? 'amount';
    $invoice_note = trim($_POST['invoice_note'] ?? '');
    
    // Generate Invoice Number
    $inv_no = "INV-" . date('ymd-His'); 
    
    // Determine Customer Name
    $cust_name = "Walk-in Customer";
    $customer_phone = "";
    if (!empty($customer_id)) {
        $stmt = $pdo->prepare("SELECT person_name, phone FROM loans WHERE id = ?");
        $stmt->execute([$customer_id]);
        $c = $stmt->fetch();
        if ($c) {
            $cust_name = $c['person_name'];
            $customer_phone = $c['phone'] ?? '';
        }
    }

    if (count($cart) > 0) {
        try {
            $pdo->beginTransaction();
            
            // Calculate discount
            $discount_amount = 0;
            if ($discount > 0) {
                if ($discount_type == 'percentage') {
                    $discount_amount = ($grand_total * $discount) / 100;
                } else {
                    $discount_amount = $discount;
                }
            }
            
            $final_total = $grand_total - $discount_amount;
            
            // Create invoice record
            $stmt = $pdo->prepare("INSERT INTO invoices (invoice_no, customer_name, customer_id, subtotal, discount, grand_total, paid_amount, due_amount, type, status, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'completed', NOW())");
            $due_amount = $final_total - $paid_amount;
            $stmt->execute([$inv_no, $cust_name, $customer_id ?: null, $grand_total, $discount_amount, $final_total, $paid_amount, $due_amount, 'sale']);
            
            foreach ($cart as $item) {
                $item_id = $item['id'];
                $item_name = $item['name'];
                $item_price = (float) $item['price'];
                $item_qty = (int) $item['qty'];
                $item_total = $item_price * $item_qty;
                
                // Auto-Add Custom Item Logic
                if ($item_id == 'NEW' || empty($item_id)) {
                    $chk = $pdo->prepare("SELECT id FROM inventory WHERE item_name = ?");
                    $chk->execute([$item_name]);
                    if ($row = $chk->fetch()) {
                        $item_id = $row['id'];
                    } else {
                        // Create New Item with 20% margin
                        $purchase_price = $item_price / 1.2;
                        $stmt = $pdo->prepare("INSERT INTO inventory (item_name, sale_price, purchase_price, stock_qty) VALUES (?, ?, ?, -1)");
                        $stmt->execute([$item_name, $item_price, $purchase_price]);
                        $item_id = $pdo->lastInsertId();
                    }
                }

                // Ledger Entry (Detailed)
                $desc = $item_name . " x" . $item_qty;
                $category = $cust_name;
                
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head, invoice_no) VALUES (NOW(), 'sale', ?, ?, ?, ?, 'Shop Cash Drawer', ?)");
                $stmt->execute([$category, $desc, $item_total, $payment_method, $inv_no]);

                // Deduct Stock (if not unlimited)
                if ($item_id !== 'NEW' && $item_id > 0) {
                    $stmt = $pdo->prepare("SELECT stock_qty FROM inventory WHERE id = ?");
                    $stmt->execute([$item_id]);
                    $stock = $stmt->fetch();
                    
                    if ($stock && $stock['stock_qty'] > 0) {
                        $pdo->prepare("UPDATE inventory SET stock_qty = stock_qty - ? WHERE id = ?")->execute([$item_qty, $item_id]);
                    }
                }
            }

            // Handle Financials
            if ($paid_amount > 0 && $payment_method == 'cash') {
                // Add to Cash Drawer
                $pdo->prepare("UPDATE accounts SET current_balance = current_balance + ? WHERE account_name = 'Shop Cash Drawer'")->execute([$paid_amount]);
                
                // If change given, deduct from drawer
                if ($change_amount > 0) {
                    $pdo->prepare("UPDATE accounts SET current_balance = current_balance - ? WHERE account_name = 'Shop Cash Drawer'")->execute([$change_amount]);
                    
                    // Record change as expense
                    $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, account_head, invoice_no) VALUES (NOW(), 'expense', 'Change Given', 'Change to Customer', ?, 'Shop Cash Drawer', ?)");
                    $stmt->execute([$change_amount, $inv_no]);
                }
            }
            
            // Record discount if applied
            if ($discount_amount > 0) {
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, account_head, invoice_no) VALUES (NOW(), 'expense', 'Discount', 'Discount on Invoice ' . ?, ?, 'Shop Cash Drawer', ?)");
                $stmt->execute([$inv_no, $discount_amount, $inv_no]);
            }

            // Handle Credit (If Customer Selected AND Paid < Total)
            if ($due_amount > 0 && $customer_id) {
                // Increase Customer's Debt (total_amount)
                $pdo->prepare("UPDATE loans SET total_amount = total_amount + ? WHERE id = ?")->execute([$due_amount, $customer_id]);
                
                // Record credit sale
                $stmt = $pdo->prepare("INSERT INTO finance_ledger (trans_date, type, category, description, amount, payment_method, account_head, invoice_no) VALUES (NOW(), 'loan_given', 'Credit Sale', 'Credit to ' . ?, ?, 'Credit', 'Customer Ledger', ?)");
                $stmt->execute([$cust_name, $due_amount, $inv_no]);
            }

            $pdo->commit();
            
            // Store invoice data for receipt
            $_SESSION['last_invoice'] = [
                'invoice_no' => $inv_no,
                'customer_name' => $cust_name,
                'customer_phone' => $customer_phone,
                'total' => $final_total,
                'paid' => $paid_amount,
                'change' => $change_amount,
                'discount' => $discount_amount,
                'items' => $cart
            ];
            
            // Redirect to Invoice/Receipt
            echo "<script>window.location.href='invoice.php?id=$inv_no';</script>";
            exit();
            
        } catch (Exception $e) {
            $pdo->rollBack();
            $error = "Sale Error: " . $e->getMessage();
        }
    }
}

// 5. FETCH CUSTOMERS FOR DROPDOWN
$customers = $pdo->query("SELECT * FROM loans WHERE type='given' AND status='active' ORDER BY person_name ASC")->fetchAll();

// 6. FETCH INVENTORY ITEMS
$inventory_items = $pdo->query("SELECT * FROM inventory WHERE stock_qty != 0 ORDER BY item_name ASC")->fetchAll();

// 7. GET TODAY'S STATS
$today_sales = $pdo->query("SELECT SUM(amount) FROM finance_ledger WHERE type = 'sale' AND DATE(trans_date) = CURDATE()")->fetchColumn() ?: 0;
$today_transactions = $pdo->query("SELECT COUNT(*) FROM finance_ledger WHERE type = 'sale' AND DATE(trans_date) = CURDATE()")->fetchColumn() ?: 0;

// 8. GET LOW STOCK ITEMS
$low_stock = $pdo->query("SELECT * FROM inventory WHERE stock_qty > 0 AND stock_qty < 10 ORDER BY stock_qty ASC LIMIT 5")->fetchAll();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System - <?php echo $shop_name; ?></title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    
    <!-- Scanner Libraries -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- Sound Effects -->
    <audio id="beepSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="errorSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    
    <style>
        /* ===== VARIABLES ===== */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #1abc9c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            --border-radius: 15px;
            --transition: all 0.3s ease;
        }

        /* ===== BASE STYLES ===== */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* ===== PWA APP STYLES ===== */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .pwa-header {
                padding-top: 20px;
            }
        }

        /* ===== LAYOUT ===== */
        .pos-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (min-width: 992px) {
            .pos-container {
                grid-template-columns: 1fr 1fr;
                height: calc(100vh - 40px);
            }
        }

        /* ===== CARD STYLES ===== */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            overflow: hidden;
        }

        .glass-card:hover {
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
            transform: translateY(-2px);
        }

        /* ===== HEADER ===== */
        .pos-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .pos-header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pos-header h1 i {
            font-size: 1.5rem;
        }

        .pos-stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(5px);
        }

        /* ===== SCANNER ===== */
        .scanner-container {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        #reader {
            width: 100%;
            height: 300px;
            border: 3px solid var(--primary);
            border-radius: var(--border-radius);
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(transparent 45%, rgba(0,0,0,0.1) 50%, transparent 55%);
            pointer-events: none;
        }

        /* ===== PRODUCT GRID ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
        }

        .product-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--secondary);
        }

        .product-card.selected {
            border-color: var(--success);
            background: rgba(46, 204, 113, 0.1);
        }

        .product-card .stock-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .product-card .stock-badge.low {
            background: var(--danger);
            color: white;
        }

        .product-card .stock-badge.medium {
            background: var(--warning);
            color: white;
        }

        .product-card .stock-badge.high {
            background: var(--success);
            color: white;
        }

        .product-name {
            font-weight: 600;
            margin: 10px 0 5px;
            font-size: 0.9rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-price {
            color: var(--success);
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* ===== CART SECTION ===== */
        .cart-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .cart-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            max-height: 400px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: var(--transition);
        }

        .cart-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .cart-item .item-info {
            flex: 1;
        }

        .cart-item .item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cart-item .item-price {
            color: var(--success);
            font-weight: 700;
        }

        .cart-item .item-qty {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-item .qty-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
        }

        .cart-item .qty-btn:hover {
            background: var(--secondary);
            color: white;
        }

        .cart-item .item-total {
            font-weight: 700;
            color: var(--primary);
            min-width: 80px;
            text-align: right;
        }

        .cart-item .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
        }

        /* ===== CALCULATOR ===== */
        .calculator {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 20px;
        }

        .calc-btn {
            height: 60px;
            border: none;
            border-radius: 10px;
            background: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .calc-btn.number {
            background: var(--light);
        }

        .calc-btn.operation {
            background: var(--secondary);
            color: white;
        }

        .calc-btn.clear {
            background: var(--danger);
            color: white;
        }

        .calc-btn.equals {
            background: var(--success);
            color: white;
            grid-column: span 2;
        }

        /* ===== PAYMENT PANEL ===== */
        .payment-panel {
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .amount-display {
            font-size: 3rem;
            font-weight: 800;
            text-align: center;
            color: var(--primary);
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .payment-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payment-input {
            flex: 1;
            height: 60px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid var(--light);
            border-radius: 10px;
            padding: 10px;
        }

        .payment-input:focus {
            border-color: var(--secondary);
            outline: none;
        }

        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-amount {
            padding: 12px;
            border: 2px solid var(--light);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .quick-amount:hover {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.1);
        }

        /* ===== BUTTONS ===== */
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--light);
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-secondary:hover {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.1);
        }

        /* ===== TABS ===== */
        .pos-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .pos-tab {
            padding: 15px 25px;
            border: none;
            background: none;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .pos-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .pos-tab:hover {
            color: var(--primary);
        }

        .pos-tab .badge {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.7rem;
            padding: 2px 6px;
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse-animation {
            animation: pulse 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        /* ===== UTILITIES ===== */
        .hidden {
            display: none !important;
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-muted { color: #666; }

        .mb-1 { margin-bottom: 5px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .mb-4 { margin-bottom: 20px; }

        .mt-1 { margin-top: 5px; }
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mt-4 { margin-top: 20px; }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            .pos-container {
                padding: 10px;
                gap: 10px;
            }

            .amount-display {
                font-size: 2.5rem;
            }

            .calculator {
                grid-template-columns: repeat(4, 1fr);
                gap: 5px;
                padding: 10px;
            }

            .calc-btn {
                height: 50px;
                font-size: 1.1rem;
            }

            .payment-input {
                height: 50px;
                font-size: 1.3rem;
            }

            .pos-header h1 {
                font-size: 1.5rem;
            }

            .stat-badge {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
        }

        /* ===== DARK MODE ===== */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #3498db;
                --secondary: #2c3e50;
                --light: #2c3e50;
                --glass-bg: rgba(44, 62, 80, 0.9);
            }

            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }

            .glass-card {
                color: white;
                background: var(--glass-bg);
            }

            .product-card {
                background: #34495e;
                color: white;
            }

            .cart-item {
                background: #34495e;
                color: white;
            }

            .calc-btn.number {
                background: #2c3e50;
                color: white;
            }

            .modal-content {
                background: #2c3e50;
                color: white;
            }
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== NOTIFICATIONS ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        /* ===== KEYBOARD SHORTCUTS HINT ===== */
        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .shortcut-hint.show {
            opacity: 1;
        }

        /* ===== VOICE COMMAND INDICATOR ===== */
        .voice-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 999;
            animation: pulse 1s infinite;
            cursor: pointer;
        }

        /* ===== CUSTOMER SELECTOR ===== */
        .customer-selector {
            position: relative;
            margin-bottom: 20px;
        }

        .customer-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .customer-dropdown.show {
            display: block;
            animation: slideIn 0.2s ease;
        }

        .customer-option {
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid #eee;
        }

        .customer-option:hover {
            background: var(--light);
        }

        .customer-option.selected {
            background: rgba(52, 152, 219, 0.1);
            font-weight: 600;
        }

        /* ===== RECENT SALES ===== */
        .recent-sales {
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
        }

        .recent-sale-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .recent-sale-item:last-child {
            border-bottom: none;
        }

        /* ===== INVOICE PREVIEW ===== */
        .invoice-preview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .invoice-total {
            border-top: 2px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* ===== OFFLINE INDICATOR ===== */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--danger);
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 1001;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-indicator.show {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash me-2"></i> You are offline. Some features may be limited.
    </div>

    <!-- Notifications Container -->
    <div id="notificationsContainer"></div>

    <!-- Keyboard Shortcuts Hint -->
    <div class="shortcut-hint" id="shortcutHint">
        <div class="mb-1"><strong>Keyboard Shortcuts:</strong></div>
        <div>F2: Scanner | F3: Calculator | F4: Products | F5: Checkout</div>
    </div>

    <!-- Voice Command Indicator -->
    <div class="voice-indicator hidden" id="voiceIndicator">
        <i class="fas fa-microphone"></i>
    </div>

    <!-- Main POS Container -->
    <div class="pos-container">
        <!-- Left Column: Products & Scanner -->
        <div class="glass-card">
            <!-- Header -->
            <div class="pos-header">
                <h1><i class="fas fa-store"></i> <?php echo $shop_name; ?> POS</h1>
                <div class="pos-stats">
                    <div class="stat-badge">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cartCount">0 Items</span>
                    </div>
                    <div class="stat-badge">
                        <i class="fas fa-chart-line"></i>
                        <span>Today: Rs. <?php echo number_format($today_sales); ?></span>
                    </div>
                    <div class="stat-badge">
                        <i class="fas fa-user"></i>
                        <span><?php echo $username; ?></span>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="pos-tabs">
                <button class="pos-tab active" onclick="switchTab('scanner')">
                    <i class="fas fa-barcode"></i> Scanner
                    <span class="badge bg-success" id="scanCount">0</span>
                </button>
                <button class="pos-tab" onclick="switchTab('products')">
                    <i class="fas fa-boxes"></i> Products
                    <span class="badge bg-primary"><?php echo count($inventory_items); ?></span>
                </button>
                <button class="pos-tab" onclick="switchTab('customers')">
                    <i class="fas fa-users"></i> Customers
                    <span class="badge bg-warning"><?php echo count($customers); ?></span>
                </button>
                <button class="pos-tab" onclick="switchTab('recent')">
                    <i class="fas fa-history"></i> Recent
                    <span class="badge bg-info"><?php echo $today_transactions; ?></span>
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content p-3">
                <!-- Scanner Tab -->
                <div id="scannerTab" class="tab-pane">
                    <div class="scanner-container">
                        <div id="reader"></div>
                        <div class="scanner-overlay"></div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn-secondary" onclick="toggleScanner()" id="scannerToggle">
                            <i class="fas fa-camera"></i> Start Scanner
                        </button>
                        <button class="btn-secondary" onclick="switchCamera()">
                            <i class="fas fa-sync-alt"></i> Switch Camera
                        </button>
                        <button class="btn-secondary" onclick="toggleTorch()">
                            <i class="fas fa-lightbulb"></i> Torch
                        </button>
                    </div>
                    <div class="mt-3">
                        <input type="text" class="form-control" id="manualBarcode" placeholder="Enter barcode manually or scan..." onkeypress="handleManualBarcode(event)">
                    </div>
                </div>

                <!-- Products Tab -->
                <div id="productsTab" class="tab-pane hidden">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="productSearch" placeholder="Search products..." oninput="filterProducts()">
                    </div>
                    <div class="products-grid" id="productsGrid">
                        <?php foreach($inventory_items as $item): 
                            $stock_class = '';
                            if ($item['stock_qty'] > 0) {
                                if ($item['stock_qty'] < 5) $stock_class = 'low';
                                elseif ($item['stock_qty'] < 15) $stock_class = 'medium';
                                else $stock_class = 'high';
                            }
                        ?>
                        <div class="product-card" data-id="<?php echo $item['id']; ?>" 
                             data-name="<?php echo htmlspecialchars($item['item_name']); ?>" 
                             data-price="<?php echo $item['sale_price']; ?>"
                             data-stock="<?php echo $item['stock_qty']; ?>"
                             onclick="addToCart('<?php echo $item['id']; ?>', '<?php echo htmlspecialchars(addslashes($item['item_name'])); ?>', <?php echo $item['sale_price']; ?>)">
                            <?php if($item['stock_qty'] > 0): ?>
                            <span class="stock-badge <?php echo $stock_class; ?>">
                                <?php echo $item['stock_qty']; ?> left
                            </span>
                            <?php endif; ?>
                            <div class="product-name"><?php echo htmlspecialchars($item['item_name']); ?></div>
                            <div class="product-price">Rs. <?php echo number_format($item['sale_price']); ?></div>
                        </div>
                        <?php endforeach; ?>
                    </div>
                </div>

                <!-- Customers Tab -->
                <div id="customersTab" class="tab-pane hidden">
                    <div class="customer-selector">
                        <input type="text" class="form-control" id="customerSearch" placeholder="Search customer..." oninput="filterCustomers()">
                        <div class="customer-dropdown" id="customerDropdown">
                            <div class="customer-option" onclick="selectCustomer(null)">
                                <strong>Walk-in Customer</strong>
                                <div class="text-muted small">Cash only</div>
                            </div>
                            <?php foreach($customers as $customer): 
                                $balance = $customer['total_amount'] - $customer['paid_amount'];
                            ?>
                            <div class="customer-option" data-id="<?php echo $customer['id']; ?>" 
                                 onclick="selectCustomer(<?php echo $customer['id']; ?>, '<?php echo htmlspecialchars(addslashes($customer['person_name'])); ?>', <?php echo $balance; ?>)">
                                <strong><?php echo htmlspecialchars($customer['person_name']); ?></strong>
                                <div class="text-muted small">
                                    <?php echo $customer['phone']; ?> | 
                                    Balance: Rs. <?php echo number_format($balance); ?>
                                </div>
                            </div>
                            <?php endforeach; ?>
                        </div>
                    </div>
                    
                    <div id="selectedCustomer" class="p-3 bg-light rounded">
                        <strong>Selected:</strong> Walk-in Customer
                    </div>
                    
                    <div class="mt-3">
                        <h5>Customer Statistics</h5>
                        <div id="customerStats">
                            <!-- Stats will load dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Recent Sales Tab -->
                <div id="recentTab" class="tab-pane hidden">
                    <div class="recent-sales" id="recentSales">
                        <!-- Recent sales will load via AJAX -->
                    </div>
                    <button class="btn-secondary w-100 mt-3" onclick="loadRecentSales()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column: Cart & Payment -->
        <div class="glass-card cart-container">
            <!-- Cart Header -->
            <div class="cart-header">
                <h3 class="mb-0">
                    <i class="fas fa-shopping-cart"></i> Current Sale
                    <span class="float-end text-success" id="grandTotal">Rs. 0</span>
                </h3>
            </div>

            <!-- Cart Items -->
            <div class="cart-items" id="cartItems">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-cart-plus fa-3x mb-3"></i>
                    <p>No items in cart</p>
                    <p class="small">Scan barcode or select products to start</p>
                </div>
            </div>

            <!-- Calculator -->
            <div class="p-3 border-top">
                <div class="calculator">
                    <button class="calc-btn number" onclick="addToCalc('7')">7</button>
                    <button class="calc-btn number" onclick="addToCalc('8')">8</button>
                    <button class="calc-btn number" onclick="addToCalc('9')">9</button>
                    <button class="calc-btn operation" onclick="addToCalc('/')">/</button>
                    
                    <button class="calc-btn number" onclick="addToCalc('4')">4</button>
                    <button class="calc-btn number" onclick="addToCalc('5')">5</button>
                    <button class="calc-btn number" onclick="addToCalc('6')">6</button>
                    <button class="calc-btn operation" onclick="addToCalc('*')">√ó</button>
                    
                    <button class="calc-btn number" onclick="addToCalc('1')">1</button>
                    <button class="calc-btn number" onclick="addToCalc('2')">2</button>
                    <button class="calc-btn number" onclick="addToCalc('3')">3</button>
                    <button class="calc-btn operation" onclick="addToCalc('-')">-</button>
                    
                    <button class="calc-btn number" onclick="addToCalc('0')">0</button>
                    <button class="calc-btn number" onclick="addToCalc('.')">.</button>
                    <button class="calc-btn clear" onclick="clearCalc()">C</button>
                    <button class="calc-btn operation" onclick="addToCalc('+')">+</button>
                    
                    <button class="calc-btn equals" onclick="calculate()">=</button>
                </div>
            </div>

            <!-- Payment Panel -->
            <div class="payment-panel">
                <!-- Discount Section -->
                <div class="mb-3">
                    <div class="d-flex gap-2 mb-2">
                        <input type="number" class="form-control" id="discountAmount" placeholder="Discount" value="0" min="0">
                        <select class="form-control" id="discountType" style="width: 120px;">
                            <option value="amount">Rs.</option>
                            <option value="percentage">%</option>
                        </select>
                        <button class="btn-secondary" onclick="applyDiscount()">
                            <i class="fas fa-tag"></i> Apply
                        </button>
                    </div>
                    <div class="text-success small" id="discountDisplay"></div>
                </div>

                <!-- Amount Display -->
                <div class="amount-display" id="totalAmount">
                    Rs. 0
                </div>

                <!-- Payment Input -->
                <div class="payment-input-group">
                    <input type="number" class="payment-input" id="paidAmount" placeholder="Paid Amount" value="0" min="0" oninput="calculateChange()">
                    <div class="text-center" style="min-width: 100px;">
                        <div class="text-muted small">Change</div>
                        <div class="fs-4 text-success fw-bold" id="changeAmount">Rs. 0</div>
                    </div>
                </div>

                <!-- Quick Amounts -->
                <div class="quick-amounts">
                    <div class="quick-amount" onclick="setPaidAmount(100)">100</div>
                    <div class="quick-amount" onclick="setPaidAmount(500)">500</div>
                    <div class="quick-amount" onclick="setPaidAmount(1000)">1000</div>
                    <div class="quick-amount" onclick="setPaidAmount(5000)">5000</div>
                    <div class="quick-amount" onclick="setPaidAmount('exact')">Exact</div>
                    <div class="quick-amount" onclick="setPaidAmount('round')">Round</div>
                </div>

                <!-- Payment Method -->
                <div class="mb-3">
                    <select class="form-control" id="paymentMethod">
                        <option value="cash">üíµ Cash</option>
                        <option value="card">üí≥ Card</option>
                        <option value="easypaisa">üì± Easypaisa</option>
                        <option value="jazzcash">üì± JazzCash</option>
                        <option value="credit">üìí Credit</option>
                    </select>
                </div>

                <!-- Note -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="invoiceNote" placeholder="Add note (optional)">
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn-primary" onclick="processCheckout()">
                        <i class="fas fa-check-circle"></i> COMPLETE SALE
                    </button>
                    <button class="btn-secondary" onclick="clearCart()">
                        <i class="fas fa-trash-alt"></i> CLEAR CART
                    </button>
                    <button class="btn-secondary" onclick="holdSale()">
                        <i class="fas fa-pause"></i> HOLD SALE
                    </button>
                    <button class="btn-secondary" onclick="printReceipt()">
                        <i class="fas fa-print"></i> PRINT RECEIPT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div class="modal-overlay hidden" id="scannerModal" onclick="closeScannerModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="mb-3"><i class="fas fa-qrcode"></i> Full Screen Scanner</h3>
            <div id="fullScreenReader" style="width: 100%; height: 400px;"></div>
            <div class="text-center mt-3">
                <button class="btn-secondary" onclick="closeScannerModal()">
                    <i class="fas fa-times"></i> Close Scanner
                </button>
            </div>
        </div>
    </div>

    <!-- Hold Sales Modal -->
    <div class="modal-overlay hidden" id="holdModal">
        <div class="modal-content">
            <h3 class="mb-3"><i class="fas fa-save"></i> Hold Sale</h3>
            <div class="mb-3">
                <input type="text" class="form-control" id="holdName" placeholder="Sale reference name">
            </div>
            <div class="d-grid gap-2">
                <button class="btn-primary" onclick="saveHoldSale()">
                    <i class="fas fa-save"></i> Save Hold
                </button>
                <button class="btn-secondary" onclick="closeModal('holdModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Held Sales Modal -->
    <div class="modal-overlay hidden" id="heldSalesModal">
        <div class="modal-content">
            <h3 class="mb-3"><i class="fas fa-history"></i> Held Sales</h3>
            <div id="heldSalesList" style="max-height: 300px; overflow-y: auto;">
                <!-- Held sales will be loaded here -->
            </div>
            <div class="d-grid gap-2 mt-3">
                <button class="btn-secondary" onclick="closeModal('heldSalesModal')">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Product Add Modal -->
    <div class="modal-overlay hidden" id="quickAddModal">
        <div class="modal-content">
            <h3 class="mb-3"><i class="fas fa-plus-circle"></i> Add Quick Product</h3>
            <div class="mb-3">
                <input type="text" class="form-control" id="quickProductName" placeholder="Product Name">
            </div>
            <div class="mb-3">
                <input type="number" class="form-control" id="quickProductPrice" placeholder="Price">
            </div>
            <div class="d-grid gap-2">
                <button class="btn-primary" onclick="addQuickProduct()">
                    <i class="fas fa-plus"></i> Add to Cart
                </button>
                <button class="btn-secondary" onclick="closeModal('quickAddModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal-overlay hidden" id="analyticsModal">
        <div class="modal-content">
            <h3 class="mb-3"><i class="fas fa-chart-bar"></i> Sales Analytics</h3>
            <div style="height: 300px;">
                <canvas id="salesChart"></canvas>
            </div>
            <div class="d-grid gap-2 mt-3">
                <button class="btn-secondary" onclick="closeModal('analyticsModal')">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // ===== GLOBAL VARIABLES =====
        let cart = [];
        let html5QrCode = null;
        let isScannerActive = false;
        let currentCameraId = null;
        let cameras = [];
        let isTorchOn = false;
        let scanCount = 0;
        let heldSales = JSON.parse(localStorage.getItem('heldSales') || '[]');
        let currentCustomer = null;
        let currentCustomerBalance = 0;
        let discount = { amount: 0, type: 'amount' };
        let grandTotal = 0;
        let discountAmount = 0;
        let finalTotal = 0;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeScanner();
            loadRecentSales();
            updateCartDisplay();
            setupKeyboardShortcuts();
            setupVoiceCommands();
            setupServiceWorker();
            setupOfflineDetection();
            
            // Load held sales from localStorage
            updateHeldSalesList();
            
            // Set current time
            updateClock();
            setInterval(updateClock, 60000);
        });

        // ===== SCANNER FUNCTIONS =====
        function initializeScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            Html5Qrcode.getCameras().then(devices => {
                cameras = devices;
                if (devices && devices.length) {
                    currentCameraId = devices[0].id;
                }
            }).catch(err => {
                console.log("Camera error:", err);
            });
        }

        function toggleScanner() {
            const toggleBtn = document.getElementById('scannerToggle');
            
            if (!isScannerActive) {
                startScanner();
                toggleBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Scanner';
                toggleBtn.classList.add('btn-danger');
            } else {
                stopScanner();
                toggleBtn.innerHTML = '<i class="fas fa-camera"></i> Start Scanner';
                toggleBtn.classList.remove('btn-danger');
            }
            
            isScannerActive = !isScannerActive;
        }

        async function startScanner() {
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 150 },
                aspectRatio: 1.7777778
            };
            
            try {
                await html5QrCode.start(
                    currentCameraId,
                    config,
                    onScanSuccess,
                    onScanError
                );
            } catch (err) {
                showNotification('Scanner Error: ' + err.message, 'error');
            }
        }

        async function stopScanner() {
            try {
                await html5QrCode.stop();
            } catch (err) {
                console.log("Stop error:", err);
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            playSound('beep');
            scanCount++;
            document.getElementById('scanCount').textContent = scanCount;
            
            // Process scanned barcode
            processBarcode(decodedText);
            
            // Visual feedback
            document.getElementById('reader').classList.add('pulse-animation');
            setTimeout(() => {
                document.getElementById('reader').classList.remove('pulse-animation');
            }, 500);
        }

        function onScanError(error) {
            // Expected errors, ignore
        }

        function processBarcode(barcode) {
            // Try to find product by barcode (you'd need to add barcode field to inventory)
            // For now, search by name or ID
            const product = inventoryItems.find(p => 
                p.id == barcode || 
                p.item_name.toLowerCase().includes(barcode.toLowerCase())
            );
            
            if (product) {
                addToCart(product.id, product.item_name, product.sale_price);
                showNotification(`Added: ${product.item_name}`, 'success');
            } else {
                // If not found, open quick add modal with barcode as reference
                document.getElementById('quickProductName').value = `Item ${barcode}`;
                document.getElementById('quickProductPrice').value = '';
                openModal('quickAddModal');
                showNotification('Product not found. Add manually.', 'warning');
            }
        }

        function handleManualBarcode(event) {
            if (event.key === 'Enter') {
                processBarcode(event.target.value);
                event.target.value = '';
            }
        }

        async function switchCamera() {
            if (cameras.length < 2) {
                showNotification('Only one camera available', 'warning');
                return;
            }
            
            if (isScannerActive) {
                await stopScanner();
            }
            
            const currentIndex = cameras.findIndex(cam => cam.id === currentCameraId);
            const nextIndex = (currentIndex + 1) % cameras.length;
            currentCameraId = cameras[nextIndex].id;
            
            if (isScannerActive) {
                await startScanner();
            }
            
            showNotification(`Switched to ${cameras[nextIndex].label}`, 'info');
        }

        async function toggleTorch() {
            try {
                const videoTrack = await html5QrCode.getRunningTrack();
                if (videoTrack && videoTrack.getCapabilities().torch) {
                    isTorchOn = !isTorchOn;
                    await videoTrack.applyConstraints({
                        advanced: [{ torch: isTorchOn }]
                    });
                    
                    showNotification(isTorchOn ? 'Torch ON' : 'Torch OFF', 'info');
                }
            } catch (err) {
                console.log("Torch error:", err);
            }
        }

        function openScannerModal() {
            document.getElementById('scannerModal').classList.remove('hidden');
            // Initialize full screen scanner
            const fullScreenScanner = new Html5Qrcode("fullScreenReader");
            fullScreenScanner.start(
                currentCameraId,
                { fps: 10, qrbox: 250 },
                onScanSuccess,
                onScanError
            );
        }

        function closeScannerModal() {
            document.getElementById('scannerModal').classList.add('hidden');
        }

        // ===== CART FUNCTIONS =====
        function addToCart(id, name, price, quantity = 1) {
            // Check if item already in cart
            const existingItem = cart.find(item => item.id === id);
            
            if (existingItem) {
                existingItem.qty += quantity;
            } else {
                cart.push({
                    id: id,
                    name: name,
                    price: parseFloat(price),
                    qty: quantity
                });
            }
            
            playSound('beep');
            updateCartDisplay();
            showNotification(`Added: ${name}`, 'success');
        }

        function updateCartDisplay() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartCountSpan = document.getElementById('cartCount');
            const grandTotalSpan = document.getElementById('grandTotal');
            
            // Calculate totals
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.qty;
            });
            
            // Apply discount
            if (discount.amount > 0) {
                if (discount.type === 'percentage') {
                    discountAmount = (subtotal * discount.amount) / 100;
                } else {
                    discountAmount = discount.amount;
                }
            }
            
            finalTotal = subtotal - discountAmount;
            grandTotal = finalTotal;
            
            // Update displays
            cartCountSpan.textContent = `${cart.reduce((sum, item) => sum + item.qty, 0)} Items`;
            grandTotalSpan.textContent = `Rs. ${formatCurrency(finalTotal)}`;
            document.getElementById('totalAmount').textContent = `Rs. ${formatCurrency(finalTotal)}`;
            
            // Update cart items list
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-cart-plus fa-3x mb-3"></i>
                        <p>No items in cart</p>
                        <p class="small">Scan barcode or select products to start</p>
                    </div>
                `;
            } else {
                let itemsHTML = '';
                cart.forEach((item, index) => {
                    const itemTotal = item.price * item.qty;
                    itemsHTML += `
                        <div class="cart-item slide-in">
                            <div class="item-info">
                                <div class="item-name">${item.name}</div>
                                <div class="item-price">Rs. ${formatCurrency(item.price)} each</div>
                            </div>
                            <div class="item-qty">
                                <button class="qty-btn" onclick="updateQuantity(${index}, -1)">-</button>
                                <span class="fw-bold">${item.qty}</span>
                                <button class="qty-btn" onclick="updateQuantity(${index}, 1)">+</button>
                            </div>
                            <div class="item-total">
                                Rs. ${formatCurrency(itemTotal)}
                            </div>
                            <button class="remove-btn" onclick="removeFromCart(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                
                // Add totals row
                itemsHTML += `
                    <div class="cart-item bg-light">
                        <div class="item-info">
                            <div class="fw-bold">Subtotal</div>
                        </div>
                        <div class="item-total">Rs. ${formatCurrency(subtotal)}</div>
                    </div>
                `;
                
                if (discountAmount > 0) {
                    itemsHTML += `
                        <div class="cart-item bg-light">
                            <div class="item-info">
                                <div class="fw-bold text-danger">Discount</div>
                            </div>
                            <div class="item-total text-danger">- Rs. ${formatCurrency(discountAmount)}</div>
                        </div>
                    `;
                }
                
                itemsHTML += `
                    <div class="cart-item bg-success text-white">
                        <div class="item-info">
                            <div class="fw-bold fs-5">TOTAL</div>
                        </div>
                        <div class="item-total fs-5">Rs. ${formatCurrency(finalTotal)}</div>
                    </div>
                `;
                
                cartItemsDiv.innerHTML = itemsHTML;
            }
            
            // Update change calculation
            calculateChange();
        }

        function updateQuantity(index, change) {
            if (cart[index]) {
                const newQty = cart[index].qty + change;
                if (newQty > 0) {
                    cart[index].qty = newQty;
                } else {
                    cart.splice(index, 1);
                }
                updateCartDisplay();
            }
        }

        function removeFromCart(index) {
            if (cart[index]) {
                const itemName = cart[index].name;
                cart.splice(index, 1);
                updateCartDisplay();
                showNotification(`Removed: ${itemName}`, 'warning');
            }
        }

        function clearCart() {
            if (cart.length > 0) {
                if (confirm('Clear all items from cart?')) {
                    cart = [];
                    discount = { amount: 0, type: 'amount' };
                    discountAmount = 0;
                    updateCartDisplay();
                    showNotification('Cart cleared', 'info');
                }
            }
        }

        // ===== CALCULATOR FUNCTIONS =====
        function addToCalc(value) {
            const paidInput = document.getElementById('paidAmount');
            let currentValue = paidInput.value;
            
            if (currentValue === '0' || currentValue === '') {
                currentValue = value;
            } else {
                currentValue += value;
            }
            
            paidInput.value = currentValue;
            calculateChange();
        }

        function clearCalc() {
            document.getElementById('paidAmount').value = '0';
            calculateChange();
        }

        function calculate() {
            const paidInput = document.getElementById('paidAmount');
            try {
                const result = eval(paidInput.value);
                paidInput.value = result;
                calculateChange();
            } catch (e) {
                showNotification('Invalid calculation', 'error');
            }
        }

        // ===== PAYMENT FUNCTIONS =====
        function calculateChange() {
            const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
            const change = paidAmount - finalTotal;
            
            if (change >= 0) {
                document.getElementById('changeAmount').textContent = `Rs. ${formatCurrency(change)}`;
                document.getElementById('changeAmount').className = 'fs-4 text-success fw-bold';
            } else {
                document.getElementById('changeAmount').textContent = `Rs. ${formatCurrency(Math.abs(change))}`;
                document.getElementById('changeAmount').className = 'fs-4 text-danger fw-bold';
            }
        }

        function setPaidAmount(amount) {
            const paidInput = document.getElementById('paidAmount');
            
            if (amount === 'exact') {
                paidInput.value = finalTotal;
            } else if (amount === 'round') {
                const rounded = Math.ceil(finalTotal / 100) * 100;
                paidInput.value = rounded;
            } else {
                paidInput.value = amount;
            }
            
            calculateChange();
        }

        function applyDiscount() {
            const amount = parseFloat(document.getElementById('discountAmount').value) || 0;
            const type = document.getElementById('discountType').value;
            
            if (amount < 0) {
                showNotification('Discount cannot be negative', 'error');
                return;
            }
            
            if (type === 'percentage' && amount > 100) {
                showNotification('Discount percentage cannot exceed 100%', 'error');
                return;
            }
            
            discount = { amount: amount, type: type };
            
            // Validate discount
            let discountValue = amount;
            if (type === 'percentage') {
                discountValue = (grandTotal * amount) / 100;
            }
            
            if (discountValue > grandTotal) {
                showNotification('Discount cannot exceed total amount', 'error');
                discount = { amount: 0, type: 'amount' };
            }
            
            updateCartDisplay();
            
            // Show discount applied message
            if (amount > 0) {
                document.getElementById('discountDisplay').innerHTML = `
                    <i class="fas fa-check-circle"></i> 
                    Discount applied: ${amount}${type === 'percentage' ? '%' : ' Rs.'}
                `;
            } else {
                document.getElementById('discountDisplay').innerHTML = '';
            }
        }

        // ===== CHECKOUT PROCESS =====
        function processCheckout() {
            if (cart.length === 0) {
                showNotification('Cart is empty!', 'error');
                return;
            }
            
            const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
            const change = paidAmount - finalTotal;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const invoiceNote = document.getElementById('invoiceNote').value;
            
            // Validate payment for credit
            if (paymentMethod === 'credit' && !currentCustomer) {
                showNotification('Please select a customer for credit sale', 'error');
                return;
            }
            
            // Validate cash payment
            if (paymentMethod === 'cash' && paidAmount < finalTotal) {
                showNotification('Insufficient payment!', 'error');
                return;
            }
            
            // Validate credit limit
            if (paymentMethod === 'credit' && currentCustomerBalance > 50000) {
                if (!confirm(`Customer has high balance (Rs. ${formatCurrency(currentCustomerBalance)}). Continue?`)) {
                    return;
                }
            }
            
            // Prepare data for submission
            const formData = new FormData();
            formData.append('checkout', '1');
            formData.append('cart_data', JSON.stringify(cart));
            formData.append('customer_id', currentCustomer || '');
            formData.append('paid_amount', paidAmount);
            formData.append('grand_total', grandTotal);
            formData.append('change_amount', Math.max(0, change));
            formData.append('payment_method', paymentMethod);
            formData.append('discount', discount.amount);
            formData.append('discount_type', discount.type);
            formData.append('invoice_note', invoiceNote);
            
            // Show loading
            const checkoutBtn = document.querySelector('button[onclick="processCheckout()"]');
            const originalText = checkoutBtn.innerHTML;
            checkoutBtn.innerHTML = '<span class="loading"></span> Processing...';
            checkoutBtn.disabled = true;
            
            // Submit form
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                // Check if redirect happened
                if (data.includes('window.location.href')) {
                    // Extract and follow redirect
                    const match = data.match(/window\.location\.href='([^']+)'/);
                    if (match) {
                        window.location.href = match[1];
                    }
                } else {
                    // Handle error
                    showNotification('Checkout failed. Please try again.', 'error');
                    checkoutBtn.innerHTML = originalText;
                    checkoutBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Check connection.', 'error');
                checkoutBtn.innerHTML = originalText;
                checkoutBtn.disabled = false;
            });
        }

        // ===== CUSTOMER FUNCTIONS =====
        function selectCustomer(id, name, balance) {
            currentCustomer = id;
            currentCustomerBalance = balance || 0;
            
            const selectedDiv = document.getElementById('selectedCustomer');
            selectedDiv.innerHTML = `
                <strong>Selected:</strong> ${name || 'Walk-in Customer'}
                ${balance > 0 ? `<br><small class="text-danger">Balance Due: Rs. ${formatCurrency(balance)}</small>` : ''}
            `;
            
            // Close dropdown
            document.getElementById('customerDropdown').classList.remove('show');
            
            // Update payment method if credit customer
            if (id) {
                document.getElementById('paymentMethod').value = 'credit';
            } else {
                document.getElementById('paymentMethod').value = 'cash';
            }
            
            // Load customer stats
            loadCustomerStats(id);
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const options = document.querySelectorAll('.customer-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            document.getElementById('customerDropdown').classList.add('show');
        }

        async function loadCustomerStats(customerId) {
            if (!customerId) {
                document.getElementById('customerStats').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-user fa-3x mb-3"></i>
                        <p>Walk-in customer selected</p>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch(`api_customer_stats.php?id=${customerId}`);
                const stats = await response.json();
                
                document.getElementById('customerStats').innerHTML = `
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fs-4 text-primary">${stats.total_sales || 0}</div>
                            <small>Total Sales</small>
                        </div>
                        <div class="col-6">
                            <div class="fs-4 ${stats.balance_due > 0 ? 'text-danger' : 'text-success'}">
                                Rs. ${formatCurrency(stats.balance_due || 0)}
                            </div>
                            <small>Balance Due</small>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ===== TAB FUNCTIONS =====
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.pos-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Activate selected tab button
            document.querySelector(`.pos-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Special handling for scanner tab
            if (tabName === 'scanner' && isScannerActive) {
                startScanner();
            } else if (tabName !== 'scanner' && isScannerActive) {
                stopScanner();
                document.getElementById('scannerToggle').innerHTML = '<i class="fas fa-camera"></i> Start Scanner';
                document.getElementById('scannerToggle').classList.remove('btn-danger');
                isScannerActive = false;
            }
        }

        // ===== PRODUCT FUNCTIONS =====
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const products = document.querySelectorAll('.product-card');
            
            products.forEach(product => {
                const name = product.getAttribute('data-name').toLowerCase();
                if (name.includes(searchTerm)) {
                    product.style.display = '';
                } else {
                    product.style.display = 'none';
                }
            });
        }

        function addQuickProduct() {
            const name = document.getElementById('quickProductName').value.trim();
            const price = parseFloat(document.getElementById('quickProductPrice').value);
            
            if (!name || !price || price <= 0) {
                showNotification('Please enter valid product name and price', 'error');
                return;
            }
            
            addToCart('NEW', name, price);
            closeModal('quickAddModal');
            
            // Clear form
            document.getElementById('quickProductName').value = '';
            document.getElementById('quickProductPrice').value = '';
        }

        // ===== HOLD SALE FUNCTIONS =====
        function holdSale() {
            if (cart.length === 0) {
                showNotification('Cart is empty!', 'error');
                return;
            }
            
            openModal('holdModal');
        }

        function saveHoldSale() {
            const name = document.getElementById('holdName').value.trim() || `Sale ${new Date().toLocaleTimeString()}`;
            
            const holdData = {
                id: Date.now(),
                name: name,
                cart: [...cart],
                customer: currentCustomer,
                timestamp: new Date().toISOString(),
                total: finalTotal
            };
            
            heldSales.push(holdData);
            localStorage.setItem('heldSales', JSON.stringify(heldSales));
            
            // Clear current cart
            clearCart();
            
            closeModal('holdModal');
            showNotification(`Sale held: ${name}`, 'success');
            updateHeldSalesList();
        }

        function loadHeldSale(holdId) {
            const heldSale = heldSales.find(sale => sale.id === holdId);
            if (heldSale) {
                cart = [...heldSale.cart];
                currentCustomer = heldSale.customer;
                updateCartDisplay();
                closeModal('heldSalesModal');
                showNotification(`Loaded: ${heldSale.name}`, 'success');
            }
        }

        function deleteHeldSale(holdId) {
            if (confirm('Delete this held sale?')) {
                heldSales = heldSales.filter(sale => sale.id !== holdId);
                localStorage.setItem('heldSales', JSON.stringify(heldSales));
                updateHeldSalesList();
                showNotification('Held sale deleted', 'warning');
            }
        }

        function updateHeldSalesList() {
            const listDiv = document.getElementById('heldSalesList');
            if (heldSales.length === 0) {
                listDiv.innerHTML = '<div class="text-center text-muted py-3">No held sales</div>';
                return;
            }
            
            let html = '';
            heldSales.forEach(sale => {
                html += `
                    <div class="cart-item mb-2">
                        <div class="item-info">
                            <div class="item-name">${sale.name}</div>
                            <small class="text-muted">${new Date(sale.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="item-total">
                            Rs. ${formatCurrency(sale.total)}
                        </div>
                        <button class="btn-secondary btn-sm" onclick="loadHeldSale(${sale.id})">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn-secondary btn-sm" onclick="deleteHeldSale(${sale.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        // ===== RECENT SALES =====
        async function loadRecentSales() {
            try {
                const response = await fetch('api_recent_sales.php');
                const sales = await response.json();
                
                const container = document.getElementById('recentSales');
                if (sales.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-3">No recent sales</div>';
                    return;
                }
                
                let html = '';
                sales.forEach(sale => {
                    html += `
                        <div class="recent-sale-item">
                            <div>
                                <strong>${sale.invoice_no}</strong>
                                <div class="small">${sale.customer_name}</div>
                            </div>
                            <div class="text-success fw-bold">
                                Rs. ${formatCurrency(sale.amount)}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading recent sales:', error);
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function playSound(type) {
            const sound = document.getElementById(type + 'Sound');
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log('Audio play failed:', e));
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationsContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function updateClock() {
            // Update any clock displays if needed
        }

        // ===== KEYBOARD SHORTCUTS =====
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Show hint
                document.getElementById('shortcutHint').classList.add('show');
                setTimeout(() => {
                    document.getElementById('shortcutHint').classList.remove('show');
                }, 3000);
                
                // F2 - Scanner
                if (e.key === 'F2') {
                    e.preventDefault();
                    switchTab('scanner');
                }
                
                // F3 - Calculator focus
                if (e.key === 'F3') {
                    e.preventDefault();
                    document.getElementById('paidAmount').focus();
                }
                
                // F4 - Products
                if (e.key === 'F4') {
                    e.preventDefault();
                    switchTab('products');
                }
                
                // F5 - Checkout
                if (e.key === 'F5') {
                    e.preventDefault();
                    processCheckout();
                }
                
                // F6 - Hold sale
                if (e.key === 'F6') {
                    e.preventDefault();
                    holdSale();
                }
                
                // F7 - Clear cart
                if (e.key === 'F7') {
                    e.preventDefault();
                    clearCart();
                }
                
                // ESC - Clear focus
                if (e.key === 'Escape') {
                    document.activeElement.blur();
                }
                
                // Ctrl + S - Quick sale
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('productSearch').focus();
                }
                
                // Ctrl + P - Print receipt
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    printReceipt();
                }
                
                // Ctrl + H - Hold sales list
                if (e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    openModal('heldSalesModal');
                }
            });
        }

        // ===== VOICE COMMANDS =====
        function setupVoiceCommands() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                
                document.getElementById('voiceIndicator').addEventListener('click', () => {
                    if (recognition.recording) {
                        recognition.stop();
                    } else {
                        recognition.start();
                    }
                });
                
                recognition.onstart = () => {
                    document.getElementById('voiceIndicator').classList.remove('hidden');
                };
                
                recognition.onend = () => {
                    document.getElementById('voiceIndicator').classList.add('hidden');
                };
                
                recognition.onresult = (event) => {
                    const command = event.results[0][0].transcript.toLowerCase();
                    handleVoiceCommand(command);
                };
            }
        }

        function handleVoiceCommand(command) {
            showNotification(`Voice: ${command}`, 'info');
            
            // Add product
            if (command.includes('add') && command.includes('product')) {
                const priceMatch = command.match(/\d+/);
                if (priceMatch) {
                    const price = parseInt(priceMatch[0]);
                    document.getElementById('quickProductPrice').value = price;
                    openModal('quickAddModal');
                }
            }
            
            // Clear cart
            if (command.includes('clear cart')) {
                clearCart();
            }
            
            // Checkout
            if (command.includes('checkout') || command.includes('complete sale')) {
                processCheckout();
            }
        }

        // ===== PWA & OFFLINE =====
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Failed:', err));
            }
        }

        function setupOfflineDetection() {
            window.addEventListener('online', () => {
                document.getElementById('offlineIndicator').classList.remove('show');
                showNotification('Back online', 'success');
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('offlineIndicator').classList.add('show');
                showNotification('You are offline', 'warning');
            });
            
            // Initial check
            if (!navigator.onLine) {
                document.getElementById('offlineIndicator').classList.add('show');
            }
        }

        // ===== PRINT RECEIPT =====
        function printReceipt() {
            if (cart.length === 0) {
                showNotification('Cart is empty!', 'error');
                return;
            }
            
            // Generate receipt HTML
            const receiptWindow = window.open('', '_blank');
            receiptWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Receipt</title>
                    <style>
                        body { font-family: monospace; width: 80mm; padding: 10px; }
                        .header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
                        .item { display: flex; justify-content: space-between; margin: 5px 0; }
                        .total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; }
                        .footer { text-align: center; margin-top: 20px; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>${shop_name}</h2>
                        <div>${shop_phone}</div>
                        <div>${new Date().toLocaleString()}</div>
                    </div>
                    <div class="items">
                        ${cart.map(item => `
                            <div class="item">
                                <span>${item.name} x${item.qty}</span>
                                <span>Rs. ${(item.price * item.qty).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="total">
                        <div class="item">
                            <span>TOTAL</span>
                            <span>Rs. ${finalTotal.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="footer">
                        ${receipt_footer}
                    </div>
                </body>
                </html>
            `);
            
            receiptWindow.document.close();
            receiptWindow.print();
            receiptWindow.close();
        }

        // ===== INVENTORY DATA =====
        const inventoryItems = <?php echo json_encode($inventory_items); ?>;
    </script>

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => {
                console.log('Service worker registration failed:', err);
            });
        }
    </script>
</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\users.php
==============================================================================

<?php
// 1. ENABLE ERROR REPORTING
error_reporting(E_ALL);
ini_set('display_errors', 1);

require 'includes/header.php';

// 2. ACCESS CONTROL - Only Admin can manage users
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

$allowed_ids = [1, 14, 15];
$is_admin = (in_array($_SESSION['user_id'], $allowed_ids) || strtolower($_SESSION['role']) === 'admin');

if (!$is_admin) {
    die("<div class='container mt-5'><div class='alert alert-danger text-center p-5 shadow fw-bold'>‚õî ACCESS DENIED: Only Administrators can manage users.</div></div>");
}

// 3. HANDLE FORM ACTIONS
$msg = "";
$error = "";

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    
    // A. ADD/EDIT USER
    if (isset($_POST['save_user'])) {
        $id = $_POST['user_id'];
        $username = trim($_POST['username']);
        $password = $_POST['password'];
        $role = $_POST['role'];
        $status = $_POST['status'];
        
        // Build permissions array
        $permissions = [
            'admin' => isset($_POST['perm_admin']) ? 1 : 0,
            'bisp' => isset($_POST['perm_bisp']) ? 1 : 0,
            'hbl' => isset($_POST['perm_hbl']) ? 1 : 0,
            'loans' => isset($_POST['perm_loans']) ? 1 : 0,
            'shop' => isset($_POST['perm_shop']) ? 1 : 0,
            'closing' => isset($_POST['perm_closing']) ? 1 : 0
        ];
        
        $permissions_json = json_encode($permissions);
        
        if (empty($username)) {
            $error = "Username is required.";
        } else {
            try {
                if ($id) {
                    // UPDATE EXISTING USER
                    if (!empty($password)) {
                        // Update with new password
                        $hashed_password = password_hash($password, PASSWORD_DEFAULT);
                        $stmt = $pdo->prepare("UPDATE users SET username=?, password=?, role=?, status=?, permissions=? WHERE id=?");
                        $stmt->execute([$username, $hashed_password, $role, $status, $permissions_json, $id]);
                    } else {
                        // Update without changing password
                        $stmt = $pdo->prepare("UPDATE users SET username=?, role=?, status=?, permissions=? WHERE id=?");
                        $stmt->execute([$username, $role, $status, $permissions_json, $id]);
                    }
                    $msg = "User updated successfully!";
                } else {
                    // CREATE NEW USER
                    if (empty($password)) {
                        $error = "Password is required for new users.";
                    } else {
                        $hashed_password = password_hash($password, PASSWORD_DEFAULT);
                        $stmt = $pdo->prepare("INSERT INTO users (username, password, role, status, permissions, created_at) VALUES (?, ?, ?, ?, ?, NOW())");
                        $stmt->execute([$username, $hashed_password, $role, $status, $permissions_json]);
                        $msg = "New user created successfully!";
                    }
                }
            } catch (PDOException $e) {
                if (strpos($e->getMessage(), 'Duplicate entry') !== false) {
                    $error = "Username already exists!";
                } else {
                    $error = "Database Error: " . $e->getMessage();
                }
            }
        }
    }
    
    // B. DELETE USER
    if (isset($_POST['delete_user'])) {
        $id = $_POST['delete_id'];
        
        // Prevent deleting yourself
        if ($id == $_SESSION['user_id']) {
            $error = "You cannot delete your own account!";
        } else {
            try {
                $stmt = $pdo->prepare("DELETE FROM users WHERE id = ?");
                $stmt->execute([$id]);
                $msg = "User deleted successfully!";
            } catch (PDOException $e) {
                $error = "Error deleting user: " . $e->getMessage();
            }
        }
    }
    
    // C. RESET PASSWORD
    if (isset($_POST['reset_password'])) {
        $id = $_POST['reset_id'];
        $new_password = $_POST['new_password'];
        
        if (empty($new_password)) {
            $error = "Please enter a new password.";
        } else {
            $hashed_password = password_hash($new_password, PASSWORD_DEFAULT);
            $stmt = $pdo->prepare("UPDATE users SET password = ? WHERE id = ?");
            $stmt->execute([$hashed_password, $id]);
            $msg = "Password reset successfully!";
        }
    }
}

// 4. FETCH ALL USERS
$users = $pdo->query("SELECT * FROM users ORDER BY role DESC, username ASC")->fetchAll();

// 5. PRESET ROLES FOR QUICK ASSIGNMENT
$preset_roles = [
    'owner' => [
        'name' => 'Owner (Full Access)',
        'perms' => ['admin' => 1, 'bisp' => 1, 'hbl' => 1, 'loans' => 1, 'shop' => 1, 'closing' => 1],
        'description' => 'Complete system access. Can view all financials, delete records, and manage settings.'
    ],
    'manager' => [
        'name' => 'Manager',
        'perms' => ['admin' => 0, 'bisp' => 1, 'hbl' => 1, 'loans' => 1, 'shop' => 1, 'closing' => 0],
        'description' => 'Can manage operations but cannot see profits or delete records.'
    ],
    'bisp_cashier' => [
        'name' => 'BISP Cashier',
        'perms' => ['admin' => 0, 'bisp' => 1, 'hbl' => 0, 'loans' => 0, 'shop' => 0, 'closing' => 0],
        'description' => 'Only handles BISP customers - token issuance and payout processing.'
    ],
    'bill_clerk' => [
        'name' => 'Bill Entry Clerk',
        'perms' => ['admin' => 0, 'bisp' => 0, 'hbl' => 1, 'loans' => 0, 'shop' => 0, 'closing' => 0],
        'description' => 'Only types bills, cannot mark as paid or delete entries.'
    ],
    'viewer' => [
        'name' => 'Viewer / Helper',
        'perms' => ['admin' => 0, 'bisp' => 0, 'hbl' => 0, 'loans' => 0, 'shop' => 0, 'closing' => 0],
        'description' => 'Can login but cannot perform any actions. For observation only.'
    ],
    'custom' => [
        'name' => 'Custom Role',
        'perms' => ['admin' => 0, 'bisp' => 0, 'hbl' => 0, 'loans' => 0, 'shop' => 0, 'closing' => 0],
        'description' => 'Create custom permission set.'
    ]
];
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - ARHAM ERP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #1abc9c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: var(--shadow);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.25);
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.1)" fill-opacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,192C672,181,768,139,864,138.7C960,139,1056,181,1152,197.3C1248,213,1344,203,1392,197.3L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
            background-position: bottom;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .role-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .role-badge.admin {
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: white;
        }

        .role-badge.staff {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
        }

        .permission-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .permission-card:hover {
            border-color: var(--secondary);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.1);
        }

        .permission-card.active {
            border-color: var(--success);
            background: rgba(46, 204, 113, 0.05);
        }

        .permission-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .permission-icon.admin { background: linear-gradient(45deg, #ff8a00, #e52e71); color: white; }
        .permission-icon.bisp { background: linear-gradient(45deg, #3498db, #2ecc71); color: white; }
        .permission-icon.hbl { background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; }
        .permission-icon.loans { background: linear-gradient(45deg, #f39c12, #d35400); color: white; }
        .permission-icon.shop { background: linear-gradient(45deg, #1abc9c, #16a085); color: white; }
        .permission-icon.closing { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; }

        .preset-role-card {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .preset-role-card:hover {
            transform: translateY(-5px);
            border-color: var(--secondary);
        }

        .preset-role-card.selected {
            border-color: var(--success);
            background: rgba(46, 204, 113, 0.05);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.active { background: rgba(46, 204, 113, 0.2); color: var(--success); }
        .status-badge.inactive { background: rgba(231, 76, 60, 0.2); color: var(--danger); }

        .action-btn {
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .action-btn.edit { background: rgba(52, 152, 219, 0.1); color: var(--secondary); }
        .action-btn.delete { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .action-btn.reset { background: rgba(243, 156, 18, 0.1); color: var(--warning); }

        .tab-content {
            padding: 20px;
            background: white;
            border-radius: 0 0 20px 20px;
            border: 1px solid #e0e0e0;
            border-top: none;
        }

        .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: #6c757d;
            font-weight: 600;
            padding: 15px 25px;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            border-color: rgba(44, 62, 80, 0.3);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: transparent;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 20px;
            }
            
            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        .permission-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .permission-details ul {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        .permission-details li {
            padding: 5px 0;
            font-size: 13px;
        }

        .permission-details li i {
            width: 20px;
            text-align: center;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .user-table tr {
            transition: all 0.3s ease;
        }

        .user-table tr:hover {
            background-color: #f8f9fa;
        }

        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--success), var(--info));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(46, 204, 113, 0.3);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(46, 204, 113, 0.4);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .permission-matrix {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
        }

        .matrix-table th,
        .matrix-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .matrix-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .matrix-table .role-header {
            background: var(--primary);
            color: white;
        }

        .access-yes {
            color: var(--success);
            font-weight: bold;
        }

        .access-no {
            color: var(--danger);
            opacity: 0.5;
        }

        .access-partial {
            color: var(--warning);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container-fluid py-4">
        <!-- Dashboard Header -->
        <div class="dashboard-header animate__animated animate__fadeInDown">
            <div class="header-content">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="display-5 fw-bold mb-2">User Management</h1>
                        <p class="mb-0 opacity-75">
                            <i class="fas fa-users me-2"></i>Manage system users, roles, and permissions
                        </p>
                    </div>
                    <div class="text-end">
                        <span class="role-badge admin">
                            <i class="fas fa-crown me-2"></i>Administrator
                        </span>
                        <div class="mt-2">
                            <small class="opacity-75">
                                <i class="fas fa-shield-alt me-1"></i> Security Level: Maximum
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <?php if($msg): ?>
            <div class="alert alert-success alert-dismissible fade show glass-panel animate__animated animate__fadeInUp" role="alert">
                <i class="fas fa-check-circle me-2"></i> <?php echo $msg; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <?php if($error): ?>
            <div class="alert alert-danger alert-dismissible fade show glass-panel animate__animated animate__shakeX" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i> <?php echo $error; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <!-- User Statistics -->
        <div class="user-stats animate__animated animate__fadeIn">
            <?php
                $total_users = count($users);
                $active_users = 0;
                $admin_users = 0;
                $staff_users = 0;
                
                foreach($users as $user) {
                    if($user['status'] == 1) $active_users++;
                    if(strtolower($user['role']) == 'admin') $admin_users++;
                    else $staff_users++;
                }
            ?>
            <div class="stat-card">
                <div class="stat-value text-primary"><?php echo $total_users; ?></div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-success"><?php echo $active_users; ?></div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-warning"><?php echo $admin_users; ?></div>
                <div class="stat-label">Administrators</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-info"><?php echo $staff_users; ?></div>
                <div class="stat-label">Staff Members</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <div class="col-lg-8">
                <!-- Users Table -->
                <div class="glass-panel p-4 mb-4">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-users-cog me-2"></i>System Users
                        </h2>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="userSearch" class="form-control" placeholder="Search users...">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover user-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Permissions</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <?php foreach($users as $user): 
                                    $perms = json_decode($user['permissions'] ?? '{}', true);
                                    $initials = strtoupper(substr($user['username'], 0, 2));
                                    $is_current_user = ($user['id'] == $_SESSION['user_id']);
                                ?>
                                <tr class="animate__animated animate__fadeInUp" data-username="<?php echo strtolower($user['username']); ?>">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-3">
                                                <?php echo $initials; ?>
                                            </div>
                                            <div>
                                                <div class="fw-bold"><?php echo htmlspecialchars($user['username']); ?></div>
                                                <small class="text-muted">ID: <?php echo $user['id']; ?></small>
                                                <?php if($is_current_user): ?>
                                                    <span class="badge bg-info ms-2">Current</span>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="role-badge <?php echo strtolower($user['role']) == 'admin' ? 'admin' : 'staff'; ?>">
                                            <?php echo ucfirst($user['role']); ?>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-wrap gap-1">
                                            <?php if($perms['admin'] ?? 0): ?>
                                                <span class="badge bg-danger" title="Admin Access">A</span>
                                            <?php endif; ?>
                                            <?php if($perms['bisp'] ?? 0): ?>
                                                <span class="badge bg-primary" title="BISP Access">B</span>
                                            <?php endif; ?>
                                            <?php if($perms['hbl'] ?? 0): ?>
                                                <span class="badge bg-purple" title="Bill Access">H</span>
                                            <?php endif; ?>
                                            <?php if($perms['loans'] ?? 0): ?>
                                                <span class="badge bg-warning" title="Loans Access">L</span>
                                            <?php endif; ?>
                                            <?php if($perms['shop'] ?? 0): ?>
                                                <span class="badge bg-success" title="Shop Access">S</span>
                                            <?php endif; ?>
                                            <?php if($perms['closing'] ?? 0): ?>
                                                <span class="badge bg-dark" title="Closing Access">C</span>
                                            <?php endif; ?>
                                            <?php if(array_sum($perms) == 0): ?>
                                                <span class="badge bg-secondary">No Access</span>
                                            <?php endif; ?>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge <?php echo $user['status'] == 1 ? 'active' : 'inactive'; ?>">
                                            <?php echo $user['status'] == 1 ? 'Active' : 'Inactive'; ?>
                                        </span>
                                    </td>
                                    <td class="text-muted small">
                                        <?php echo $user['last_login'] ? date('d M, h:i A', strtotime($user['last_login'])) : 'Never'; ?>
                                    </td>
                                    <td class="text-end">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button class="action-btn edit" onclick="editUser(<?php echo htmlspecialchars(json_encode($user)); ?>)">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="action-btn reset" onclick="resetPasswordModal(<?php echo $user['id']; ?>, '<?php echo htmlspecialchars($user['username']); ?>')">
                                                <i class="fas fa-key"></i> Reset
                                            </button>
                                            <?php if(!$is_current_user): ?>
                                            <button class="action-btn delete" onclick="deleteUserModal(<?php echo $user['id']; ?>, '<?php echo htmlspecialchars($user['username']); ?>')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <?php endif; ?>
                                        </div>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Permission Matrix -->
                <div class="permission-matrix animate__animated animate__fadeInUp">
                    <h4 class="fw-bold mb-3">
                        <i class="fas fa-table me-2"></i>Role Permission Matrix
                    </h4>
                    <div class="table-responsive">
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th class="role-header">Permission</th>
                                    <th class="role-header">Owner</th>
                                    <th>Manager</th>
                                    <th>BISP Cashier</th>
                                    <th>Bill Clerk</th>
                                    <th>Viewer</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-start fw-bold">Admin Access</td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-start fw-bold">BISP Access</td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-start fw-bold">Bill Access</td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-start fw-bold">Loans Access</td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-start fw-bold">Shop Access</td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-start fw-bold">Closing Access</td>
                                    <td class="access-yes"><i class="fas fa-check-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                    <td class="access-no"><i class="fas fa-times-circle"></i></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- User Form -->
                <div class="glass-panel p-4 mb-4">
                    <h3 class="fw-bold mb-3" id="formTitle">
                        <i class="fas fa-user-plus me-2"></i>Add New User
                    </h3>
                    
                    <form method="POST" id="userForm">
                        <input type="hidden" name="save_user" value="1">
                        <input type="hidden" name="user_id" id="user_id" value="">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Username</label>
                            <input type="text" name="username" id="username" class="form-control" required>
                            <div class="form-text">Choose a unique username for login</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Password</label>
                            <input type="password" name="password" id="password" class="form-control">
                            <div class="form-text" id="passwordHelp">
                                Leave blank to keep existing password when editing
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Role</label>
                                <select name="role" id="role" class="form-select">
                                    <option value="admin">Administrator</option>
                                    <option value="staff" selected>Staff Member</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Status</label>
                                <select name="status" id="status" class="form-select">
                                    <option value="1">Active</option>
                                    <option value="0">Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Preset Roles -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Quick Role Presets</label>
                            <div class="row g-2" id="presetRoles">
                                <?php foreach($preset_roles as $key => $preset): ?>
                                <div class="col-6">
                                    <div class="preset-role-card p-3 text-center" 
                                         onclick="applyPreset('<?php echo $key; ?>')"
                                         data-preset="<?php echo $key; ?>">
                                        <div class="fw-bold mb-1"><?php echo $preset['name']; ?></div>
                                        <small class="text-muted"><?php echo $preset['description']; ?></small>
                                    </div>
                                </div>
                                <?php endforeach; ?>
                            </div>
                        </div>
                        
                        <!-- Individual Permissions -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Detailed Permissions</label>
                            
                            <div class="permission-card" id="permAdminCard">
                                <div class="d-flex align-items-center">
                                    <div class="permission-icon admin me-3">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="fw-bold mb-1">Admin Access</h6>
                                                <small class="text-muted">Full system control</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="perm_admin" id="perm_admin" value="1">
                                            </div>
                                        </div>
                                        <div class="permission-details" style="display: none;">
                                            <ul>
                                                <li><i class="fas fa-check text-success"></i> View all financials</li>
                                                <li><i class="fas fa-check text-success"></i> Delete records</li>
                                                <li><i class="fas fa-check text-success"></i> Change system settings</li>
                                                <li><i class="fas fa-check text-success"></i> Override staff actions</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="permission-card" id="permBispCard">
                                <div class="d-flex align-items-center">
                                    <div class="permission-icon bisp me-3">
                                        <i class="fas fa-hand-holding-usd"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="fw-bold mb-1">BISP Access</h6>
                                                <small class="text-muted">Cash disbursement</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="perm_bisp" id="perm_bisp" value="1">
                                            </div>
                                        </div>
                                        <div class="permission-details" style="display: none;">
                                            <ul>
                                                <li><i class="fas fa-check text-success"></i> Issue BISP tokens</li>
                                                <li><i class="fas fa-check text-success"></i> Process cash payouts</li>
                                                <li><i class="fas fa-check text-success"></i> View waiting queue</li>
                                                <li><i class="fas fa-times text-danger"></i> Cannot see commissions</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="permission-card" id="permHblCard">
                                <div class="d-flex align-items-center">
                                    <div class="permission-icon hbl me-3">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="fw-bold mb-1">Bill Access</h6>
                                                <small class="text-muted">Utility bill management</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="perm_hbl" id="perm_hbl" value="1">
                                            </div>
                                        </div>
                                        <div class="permission-details" style="display: none;">
                                            <ul>
                                                <li><i class="fas fa-check text-success"></i> Add new bills</li>
                                                <li><i class="fas fa-check text-success"></i> View pending queue</li>
                                                <li><i class="fas fa-times text-danger"></i> Cannot mark as paid</li>
                                                <li><i class="fas fa-times text-danger"></i> Cannot delete bills</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="permission-card" id="permLoansCard">
                                <div class="d-flex align-items-center">
                                    <div class="permission-icon loans me-3">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="fw-bold mb-1">Loans Access</h6>
                                                <small class="text-muted">Customer credit management</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="perm_loans" id="perm_loans" value="1">
                                            </div>
                                        </div>
                                        <div class="permission-details" style="display: none;">
                                            <ul>
                                                <li><i class="fas fa-check text-success"></i> View customer balances</li>
                                                <li><i class="fas fa-check text-success"></i> Record credit transactions</li>
                                                <li><i class="fas fa-times text-danger"></i> Cannot edit cash drawer</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="permission-card" id="permShopCard">
                                <div class="d-flex align-items-center">
                                    <div class="permission-icon shop me-3">
                                        <i class="fas fa-store"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="fw-bold mb-1">Shop Access</h6>
                                                <small class="text-muted">POS and inventory</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="perm_shop" id="perm_shop" value="1">
                                            </div>
                                        </div>
                                        <div class="permission-details" style="display: none;">
                                            <ul>
                                                <li><i class="fas fa-check text-success"></i> Process sales</li>
                                                <li><i class="fas fa-check text-success"></i> View inventory</li>
                                                <li><i class="fas fa-check text-success"></i> Manage stock</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="permission-card" id="permClosingCard">
                                <div class="d-flex align-items-center">
                                    <div class="permission-icon closing me-3">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="fw-bold mb-1">Closing Access</h6>
                                                <small class="text-muted">Day end reconciliation</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="perm_closing" id="perm_closing" value="1">
                                            </div>
                                        </div>
                                        <div class="permission-details" style="display: none;">
                                            <ul>
                                                <li><i class="fas fa-check text-success"></i> Perform day closing</li>
                                                <li><i class="fas fa-check text-success"></i> Count physical cash</li>
                                                <li><i class="fas fa-check text-success"></i> Calculate differences</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg fw-bold">
                                <i class="fas fa-save me-2"></i> Save User
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-times me-2"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Quick Guide -->
                <div class="glass-panel p-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-question-circle me-2"></i>Permission Guide
                    </h5>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>Best Practices</h6>
                        <ul class="mb-0">
                            <li>Assign minimum required permissions</li>
                            <li>Use preset roles for common positions</li>
                            <li>Regularly review user activity</li>
                            <li>Deactivate unused accounts</li>
                        </ul>
                    </div>
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Security Notes</h6>
                        <small>
                            <strong>Admin Access</strong> gives complete system control.
                            Only assign to trusted personnel.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-action-btn" onclick="resetForm()">
        <i class="fas fa-user-plus"></i>
    </div>

    <!-- Modals -->
    <!-- Delete User Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete user <strong id="deleteUserName"></strong>?</p>
                    <p class="text-danger small">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        This action cannot be undone. All user data will be permanently removed.
                    </p>
                    <form method="POST" id="deleteForm">
                        <input type="hidden" name="delete_user" value="1">
                        <input type="hidden" name="delete_id" id="deleteUserId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="document.getElementById('deleteForm').submit()">
                        <i class="fas fa-trash me-2"></i> Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="fas fa-key me-2"></i>Reset Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Reset password for user: <strong id="resetUserName"></strong></p>
                    <form method="POST" id="resetForm">
                        <input type="hidden" name="reset_password" value="1">
                        <input type="hidden" name="reset_id" id="resetUserId">
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" name="new_password" class="form-control" required>
                            <div class="form-text">Enter a strong password for the user</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="document.getElementById('resetForm').submit()">
                        <i class="fas fa-sync-alt me-2"></i> Reset Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize modals
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const resetModal = new bootstrap.Modal(document.getElementById('resetModal'));

        // Search functionality
        document.getElementById('userSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#userTableBody tr');
            
            rows.forEach(row => {
                const username = row.getAttribute('data-username');
                if (username.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Edit user function
        function editUser(user) {
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>Edit User';
            document.getElementById('user_id').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('role').value = user.role;
            document.getElementById('status').value = user.status;
            document.getElementById('password').required = false;
            document.getElementById('passwordHelp').textContent = 'Leave blank to keep existing password';
            
            // Parse permissions
            const perms = JSON.parse(user.permissions || '{}');
            document.getElementById('perm_admin').checked = perms.admin == 1;
            document.getElementById('perm_bisp').checked = perms.bisp == 1;
            document.getElementById('perm_hbl').checked = perms.hbl == 1;
            document.getElementById('perm_loans').checked = perms.loans == 1;
            document.getElementById('perm_shop').checked = perms.shop == 1;
            document.getElementById('perm_closing').checked = perms.closing == 1;
            
            updatePermissionCards();
            
            // Scroll to form
            document.getElementById('userForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Apply preset role
        function applyPreset(presetKey) {
            const preset = {
                'owner': { admin: 1, bisp: 1, hbl: 1, loans: 1, shop: 1, closing: 1 },
                'manager': { admin: 0, bisp: 1, hbl: 1, loans: 1, shop: 1, closing: 0 },
                'bisp_cashier': { admin: 0, bisp: 1, hbl: 0, loans: 0, shop: 0, closing: 0 },
                'bill_clerk': { admin: 0, bisp: 0, hbl: 1, loans: 0, shop: 0, closing: 0 },
                'viewer': { admin: 0, bisp: 0, hbl: 0, loans: 0, shop: 0, closing: 0 },
                'custom': { admin: 0, bisp: 0, hbl: 0, loans: 0, shop: 0, closing: 0 }
            };
            
            const perms = preset[presetKey];
            
            document.getElementById('perm_admin').checked = perms.admin == 1;
            document.getElementById('perm_bisp').checked = perms.bisp == 1;
            document.getElementById('perm_hbl').checked = perms.hbl == 1;
            document.getElementById('perm_loans').checked = perms.loans == 1;
            document.getElementById('perm_shop').checked = perms.shop == 1;
            document.getElementById('perm_closing').checked = perms.closing == 1;
            
            updatePermissionCards();
            
            // Highlight selected preset
            document.querySelectorAll('.preset-role-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-preset="${presetKey}"]`).classList.add('selected');
        }

        // Update permission card visuals
        function updatePermissionCards() {
            const checkboxes = ['admin', 'bisp', 'hbl', 'loans', 'shop', 'closing'];
            
            checkboxes.forEach(perm => {
                const checkbox = document.getElementById(`perm_${perm}`);
                const card = document.getElementById(`perm${perm.charAt(0).toUpperCase() + perm.slice(1)}Card`);
                const details = card.querySelector('.permission-details');
                
                if (checkbox.checked) {
                    card.classList.add('active');
                    details.style.display = 'block';
                } else {
                    card.classList.remove('active');
                    details.style.display = 'none';
                }
            });
        }

        // Reset form
        function resetForm() {
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('user_id').value = '';
            document.getElementById('password').required = true;
            document.getElementById('passwordHelp').textContent = 'Enter a password for the new user';
            document.getElementById('role').value = 'staff';
            document.getElementById('status').value = '1';
            
            // Reset all permissions to unchecked
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // Reset preset selection
            document.querySelectorAll('.preset-role-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            updatePermissionCards();
        }

        // Delete user modal
        function deleteUserModal(userId, username) {
            document.getElementById('deleteUserName').textContent = username;
            document.getElementById('deleteUserId').value = userId;
            deleteModal.show();
        }

        // Reset password modal
        function resetPasswordModal(userId, username) {
            document.getElementById('resetUserName').textContent = username;
            document.getElementById('resetUserId').value = userId;
            resetModal.show();
        }

        // Permission card click handlers
        document.querySelectorAll('.permission-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (!e.target.classList.contains('form-check-input')) {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    updatePermissionCards();
                }
            });
        });

        // Initialize permission cards
        document.addEventListener('DOMContentLoaded', function() {
            updatePermissionCards();
            
            // Add event listeners to checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updatePermissionCards);
            });
            
            // Auto-select custom preset when manually changing permissions
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    document.querySelectorAll('.preset-role-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    document.querySelector('[data-preset="custom"]').classList.add('selected');
                });
            });
            
            // Tooltips for permission badges
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Form validation
        document.getElementById('userForm').addEventListener('submit', function(e) {
            const username = document.getElementById('username').value.trim();
            const userId = document.getElementById('user_id').value;
            const password = document.getElementById('password').value;
            
            if (!userId && !password) {
                e.preventDefault();
                alert('Password is required for new users');
                document.getElementById('password').focus();
                return false;
            }
            
            if (username.length < 3) {
                e.preventDefault();
                alert('Username must be at least 3 characters long');
                return false;
            }
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
            submitBtn.disabled = true;
            
            // Re-enable after 3 seconds in case of error
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 3000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + N for new user
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                resetForm();
                document.getElementById('username').focus();
            }
            
            // Escape to reset form
            if (e.key === 'Escape') {
                resetForm();
            }
        });
    </script>
</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\void_transaction.php
==============================================================================

<?php 
require 'includes/header.php'; 
if ($_SESSION['role'] !== 'admin') { die("ACCESS DENIED"); }

// HANDLE VOID
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $id = $_POST['id'];
    $reason = $_POST['reason'];
    
    // Mark transaction as void instead of deleting (Audit Trail)
    $stmt = $pdo->prepare("UPDATE transactions SET status = 'void', void_reason = ?, void_by = ? WHERE id = ?");
    $stmt->execute([$reason, $_SESSION['user_id'], $id]);
    
    echo "<script>window.location.href='reports.php';</script>";
    exit();
}

$id = $_GET['id'] ?? 0;
$txn = $pdo->query("SELECT * FROM transactions WHERE id = $id")->fetch();
if(!$txn) die("Transaction not found");
?>

<link rel="stylesheet" href="css/modern.css">

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="glass-panel p-5 border-danger" style="border: 1px solid #dc3545;">
            <div class="text-center text-danger mb-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h3 class="fw-bold">Void Transaction #<?php echo $id; ?></h3>
                <p class="text-white-50">This action will remove the amount from financial totals.</p>
            </div>

            <div class="bg-dark bg-opacity-50 p-3 rounded mb-4">
                <div class="d-flex justify-content-between mb-2">
                    <span>Amount:</span>
                    <span class="fw-bold text-white">Rs. <?php echo number_format($txn['amount']); ?></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Bank ID:</span>
                    <span class="fw-bold text-white"><?php echo $txn['konnect_trx_id']; ?></span>
                </div>
            </div>

            <form method="post">
                <input type="hidden" name="id" value="<?php echo $id; ?>">
                
                <div class="mb-4">
                    <label class="fw-bold text-danger">Reason for Voiding (Required)</label>
                    <textarea name="reason" class="form-control bg-dark text-white border-secondary" rows="3" required placeholder="e.g. Duplicate entry, Wrong amount..."></textarea>
                </div>

                <div class="d-flex gap-3">
                    <a href="reports.php" class="btn btn-outline-light w-50 rounded-pill">Cancel</a>
                    <button type="submit" class="btn btn-danger w-50 rounded-pill fw-bold">Confirm Void</button>
                </div>
            </form>
        </div>
    </div>
</div>

<?php include 'includes/footer.php'; ?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\manifest.json
==============================================================================

{
    "name": "ARHAM POS System",
    "short_name": "ARHAM POS",
    "description": "Point of Sale System for ARHAM PRINTERS",
    "start_url": "/shop_pos.php",
    "display": "standalone",
    "background_color": "#2c3e50",
    "theme_color": "#3498db",
    "icons": [
        {
            "src": "/android-chrome-192x192.png",
            "sizes": "192x192",
            "type": "image/png"
        },
        {
            "src": "/android-chrome-512x512.png",
            "sizes": "512x512",
            "type": "image/png"
        }
    ]
} 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\sw.js
==============================================================================

// Service Worker for PWA
const CACHE_NAME = 'pos-cache-v1';
const urlsToCache = [
    '/',
    '/shop_pos.php',
    '/manifest.json',
    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
    'https://unpkg.com/html5-qrcode'
];

self.addEventListener('install', event => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(cache => cache.addAll(urlsToCache))
    );
});

self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request)
            .then(response => response || fetch(event.request))
    );
}); 
 
ampp
==============================================================================
FILE PATH: C:\xampp\htdocs\portal\css\invoice_theme.css
==============================================================================
ampp\htdocs
/* css/invoice_theme.css */
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Poppins:wght@400;500;600&display=swap');

:root {
    --brand-cyan: #00E5FF; /* Extracted from your Index */
    --brand-dark: #1a1a1a;
    --brand-grey: #f4f7f6;
    --text-main: #212529;
}

body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--brand-grey);
    color: var(--text-main);
    -webkit-print-color-adjust: exact !important;
}

/* THE INVOICE SHEET */
.invoice-paper {
    background: #fff;
    max-width: 850px;
    margin: 40px auto;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

/* HEADER STYLE (Matches your Website Hero) */
.inv-header {
    background: var(--brand-dark);
    padding: 40px;
    color: #fff;
    border-bottom: 5px solid var(--brand-cyan);
}

.brand-logo {
    font-family: 'Montserrat', sans-serif;
    font-weight: 800;
    font-size: 32px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #fff;
    margin: 0;
}
.brand-logo span { color: var(--brand-cyan); }

.inv-meta {
    text-align: right;
}
.inv-number {
    font-family: 'Montserrat', sans-serif;
    font-size: 24px;
    font-weight: 700;
    color: var(--brand-cyan);
}

/* TABLE STYLING */
.table-modern {
    width: 100%;
    margin-top: 30px;
    border-collapse: collapse;
}
.table-modern th {
    background-color: #f8f9fa;
    color: #666;
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 12px;
    padding: 15px;
    border-bottom: 2px solid var(--brand-cyan);
}
.table-modern td {
    padding: 15px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
}
.table-modern tr:last-child td { border-bottom: none; }

/* TOTALS SECTION */
.totals-area {
    background-color: #fcfcfc;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}
.total-row {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 14px;
}
.grand-total {
    font-family: 'Montserrat', sans-serif;
    font-weight: 800;
    font-size: 20px;
    color: var(--brand-dark);
    border-top: 2px solid #ddd;
    padding-top: 10px;
    margin-top: 5px;
}

/* PRINT OPTIMIZATION */
@media print {
    body { background: #fff; padding: 0; margin: 0; }
    .invoice-paper { box-shadow: none; margin: 0; max-width: 100%; width: 100%; }
    .no-print { display: none !important; }
    .btn { display: none !important; }
} 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\css\modern.css
==============================================================================

/* css/modern.css */
:root {
    --brand-dark: #212529;
    --brand-cyan: #00E5FF;
    --glass-bg: rgba(255, 255, 255, 0.95);
    --glass-border: 1px solid rgba(255, 255, 255, 0.5);
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
}

body {
    background-color: #f0f2f5;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    color: #333;
}

/* Glass Panel Effect */
.glass-panel {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: var(--glass-border);
    box-shadow: var(--shadow);
    border-radius: 15px;
    margin-bottom: 20px;
    overflow: hidden;
    transition: transform 0.2s;
}

.glass-panel:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
}

/* Hover Effects for Cards */
.hover-effect {
    cursor: pointer;
    transition: all 0.3s ease;
}
.hover-effect:hover {
    background: linear-gradient(135deg, #212529 0%, #000 100%);
    transform: scale(1.03);
}
.hover-effect:hover h5, .hover-effect:hover i {
    color: #00E5FF !important;
}

/* Buttons */
.btn-primary {
    background-color: #212529;
    border-color: #212529;
}
.btn-primary:hover {
    background-color: #000;
    border-color: #000;
}
.rounded-pill { border-radius: 50px !important; }

/* Table Styling */
.table-hover tbody tr:hover {
    background-color: rgba(0, 229, 255, 0.05);
} 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\includes\config.php
==============================================================================

<?php
// includes/config.php

// 1. START SESSION
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// 2. TIMEZONE
date_default_timezone_set('Asia/Karachi');

// 3. DATABASE CREDENTIALS (YOUR EXACT SETTINGS)
define('DB_HOST', 'localhost');
define('DB_NAME', 'arham_portal-323133bb14');
define('DB_USER', 'root');
define('DB_PASS', ''); 

try {
    // --- CONNECT TO DATABASE ---
    $dsn = "mysql:host=".DB_HOST.";dbname=".DB_NAME.";charset=utf8mb4";
    
    $options = [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
    ];
    
    $pdo = new PDO($dsn, DB_USER, DB_PASS, $options);
    
    // --- FORCE SQL MODES FOR URDU & TIME ---
    $pdo->exec("SET NAMES utf8mb4");
    $pdo->exec("SET CHARACTER SET utf8mb4");
    $pdo->exec("SET time_zone = '+05:00';");
    
} catch (PDOException $e) {
    // Show a clean error if DB fails
    die("<div style='text-align:center; padding:50px; font-family:sans-serif;'>
        <h3>Database Connection Error</h3>
        <p>Could not connect to the database.</p>
        <small>" . $e->getMessage() . "</small>
    </div>");
}

// 4. AUTH HELPER
function requireAuth() {
    if (!isset($_SESSION['user_id'])) {
        header("Location: login.php");
        exit();
    }
}

// 5. LOGGER HELPER
if (!function_exists('logActivity')) {
    function logActivity($pdo, $action, $details = "") {
        if(isset($_SESSION['user_id'])) {
            try {
                $stmt = $pdo->prepare("INSERT INTO system_logs (user_id, action, details, ip_address) VALUES (?, ?, ?, ?)");
                $stmt->execute([$_SESSION['user_id'], $action, $details, $_SERVER['REMOTE_ADDR']]);
            } catch (Exception $e) {
                // Silently ignore log errors so system doesn't crash
            }
        }
    }
}

// 6. PERMISSION HELPER (Vital for Header)
if (!function_exists('hasAccess')) {
    function hasAccess($key) {
        // Admin always true
        if (isset($_SESSION['role']) && strtolower($_SESSION['role']) === 'admin') {
            return true;
        }
        // Check staff permissions
        if (isset($_SESSION['permissions'][$key]) && $_SESSION['permissions'][$key] == 1) {
            return true;
        }
        return false;
    }
}
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\includes\footer.php
==============================================================================

</main>
        </div>
    </div>
    <footer class="mt-auto py-3 bg-light text-center border-top">
        <div class="container">
            <span class="text-muted small">Arham ERP Portal &copy; <?php echo date('Y'); ?></span>
        </div>
    </footer>
</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\includes\functions.php
==============================================================================

<?php
// Function to record every move
function logActivity($pdo, $action, $details) {
    if (session_status() === PHP_SESSION_NONE) session_start();
    $user_id = $_SESSION['user_id'] ?? 0;
    $ip = $_SERVER['REMOTE_ADDR'];
    
    try {
        $stmt = $pdo->prepare("INSERT INTO system_logs (user_id, action, details, ip_address) VALUES (?, ?, ?, ?)");
        $stmt->execute([$user_id, $action, $details, $ip]);
    } catch (Exception $e) {
        // Silently fail logging if DB issue, don't stop the app
    }
}

// Function to check strict Admin access
function requireAdmin() {
    if (session_status() === PHP_SESSION_NONE) session_start();
    if (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') {
        die("<div class='alert alert-danger text-center m-5 fw-bold'>‚õî ACCESS DENIED: Admin Authorization Required</div>");
    }
}
?> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\includes\header.php
==============================================================================

<?php
/**
 * Advanced Header Component
 * Features: Responsive design, role-based menus, mobile/desktop optimized, accessibility compliant
 */

// Session management for user authentication
session_start();

// User role detection (modify according to your authentication system)
$user_role = 'guest'; // Default role
if (isset($_SESSION['user_id'])) {
    // Fetch user role from session/database
    $user_role = $_SESSION['user_role'] ?? 'subscriber';
    
    // User details for personalization
    $user_name = $_SESSION['user_name'] ?? '';
    $user_email = $_SESSION['user_email'] ?? '';
    $user_avatar = $_SESSION['user_avatar'] ?? 'default-avatar.png';
}

// Define which menu items each role can see
$role_capabilities = [
    'guest' => ['home', 'about', 'services', 'contact', 'login', 'register'],
    'subscriber' => ['home', 'dashboard', 'profile', 'logout', 'settings'],
    'editor' => ['home', 'dashboard', 'profile', 'content', 'media', 'logout', 'settings'],
    'admin' => ['home', 'dashboard', 'profile', 'content', 'media', 'users', 'settings', 'tools', 'reports', 'logout'],
    'super_admin' => ['home', 'dashboard', 'profile', 'content', 'media', 'users', 'settings', 'tools', 'reports', 'system', 'logout']
];

// Menu structure with all possible items
$menu_items = [
    'home' => ['title' => 'Home', 'url' => '/', 'icon' => 'home'],
    'about' => ['title' => 'About', 'url' => '/about', 'icon' => 'info'],
    'services' => ['title' => 'Services', 'url' => '/services', 'icon' => 'services'],
    'contact' => ['title' => 'Contact', 'url' => '/contact', 'icon' => 'contact'],
    'login' => ['title' => 'Login', 'url' => '/login', 'icon' => 'login'],
    'register' => ['title' => 'Register', 'url' => '/register', 'icon' => 'register'],
    'dashboard' => ['title' => 'Dashboard', 'url' => '/dashboard', 'icon' => 'dashboard'],
    'profile' => ['title' => 'My Profile', 'url' => '/profile', 'icon' => 'user'],
    'content' => ['title' => 'Content', 'url' => '/content', 'icon' => 'file-text', 'submenu' => [
        'posts' => ['title' => 'All Posts', 'url' => '/content/posts'],
        'add_new' => ['title' => 'Add New', 'url' => '/content/new'],
        'categories' => ['title' => 'Categories', 'url' => '/content/categories'],
    ]],
    'media' => ['title' => 'Media', 'url' => '/media', 'icon' => 'image'],
    'users' => ['title' => 'Users', 'url' => '/users', 'icon' => 'users', 'submenu' => [
        'all_users' => ['title' => 'All Users', 'url' => '/users'],
        'add_user' => ['title' => 'Add New', 'url' => '/users/new'],
        'roles' => ['title' => 'Roles & Capabilities', 'url' => '/users/roles'],
    ]],
    'settings' => ['title' => 'Settings', 'url' => '/settings', 'icon' => 'settings', 'submenu' => [
        'general' => ['title' => 'General', 'url' => '/settings/general'],
        'security' => ['title' => 'Security', 'url' => '/settings/security'],
        'privacy' => ['title' => 'Privacy', 'url' => '/settings/privacy'],
    ]],
    'tools' => ['title' => 'Tools', 'url' => '/tools', 'icon' => 'tool', 'submenu' => [
        'import' => ['title' => 'Import', 'url' => '/tools/import'],
        'export' => ['title' => 'Export', 'url' => '/tools/export'],
        'backup' => ['title' => 'Backup', 'url' => '/tools/backup'],
    ]],
    'reports' => ['title' => 'Reports', 'url' => '/reports', 'icon' => 'bar-chart'],
    'system' => ['title' => 'System', 'url' => '/system', 'icon' => 'server'],
    'logout' => ['title' => 'Logout', 'url' => '/logout', 'icon' => 'logout'],
];

// Filter menu items based on user role
$allowed_items = $role_capabilities[$user_role] ?? $role_capabilities['guest'];
$current_menu = [];
foreach ($allowed_items as $item_key) {
    if (isset($menu_items[$item_key])) {
        $current_menu[$item_key] = $menu_items[$item_key];
    }
}

// Get current page for active menu highlighting
$current_path = $_SERVER['REQUEST_URI'] ?? '/';
function is_active_menu($url, $current_path) {
    if ($url == '/' && $current_path == '/') return true;
    if ($url != '/' && strpos($current_path, $url) === 0) return true;
    return false;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo isset($page_title) ? $page_title . ' | ' : ''; ?>Your Site Name</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Header Styles -->
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --text-color: #1f2937;
            --light-bg: #f8fafc;
            --dark-bg: #1e293b;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            color: var(--text-color);
        }

        /* Header Container */
        .header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
        }

        .header.scrolled {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Top Bar */
        .top-bar {
            background: var(--dark-bg);
            color: var(--white);
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }

        .top-bar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .top-bar-left a {
            color: var(--white);
            text-decoration: none;
            margin-right: 1rem;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Main Header */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        /* Logo */
        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-weight: 700;
            font-size: 1.5rem;
        }

        .logo img {
            height: 40px;
            margin-right: 0.75rem;
        }

        /* Desktop Navigation */
        .desktop-nav {
            display: none;
        }

        @media (min-width: 1024px) {
            .desktop-nav {
                display: flex;
                align-items: center;
            }
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 0.5rem;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--text-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
            gap: 0.5rem;
        }

        .nav-link:hover {
            background: var(--light-bg);
            color: var(--primary-color);
        }

        .nav-link.active {
            background: var(--primary-color);
            color: var(--white);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            min-width: 220px;
            padding: 0.5rem 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: var(--transition);
            z-index: 100;
        }

        .dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: var(--text-color);
            transition: var(--transition);
        }

        .dropdown-item:hover {
            background: var(--light-bg);
            color: var(--primary-color);
            padding-left: 2rem;
        }

        /* User Menu */
        .user-menu {
            display: flex;
            align-items: center;
            margin-left: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 0.5rem;
            border: 2px solid var(--primary-color);
        }

        .user-dropdown {
            position: relative;
        }

        .user-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .user-toggle:hover {
            background: var(--light-bg);
        }

        .user-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--white);
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            min-width: 200px;
            padding: 0.5rem 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: var(--transition);
            z-index: 100;
        }

        .user-dropdown:hover .user-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-info {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-email {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--text-color);
            transition: var(--transition);
            gap: 0.75rem;
        }

        .user-dropdown-item:hover {
            background: var(--light-bg);
            color: var(--primary-color);
        }

        /* Mobile Menu Toggle */
        .mobile-toggle {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 30px;
            height: 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        @media (min-width: 1024px) {
            .mobile-toggle {
                display: none;
            }
        }

        .mobile-toggle span {
            display: block;
            height: 3px;
            width: 100%;
            background: var(--text-color);
            border-radius: 3px;
            transition: var(--transition);
        }

        .mobile-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .mobile-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            top: 0;
            right: -100%;
            width: 320px;
            height: 100vh;
            background: var(--white);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            z-index: 1001;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .mobile-nav.active {
            right: 0;
        }

        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .mobile-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .mobile-menu {
            list-style: none;
        }

        .mobile-item {
            margin-bottom: 0.5rem;
        }

        .mobile-link {
            display: flex;
            align-items: center;
            padding: 1rem;
            text-decoration: none;
            color: var(--text-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
            gap: 0.75rem;
        }

        .mobile-link:hover {
            background: var(--light-bg);
            color: var(--primary-color);
        }

        .mobile-dropdown-toggle {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: none;
            border: none;
            text-align: left;
            color: var(--text-color);
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .mobile-dropdown-toggle:hover {
            background: var(--light-bg);
            color: var(--primary-color);
        }

        .mobile-dropdown-menu {
            padding-left: 1.5rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .mobile-dropdown-menu.active {
            max-height: 500px;
        }

        .mobile-dropdown-item {
            display: block;
            padding: 0.75rem 0;
            text-decoration: none;
            color: var(--text-color);
            transition: var(--transition);
        }

        .mobile-dropdown-item:hover {
            color: var(--primary-color);
            padding-left: 0.5rem;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 1000;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Role Badge */
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-color);
            color: var(--white);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }

        /* Search Bar */
        .search-container {
            margin-left: 1rem;
            position: relative;
        }

        .search-input {
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            width: 300px;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        /* Notification Badge */
        .notification-badge {
            position: relative;
            margin-right: 1rem;
        }

        .notification-icon {
            font-size: 1.25rem;
            color: var(--text-color);
            position: relative;
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Header Start -->
    <header class="header" id="mainHeader">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-container">
                <div class="top-bar-left">
                    <a href="tel:+1234567890"><i class="fas fa-phone"></i> +1 (234) 567-890</a>
                    <a href="mailto:info@example.com"><i class="fas fa-envelope"></i> info@example.com</a>
                </div>
                <div class="top-bar-right">
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                    <?php if($user_role === 'guest'): ?>
                        <a href="/login" class="login-link">Login</a>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Main Header -->
        <div class="header-container">
            <div class="main-header">
                <!-- Logo -->
                <a href="/" class="logo">
                    <img src="/path/to/logo.png" alt="Site Logo">
                    <span>Your Brand</span>
                </a>

                <!-- Desktop Navigation -->
                <nav class="desktop-nav">
                    <!-- Search Bar -->
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="search" class="search-input" placeholder="Search...">
                    </div>

                    <!-- Main Menu -->
                    <ul class="nav-menu">
                        <?php foreach ($current_menu as $key => $item): ?>
                            <?php if (isset($item['submenu'])): ?>
                                <!-- Dropdown Item -->
                                <li class="nav-item dropdown">
                                    <a href="<?php echo $item['url']; ?>" 
                                       class="nav-link <?php echo is_active_menu($item['url'], $current_path) ? 'active' : ''; ?>">
                                        <i class="fas fa-<?php echo $item['icon']; ?>"></i>
                                        <?php echo $item['title']; ?>
                                        <i class="fas fa-chevron-down" style="font-size: 0.75rem; margin-left: 0.25rem;"></i>
                                    </a>
                                    <div class="dropdown-menu">
                                        <?php foreach ($item['submenu'] as $sub_key => $sub_item): ?>
                                            <a href="<?php echo $sub_item['url']; ?>" class="dropdown-item">
                                                <?php echo $sub_item['title']; ?>
                                            </a>
                                        <?php endforeach; ?>
                                    </div>
                                </li>
                            <?php else: ?>
                                <!-- Regular Item -->
                                <li class="nav-item">
                                    <a href="<?php echo $item['url']; ?>" 
                                       class="nav-link <?php echo is_active_menu($item['url'], $current_path) ? 'active' : ''; ?>">
                                        <i class="fas fa-<?php echo $item['icon']; ?>"></i>
                                        <?php echo $item['title']; ?>
                                    </a>
                                </li>
                            <?php endif; ?>
                        <?php endforeach; ?>
                    </ul>

                    <!-- User Menu (if logged in) -->
                    <?php if($user_role !== 'guest'): ?>
                        <div class="user-menu">
                            <!-- Notification -->
                            <div class="notification-badge">
                                <a href="/notifications" class="notification-icon">
                                    <i class="fas fa-bell"></i>
                                    <span class="badge-count">3</span>
                                </a>
                            </div>

                            <!-- User Dropdown -->
                            <div class="user-dropdown">
                                <div class="user-toggle">
                                    <img src="/uploads/avatars/<?php echo $user_avatar; ?>" alt="User Avatar" class="user-avatar">
                                    <span><?php echo $user_name; ?></span>
                                    <span class="role-badge"><?php echo $user_role; ?></span>
                                    <i class="fas fa-chevron-down" style="margin-left: 0.5rem;"></i>
                                </div>
                                <div class="user-dropdown-menu">
                                    <div class="user-info">
                                        <div class="user-name"><?php echo $user_name; ?></div>
                                        <div class="user-email"><?php echo $user_email; ?></div>
                                    </div>
                                    <a href="/profile" class="user-dropdown-item">
                                        <i class="fas fa-user"></i> Profile
                                    </a>
                                    <a href="/settings" class="user-dropdown-item">
                                        <i class="fas fa-cog"></i> Settings
                                    </a>
                                    <a href="/messages" class="user-dropdown-item">
                                        <i class="fas fa-envelope"></i> Messages
                                        <span class="badge-count" style="margin-left: auto;">2</span>
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a href="/logout" class="user-dropdown-item text-danger">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </a>
                                </div>
                            </div>
                        </div>
                    <?php endif; ?>
                </nav>

                <!-- Mobile Toggle -->
                <button class="mobile-toggle" id="mobileToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-header">
            <h3>Menu</h3>
            <button class="mobile-close" id="mobileClose">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- User Info (if logged in) -->
        <?php if($user_role !== 'guest'): ?>
            <div class="user-info" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <img src="/uploads/avatars/<?php echo $user_avatar; ?>" alt="User Avatar" 
                         style="width: 50px; height: 50px; border-radius: 50%; margin-right: 1rem;">
                    <div>
                        <div class="user-name"><?php echo $user_name; ?></div>
                        <div class="user-email"><?php echo $user_email; ?></div>
                    </div>
                </div>
                <span class="role-badge"><?php echo $user_role; ?></span>
            </div>
        <?php endif; ?>

        <!-- Mobile Search -->
        <div style="margin-bottom: 1.5rem; position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
            <input type="search" placeholder="Search..." 
                   style="width: 100%; padding: 0.75rem 1rem 0.75rem 3rem; border: 1px solid #e5e7eb; border-radius: var(--border-radius);">
        </div>

        <!-- Mobile Menu -->
        <ul class="mobile-menu">
            <?php foreach ($current_menu as $key => $item): ?>
                <?php if (isset($item['submenu'])): ?>
                    <!-- Mobile Dropdown Item -->
                    <li class="mobile-item">
                        <button class="mobile-dropdown-toggle" data-target="dropdown-<?php echo $key; ?>">
                            <span>
                                <i class="fas fa-<?php echo $item['icon']; ?>"></i>
                                <?php echo $item['title']; ?>
                            </span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                        </button>
                        <div class="mobile-dropdown-menu" id="dropdown-<?php echo $key; ?>">
                            <?php foreach ($item['submenu'] as $sub_key => $sub_item): ?>
                                <a href="<?php echo $sub_item['url']; ?>" class="mobile-dropdown-item">
                                    <?php echo $sub_item['title']; ?>
                                </a>
                            <?php endforeach; ?>
                        </div>
                    </li>
                <?php else: ?>
                    <!-- Mobile Regular Item -->
                    <li class="mobile-item">
                        <a href="<?php echo $item['url']; ?>" class="mobile-link">
                            <i class="fas fa-<?php echo $item['icon']; ?>"></i>
                            <?php echo $item['title']; ?>
                        </a>
                    </li>
                <?php endif; ?>
            <?php endforeach; ?>
            
            <?php if($user_role !== 'guest'): ?>
                <!-- Mobile User Links -->
                <li class="mobile-item">
                    <a href="/notifications" class="mobile-link">
                        <i class="fas fa-bell"></i>
                        Notifications
                        <span class="badge-count" style="margin-left: auto;">3</span>
                    </a>
                </li>
                <li class="mobile-item">
                    <a href="/messages" class="mobile-link">
                        <i class="fas fa-envelope"></i>
                        Messages
                        <span class="badge-count" style="margin-left: auto;">2</span>
                    </a>
                </li>
                <li class="mobile-item">
                    <a href="/settings" class="mobile-link">
                        <i class="fas fa-cog"></i>
                        Settings
                    </a>
                </li>
                <li class="mobile-item">
                    <a href="/logout" class="mobile-link" style="color: #ef4444;">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </li>
            <?php endif; ?>
        </ul>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile Menu Toggle
            const mobileToggle = document.getElementById('mobileToggle');
            const mobileNav = document.getElementById('mobileNav');
            const mobileClose = document.getElementById('mobileClose');
            const overlay = document.getElementById('overlay');
            const header = document.getElementById('mainHeader');

            function openMobileMenu() {
                mobileToggle.classList.add('active');
                mobileNav.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeMobileMenu() {
                mobileToggle.classList.remove('active');
                mobileNav.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            mobileToggle.addEventListener('click', openMobileMenu);
            mobileClose.addEventListener('click', closeMobileMenu);
            overlay.addEventListener('click', closeMobileMenu);

            // Mobile Dropdown Toggle
            const dropdownToggles = document.querySelectorAll('.mobile-dropdown-toggle');
            dropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const dropdownMenu = document.getElementById(targetId);
                    const arrow = this.querySelector('.dropdown-arrow');
                    
                    dropdownMenu.classList.toggle('active');
                    arrow.classList.toggle('fa-chevron-down');
                    arrow.classList.toggle('fa-chevron-up');
                });
            });

            // Header Scroll Effect
            window.addEventListener('scroll', function() {
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });

            // User Dropdown (for touch devices)
            const userToggle = document.querySelector('.user-toggle');
            if (userToggle) {
                userToggle.addEventListener('click', function(e) {
                    if (window.innerWidth < 1024) {
                        e.preventDefault();
                        const dropdown = this.closest('.user-dropdown').querySelector('.user-dropdown-menu');
                        dropdown.classList.toggle('active');
                    }
                });
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown') && !e.target.closest('.user-dropdown')) {
                    document.querySelectorAll('.dropdown-menu, .user-dropdown-menu').forEach(menu => {
                        menu.classList.remove('active');
                    });
                }
            });

            // Search functionality
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const query = this.value.trim();
                        if (query) {
                            window.location.href = `/search?q=${encodeURIComponent(query)}`;
                        }
                    }
                });
            }

            // Notification badge click
            document.querySelectorAll('.notification-badge').forEach(badge => {
                badge.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Mark notifications as read via AJAX
                    fetch('/api/notifications/read', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.querySelector('.badge-count').style.display = 'none';
                        }
                    });
                    
                    // Navigate to notifications page
                    setTimeout(() => {
                        window.location.href = '/notifications';
                    }, 300);
                });
            });
        });

        // Dynamic menu highlighting based on current page
        function highlightCurrentMenu() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link, .mobile-link');
            
            navLinks.forEach(link => {
                const linkPath = link.getAttribute('href');
                if (linkPath === currentPath || 
                    (linkPath !== '/' && currentPath.startsWith(linkPath))) {
                    link.classList.add('active');
                }
            });
        }

        // Call on page load
        highlightCurrentMenu();
    </script>
</body>
</html> 
 

==============================================================================
FILE PATH: C:\xampp\htdocs\portal\includes\intelligence.php
==============================================================================

<?php
class ArhamIntelligence {
    private $pdo;

    public function __construct($pdo) {
        $this->pdo = $pdo;
    }

    // --- 1. FRAUD GUARD (Security Layer) ---
    public function checkFraudRisk($cnic, $phone = '') {
        $alerts = [];
        $risk_score = 0;

        // Rule A: High Frequency (Coming too often - >1 times in 30 days)
        // Note: Adjust '30 DAY' to your policy preference
        $stmt = $this->pdo->prepare("SELECT COUNT(*) FROM transactions t JOIN beneficiaries b ON t.beneficiary_id = b.id WHERE b.cnic = ? AND t.created_at > DATE_SUB(NOW(), INTERVAL 30 DAY)");
        $stmt->execute([$cnic]);
        $visits = $stmt->fetchColumn();
        
        if ($visits >= 1) {
            $alerts[] = "‚ö†Ô∏è **High Frequency:** Beneficiary was paid recently ($visits times in 30 days).";
            $risk_score += 40;
        }

        // Rule B: Phone Hopping (One phone linked to multiple CNICs)
        if (!empty($phone)) {
            $stmt = $this->pdo->prepare("SELECT COUNT(DISTINCT cnic) FROM beneficiaries WHERE phone = ?");
            $stmt->execute([$phone]);
            $linked_cnics = $stmt->fetchColumn();
            
            if ($linked_cnics >= 3) {
                $alerts[] = "üö® **Phone Ring:** This number is linked to $linked_cnics different CNICs.";
                $risk_score += 50;
            }
        }

        // Rule C: Queue Flooding (Already waiting in queue today)
        $today = date('Y-m-d');
        $stmt = $this->pdo->prepare("SELECT token_number FROM queue_tokens WHERE cnic = ? AND DATE(issued_at) = '$today' AND status='waiting'");
        $stmt->execute([$cnic]);
        $existing = $stmt->fetchColumn();
        
        if ($existing) {
            $alerts[] = "üõë **Duplicate Token:** Already in queue (Token #$existing).";
            $risk_score += 100; // Immediate block
        }

        return ['score' => $risk_score, 'alerts' => $alerts];
    }

    // --- 2. PREDICTIVE ANALYTICS (AI Logic) ---
    public function predictWaitTime($queue_length) {
        // Machine Learning: Calculate Moving Average of last 50 transactions
        $stmt = $this->pdo->query("SELECT AVG(TIMESTAMPDIFF(MINUTE, issued_at, served_at)) as avg_time FROM queue_tokens WHERE status='served' ORDER BY id DESC LIMIT 50");
        $avg_pace = $stmt->fetchColumn() ?: 5; // Default to 5 mins if no data
        
        return round($queue_length * $avg_pace);
    }

    public function forecastDemand() {
        // Predict today's total traffic based on previous same-day activity
        $day_of_week = date('w'); // 0 (Sun) - 6 (Sat)
        $stmt = $this->pdo->prepare("SELECT COUNT(*) FROM queue_tokens WHERE DAYOFWEEK(issued_at) = ? + 1 AND DATE(issued_at) < CURDATE()");
        $stmt->execute([$day_of_week]);
        $avg_traffic = $stmt->fetchColumn(); 
        
        // Simple linear projection (Avg of history) or default to 50
        return $avg_traffic ? round($avg_traffic / 4) : 50; // Approximate average
    }
}

// Initialize Global Intelligence if DB connection exists
if(isset($pdo)) {
    $AI = new ArhamIntelligence($pdo);
}
?> 
 
