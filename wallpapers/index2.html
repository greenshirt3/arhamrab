<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Wallpaper Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@tweenjs/tween.js": "https://unpkg.com/@tweenjs/tween.js@23.1.1/dist/tween.esm.js"
        }
    }
    </script>

    <style>
        :root { --primary: #00d4ff; --bg: #111; --text: #fff; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Outfit', sans-serif; color: var(--text); user-select: none; }
        #canvas-container { width: 100%; height: 100vh; position: absolute; top:0; left:0; z-index: 1; }

        /* --- UI LAYER --- */
        .ui-layer { pointer-events: none; position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        
        .brand { text-align: center; margin-top: 10px; pointer-events: auto; }
        .brand h1 { font-weight: 800; font-size: 1.5rem; margin: 0; letter-spacing: 2px; color: #fff; text-transform: uppercase; text-shadow: 0 0 15px rgba(0,212,255,0.5); }
        .brand span { color: var(--primary); }
        .room-info { font-size: 0.9rem; color: #000; margin-top: 5px; font-weight: 600; background: rgba(255,255,255,0.8); display: inline-block; padding: 4px 15px; border-radius: 20px; backdrop-filter: blur(5px); }

        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); color: #fff;
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; pointer-events: auto;
            transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .nav-btn:hover { background: var(--primary); color: #000; transform: translateY(-50%) scale(1.1); }
        .nav-prev { left: 15px; }
        .nav-next { right: 15px; }

        /* WhatsApp Button */
        .wa-float {
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); z-index: 50;
            background: #25D366; color: white; padding: 12px 30px; border-radius: 50px;
            text-decoration: none; font-weight: 700; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); pointer-events: auto; font-size: 1rem;
            transition: transform 0.3s;
        }
        .wa-float:hover { transform: translateX(-50%) translateY(-5px); box-shadow: 0 10px 25px rgba(37, 211, 102, 0.5); }

        /* Tour Button */
        #tour-btn {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            padding: 10px 20px; background: #25D366; color: white; border: none;
            border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-family: 'Outfit', sans-serif;
            transition: background 0.3s;
        }
        #tour-btn:hover { filter: brightness(1.1); }

        /* Ticker */
        .neon-ticker-wrap {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50px;
            background: #000; border-top: 2px solid var(--primary);
            z-index: 90; display: flex; align-items: center; overflow: hidden; pointer-events: none;
        }
        .ticker-text {
            white-space: nowrap; font-family: 'Outfit', sans-serif; font-weight: 700; text-transform: uppercase;
            color: #fff; text-shadow: 0 0 10px var(--primary); font-size: 1rem; letter-spacing: 2px;
            animation: tickerAnim 25s linear infinite; padding-left: 100%;
        }
        @keyframes tickerAnim { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #000; color: #fff; z-index: 100; display: flex; align-items: center; justify-content: center; font-weight: bold; letter-spacing: 2px; transition: opacity 0.5s; }
    </style>
</head>
<body>

    <div id="loader">LOADING STUDIO...</div>
    <div id="canvas-container"></div>

    <div class="ui-layer">
        <div class="brand">
            <h1>Arham<span>Printers</span></h1>
            <div class="room-info" id="room-name">Loading...</div>
        </div>
        
        <button id="tour-btn" onclick="window.toggleTour()">▶ START TOUR</button>

        <div class="nav-btn nav-prev" onclick="window.moveRoom(-1)">&#10094;</div>
        <div class="nav-btn nav-next" onclick="window.moveRoom(1)">&#10095;</div>
    </div>

    <a href="https://wa.me/923006238233" target="_blank" class="wa-float">
        <i class="fab fa-whatsapp" style="font-size:1.3rem;"></i> ORDER THIS DESIGN
    </a>

    <div class="neon-ticker-wrap">
        <div class="ticker-text">
            ARHAM PRINTERS &nbsp;✦&nbsp; BANNERS &nbsp;✦&nbsp; 3D WALLPAPERS &nbsp;✦&nbsp; WEDDING CARDS &nbsp;✦&nbsp; BUSINESS CARDS &nbsp;✦&nbsp; DIGITAL PRINTING &nbsp;✦&nbsp; FLEX PRINTING
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
        import * as TWEEN from '@tweenjs/tween.js';

        // --- GLOBAL VARIABLES ---
        let activeRoomIdx = 0;
        const ROOM_SPACING = 50; 
        let config = { rooms: [] };
        let isTourActive = false;

        // THREE.JS VARS
        let scene, camera, renderer, controls, worldGroup, composer;
        let mainBulb; // Global light to tween
        const texLoader = new THREE.TextureLoader();

        // --- FETCH JSON DATA ---
        fetch('data.json?v=' + Date.now()) 
            .then(response => response.json())
            .then(data => {
                config = data;
                init();
                // Fade out loader
                document.getElementById('loader').style.opacity = 0;
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            })
            .catch(err => {
                document.getElementById('loader').innerText = "ERROR: CHECK DATA.JSON";
                console.error(err);
            });

        function init() {
            const container = document.getElementById('canvas-container');
            
            // 1. Scene Setup with Skybox
            scene = new THREE.Scene();
            
            // Try to load skybox (background.jpg)
            texLoader.load('uploads/background.jpg', (texture) => {
                texture.mapping = THREE.EquirectangularReflectionMapping;
                texture.colorSpace = THREE.SRGBColorSpace;
                scene.background = texture;
                scene.environment = texture; // Walls reflect the skybox
            }, undefined, () => {
                // Fallback if no image found
                scene.background = new THREE.Color(0x222222);
            });

            // Very light fog to blend distant rooms, but keep sky visible
            scene.fog = new THREE.FogExp2(0x111111, 0.002); 

            // 2. Camera
            const isMobile = window.innerWidth < 768;
            camera = new THREE.PerspectiveCamera(isMobile ? 85 : 60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 6, 14); 

            // 3. Renderer (Cinematic Quality)
            renderer = new THREE.WebGLRenderer({ antialias: false, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            container.appendChild(renderer.domElement);

            // 4. Post-Processing (Bloom)
            const renderScene = new RenderPass(scene, camera);
            
            // Bloom: res, strength, radius, threshold
            const bloomPass = new UnrealBloomPass( new THREE.Vector2( window.innerWidth, window.innerHeight ), 1.5, 0.4, 0.85 );
            bloomPass.threshold = 0.8; 
            bloomPass.strength = 0.3; 
            bloomPass.radius = 0.5;

            const outputPass = new OutputPass();

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);
            composer.addPass(outputPass);

            // 5. Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            
            // Main Room Light (We will tween this color per room)
            mainBulb = new THREE.PointLight(0xfffaed, 2.0, 40);
            mainBulb.position.set(0, 8, 0); 
            scene.add(mainBulb);

            // 6. Build World
            worldGroup = new THREE.Group(); 
            scene.add(worldGroup);
            buildWorld();

            // 7. Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enablePan = false;
            controls.minDistance = 2; 
            controls.maxDistance = 20; 
            controls.target.set(0, 4, 0);

            // 8. Events
            window.addEventListener('resize', onResize);

            // Initialize UI and Light for first room
            updateUI();
            updateLighting(0);
            animate();
        }

        // --- BUILDER ---
        function buildWorld() {
            config.rooms.forEach((room, idx) => {
                const g = new THREE.Group();
                g.position.x = idx * ROOM_SPACING;

                const getMat = (surfName) => {
                    const s = room.surfaces[surfName];
                    const mat = new THREE.MeshStandardMaterial({ 
                        side: THREE.BackSide,
                        roughness: 0.2, // Shiny for reflection
                        metalness: 0.1 
                    }); 
                    
                    if(s && s.tex) {
                        texLoader.load(s.tex, (t) => {
                            t.colorSpace = THREE.SRGBColorSpace;
                            mat.map = t; mat.needsUpdate = true;
                        });
                    } 
                    if(s && s.col) mat.color.set(s.col);
                    return mat;
                };

                const mats = [
                    getMat('right'), getMat('left'), getMat('ceil'), 
                    getMat('floor'), getMat('front'), getMat('back')
                ];

                const shell = new THREE.Mesh(new THREE.BoxGeometry(room.w, room.h, room.d), mats);
                shell.position.y = room.h / 2;
                g.add(shell);
                worldGroup.add(g);
            });
        }

        // --- LIGHTING CONTROL ---
        function updateLighting(index) {
            const room = config.rooms[index];
            if(room && room.lighting) {
                // Tween Light Color
                new TWEEN.Tween(mainBulb.color)
                    .to(new THREE.Color(room.lighting.color), 1000)
                    .start();
                // Tween Intensity
                new TWEEN.Tween(mainBulb)
                    .to({ intensity: room.lighting.intensity }, 1000)
                    .start();
                
                // Move Bulb to new room center physically
                mainBulb.position.x = index * ROOM_SPACING;
            }
        }

        // --- NAVIGATION & TOUR LOGIC ---
        window.moveRoom = function(dir) {
            const next = activeRoomIdx + dir;
            // Stop automatic tour if user manually clicks
            if(isTourActive && dir !== 0) toggleTour(); 
            goToRoom(next);
        }

        function goToRoom(index) {
    if(index >= 0 && index < config.rooms.length) {
        activeRoomIdx = index;
        updateLighting(activeRoomIdx);
        
        const targetX = activeRoomIdx * ROOM_SPACING;
        
        // --- CHANGE IS HERE ---
        // Old: x: targetX + 8, z: 8
        // New: x: targetX (Center), z: 14 (Back)
        new TWEEN.Tween(camera.position)
            .to({ x: targetX, y: 6, z: 14 }, 1500)
            .easing(TWEEN.Easing.Cubic.InOut)
            .start();
            
        // Look Straight Ahead (Center)
        new TWEEN.Tween(controls.target)
            .to({ x: targetX, y: 5, z: 0 }, 1500)
            .easing(TWEEN.Easing.Cubic.InOut)
            .start();

        updateUI();
    }
}

        // --- AUTO TOUR FUNCTION ---
        window.toggleTour = function() {
            isTourActive = !isTourActive;
            const btn = document.getElementById('tour-btn');
            
            if(isTourActive) {
                btn.innerText = "⏹ STOP TOUR";
                btn.style.background = "#ff4444";
                runTourStep(activeRoomIdx); // Start loop
            } else {
                btn.innerText = "▶ START TOUR";
                btn.style.background = "#25D366";
                TWEEN.removeAll(); // Stop animations
                goToRoom(activeRoomIdx); // Reset view
            }
        }

        function runTourStep(index) {
    if(!isTourActive) return;
    if(index >= config.rooms.length) index = 0; 

    activeRoomIdx = index;
    updateUI();
    updateLighting(index);

    const roomX = index * ROOM_SPACING;

    // 1. Move Camera INSIDE the room (Center)
    // We set z: 0.1 instead of 0 to prevent a math glitch where camera & target are in exact same spot
    new TWEEN.Tween(camera.position)
        .to({ x: roomX, y: 5, z: 0.1 }, 2000) 
        .easing(TWEEN.Easing.Cubic.InOut)
        .start();

    // 2. The 360-Degree Look Sequence (First Person View)
    
    // Step A: Look at Front Wall
    const tFront = new TWEEN.Tween(controls.target)
        .to({ x: roomX, y: 5, z: -10 }, 2000)
        .easing(TWEEN.Easing.Cubic.InOut);

    // Step B: Pan to Right Wall
    const tRight = new TWEEN.Tween(controls.target)
        .to({ x: roomX + 10, y: 5, z: 0 }, 2000)
        .delay(500);

    // Step C: Pan to Back Wall
    const tBack = new TWEEN.Tween(controls.target)
        .to({ x: roomX, y: 5, z: 10 }, 2000)
        .delay(200);

    // Step D: Pan to Left Wall
    const tLeft = new TWEEN.Tween(controls.target)
        .to({ x: roomX - 10, y: 5, z: 0 }, 2000)
        .delay(200);

    // Step E: Look Up at Roof (Angled)
    const tRoof = new TWEEN.Tween(controls.target)
        .to({ x: roomX, y: 12, z: -5 }, 2000)
        .delay(200);

    // Step F: Next Room
    // We don't reset to center here, we just fly straight to the next room
    const tNext = new TWEEN.Tween(controls.target)
        .to({ x: roomX, y: 5, z: -10 }, 1000) // Reset look forward
        .delay(500)
        .onComplete(() => {
            if(isTourActive) runTourStep(index + 1);
        });

    // Chain the full 360 spin
    tFront.chain(tRight);
    tRight.chain(tBack);
    tBack.chain(tLeft);
    tLeft.chain(tRoof);
    tRoof.chain(tNext);
    
    tFront.start();
}

        function updateUI() {
            if(!config.rooms[activeRoomIdx]) return;
            const rName = config.rooms[activeRoomIdx].name;
            const count = (activeRoomIdx + 1) + " / " + config.rooms.length;
            document.getElementById('room-name').innerText = rName + " (" + count + ")";
            
            document.querySelector('.nav-prev').style.opacity = activeRoomIdx === 0 ? 0.3 : 1;
            document.querySelector('.nav-next').style.opacity = activeRoomIdx === config.rooms.length-1 ? 0.3 : 1;
        }

        function onResize() {
            const isMobile = window.innerWidth < 768;
            camera.fov = isMobile ? 85 : 60; 
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            controls.update();
            
            // "Breathing" Camera
            if(!isTourActive) {
                camera.position.y += Math.sin(Date.now() * 0.0005) * 0.002;
            }

            composer.render();
        }
    </script>
</body>
</html>